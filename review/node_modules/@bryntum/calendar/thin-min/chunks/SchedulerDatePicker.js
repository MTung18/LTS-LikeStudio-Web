/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Localizable as e,DateHelper as t,InstancePlugin as r,ObjectHelper as n,Objects as i,Config as o,Popup as s,Store as a,Button as l,Base as c,_objectSpread2 as d,Widget as u,Combo as h,DomHelper as g,Delayable as v,List as m,StringHelper as p,ArrayHelper as E,VersionHelper as y}from"./Editor.js";import{DateField as f,DatePicker as b}from"./MessageDialog.js";import{GridFeatureManager as C}from"./GridBase.js";import{RecurrenceFrequencyCombo as R}from"./EventNavigation.js";import{RecurrenceDayRuleEncoder as S,TimeSpan as D}from"./ProjectModel.js";class w extends(e()){static get $name(){return"RecurrenceLegend"}static get allDaysValueAsArray(){return["SU","MO","TU","WE","TH","FR","SA"]}static get allDaysValue(){return this.allDaysValueAsArray.join(",")}static get workingDaysValue(){return this.allDaysValueAsArray.filter(((e,r)=>!t.nonWorkingDays[r])).join(",")}static get nonWorkingDaysValue(){return this.allDaysValueAsArray.filter(((e,r)=>t.nonWorkingDays[r])).join(",")}static getLegend(e,r){const n=this,{timeSpan:i,interval:o,days:s,monthDays:a,months:l,positions:c}=e,d=r||i.startDate,u={interval:o};let h;switch(e.frequency){case"DAILY":return 1===o?n.L("L{Daily}"):n.L("L{Every {0} days}",u);case"WEEKLY":return s&&s.length?u.days=n.getDaysLegend(s):d&&(u.days=t.getDayName(d.getDay())),n.L(1===o?"L{Weekly on {1}}":"L{Every {0} weeks on {1}}",u);case"MONTHLY":return s&&s.length&&c&&c.length?u.days=n.getDaysLegend(s,c):a&&a.length?(a.sort(((e,t)=>e-t)),u.days=n.arrayToText(a)):d&&(u.days=d.getDate()),n.L(1===o?"L{Monthly on {1}}":"L{Every {0} months on {1}}",u);case"YEARLY":return s&&s.length&&c&&c.length?u.days=n.getDaysLegend(s,c):u.days=d.getDate(),l&&l.length?(l.sort(((e,t)=>e-t)),h=l.length>2?e=>t.getMonthShortName(e-1):e=>t.getMonthName(e-1),u.months=n.arrayToText(l,h)):u.months=t.getMonthName(d.getMonth()),n.L(1===o?"L{Yearly on {1} of {2}}":"L{Every {0} years on {1} of {2}}",u)}}static getDaysLegend(e,r){const n=this,i={position:""};let o;if(r&&r.length&&(i.position=n.arrayToText(r,(e=>n.L(`L{position${e}}`)))),e.length)switch(e.sort(((e,t)=>S.decodeDay(e)[0]-S.decodeDay(t)[0])),e.join(",")){case n.allDaysValue:i.days=n.L("L{day}");break;case n.workingDaysValue:i.days=n.L("L{weekday}");break;case n.nonWorkingDaysValue:i.days=n.L("L{weekend day}");break;default:o=e.length>2?e=>t.getDayShortName(S.decodeDay(e)[0]):e=>t.getDayName(S.decodeDay(e)[0]),i.days=n.arrayToText(e,o)}return n.L("L{daysFormat}",i)}static arrayToText(e,t){return t&&(e=e.map(t)),e.join(", ").replace(/,(?=[^,]*$)/,this.L("L{ and }"))}}w._$name="RecurrenceLegend";const F=t,L=["startDate","endDate","resource","recurrenceRule"],T=e=>{if(1===e.length)return e[0].value;if(2===e.length){const[r,n]=e[0]instanceof f?e:e.reverse(),i=F.parse(r.value);return i&&n.value&&i.setHours(n.value.getHours(),n.value.getMinutes(),n.value.getSeconds(),n.value.getMilliseconds()),i?t.clone(i):null}return null},O=(e,t,r)=>{if(e&&t&&r.endDateField&&r.endTimeField){const e=F.add(((e,t)=>{const r=new Date(e.getTime());return r.setHours(t.getHours(),t.getMinutes()),r})(r.startDateField.value,r.startTimeField.value),r.eventRecord.durationMS,"milliseconds");r.endDateField.value=e,r.endTimeField.value=F.clone(e)}};class k extends r{static get configurable(){return{saveAndCloseOnEnter:!0,triggerEvent:null,dateFormat:"L",timeFormat:"LT",editorConfig:null,items:null,weekStartDay:null}}construct(e,t){const r=this;e.eventEdit=r,super.construct(e,n.assign({weekStartDay:e.weekStartDay},t)),r.clientListenersDetacher=e.ion({[r.triggerEvent]:"onActivateEditor",dragCreateEnd:"onDragCreateEnd",eventAutoCreated:"onEventAutoCreated",thisObj:r})}doDestroy(){var e;this.clientListenersDetacher(),null===(e=this._editor)||void 0===e||e.destroy(),super.doDestroy()}onEventAutoCreated(){}changeEditorConfig(e){const{items:t}=this;return t&&((e=i.clone(e)).items=o.merge(t,e.items)),e}changeItems(e){return this.cleanItemsConfig(e),e}cleanItemsConfig(e){for(const t in e){const r=e[t];!0===r?delete e[t]:null!=r&&r.items&&this.cleanItemsConfig(r.items)}}onDatesChange(e){var t,r;const n=this,i=e.source,o=e.value;var s,a;(n.startDateField&&n.endDateField&&(n.endDateField.min=n.startDateField.value),n.endTimeField)&&(F.isEqual(F.clearTime(null===(s=n.startDateField)||void 0===s?void 0:s.value),F.clearTime(null===(a=n.endDateField)||void 0===a?void 0:a.value))?n.endTimeField.min=n.startTimeField.value:n.endTimeField.min=null);switch(i.ref){case"startDateField":(null===(t=n.startTimeField)||void 0===t?void 0:t.value)&&O(o,n.startTimeField.value,n);break;case"startTimeField":(null===(r=n.startDateField)||void 0===r?void 0:r.value)&&O(n.startDateField.value,o,n)}}async save(){throw new Error("Implement in subclass")}get values(){const e=this,{editor:t}=e,r=[],n=[],{values:i}=t;return L.forEach((e=>delete i[e])),t.eachWidget((o=>{var s;const{name:a}=o;if(!a||o.hidden||o.up((t=>t===e.recurrenceEditor)))delete i[a];else switch(a){case"startDate":r.push(o);break;case"endDate":n.push(o);break;case"resource":i[a]=o.record;break;case"recurrenceRule":i[a]="none"===(null===(s=t.widgetMap.recurrenceCombo)||void 0===s?void 0:s.value)?"":o.value}}),!0),i.allDay&&!e.eventRecord.allDay&&(r.push(e.startTimeField),n.push(e.endTimeField)),r.length&&(i.startDate=T(r)),n.length&&(i.endDate=T(n)),"startDate"in i&&"endDate"in i&&(i.duration=F.diff(i.startDate,i.endDate,e.editor.record.durationUnit,!0)),i}onBeforeSave(e){}onAfterSave(e){}updateRecord(e){const{values:t}=this;return this.assignmentStore&&delete t.resource,e.set(t)}onBeforeEditorShow(){const{eventRecord:e,editor:t}=this.editingContext,{nameField:r}=t.widgetMap;r&&e.isCreating&&(t.assigningValues=!0,r.value="",t.assigningValues=!1,r._configuredPlaceholder=r.placeholder,r.placeholder=e.name)}resetEditingContext(){const e=this;if(!e.editingContext)return;const{client:t}=e,{editor:r,eventRecord:n}=e.editingContext,{eventStore:i}=t,{nameField:o}=r.widgetMap;if(n.isCreating){var s;if(t.isTimelineBase)null===(s=e.editingContext.eventElement)||void 0===s||s.closest("[data-event-id]").classList.add("b-released");i.remove(n),n.isCreating=!1}o&&(o.placeholder=o._configuredPlaceholder),t.element.classList.remove("b-eventeditor-editing"),e.targetEventElement=e.editingContext=r._record=null}onPopupKeyDown({event:e}){const t=this;!t.readOnly&&"Enter"===e.key&&t.saveAndCloseOnEnter&&"input"===e.target.tagName.toLowerCase()&&(e.preventDefault(),"startDate"===e.target.name&&t.startTimeField&&O(t.startDateField.value,t.startTimeField.value,t),t.onSaveClick())}async onSaveClick(){this.editor.focus();const e=await this.save();return e&&(this.editor.close(),this.client.trigger("afterEventEdit")),e}async onDeleteClick(){if(await this.deleteEvent()){const{editor:e}=this;e.autoClose&&!e.containsFocus||e.close(),this.client.trigger("afterEventEdit")}}onCancelClick(){this.editor.close(),this.client.trigger("afterEventEdit")}}k._$name="EditBase";class x extends s{static get type(){return"eventeditor"}static get $name(){return"EventEditor"}static get configurable(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible",scrollable:{overflowY:!0},readOnly:null,titleRenderer:null}}updateLocalization(){super.updateLocalization(...arguments),this.initialTitle=this.title||""}chainResourceStore(){return this.eventEditFeature.resourceStore.chain((e=>!e.isSpecialRow),null,{storeClass:a,excludeCollapsedRecords:!1})}processWidgetConfig(e){var t;if(null!==(t=e.type)&&void 0!==t&&t.includes("date")&&null==e.weekStartDay&&(e.weekStartDay=this.weekStartDay),"extraItems"===e.type)return!1;const{eventEditFeature:r}=this,n={};if("resourceField"===e.ref){const{store:t}=e;e.store=this.chainResourceStore(),t&&e.store.setConfig(t),"multiSelect"in e||(e.multiSelect=!r.eventStore.usesSingleAssignment)}return"startDate"!==e.name&&"endDate"!==e.name||"date"!==e.type||(n.format=r.dateFormat),"startDate"!==e.name&&"endDate"!==e.name||"time"!==e.type||(n.format=r.timeFormat),Object.assign(e,n),super.processWidgetConfig(e)}onBeforeShow(...e){var t;const r=this,{record:n,titleRenderer:i}=r,{deleteButton:o}=r.widgetMap;o&&(o.hidden=r.readOnly||n.isCreating),r.title=i?r.callback(i,r,[n]):r.initialTitle,null===(t=super.onBeforeShow)||void 0===t||t.call(this,...e)}onInternalKeyDown(e){this.trigger("keyDown",{event:e}),super.onInternalKeyDown(e)}updateReadOnly(e){const{deleteButton:t,saveButton:r,cancelButton:n}=this.widgetMap;super.updateReadOnly(e),t&&(t.hidden=e),r&&(r.hidden=e),n&&(n.hidden=e)}}x.initClass(),x._$name="EventEditor";class B extends R{static get $name(){return"RecurrenceCombo"}static get type(){return"recurrencecombo"}static get defaultConfig(){return{customValue:"custom",placeholder:"None",splitCls:"b-recurrencecombo-split",items:!0,highlightExternalChange:!1}}buildItems(){return[{value:"none",text:"L{None}"},...super.buildItems(),{value:this.customValue,text:"L{Custom}",cls:this.splitCls}]}set value(e){e=e||"none",super.value=e}get value(){return super.value}set recurrence(e){const t=this;t.value=e?t.isCustomRecurrence(e)?t.customValue:e.frequency:null}isCustomRecurrence(e){const{interval:t,days:r,monthDays:n,months:i}=e;return Boolean(t>1||r&&r.length||n&&n.length||i&&i.length)}}B.initClass(),B._$name="RecurrenceCombo";class j extends l{static get $name(){return"RecurrenceLegendButton"}static get type(){return"recurrencelegendbutton"}static get defaultConfig(){return{localizableProperties:[],recurrence:null}}set recurrence(e){this._recurrence=e,this.updateLegend()}get recurrence(){return this._recurrence}set eventStartDate(e){this._eventStartDate=e,this.updateLegend()}get eventStartDate(){return this._eventStartDate}updateLegend(){const{recurrence:e}=this;this.text=e?w.getLegend(e,this.eventStartDate):""}onLocaleChange(){this.updateLegend()}updateLocalization(){this.onLocaleChange(),super.updateLocalization()}}j.initClass(),j._$name="RecurrenceLegendButton";class $ extends s{static get $name(){return"RecurrenceEditor"}static get type(){return"recurrenceeditor"}static get configurable(){return{draggable:!0,closable:!0,floating:!0,cls:"b-recurrenceeditor",title:"L{Repeat event}",autoClose:!0,width:470,items:{recurrenceEditorPanel:{type:"recurrenceeditorpanel",title:null}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler",weight:100},saveButton:{color:"b-green",text:"L{Save}",onClick:"up.onSaveClick",weight:200},cancelButton:{color:"b-gray",text:"L{Object.Cancel}",onClick:"up.onCancelClick",weight:300}}}}}updateReadOnly(e){super.updateReadOnly(e),this.bbar.hidden=e}get recurrenceEditorPanel(){return this.widgetMap.recurrenceEditorPanel}updateRecord(e){this.recurrenceEditorPanel.record=e}onSaveClick(){const e=this;e.saveHandler?e.saveHandler.call(e.thisObj||e,e,e.record):(e.recurrenceEditorPanel.syncEventRecord(),e.close())}onCancelClick(){const e=this;e.cancelHandler?e.cancelHandler.call(e.thisObj||e,e,e.record):e.close()}}$.initClass(),$._$name="RecurrenceEditor";var _=e=>class extends(e||c){static get $name(){return"RecurringEventEdit"}static get configurable(){return{recurringEventsItems:{recurrenceCombo:{type:"recurrencecombo",label:"L{EventEdit.Repeat}",ref:"recurrenceCombo",weight:700},editRecurrenceButton:{type:"recurrencelegendbutton",ref:"editRecurrenceButton",name:"recurrenceRule",color:"b-gray",menuIcon:null,flex:1,weight:800,ignoreParentReadOnly:!0}},showRecurringUI:null}}changeEditorConfig(e){return e.items=d(d({},e.items),this.recurringEventsItems),e=super.changeEditorConfig(e)}construct(e,t){super.construct(e,t),this.scheduler.ion({beforeEventSave:"onRecurrableEventBeforeSave",thisObj:this})}doDestroy(){var e,t;null===(e=this._recurrenceConfirmation)||void 0===e||e.destroy(),null===(t=this._recurrenceEditor)||void 0===t||t.destroy(),super.doDestroy()}onEditorConstructed(e){var t;const r=this;e.ion({hide:r.onRecurringEventEditorHide,thisObj:r}),r.editRecurrenceButton&&(r.editRecurrenceButton.menu=r.recurrenceEditor),null===(t=r.recurrenceCombo)||void 0===t||t.ion({change:r.onRecurrenceComboChange,thisObj:r})}updateReadOnly(e){this._recurrenceEditor&&(this._recurrenceEditor.readOnly=e)}internalShowEditor(){this.toggleRecurringFieldsVisibility(this.client.enableRecurringEvents&&!1!==this.showRecurringUI)}toggleRecurringFieldsVisibility(e=!0){var t,r,n,i;const o=e?"show":"hide";null===(t=this.editRecurrenceButton)||void 0===t||null===(r=t[o])||void 0===r||r.call(t),null===(n=this.recurrenceCombo)||void 0===n||null===(i=n[o])||void 0===i||i.call(n)}onRecurringEventEditorHide(){var e,t;null!==(e=this.recurrenceEditor)&&void 0!==e&&e.isVisible&&this.recurrenceEditor.hide(),null!==(t=this.recurrenceConfirmation)&&void 0!==t&&t.isVisible&&this.recurrenceConfirmation.hide()}makeRecurrence(e){const t=this.eventRecord,r=t.copy();let n=t.recurrence;return n=!e&&n?n.copy():new t.recurrenceModel(e?{rule:e}:{}),n.timeSpan=r,r.setStartDate(this.values.startDate),n.suspendTimeSpanNotifying(),n}onRecurrableEventBeforeSave({eventRecord:e,context:t}){const r=this;r.isEditing&&!e.isCreating&&e.supportsRecurring&&(e.isRecurring||e.isOccurrence)&&(r.recurrenceConfirmation.confirm({actionType:"update",eventRecord:e,changerFn(){t.finalize(!0)},cancelFn(){t.finalize(!1)}}),t.async=!0)}set recurrenceConfirmation(e){this._recurrenceConfirmation=e}get recurrenceConfirmation(){const e=this;let t=e._recurrenceConfirmation;return t&&t.$$name||(t=u.create(d({type:"recurrenceconfirmation",owner:e.editor},t)),e._recurrenceConfirmation=t),t}set recurrenceEditor(e){this._recurrenceEditor=e}get recurrenceEditor(){const e=this;let t=e._recurrenceEditor;return t&&t.$$name||(e._recurrenceEditor=t=u.create(d({type:"recurrenceeditor",autoShow:!1,centered:!0,modal:!0,constrainTo:globalThis,anchor:!1,rootElement:e.rootElement,saveHandler:e.recurrenceEditorSaveHandler,onBeforeShow:e.onBeforeShowRecurrenceEditor.bind(e),thisObj:e},t)),t.readOnly=e._readOnly),t}onBeforeShowRecurrenceEditor(){const e=this,{recurrenceEditor:t,eventRecord:r}=e;t&&null!=r&&r.supportsRecurring&&(e.recurrence||(e.recurrence=e.makeRecurrence()),e.recurrence.timeSpan.setStartDate(e.values.startDate),t.record=e.recurrence,t.centered=!0)}loadRecurrenceData(e){this.recurrence=e,this.updateRecurrenceFields(e)}updateRecurrenceFields(e){const t=this,{editRecurrenceButton:r}=t;t.recurrenceCombo&&(t.recurrenceCombo.recurrence=e),r&&(r.recurrence=e,r.value=e?e.rule:null,e&&t.client.enableRecurringEvents&&!1!==t.showRecurringUI?r.show():r.hide())}onRecurrenceComboChange({source:e,value:t,userAction:r}){if(r){const r=this,{recurrenceEditor:n}=r;t===e.customValue?(r.recurrenceCombo.recurrence=r.makeRecurrence(),n.centered?n.show():n.show((r.editRecurrenceButton||e).element)):r.loadRecurrenceData(t&&"none"!==t?r.makeRecurrence(`FREQ=${t}`):null)}}recurrenceEditorSaveHandler(e,t){e.recurrenceEditorPanel.syncEventRecord(t),this.updateRecurrenceFields(t),e.close()}onDatesChange(...e){if(super.onDatesChange(...e),!this.loadingRecord&&this.editRecurrenceButton){const{startDate:e}=this.values;e&&(this.editRecurrenceButton.eventStartDate=e)}}internalLoadRecord(e){null!=e&&e.supportsRecurring&&this.loadRecurrenceData(e.recurrence?this.makeRecurrence():null)}updateRecord(e){return e.recurrenceRule&&!this.recurrence&&(e.recurrenceRule=null),super.updateRecord(e)}};class I extends h{static get $name(){return"ResourceCombo"}static get type(){return"resourcecombo"}static get configurable(){return{showEventColor:!1,picker:{cls:"b-resourcecombo-picker",itemIconTpl(e,t){const{eventColor:r}=e,n=!g.isNamedColor(r);return`<div class="b-icon b-icon-square${!r||n?"":` b-sch-foreground-${r}`}"${r?n?` style="color:${r}"`:"":' style="display:none"'}></div>`}}}}changeShowEventColor(e){return Boolean(e)}updateShowEventColor(e){const{_picker:t}=this,r=e?"add":"remove";this.element.classList[r]("b-show-event-color"),null==t||t.element.classList[r]("b-show-event-color")}changePicker(e,t){var r;return null===(r=e=super.changePicker(e,t))||void 0===r||r.element.classList[this.showEventColor?"add":"remove"]("b-show-event-color"),e}get innerElements(){return[{class:"b-icon b-resource-icon b-icon-square b-hide-display",reference:"resourceIcon"},this.inputElement]}syncInputFieldValue(){var e,t;const r=this,{resourceIcon:n,lastResourceIconCls:i}=r,{classList:o}=n,s=null!==(e=null===(t=r.selected)||void 0===t?void 0:t.eventColor)&&void 0!==e?e:"";super.syncInputFieldValue(),n.style.color="",i&&o.remove(i),r.lastResourceIconCls=null,s?(g.isNamedColor(s)?(r.lastResourceIconCls=`b-sch-foreground-${s}`,o.add(r.lastResourceIconCls)):n.style.color=s,o.remove("b-hide-display")):o.add("b-hide-display")}}I.initClass(),I._$name="ResourceCombo";const M=/[^\w\d]/g;class A extends(k.mixin(_,v)){static get $name(){return"EventEdit"}static get configurable(){return{triggerEvent:"eventdblclick",typeField:"eventType",eventRecord:null,readOnly:null,editorConfig:{type:"eventeditor",title:"L{EventEdit.Edit event}",closable:!0,localeClass:this,defaults:{localeClass:this},items:{nameField:{type:"text",label:"L{Name}",clearable:!0,name:"name",weight:100,required:!0},resourceField:{type:"resourcecombo",label:"L{Resource}",name:"resource",editable:!0,valueField:"id",displayField:"name",highlightExternalChange:!1,destroyStore:!0,weight:200},startDateField:{type:"date",cls:"b-inline",clearable:!1,required:!0,label:"L{Start}",name:"startDate",validateDateOnly:!0,weight:300},startTimeField:{type:"time",clearable:!1,required:!0,name:"startDate",cls:"b-match-label",weight:400},endDateField:{type:"date",cls:"b-inline",clearable:!1,required:!0,label:"L{End}",name:"endDate",validateDateOnly:!0,weight:500},endTimeField:{type:"time",clearable:!1,required:!0,name:"endDate",cls:"b-match-label",weight:600}},bbar:{hideWhenEmpty:!0,defaults:{localeClass:this},items:{saveButton:{color:"b-blue",cls:"b-raised",text:"L{Save}",weight:100},deleteButton:{text:"L{Delete}",weight:200},cancelButton:{text:"L{Object.Cancel}",weight:300}}}},targetEventElement:null}}static get pluginConfig(){return{chain:["populateEventMenu","onEventEnterKey","editEvent"]}}construct(e,t){this.readOnly=e.readOnly,super.construct(e,t),e.ion({projectChange:"onChangeProject",readOnly:"onClientReadOnlyToggle",thisObj:this})}get scheduler(){return this.client}get readOnly(){return this._editor?this.editor.readOnly:this._readOnly}updateReadOnly(e){super.updateReadOnly(e),this._editor&&(this.editor.readOnly=e)}onClientReadOnlyToggle({readOnly:e}){this.readOnly=e}get editor(){var e,t,r,n,i;const o=this,s={beforehide:"resetEditingContext",beforeshow:"onBeforeEditorShow",keydown:"onPopupKeyDown",thisObj:o};let{_editor:a}=o;return a||(a=o._editor=u.create(o.getEditorConfig()),a.floating||a.positioned||(a.element.parentNode||o.client.add(a),delete s.beforehide,delete s.beforShow,s.beforeToggleReveal="onBeforeEditorToggleReveal"),a.readOnly=o._readOnly,0===a.items.length&&console.warn("Event Editor configured without any `items`"),a.ion(s),o.scheduler.relayEvents(a,["beforeSetRecord"],"eventEdit"),Object.values(a.widgetMap).forEach((e=>{const t=e.ref||e.id;if(t&&!o[t])switch(o[t]=e,e.name){case"startDate":case"endDate":e.ion({change:"onDatesChange",thisObj:o})}})),null===(e=o.onEditorConstructed)||void 0===e||e.call(o,a),null===(t=o.eventTypeField)||void 0===t||t.ion({change:"onEventTypeChange",thisObj:o}),null===(r=o.saveButton)||void 0===r||r.ion({click:"onSaveClick",thisObj:o}),null===(n=o.deleteButton)||void 0===n||n.ion({click:"onDeleteClick",thisObj:o}),null===(i=o.cancelButton)||void 0===i||i.ion({click:"onCancelClick",thisObj:o}),a)}getEditorConfig(){const e=this,r=new Date(2e3,12,31,23,55,55),i=t.format(r,e.dateFormat).replace(M,"").length,o=t.format(r,e.timeFormat).replace(M,"").length,s=i+o,{cls:a,scheduler:l}=e,c=n.assign({owner:l,eventEditFeature:e,weekStartDay:e.weekStartDay,align:"b-t",id:`${l.id}-event-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,cls:a},e.editorConfig);return u.prototype.getRenderContext(c)[0]&&(c.floating=!1),!1!==c.floating||c.positioned||(c.collapsible={type:"overlay",direction:"right",autoClose:!1,tool:null,recollapseTool:null},c.collapsed=!0,c.hidden=c.anchor=!1,c.hide=function(){this.collapsible.toggleReveal(!1)}),c.onElementCreated=function({element:e}){e.style.setProperty("--date-time-length",`${s}em`),e.style.setProperty("--date-width-difference",(i-o)/2+"em")},c}internalShowEditor(e,t,r=null){var n,i,o;const s=this,{scheduler:a}=s,l=(null===(n=r)||void 0===n||null===(i=n.target)||void 0===i?void 0:i.nodeType)===Element.ELEMENT_NODE?r.target:a.getElementFromEventRecord(e,t),c=e.isPartOfStore(a.eventStore);if((r=null!==(o=r)&&void 0!==o?o:{target:l,anchor:!0}).target||!c||e.isCreating){var d;if(!1===a.trigger("beforeEventEdit",{eventEdit:s,eventRecord:e,resourceRecord:t,eventElement:l}))return a.element.classList.remove("b-eventeditor-editing"),!1;s.resourceRecord=t;const{editor:n}=s;s.editingContext={eventRecord:e,resourceRecord:t,eventElement:l,editor:n,isPartOfStore:c},null===(d=super.internalShowEditor)||void 0===d||d.call(this,e,t,r),s.typeField&&s.toggleEventType(e.get(s.typeField)),s.loadRecord(e,t),n.collapsed?n.setTimeout((async()=>{await n.collapsible.toggleReveal(!0),n.focus()}),100):!n.centered&&n.anchor&&n.floating?l?(s.targetEventElement=l,n.showBy(r)):(n.show(),n.updateCentered(!0)):n.show();const i=a.timeAxisViewModel.timeResolution;if("hour"===i.unit||"minute"===i.unit){const e=`${i.increment}${i.unit}`;s.startTimeField&&(s.startTimeField.step=e),s.endTimeField&&(s.endTimeField.step=e)}s.detachListeners("changesWhileEditing"),a.eventStore.ion({change:s.onChangeWhileEditing,refresh:s.onChangeWhileEditing,thisObj:s,name:"changesWhileEditing"})}}onChangeWhileEditing(){const e=this;e.isEditing&&e.editingContext.isPartOfStore&&!e.eventRecord.isPartOfStore(e.scheduler.eventStore)&&e.onCancelClick()}onBeforeEditorShow(){super.onBeforeEditorShow(...arguments),this.scheduler.trigger("beforeEventEditShow",d({eventEdit:this},this.editingContext))}updateTargetEventElement(e,t){null==e||e.classList.add("b-editing"),null==t||t.classList.remove("b-editing")}editEvent(e,t,r=null){const n=this,{simpleEventEdit:i}=n.client.features;if(n.isEditing&&n.resetEditingContext(),n.disabled||e.readOnly||e.isCreating&&null!=i&&i.enabled)return;const o=n.doEditEvent(...arguments);return n.isEditing&&n.scheduler.element.classList.add("b-eventeditor-editing"),o}get isEditing(){const{_editor:e}=this;return Boolean((null==e?void 0:e.isVisible)&&!(e.collapsed&&!e.revealed))}doEditEvent(e,t,r=null){const n=this,{scheduler:i}=n,o=e.isCreating;t||(t=e.resource||n.resourceStore.getById(e.resourceId)),o&&D.prototype.normalize.call(e),r||o?n.internalShowEditor(e,t,r?{target:r}:null):i.scrollResourceEventIntoView(t,e,{animate:!0,edgeOffset:0,extendTimeAxis:!1}).then((()=>n.internalShowEditor(e,t)),(()=>i.element.classList.remove("b-eventeditor-editing")))}loadRecord(e,t){this.loadingRecord=!0,this.internalLoadRecord(e,t),this.loadingRecord=!1}get eventRecord(){var e;return null===(e=this._editor)||void 0===e?void 0:e.record}internalLoadRecord(e,t){var r;const n=this,{eventStore:i}=n.client,{editor:o,resourceField:s}=n;if(n.resourceRecord=t,s&&(null===(r=s.store)||void 0===r?void 0:r.masterStore)!==n.resourceStore&&(s.store=o.chainResourceStore()),o.record=e,s){const r=i.assignmentStore.getResourcesForEvent(e);o.assigningValues=!0,e.isOccurrence||i.storage.includes(e,!0)||!t?n.assignmentStore&&(n.resourceField.value=r.map((e=>e[n.resourceField.valueField]))):n.resourceField.value=t[n.resourceField.valueField],o.assigningValues=!1}super.internalLoadRecord(e,t)}toggleEventType(e){this.editor.element.dataset.eventType=e||"",this.editor.eachWidget((t=>{var r;(null===(r=t.dataset)||void 0===r?void 0:r.eventType)&&(t.hidden=t.dataset.eventType!==e)}))}async finalizeEventSave(e,t,r,n){const i=this,{scheduler:o,assignmentStore:s}=i;s.suspendAutoCommit(),o.suspendRefresh(),i.onBeforeSave(e),e.beginBatch(),i.updateRecord(e),e.endBatch(),e.isOccurrence?t&&e.set("resourceRecords",t):i.resourceField&&s.assignEventToResource(e,t,null,!0),e.isCreating=!1,await o.project.commitAsync(),s.resumeAutoCommit(),o.resumeRefresh(!0),o.trigger("afterEventSave",{eventRecord:e}),i.onAfterSave(e),r(e)}save(){return new Promise(((e,r)=>{var n;const i=this,{scheduler:o,eventRecord:s}=i;if(!s||!i.editor.isValid)return void e(!1);const{eventStore:a,values:l}=i,c=(null===(n=i.resourceField)||void 0===n?void 0:n.records)||(i.resourceRecord?[i.resourceRecord]:[]);if(!i.scheduler.allowOverlap&&a){let{startDate:r,endDate:n}=l;n||(n="duration"in l?t.add(r,l.duration,l.durationUnit||s.durationUnit):"fullDuration"in l?t.add(r,l.fullDuration):s.endDate);if(c.some((e=>!a.isDateRangeAvailable(r,n,s,e))))return void e(!1)}const d={finalize(t){try{!1!==t?i.finalizeEventSave(s,c,e,r):e(!1)}catch(e){r(e)}}};!1!==o.trigger("beforeEventSave",{eventRecord:s,resourceRecords:c,values:l,context:d})?d.async||d.finalize():e(!1)}))}deleteEvent(){return this.detachListeners("changesWhileEditing"),new Promise(((e,t)=>{const{eventRecord:r,editor:n}=this;this.scheduler.removeEvents([r],(t=>{t&&n.containsFocus&&n.revertFocus(),e(t)}),n)}))}onChangeProject(){this.resourceField&&(this.resourceField.store={})}get eventStore(){return this.scheduler.project.eventStore}get resourceStore(){return this.scheduler.project.resourceStore}get assignmentStore(){return this.scheduler.project.assignmentStore}onActivateEditor({eventRecord:e,resourceRecord:t,eventElement:r}){this.editEvent(e,t,r)}onDragCreateEnd({eventRecord:e,resourceRecord:t,proxyElement:r}){this.editEvent(e,t,r)}onEventEnterKey({assignmentRecord:e,eventRecord:t,target:r}){const{client:n}=this,i=r[r.matches(n.eventSelector)?"querySelector":"closest"](n.eventInnerSelector);e?this.editEvent(t,e.resource,i):t&&this.editEvent(t,t.resource,i)}onEventTypeChange({value:e}){this.toggleEventType(e)}populateEventMenu({eventRecord:e,resourceRecord:t,items:r}){this.scheduler.readOnly||this.disabled||(r.editEvent={text:"L{EventEdit.Edit event}",localeClass:this,icon:"b-icon b-icon-edit",weight:100,disabled:e.readOnly,onItem:()=>{this.editEvent(e,t)}})}onBeforeEditorToggleReveal({reveal:e}){this[e?"onBeforeEditorShow":"resetEditingContext"]()}resetEditingContext(){this.detachListeners("changesWhileEditing"),super.resetEditingContext(),this.resourceRecord=null}}A._$name="EventEdit",C.registerFeature(A,!0,"Scheduler"),C.registerFeature(A,!1,["SchedulerPro","ResourceHistogram"]),A.initClass();class P extends m{static get $name(){return"ResourceFilter"}static get type(){return"resourcefilter"}static get delayable(){return{applyFilter:"raf"}}static get configurable(){return{eventStore:null,multiSelect:!0,toggleAllIfCtrlPressed:!0,itemTpl:e=>p.encodeHtml(e.name||""),masterFilter:()=>!0}}itemIconTpl(e,t){const{eventColor:r}=e,n=g.isNamedColor(r)?` b-sch-foreground-${r}`:"",i=!n&&r?` style="color:${r}"`:"";return this.multiSelect?`<div class="b-selected-icon b-icon${n}"${i}></div>`:""}updateEventStore(e){var t,r;const n=this,i=null!==(t=n.initialConfig.store)&&void 0!==t&&t.isStore?n.initialConfig.store.initialConfig:null===(r=n.store)||void 0===r?void 0:r.config,{resourceStore:o}=e,s=n.store=o.chain(n.masterFilter,null,d(d({},i),{},{syncOrder:!0})),a={change:"onStoreChange",thisObj:n};s.un(a),o.ion(a),o.count?n.initFilter():o.project.ion({name:"project",refresh:"initFilter",thisObj:n})}changeMasterFilter(e){const t=this;return function(r){return e.call(t,r)}}initFilter(){const{eventStore:e,selected:t}=this;e.count&&e.resourceStore.count&&(this.initialSelection||t.add(this.store.getRange()),this.detachListeners("project"))}onStoreRefresh({source:e,action:t}){if("filter"===t&&this.resourceFilter){const{resourceFilter:t}=this,{disabled:r}=t,n=!e.isFiltered&&this.allSelected;n!==r&&(t.disabled=n,this.applyFilter())}super.onStoreRefresh(...arguments)}onSelectionChange({source:e,added:t,removed:r}){const n=this,i=!n.store.isFiltered&&n.allSelected;if(super.onSelectionChange(...arguments),n.resourceFilter){if(n.resourceFilter.disabled=i,n.applyFilter(),n.eventListeners.change){const i=e.values,o=i.concat(r);E.remove(o,t),n.triggerFieldChange({value:i,oldValue:o})}}else n.resourceFilter=n.eventStore.addFilter({id:`${n.id}-filter-instance`,filterBy:e=>!e.resource||n.selected.includes(e.resources),disabled:i},t.length===n.store.count)}get value(){return this.selected.values}applyFilter(){this.eventStore.filter()}}P.initClass(),P._$name="ResourceFilter";class V extends b{static get $name(){return"SchedulerDatePicker"}static get type(){return"datepicker"}static get configurable(){return{showEvents:null,eventStore:null}}construct(e){"events"in e&&(delete(e=d(d({},e),{},{showEvents:e.events})).events,y.deprecate(y.calendar?"Calendar":"Scheduler","6.0.0","DatePicker#events should be configured as showEvents")),super.construct(e)}doRefresh(){return this.refreshEventsMap(),super.doRefresh(...arguments)}updateShowEvents(e,t){const r=this,{classList:n}=r.contentElement;let{eventStore:i}=r;if(r.requestAnimationFrame((()=>{var i;r.element.classList.toggle("b-datepicker-with-events",Boolean(e)),null===(i=r.owner)||void 0===i||i.element.classList.toggle("b-datepicker-with-events",Boolean(e)),e&&n.add(`b-show-events-${e}`),n.remove(`b-show-events-${t}`)})),e){if(!i){const e=r.up((e=>e.eventStore));if(!e)throw new Error("DatePicker configured with events but no eventStore");i=e.eventStore}}else r.eventsMap=null;r.isConfiguring||(r.updateEventStore(i),r.doRefresh())}refreshEventsMap(){const e=this;e.showEvents&&(e.eventsMap=e.eventStore.getEventCounts({startDate:e.startDate,endDate:e.endDate,dateMap:e.eventsMap}))}updateEventStore(e){var t;-1===e.findListener("change","refresh",this)&&(null==e||null===(t=e[this.showEvents?"on":"un"])||void 0===t||t.call(e,{change:"refresh",thisObj:this}))}cellRenderer({cell:e,date:r}){var n,i;const{showEvents:o}=this,s=null===(n=this.eventCounts)||void 0===n||null===(i=n.get)||void 0===i?void 0:i.call(n,t.makeKey(r)),a="count"===o;delete e.dataset.btip,s&&(!a&&this.eventCountTip&&(e.dataset.btip=this.L("L{ResourceInfoColumn.eventCountText}",s)),g.createElement({dataset:{count:s},class:{[a?"b-cell-events-badge":"b-icon b-icon-circle"]:1,[V.getEventCountClass(s)]:1},parent:e,[a?"text":""]:s}))}static getEventCountClass(e){return e?e<4?"b-datepicker-1-to-3-events":e<7?"b-datepicker-4-to-6-events":"b-calendar-7-or-more-events":""}static setupClass(e){e.replaceType=!0,super.setupClass(e)}}V.initClass(),V._$name="SchedulerDatePicker";export{k as EditBase,A as EventEdit,x as EventEditor,B as RecurrenceCombo,$ as RecurrenceEditor,w as RecurrenceLegend,j as RecurrenceLegendButton,_ as RecurringEventEdit,I as ResourceCombo,P as ResourceFilter,V as SchedulerDatePicker};
//# sourceMappingURL=SchedulerDatePicker.js.map
