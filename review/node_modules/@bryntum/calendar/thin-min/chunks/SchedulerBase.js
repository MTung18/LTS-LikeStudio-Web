/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{_objectSpread2 as e,_defineProperty as t,Base as r,InstancePlugin as n,Popup as s,ObjectHelper as i,Rectangle as o,Duration as a,Delayable as l,DomHelper as c,EventHelper as d,DateHelper as u,DomSync as h,StringHelper as g,VersionHelper as m,DomClassList as v,BrowserHelper as p,Store as f,GlobalEvents as R,ArrayHelper as E,Model as y}from"./Editor.js";import{AttachToProjectMixin as C,ProjectConsumer as S,SchedulerEventNavigation as D,CurrentConfig as b}from"./EventNavigation.js";import{ColumnStore as w,Column as x,GridFeatureManager as T}from"./GridBase.js";import"./MessageDialog.js";import{DependencyModel as A,TimeSpan as M,CrudManagerView as I}from"./ProjectModel.js";import{TimeAxisBase as O,DragBase as F,DragCreateBase as L,TooltipBase as k,AbstractTimeRanges as P,TimelineBase as B}from"./TimelineBase.js";import{PackMixin as j,Describable as z,SchedulerEventSelection as W,CrudManager as V}from"./EventSelection.js";import"./RegionResize.js";class H extends O{static get $name(){return"VerticalTimeAxis"}static get configurable(){return{cls:"b-verticaltimeaxis",sizeProperty:"height",positionProperty:"top",wrapText:!0}}buildHorizontalCells(){const t=this,{client:r}=t,n=null==r?void 0:r.stickyHeaders,s=[],i=t.levels.reduce(((r,s,i)=>{var o;s.cells&&r.push(...null===(o=s.cells)||void 0===o?void 0:o.filter((e=>e.start<t.endDate&&e.end>t.startDate)).map(((r,s,o)=>({role:"presentation",className:{"b-sch-header-timeaxis-cell":1,[r.headerCellCls]:r.headerCellCls,[`b-align-${r.align}`]:r.align,"b-last":s===o.length-1,"b-lowest":i===t.levels.length-1},dataset:e({tickIndex:r.index,cellId:`${i}-${r.index}`,headerPosition:i},globalThis.DEBUG&&{date:r.start.getTime()}),style:{top:r.coord,height:r.width,minHeight:r.width},children:[{role:"presentation",className:{"b-sch-header-text":1,"b-sticky-header":n},html:r.value}]}))));return r}),[]);return null==r||r.getHeaderDomConfigs(s),i.push(...s),{className:t.widgetClassList,dataset:{headerFeature:"headerRow0",headerPosition:0},syncOptions:{releaseThreshold:5,syncIdField:"cellId"},children:i}}get height(){return this.size}}H._$name="VerticalTimeAxis";class $ extends x{static get type(){return"verticalTimeAxis"}static get defaults(){return{draggable:!1,groupable:!1,hideable:!1,showColumnPicker:!1,filterable:!1,sortable:!1,searchable:!1,editor:!1,enableCellContextMenu:!1,tooltipRenderer:!1,minWidth:0,resizable:!1,cellCls:"b-verticaltimeaxiscolumn",flex:1,alwaysClearCell:!1}}get isFocusable(){return!1}construct(e){super.construct(...arguments),this.view=new H({model:this.grid.timeAxisViewModel,client:this.grid})}renderer({cellElement:e,size:t}){this.view.render(e),t.height=this.view.height}getCurrentConfig(e){const t=super.getCurrentConfig(e);return delete t.id,delete t.region,delete t.type,delete t.field,delete t.ariaLabel,delete t.cellAriaLabel,t}}t($,"$name","VerticalTimeAxisColumn"),w.registerColumnType($),$._$name="VerticalTimeAxisColumn";class N extends r{static get defaultConfig(){return{nbrOfBandsByResource:{},bandIndexToPxConvertFn:null,bandIndexToPxConvertThisObj:null}}clearCache(e){e?delete this.nbrOfBandsByResource[e.id]:this.nbrOfBandsByResource={}}applyLayout(e,t){return this.nbrOfBandsByResource[t.id]=this.layoutEventsInBands(e)}layoutEventsInBands(e){throw new Error("Implement in subclass")}}N._$name="HorizontalLayout";class U extends(N.mixin(j)){static get $name(){return"HorizontalLayoutPack"}static get configurable(){return{type:"pack"}}layoutEventsInBands(e){const t=this.packEventsInBands(e,((e,t,r,n)=>{e.height=n,e.top=r.start+t*n}));return e.forEach((e=>{Object.assign(e,this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertThisObj||this,e.top,e.height,e.eventRecord,e.resourceRecord))})),t}}U._$name="HorizontalLayoutPack";class _ extends N{static get $name(){return"HorizontalLayoutStack"}static get configurable(){return{type:"stack"}}layoutEventsInBands(e,t=!1){let r=0;do{let n=0,s=e[0];for(;s;)t||(s.top=this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertThisObj||this,r,s.eventRecord,s.resourceRecord)),e.splice(n,1),n=this.findClosestSuccessor(s,e),s=e[n];r++}while(e.length>0);return r}findClosestSuccessor(e,t){const{endMS:r,group:n}=e,s=e.eventRecord&&0===e.eventRecord.duration;let i,o,a,l=1/0;for(let e=0,c=t.length;e<c;e++)if(a=t[e],o=a.startMS-r,o>=0&&o<l&&(o>0||a.endMS-a.startMS>0||!s)){if(this.grouped&&n!==a.group)break;i=e,l=o}return i}}_._$name="HorizontalLayoutStack";class G extends(n.mixin(C)){static get pluginConfig(){return{chain:["getEventsToRender","onEventDataGenerated","noFeatureElementsInAxis"],override:["resolveResourceRecord"]}}noFeatureElementsInAxis(){const{timeAxis:e}=this.client;return!this.needsRefresh&&this.store&&!this.store.storage.values.some((t=>e.isTimeSpanInAxis(t)))}doDisable(e){this.client.isPainted&&this.client.refresh(),super.doDisable(e)}updateTabIndex(){this.isConfiguring||this.client.refresh()}getEventsToRender(e,t){throw new Error("Implement in subclass")}onEventDataGenerated(e){const t=this,{eventRecord:r,iconCls:n}=e;t.shouldInclude(r)&&(t.client.isVertical?e.width=e.resourceRecord.columnWidth||t.client.resourceColumnWidth:e.top=0,e.fillSize=!0,e.wrapperCls[t.rangeCls]=1,e.wrapperCls[`b-sch-color-${r.timeRangeColor}`]=r.timeRangeColor,e.eventContent.text=r.name,e.children.push(e.eventContent),e.tabIndex=null!=t.tabIndex?String(t.tabIndex):null,(null==n?void 0:n.length)>0&&e.children.unshift({tag:"i",className:n.toString()}),e.eventId=t.generateElementId(r))}generateElementId(e){return e.domId}resolveResourceTimeRangeRecord(e){var t;return null==e||null===(t=e.closest(`.${this.rangeCls}`))||void 0===t?void 0:t.elementData.eventRecord}getElementFromResourceTimeRangeRecord(e){return this.client.foregroundCanvas.syncIdMap[e.domId]}resolveResourceRecord(e){var t;return this.overridden.resolveResourceRecord(...arguments)||(null===(t=this.resolveResourceTimeRangeRecord(e.target||e))||void 0===t?void 0:t.resource)}shouldInclude(e){throw new Error("Implement in subclass")}onStoreChange(e){"removeall"!==e.action&&"dataset"!==e.action||(this.needsRefresh=!0),this.client.onInternalEventStoreChange(e),this.needsRefresh=!1}}t(G,"configurable",{tabIndex:null}),G.featureClass="",G._$name="ResourceTimeRangesBase";class Y extends s{static get $name(){return"DependencyEditor"}static get defaultConfig(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible"}}processWidgetConfig(e){const{dependencyEditFeature:t}=this;return!("lagField"===e.ref&&!t.showLagField)&&(!("deleteButton"===e.ref&&!t.showDeleteButton)&&super.processWidgetConfig(e))}afterShow(...e){const{deleteButton:t}=this.widgetMap;t&&(t.hidden=!this.record.isPartOfStore()),super.afterShow(...e)}onInternalKeyDown(e){this.trigger("keyDown",{event:e}),super.onInternalKeyDown(e)}}Y._$name="DependencyEditor";class K extends n{static get $name(){return"DependencyEdit"}static get configurable(){return{autoClose:!0,saveAndCloseOnEnter:!0,showDeleteButton:!0,triggerEvent:"dependencydblclick",showLagField:!1,dependencyRecord:null,editorConfig:{title:"L{Edit dependency}",localeClass:this,closable:!0,defaults:{localeClass:this},items:{fromNameField:{type:"display",weight:100,label:"L{From}"},toNameField:{type:"display",weight:200,label:"L{To}"},typeField:{type:"combo",weight:300,label:"L{Type}",name:"type",editable:!1,valueField:"id",displayField:"name",localizeDisplayFields:!0,buildItems:function(){const e=this.parent;return Object.keys(A.Type).map((t=>({id:A.Type[t],name:e.L(t),localeKey:t})))}},lagField:{type:"duration",weight:400,label:"L{Lag}",name:"lag",allowNegative:!0}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler"},saveButton:{color:"b-green",text:"L{Save}"},deleteButton:{color:"b-gray",text:"L{Delete}"},cancelButton:{color:"b-gray",text:"L{Object.Cancel}"}}}}}}construct(e,t){const r=this;if(e.dependencyEdit=r,super.construct(e,t),!e.features.dependencies)throw new Error("Dependencies feature required when using DependencyEdit");r.clientListenersDetacher=e.ion({[r.triggerEvent]:r.onActivateEditor,thisObj:r})}doDestroy(){var e;this.clientListenersDetacher(),null===(e=this.editor)||void 0===e||e.destroy(),super.doDestroy()}changeEditorConfig(e){const{autoClose:t,cls:r,client:n}=this;return i.assign({owner:n,align:"b-t",id:`${n.id}-dependency-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",clippedBy:[n.timeAxisSubGridElement,n.bodyContainer],constrainTo:globalThis,autoClose:t,cls:r},e)}get isValid(){return Object.values(this.editor.widgetMap).every((e=>!(e.name&&!e.hidden)||!1!==e.isValid))}get values(){const e={};return this.editor.eachWidget((t=>{t.name&&!t.hidden&&(e[t.name]=t.value)}),!0),e}onBeforeSave(e){}onAfterSave(e){}updateRecord(e){const{values:t}=this;t.lag&&(t.lagUnit=t.lag.unit,t.lag=t.lag.magnitude),"type"in t&&(null!=e.fromSide&&(t.fromSide=null),null!=e.toSide&&(t.toSide=null)),i.cleanupProperties(t,!0),e.set(t)}onPopupKeyDown({event:e}){"Enter"===e.key&&this.saveAndCloseOnEnter&&"input"===e.target.tagName.toLowerCase()&&(e.preventDefault(),this.onSaveClick())}onSaveClick(){this.save()&&this.editor.hide()}onDeleteClick(){this.deleteDependency(),this.editor.hide()}onCancelClick(){this.editor.hide()}internalShowEditor(e){const t=this,{client:r}=t;let n=t.lastPointerDownCoordinate;if(!1===r.trigger("beforeDependencyEdit",{dependencyEdit:t,dependencyRecord:e}))return;const s=t.getEditor(e);if(t.loadRecord(e),r.trigger("beforeDependencyEditShow",{dependencyEdit:t,dependencyRecord:e,editor:s}),!n){const e=o.from(t.client.element).center;n=[e.x-s.width/2,e.y-s.height/2]}s.showBy(n)}editDependency(e){this.client.readOnly||e.readOnly||this.internalShowEditor(e)}getEditor(){var e,t,r;const n=this;let{editor:s}=n;return s||(s=n.editor=Y.new({dependencyEditFeature:n,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,autoClose:n.autoClose,cls:n.cls,rootElement:n.client.rootElement,internalListeners:{keydown:n.onPopupKeyDown,thisObj:n}},n.editorConfig),0===s.items.length&&console.warn("Editor configured without any `items`"),s.eachWidget((e=>{const t=e.ref||e.id;t&&!n[t]&&(n[t]=e)})),null===(e=n.saveButton)||void 0===e||e.ion({click:"onSaveClick",thisObj:n}),null===(t=n.deleteButton)||void 0===t||t.ion({click:"onDeleteClick",thisObj:n}),null===(r=n.cancelButton)||void 0===r||r.ion({click:"onCancelClick",thisObj:n}),n.editor)}loadRecord(e){const t=this;t.fromNameField.value=e.fromEvent.name,t.toNameField.value=e.toEvent.name,t.lagField&&(t.lagField.value=new a(e.lag,e.lagUnit)),t.editor.record=t.dependencyRecord=e}async save(){const e=this,{client:t,dependencyRecord:r}=e;if(!r||!e.isValid)return;const{dependencyStore:n,values:s}=e;if(!1!==t.trigger("beforeDependencySave",{dependencyRecord:r,values:s})){var i;if(e.onBeforeSave(r),e.updateRecord(r),n&&!r.stores.length){if(!1===t.trigger("beforeDependencyAdd",{dependencyRecord:r,dependencyEdit:e}))return;n.add(r)}await(null===(i=t.project)||void 0===i?void 0:i.commitAsync()),t.trigger("afterDependencySave",{dependencyRecord:r}),e.onAfterSave(r)}return r}async deleteDependency(){const{client:e,editor:t,dependencyRecord:r}=this;var n;return!1!==e.trigger("beforeDependencyDelete",{dependencyRecord:r})&&(t.containsFocus&&t.revertFocus(),e.dependencyStore.remove(r),await(null===(n=e.project)||void 0===n?void 0:n.commitAsync()),!0)}get dependencyStore(){return this.client.dependencyStore}onActivateEditor({dependency:e,event:t}){this.disabled||(this.lastPointerDownCoordinate=[t.clientX,t.clientY],this.editDependency(e))}}K._$name="DependencyEdit",T.registerFeature(K,!1);class X extends(n.mixin(l)){static get $name(){return"ScheduleContext"}construct(t,r){super.construct(t,r);const{triggerEvent:n}=this,s={datachange:"syncContextElement",timeaxisviewmodelupdate:"onTimeAxisViewModelUpdate",presetchange:"clearContext",thisObj:this};"mouseover"===n?s.timelineContextChange="onTimelineContextChange":("click"!==n&&"mousedown"!==n||(s.schedulecontextmenu="onScheduleContextGesture"),Object.assign(s,e({[`schedule${n}`]:"onScheduleContextGesture",[`event${n}`]:"onScheduleContextGesture"},s))),t.useBackgroundCanvas=!0,t.ion(s),t.rowManager.ion({rowheight:"syncContextElement",thisObj:this})}changeTriggerEvent(e){return"hover"!==e&&"mousemove"!==e||(e="mouseover"),e}get element(){return this._element||(this._element=c.createElement({parent:this.client.backgroundCanvas,className:"b-schedule-selected-tick"}))}onTimelineContextChange({context:e}){this.context=e}onScheduleContextGesture(e){this.context=e}onTimeAxisViewModelUpdate({source:e}){var t;e.timeAxis.includes(null===(t=this.context)||void 0===t?void 0:t.tick)?this.syncContextElement():this.clearContext()}clearContext(){this.context=null}updateContext(e,t){this.syncContextElement()}syncContextElement(){if(this.context&&this.enabled){const e=this,{client:t,element:r,context:n,renderer:s}=e,{isVertical:i}=t,{style:o}=r,a=i?t.rowManager.rows[0]:t.getRowFor(n.resourceRecord);if(a){const{tickStartDate:l,tickEndDate:d,resourceRecord:u}=n,h=t.currentOrientation.getTimeSpanRenderData({startDate:l,endDate:d,startDateMS:l.getTime(),endDateMS:d.getTime()},u);let g,m,v;i?(g=h.top,m=h.resourceWidth,v=h.height):(g=a.top,m=h.width,v=a.height),o.display="",o.width=`${m}px`,o.height=`${v}px`,c.setTranslateXY(r,h.left,g),n.index=a.index,r.innerHTML="",s&&e.callback(s,e,[n,r])}else o.display="none"}else this.element.style.display="none"}}t(X,"delayable",{syncContextElement:"raf"}),t(X,"configurable",{triggerEvent:"click",renderer:null,context:{$config:{equal:(e,t)=>(null==e?void 0:e.index)===(null==t?void 0:t.index)&&(null==e?void 0:e.tickParentIndex)===(null==t?void 0:t.tickParentIndex)&&!(((null==e?void 0:e.tickStartDate)||0)-((null==t?void 0:t.tickStartDate)||0))}}}),X.featureClass="b-scheduler-context",X._$name="ScheduleContext",T.registerFeature(X,!1,["Scheduler"]);class q extends n{constructor(...e){super(...e),t(this,"clipboardRecords",[]),t(this,"entityName","event")}construct(e,t){super.construct(e,t),e.ion({eventclick:this.onEventClick,scheduleclick:this.onScheduleClick,projectChange:()=>{this.clearClipboard(),this._cellClickedContext=null},thisObj:this}),this.scheduler=e}onEventDataGenerated(e){const{assignmentRecord:t}=e;t&&(e.cls["b-cut-item"]=t.meta.isCut)}onEventClick(e){this._cellClickedContext=null}onScheduleClick(e){this._cellClickedContext=e}isActionAvailable(e,t,r){var n;const s=this.client.features.cellEdit;return!this.disabled&&0===globalThis.getSelection().toString().length&&!(null!=s&&s.isEditing)&&Boolean(r.target.closest(".b-timeaxissubgrid"))&&!(null!==(n=this.client.focusedCell)&&void 0!==n&&n.isSpecialRow)}copy(){this.copyEvents()}cut(){this.copyEvents(void 0,!0)}paste(){this.pasteEvents()}copyEvents(e=this.scheduler.selectedAssignments,t=!1){const r=this,{scheduler:n,entityName:s}=r;if(null==e||!e.length)return;let i=e.slice();e[0].isEventModel&&(i=e.map((e=>e.assignments)).flat()),t&&(i=i.filter((e=>!e.event.readOnly)));const o=i.map((e=>e.event));i.length&&!n.readOnly&&!1!==n.trigger("beforeCopy",{assignmentRecords:i,records:o,eventRecords:o,isCut:t,entityName:s})&&(i.length>0&&n.trigger("copy",{assignmentRecords:i,eventRecords:o,isCut:t,entityName:s}),r._isCut=t,r.clipboard={assignmentRecords:i,eventRecords:o},n.assignmentStore.forEach((e=>{e.meta.isCut=t&&i.includes(e)})),n.refreshWithTransition())}pasteEvents(e,t){const r=this,{clipboard:n,scheduler:s,entityName:i}=r,{assignmentRecords:o,eventRecords:a}=n,l=r._isCut;if(0===arguments.length){const n=r._cellClickedContext||{};e=n.date,t=n.resourceRecord}if(t){if(t.readOnly)return;t=t.$original}if(!n||!1===s.trigger("beforePaste",{assignmentRecords:o,records:a,eventRecords:a,resourceRecord:t||o[0].resource,date:e,isCut:l,entityName:i}))return;let c=null;const d=new Set;for(const n of o){let{event:i}=n;const o=t||n.resource,a=e||n.event.startDate;if(d.has(i))l&&n.remove();else{if(d.add(i),l)n.meta.isCut=!1,n.resource=o,c=n;else if(s.eventStore.usesSingleAssignment||"clone"===r.copyPasteAction)i=i.copy(),i.name=r.generateNewName(i),s.eventStore.add(i),i.assign(o),c=s.assignmentStore.last;else if(!i.resources.includes(o)){const e=n.copy();e.resource=o,[c]=s.assignmentStore.add(e)}i.startDate=a,i.constraintDate&&(i.constraintDate=null)}}n&&s.trigger("paste",{assignmentRecords:o,eventRecords:a,resourceRecord:t,date:e,isCut:l,entityName:i});const u=s.ion({renderEvent({assignmentRecord:e}){e===c&&(s.navigateTo(e,{scrollIntoView:!1}),u())}});l&&r.clearClipboard()}clearClipboard(){const e=this;e._isCut&&(e.clipboard.assignmentRecords.forEach((e=>{e.meta.isCut=!1})),e.scheduler.refreshWithTransition(),e._isCut=!1),e.clipboard=null}populateEventMenu({assignmentRecord:e,items:t}){const r=this;r.scheduler.readOnly||(t.copyEvent={text:"L{copyEvent}",localeClass:r,icon:"b-icon b-icon-copy",weight:110,onItem:()=>r.copyEvents([e].concat(r.scheduler.selectedAssignments.filter((t=>t!==e))))},t.cutEvent={text:"L{cutEvent}",localeClass:r,icon:"b-icon b-icon-cut",weight:120,disabled:e.event.readOnly,onItem:()=>r.copyEvents([e].concat(r.scheduler.selectedAssignments.filter((t=>t!==e))),!0)})}populateScheduleMenu({items:e,resourceRecord:t}){const r=this,{scheduler:n}=r;!n.readOnly&&r.clipboard&&(e.pasteEvent={text:"L{pasteEvent}",localeClass:r,icon:"b-icon b-icon-paste",disabled:0===n.resourceStore.count||t.readOnly,weight:110,onItem:({date:e,resourceRecord:t})=>r.pasteEvents(e,t,n.getRowFor(t))})}generateNewName(e){const t=e[this.nameField];let r=2;for(;this.client.eventStore.findRecord(this.nameField,`${t} - ${r}`);)r++;return`${t} - ${r}`}}t(q,"$name","EventCopyPaste"),t(q,"pluginConfig",{assign:["copyEvents","pasteEvents"],chain:["populateEventMenu","populateScheduleMenu","onEventDataGenerated"]}),t(q,"configurable",{nameField:"name",keyMap:{"Ctrl+C":"copy","Ctrl+X":"cut","Ctrl+V":"paste"},copyPasteAction:"clone"}),q.featureClass="b-event-copypaste",q._$name="EventCopyPaste",T.registerFeature(q,!0,"Scheduler");class Z extends F{static get $name(){return"EventDrag"}static get configurable(){return{constrainDragToResource:!1,constrainDragToTimeSlot:!1,externalDropTargetSelector:null,validatorFn:()=>{},validatorFnThisObj:null,unifiedDrag:null,snapToPosition:null,copyKey:"SHIFT",copyMode:"auto",mode:"move",capitalizedEventName:null}}afterConstruct(){this.capitalizedEventName=this.capitalizedEventName||this.client.capitalizedEventName,super.afterConstruct(...arguments)}changeMode(e){const{dragData:t,copyMode:r}=this;if(("event"===r||"auto"===r||"assignment"===r&&!this.scheduler.eventStore.usesSingleAssignment)&&(!t||t.eventRecords.every((e=>!e.isRecurring))))return e}updateMode(e){this.dragData&&("copy"===e?this.setCopying():this.setMoving(),this.client.trigger("eventDragModeChange",{mode:e}))}setCopying(){const{dragData:e}=this;e&&(e.eventBarCopies.some((e=>e.isConnected))?e.eventBarCopies.forEach((e=>{e.classList.remove("b-hidden")})):e.eventBarCopies.forEach((t=>{t.classList.add("b-drag-proxy-copy"),t.classList.remove("b-hidden"),e.context.grabbedParent.appendChild(t),t.retainElement=!0})))}setMoving(){const{dragData:e}=this;e&&e.eventBarCopies.forEach((e=>{e.classList.add("b-hidden")}))}get scheduler(){return this.client}onAfterDragStart(e){const t=this,{context:{element:r}}=e;super.onAfterDragStart(e),t.handleKeyDownOrMove(e.event),t.keyEventDetacher=d.on({element:c.getRootElement(r),keydown:t.handleKeyDownOrMove,keyup:t.handleKeyUp,thisObj:t})}onDragReset(e){var t;super.onDragReset(e),null===(t=this.keyEventDetacher)||void 0===t||t.call(this),this.mode="move"}onDrop(e){var t;return null===(t=this.dragData.eventBarCopies)||void 0===t||t.forEach((e=>e.remove())),super.onDrop(e)}getDraggableElement(e){return null==e?void 0:e.closest(this.drag.targetSelector)}resolveEventRecord(e,t=this.client){return t.resolveEventRecord(e)}isElementDraggable(e,t){var r;const n=this,{client:s}=n,i=n.getDraggableElement(e);if(!i||n.disabled||s.readOnly)return!1;if(e.matches('[class$="-handle"]'))return!1;const o=n.resolveEventRecord(i,s);if(!o||!o.isDraggable||o.readOnly)return!1;return!(!1===(null===(r=s[`is${n.capitalizedEventName}ElementDraggable`])||void 0===r?void 0:r.call(s,i,o,e,t)))}getTriggerParams(e){const{assignmentRecords:t,eventRecords:r,resourceRecord:n,browserEvent:s}=e;return{context:e,eventRecords:r,resourceRecord:n,assignmentRecords:t,event:s,domEvent:s}}triggerBeforeEventDrag(e,t){return this.client.trigger(e,t)}triggerEventDrag(e,t){this.client.trigger("eventDrag",Object.assign(this.getTriggerParams(e),{startDate:e.startDate,endDate:e.endDate,newResource:e.newResource}))}triggerDragStart(e){this.client.navigator.skipNextClick=!0,this.client.trigger("eventDragStart",this.getTriggerParams(e))}triggerDragAbort(e){this.client.trigger("eventDragAbort",this.getTriggerParams(e))}triggerDragAbortFinalized(e){this.client.trigger("eventDragAbortFinalized",this.getTriggerParams(e))}triggerAfterDrop(e,t){const r=this;if(r.currentOverClient.trigger("afterEventDrop",Object.assign(r.getTriggerParams(e),{valid:t})),!t){const{assignmentStore:e,eventStore:t}=r.client;r.dragData.initialAssignmentsState.find((({resource:n,assignment:s},i)=>{var o;return!e.includes(s)||!t.includes(s.event)||n.id!==(null===(o=r.dragData.assignmentRecords[i])||void 0===o?void 0:o.resourceId)}))&&r.client.refresh()}r.client.setTimeout((()=>r.client.navigator.skipNextClick=!1),10)}handleKeyDownOrMove(e){"copy"!==this.mode&&(e.key&&d.specialKeyFromEventKey(e.key)===this.copyKey.toLowerCase()||e[`${this.copyKey.toLowerCase()}Key`])&&(this.mode="copy")}handleKeyUp(e){d.specialKeyFromEventKey(e.key)===this.copyKey.toLowerCase()&&(this.mode="move")}isValidDrop(e){const{newResource:t,resourceRecord:r}=e,n=e.draggedEntities[0];return t?!t.isSpecialRow&&!t.readOnly&&(r===t||!n.event.resources.includes(t)):!(this.constrainDragToTimeline||!this.externalDropTargetSelector)&&Boolean(e.browserEvent.target.closest(this.externalDropTargetSelector))}checkDragValidity(e,t){var r;const n=this,s=n.currentOverClient;let i;if(null!==(r=e.newResource)&&void 0!==r&&r.readOnly)return!1;var o,a;(i=s.allowOverlap||s.isDateRangeAvailable(e.startDate,e.endDate,e.draggedEntities[0],e.newResource)?n.validatorFn.call(n.validatorFnThisObj||n,e,t):{valid:!1,message:n.L("L{eventOverlapsExisting}")},!i||i.valid)&&(i=null!==(o=null===(a=s.checkEventDragValidity)||void 0===a?void 0:a.call(s,e,t))&&void 0!==o?o:i);return i}async updateRecords(e){const t=this,r=t.client,n=t.currentOverClient,s="copy"===t.mode;let i;return e.externalDropTarget||(r.eventStore.suspendAutoCommit(),n.eventStore.suspendAutoCommit(),i=await t.updateAssignments(r,n,e,s),r.eventStore.resumeAutoCommit(),n.eventStore.resumeAutoCommit()),n.trigger("eventDrop",Object.assign(t.getTriggerParams(e),{isCopy:s,copyMode:t.copyMode,domEvent:e.browserEvent,targetEventRecord:e.targetEventRecord,targetResourceRecord:e.newResource,externalDropTarget:e.externalDropTarget})),i}async updateAssignments(t,r,n,s){const i=this,{copyMode:a}=i,l=t!==r,{isVertical:d}=r,{assignmentStore:g,eventStore:m}=t,{assignmentStore:v,eventStore:p}=r,f=t.isVertical?t.resourceStore:t.store,R=d?r.resourceStore:r.store,{eventRecords:E,assignmentRecords:y,timeDiff:C,initialAssignmentsState:S,resourceRecord:D,newResource:b}=n,{unifiedDrag:w}=i,x=p.usesSingleAssignment||!1!==p.usesSingleAssignment&&m.usesSingleAssignment,T=i.adjustStartDate(y[0].event.startDate,C),A=[],M=[],I=[],O=[],F=[],L=new Set,k=f.getAllDataRecords();t.suspendRefresh(),r.suspendRefresh();let P,B=!1,j=!1;P=l?R.indexOf(b)-f.indexOf(D):i.constainDragToResource?0:d&&R.isGrouped?k.indexOf(D)-k.indexOf(b):f.indexOf(D)-f.indexOf(b),d&&E.forEach(((e,r)=>{const s=n.eventBarEls[r];delete e.instanceMeta(t).hasTemporaryDragElement,s.dataset.transient&&s.remove()}));const z=n.eventBarEls.slice(),W=[],V={};for(let t=0;t<y.length;t++){const o=y[t];let c,h=o.event;if(s?(c=o.copy(),V[o.id]=c):c=o,!(c.isOccurrenceAssignment||g.includes(o)&&m.includes(h))){z[t].remove(),z.splice(t,1),y.splice(t,1),t--;continue}const E=S[t],D=h,$=E.startDate,N=E.resource,U=this.constrainDragToTimeSlot?$:w?T:i.adjustStartDate($,C);if(g!==v){const t=D.assignments.length>1||s;let r;s?r=c:(r=c.copy(),V[c.id]=r),r.event&&!x&&(r.event=r.event.id,r.resource=r.resource.id),s||O.push(c),t||M.push(D),(s&&("event"===a||"auto"===a&&p.usesSingleAssignment)||!p.getById(D.id))&&(h=p.createRecord(e(e({},D.data),{},{id:!s||"event"!==a&&"auto"!==a?D.id:void 0,calendar:null})),r.set({eventId:h.id,event:h}),A.push(h)),x||I.push(r),c=r}let _=b,G=null;if(!w)if(l){if(t>0){const e=f.indexOf(N);_=R.getAt(e+P)||_}}else if(0!==P){var H;let e;d&&R.isGrouped?(e=Math.max(Math.min(k.indexOf(N)-P,k.length-1),0),_=k[e]):(e=Math.max(Math.min(f.indexOf(N)-P,f.count-1),0),_=f.getAt(e),_.isSpecialRow&&(_=f.getNext(_,!1,!0)||f.getPrevious(_,!1,!0))),_=null===(H=_)||void 0===H?void 0:H.$original}else _=N;if(c.resourceId!==_.id?(G=f.getById(c.resourceId),s&&g===v?(c.resource=_,c.event=p.getById(c.eventId),("event"===a||m.usesSingleAssignment&&"auto"===a)&&(h=h.copy(),c.event=h,p.usesSingleAssignment&&(h.resource=_,h.resourceId=_.id)),v.find((e=>e.eventId===c.eventId&&e.resourceId===c.resourceId))||I.find((e=>e.eventId===c.eventId&&e.resourceId===c.resourceId))||(A.push(h),I.push(c))):c.resource=_,h.isEvent&&L.add(h),B=!0,h.isOccurrence&&h.set("newResource",_),l&&x&&(h.resourceId=_.id)):s&&("event"===a||"auto"===a&&m.usesSingleAssignment)&&!A.includes(h)&&(h=h.copy(),A.push(h),c.event=h,p.usesSingleAssignment&&h.set({resource:_,resourceId:_.id}),I.push(c)),!F.find((e=>e.draggedEvent===h))&&!u.isEqual(h.startDate,U)){for(;!h.isOccurrence&&h.isBatchUpdating;)h.endBatch(!0);h.startDate=U,F.push({draggedEvent:h,originalStartDate:$}),h.isEvent&&L.add(h),j=!0}r.processEventDrop({eventRecord:h,resourceRecord:_,element:0===t?n.context.element:n.context.relatedElements[t-1],context:n,toScheduler:r,reassignedFrom:G,eventsToAdd:A,addedEvents:W,draggedAssignment:c}),r.trigger("processEventDrop",{originalAssignment:o,draggedAssignment:c,context:n,copyMode:a,isCopy:s})}if(g.remove(O),m.remove(M),v.add(I),s&&g===v){const{syncIdMap:e}=t.foregroundCanvas;Object.entries(V).forEach((([t,r])=>{const n=e[t];delete e[t],e[r.id]=n}))}if(A.length&&W.push(...p.add(A)),!i.constrainDragToTimeline)for(let e=0;e<y.length;e++){const t=(V[y[e].id]||y[e]).event,i=(null==W?void 0:W.find((e=>e.id===t.id)))||t,a=n.eventBarEls[e],u=0===e?n.context.element:n.context.relatedElements[e-1],g=r.isInTimeAxis(i);if(s||h.removeChild(a.parentElement,a),i.resource&&(d||r.rowManager.getRowFor(i.resource))&&g){if(!i.parent||i.parent.isRoot){const e=o.from(u,r.foregroundCanvas,!0);c.setTopLeft(u,e.y,e.x),h.addChild(r.foregroundCanvas,u,i.assignments[0].id),l&&r.processCrossSchedulerEventDrop({eventRecord:i,toScheduler:r})}u.classList.remove("b-sch-event-hover","b-active","b-drag-proxy","b-dragging"),u.retainElement=!1}}null==W||W.forEach((e=>L.add(e))),(O.length||M.length||I.length||A.length)&&(B=!0),(B||j)&&(x&&L.forEach((e=>e.beginBatch())),await Promise.all([r.project!==t.project?r.project.commitAsync():null,t.project.commitAsync()]),x&&L.forEach((e=>e.endBatch(!1,!0)))),B||(B=F.some((({draggedEvent:e,originalStartDate:t})=>!u.isEqual(e.startDate,t)))),r.resumeRefresh(),t.resumeRefresh(),y.length>0&&(B?(r.fillTicks&&z.forEach((e=>delete e.lastDomConfig)),r.refreshWithTransition(),l&&(t.refreshWithTransition(),r.selectedEvents=W)):n.valid=!1)}getProductDragContext(e){const t=this,{currentOverClient:r}=t,n=e.browserEvent.target,s=e.newResource||e.resourceRecord,i=e.targetEventRecord;let o,a,l=r?t.resolveEventRecord(n,r):null;e.eventRecords.includes(l)&&(l=null),t.constrainDragToResource?o=e.resourceRecord:t.constrainDragToTimeline?r&&(o=t.resolveResource()||e.newResource||e.resourceRecord):o=t.resolveResource();const{assignmentRecords:c,eventRecords:d}=e,u=s!==o;let h=Boolean(o&&!o.isSpecialRow);return!o&&t.externalDropTargetSelector&&(a=n.closest(t.externalDropTargetSelector),h=Boolean(a)),{valid:h,externalDropTarget:a,eventRecords:d,assignmentRecords:c,newResource:o,targetEventRecord:l,dirty:u||l!==i,proxyElements:[e.context.element,...e.context.relatedElements||[]]}}getMinimalDragData(e){const t=this,{scheduler:r}=t,n=t.getElementFromContext(e),s=t.resolveEventRecord(n,r),i=r.resolveResourceRecord(n),o=r.resolveAssignmentRecord(n),a=o?[o]:[];o&&(r.isAssignmentSelected(a[0])||t.drag.startEvent.ctrlKey)&&a.push.apply(a,t.getRelatedRecords(o));return{eventRecord:s,resourceRecord:i,assignmentRecord:o,eventRecords:[...new Set(a.map((e=>e.event)))],assignmentRecords:a}}setupProductDragData(e){var t;const r=this,{scheduler:n}=r,s=r.getElementFromContext(e),{eventRecord:i,resourceRecord:a,assignmentRecord:l,assignmentRecords:c}=r.getMinimalDragData(e),d=[];if(r.constrainDragToResource&&!a)throw new Error("Resource could not be resolved for event: "+i.id);let u;if(r.constrainDragToTimeline){var h;u=null===(h=r.getDateConstraints)||void 0===h?void 0:h.call(r,a,i);const e=r.constrainRectangle=r.getConstrainingRectangle(u,a,i),t=o.from(s,n.timeAxisSubGridElement);super.setupConstraints(e,t,n.timeAxisViewModel.snapPixelAmount,Boolean(u.start))}return c.forEach((e=>{let t=n.getElementFromAssignmentRecord(e,!0);t||(t=n.currentOrientation.addTemporaryDragElement(e.event,e.resource)),d.push(t)})),{record:l,draggedEntities:c,dateConstraints:null!==(t=u)&&void 0!==t&&t.start?u:null,eventBarCopies:d.map((e=>r.createProxy(e))),eventBarEls:d}}getDateConstraints(e,t){var r;const{scheduler:n}=this,s=null===(r=n.getDateConstraints)||void 0===r?void 0:r.call(n,e,t);let i,o;return this.constrainDragToTimeSlot?(i=t.startDate,o=t.endDate):s&&(i=s.start,o=s.end),{start:i,end:o}}getConstrainingRectangle(e,t,r){return this.scheduler.getScheduleRegion(this.constrainDragToResource&&t,r,!0,e&&{start:e.start,end:e.end})}getDragData(t){const r=this.getMinimalDragData(t)||{};return e(e(e({},super.getDragData(t)),r),{},{initialAssignmentsState:r.assignmentRecords.map((e=>({startDate:e.event.startDate,resource:e.resource,assignment:e})))})}getRelatedRecords(e){return this.scheduler.selectedAssignments.filter((t=>t!==e&&!t.resource.readOnly&&t.event.isDraggable))}getCoordinate(e,t,r){const n=this.currentOverClient;if(n.isHorizontal){let s=r[0];if("default"!==n.milestoneLayoutMode&&e.isMilestone)switch(n.milestoneAlign){case"center":s+=t.offsetWidth/2;break;case"end":s+=t.offsetWidth}return s}{let s=r[1];if("default"!==n.milestoneLayoutMode&&e.isMilestone)switch(n.milestoneAlign){case"center":s+=t.offsetHeight/2;break;case"end":s+=t.offsetHeight}return s}}resolveResource(){const e=this,t=e.currentOverClient,{isHorizontal:r}=t,{context:n,browserEvent:s,dragProxy:i}=e.dragData,a=i||n.element,l=o.from(a,null,!0),c=t.isVertical||e.unifiedDrag?n.clientY:l.center.y,d=o.from(a,t.timeAxisSubGridElement,!0),{x:u,y:h}=d.center,g=e.getMouseMoveEventTarget(s);let m=null;if(t.element.contains(g))if(r){const e=t.rowManager.getRowAt(c);m=e&&t.store.getAt(e.dataIndex)}else m=t.resolveResourceRecord(t.timeAxisSubGridElement.querySelector(".b-sch-timeaxis-cell"),[u,h]);return m}adjustStartDate(e,t){const r=this.currentOverClient;return r.timeAxis.roundDate(new Date(e-0+t),!!r.snapRelativeToEventStartDate&&e)}getRecordElement(e){return this.client.getElementFromAssignmentRecord(e,!0)}getProxyElement(e){if(this.isDragging){const t=this.dragData.assignmentRecords.indexOf(e);if(t>=0)return this.dragData.proxyElements[t]}return null}getMouseMoveEventTarget(e){return e.target}}Z._$name="EventDrag",T.registerFeature(Z,!0,"Scheduler"),T.registerFeature(Z,!1,"ResourceHistogram");class J extends L{get scheduler(){return this.client}get store(){return this.client.eventStore}updateLockLayout(e){this.dragActiveCls="b-dragcreating"+(e?" b-dragcreate-lock":"")}handleBeforeDragCreate(e,t,r){var n;const{resourceRecord:s}=e;if(s.readOnly)return!1;const{scheduler:i}=this,o=(!i.isSchedulerPro||t.ignoreResourceCalendar||s.isWorkingTime(e.mousedownDate))&&i.trigger("beforeDragCreate",{resourceRecord:s,date:e.mousedownDate,event:r});return this.dateConstraints=null===(n=i.getDateConstraints)||void 0===n?void 0:n.call(i,s,t),o}dragStart(e){var t;const r=this,{client:n}=r,{eventStore:s,assignmentStore:i,enableEventAnimations:o}=n,{resourceRecord:a}=e,l=r.createEventRecord(e),d=[a];if(l.set("duration",u.diff(l.startDate,l.endDate,l.durationUnit,!0)),l.isCreating=!0,l.meta.isDragCreating=!0,n.features.taskEdit&&n.features.taskEdit.doCancel(),!1===r.handleBeforeDragCreate(e,l,e.event))return!1;let h=[];return a&&(h=i.assignEventToResource(l,a)),!1===n.trigger("beforeEventAdd",{eventRecord:l,resourceRecords:d,assignmentRecords:h})?(i.remove(h),!1):(r.lockLayout&&(l.meta.excludeFromLayout=!0),null===(t=n.onEventCreated)||void 0===t||t.call(n,l),n.enableEventAnimations=!1,s.addAsync(l).then((()=>n.enableEventAnimations=o)),n.isCreating=!0,n.refreshRows(),n.isCreating=!1,e.itemElement=e.element=n.getElementFromEventRecord(l),c.isInView(e.itemElement)||n.scrollable.scrollIntoView(e.itemElement,{animate:!0,edgeOffset:n.barMargin}),super.dragStart(e))}checkValidity(e,t){const r=this,{client:n}=r;return e.resourceRecord=r.dragging.resourceRecord,(n.allowOverlap||n.isDateRangeAvailable(e.startDate,e.endDate,e.eventRecord,e.resourceRecord))&&r.createValidatorFn.call(r.validatorFnThisObj||r,e,t)}isRowEmpty(e){const t=this.store.getEventsForResource(e);return!t||!t.length}triggerBeforeFinalize(e){this.client.trigger("beforeDragCreateFinalize",e)}createEventRecord(e){const t=this,{client:r}=t,n=r.isHorizontal?"X":"Y",{timeAxis:s,eventStore:o,weekStartDay:a}=r,{event:l,mousedownDate:c}=e,d=t.draggingEnd=l[`page${n}`]>e.startEvent[`page${n}`],h={name:o.modelClass.fieldMap.name.defaultValue||t.L("L{Object.newEvent}"),startDate:d?u.floor(c,s.resolution,null,a):c,endDate:d?c:u.ceil(c,s.resolution,null,a)};return r.project.isGanttProjectMixin&&i.assign(h,{constraintDate:h.startDate,constraintType:"startnoearlierthan"}),o.createRecord(h)}async finalizeDragCreate(e){const{meta:t}=e.eventRecord;return t.excludeFromLayout=!1,t.isDragCreating=!1,this.client.hasEventEditor||(e.eventRecord.isCreating=!1),super.finalizeDragCreate(e)}getTipHtml(...e){const t=super.getTipHtml(...e),{element:r}=this.tip;return r.classList.add("b-sch-dragcreate-tooltip"),r.classList.toggle("b-too-narrow",this.dragging.context.tooNarrow),t}onAborted(e){var t,r;const{eventRecord:n,resourceRecord:s}=e;null===(t=(r=this.store).unassignEventFromResource)||void 0===t||t.call(r,n,s),this.store.remove(n)}}t(J,"$name","EventDragCreate"),t(J,"configurable",{validatorFn:()=>!0,lockLayout:!1}),J._$name="EventDragCreate",T.registerFeature(J,!0,"Scheduler"),T.registerFeature(J,!1,"ResourceHistogram");class Q extends k{static get $name(){return"EventTooltip"}static get defaultConfig(){return{template:e=>`\n                ${e.eventRecord.name?g.xss`<div class="b-sch-event-title">${e.eventRecord.name}</div>`:""}\n                ${e.startClockHtml}\n                ${e.endClockHtml}`,cls:"b-sch-event-tooltip",monitorRecordUpdate:!0,scrollAction:"hide"}}construct(e,t){const r=this;super.construct(e,t),"string"==typeof r.align&&(r.align={align:r.align})}onPaint({firstPaint:e}){if(super.onPaint(...arguments),e){const e=this,t=e.client.features.dependencies;if(t){const r=e.align.offset;e.tooltip.ion({beforeShow:({source:e})=>{t.disabled?e.align.offset=r:e.align.offset=[0,10]}})}}}}Q._$name="EventTooltip",T.registerFeature(Q,!0,"Scheduler"),T.registerFeature(Q,!1,"ResourceHistogram");const ee={width:0,height:0};class te extends n{construct(e,t){super.construct(e,t),e.isVertical&&(this.toUpdate=new Set,e.ion({scroll:"onSchedulerScroll",horizontalScroll:"onHorizontalScroll",thisObj:this,prio:1e4}))}onEventDataGenerated(e){this.client.isHorizontal?e.wrapperCls["b-disable-sticky"]=!1===e.eventRecord.stickyContents:(this.syncEventContentPosition(e,void 0,!0),this.updateStyles())}onSchedulerScroll(){this.disabled||this.verticalSyncAllEventsContentPosition(this.client)}onHorizontalScroll({subGrid:e}){e===this.client.timeAxisSubGrid&&this.verticalSyncAllEventsContentPosition(this.client)}updateStyles(){for(const{contentEl:e,style:t}of this.toUpdate)c.applyStyle(e,t);this.toUpdate.clear()}verticalSyncAllEventsContentPosition(e){const{resourceMap:t}=e.currentOrientation;for(const e of t.values())for(const{renderData:t,elementConfig:r}of Object.values(e)){const e=[t];r&&t.eventRecord.isResourceTimeRange&&e.push(r.children[0]),this.syncEventContentPosition.apply(this,e)}this.toUpdate.size&&this.updateStyles()}syncEventContentPosition(e,t=e.eventContent,r=!1){if(this.disabled||!1===e.eventRecord.stickyContents)return;const{client:n}=this,{eventRecord:s,resourceRecord:i,useEventBuffer:o,bufferAfterWidth:a,bufferBeforeWidth:l,top:d,height:u}=e,g=n.scrollable.y,m=r?null:n.getElementFromEventRecord(s,i,!0),v=m&&h.getChild(m,"event.content"),p=s.instanceMeta(n),f="string"==typeof t.style?t.style=c.parseStyle(t.style):t.style||(t.style={});if(null!=m&&m.classList.contains("b-dragging"))return;let R=d,E=u,y=R+E;if(o&&(R+=l,E=E-l-a,y=R+E),R<g&&y>=g&&!s.isMilestone){const t=null==v?void 0:v.offsetWidth,r="center"===((null==v?void 0:v.parentNode)&&c.getStyleValue(v.parentNode,"justifyContent"))?(e.width-t)/2:0,n=R,s=n+E-1;if((!v||t)&&n<g&&s>=g){const e=this.getEventContentMargins(v),t=v?E-v.offsetHeight-e.height-r:Number.MAX_SAFE_INTEGER,s=Math.min(g-n,t-2);f.transform=s>0?`translateY(${s}px)`:"",p.stuck=!0}else f.transform="",p.stuck=!1;v&&this.toUpdate.add({contentEl:v,style:f})}else v&&p.stuck&&(f.transform="",p.stuck=!1,this.toUpdate.add({contentEl:v,style:f}))}getEventContentMargins(e){return null!=e&&e.classList.contains("b-sch-event-content")?c.getEdgeSize(e,"margin"):ee}doDisable(){super.doDisable(...arguments),this.isConfiguring||this.client.refreshWithTransition()}}t(te,"$name","StickyEvents"),t(te,"type","stickyEvents"),t(te,"pluginConfig",{chain:["onEventDataGenerated"]}),te._$name="StickyEvents",T.registerFeature(te,!0,"Scheduler"),T.registerFeature(te,!1,"ResourceHistogram");class re extends(P.mixin(C)){static get $name(){return"TimeRanges"}static get defaultConfig(){return{store:!0}}doDestroy(){var e;null===(e=this.storeDetacher)||void 0===e||e.call(this),super.doDestroy()}get timeRanges(){const e=this;if(!e._timeRanges){const{store:t}=e;let{records:r}=t;if(t.recurringEvents){const{startDate:t,endDate:n}=e.client.timeAxis;r=r.flatMap((e=>e.isRecurring?e.getOccurrencesForDateRange(t,n):e))}e.currentTimeLine&&(t.recurringEvents||(r=r.slice()),r.push(e.currentTimeLine)),e._timeRanges=r}return e._timeRanges}attachToProject(e){var t;super.attachToProject(e);const r=this;var n;(null===(t=r.projectTimeZoneChangeDetacher)||void 0===t||t.call(r),r.showCurrentTimeLine)&&(r.projectTimeZoneChangeDetacher=null===(n=r.client.project)||void 0===n?void 0:n.ion({timeZoneChange:()=>r.updateCurrentTimeLine()}),r.currentTimeLine&&r.updateCurrentTimeLine())}initCurrentTimeLine(){const e=this;if(e.currentTimeLine||!e.showCurrentTimeLine)return;const t="object"==typeof e.showCurrentTimeLine?e.showCurrentTimeLine:{};e.currentTimeLine=e.store.modelClass.new({id:"currentTime",cls:"b-sch-current-time"},t),e.currentTimeInterval=e.setInterval((()=>e.updateCurrentTimeLine()),e.currentTimeLineUpdateInterval),e._timeRanges=null,e.updateCurrentTimeLine()}updateCurrentTimeLine(){var e;const t=this,{currentTimeLine:r}=t;r._inTimeZone=null===(e=t.project)||void 0===e?void 0:e.timeZone,r.setLocalDate("startDate",new Date),r.endDate=r.startDate,r.originalData.name||(r.name=u.format(r.startDate,t.currentDateFormat)),t.renderRanges()}hideCurrentTimeLine(){const e=this;e.currentTimeLine&&(e.clearInterval(e.currentTimeInterval),e.currentTimeLine=null,e.refresh())}updateShowCurrentTimeLine(e){e?this.initCurrentTimeLine():this.hideCurrentTimeLine()}populateTimeAxisHeaderMenu({column:e,items:t}){t.currentTimeLine={weight:400,text:this.L("L{showCurrentTimeLine}"),checked:this.showCurrentTimeLine,onToggle:({checked:e})=>{this.showCurrentTimeLine=e}}}attachToStore(e){const t=this;let r=!1;t.storeDetacher&&(t.storeDetacher(),r=!0),t.storeDetacher=e.ion({change:"onStoreChange",refresh:"onStoreChange",thisObj:t}),t._timeRanges=null,r&&t.renderRanges()}get store(){return this.client.project.timeRangeStore}updateStore(e){const{client:t}=this,{project:r}=t;e=r.timeRangeStore,this.attachToStore(e),t.timeRanges&&!t._timeRangesExposed&&(e.add(t.timeRanges),delete t.timeRanges)}attachToTimeRangeStore(e){this.store=e}resolveTimeRangeRecord(e){return this.store.getById(e.closest(this.baseSelector).dataset.id)}onStoreChange({type:e,action:t}){const r=this;r._timeRanges=null,r.disabled||!r.client.isVisible||r.isConfiguring||"refresh"===e&&"batch"!==t||r.client.runWithTransition((()=>r.renderRanges()),!r.client.refreshSuspended)}onDragStart(e){const t=this,{context:r}=e,n=t.resolveTimeRangeRecord(r.element.closest(t.baseSelector)),s=t.getBodyElementByRecord(n);r.relatedElements=[s],Object.assign(r,{record:n,rangeBodyEl:s,originRangeX:c.getTranslateX(s),originRangeY:c.getTranslateY(s)}),super.onDragStart(e),t.showTip(r)}onDrop(e){const{context:t}=e;if(!t.valid)return this.onInvalidDrop({context:t});const r=this,{client:n}=r,{record:s}=t,i=o.from(t.rangeBodyEl),a=n.getDateFromCoordinate(i.getStart(n.rtl,n.isHorizontal),"round",!1);s.startDate-a!=0?s.setStartDate(a):r.onInvalidDrop(),r.destroyTip(),super.onDrop(e)}onResizeStart({context:e}){const t=this,r=t.resolveTimeRangeRecord(e.element.closest(t.baseSelector)),n=t.getBodyElementByRecord(r);Object.assign(e,{record:r,rangeBodyEl:n}),t.showTip(e)}onResizeDrag({context:e}){const{rangeBodyEl:t}=e;this.client.isVertical?("top"===e.edge&&c.setTranslateY(t,e.newY),t.style.height=e.newHeight+"px"):("left"===e.edge&&c.setTranslateX(t,e.newX),t.style.width=e.newWidth+"px")}onResize({context:e}){if(!e.valid)return this.onInvalidDrop({context:e});const t=this,{client:r}=t,{rtl:n}=r,s=e.record,i=o.from(e.element),a=i.getStart(n,r.isHorizontal),l=i.getEnd(n,r.isHorizontal),c=r.getDateFromCoordinate(a,"round",!1),d=n&&"right"===e.edge||!n&&"left"===e.edge||"top"===e.edge,u=r.getDateFromCoordinate(l,"round",!1);(d&&s.startDate-c!=0||u&&s.endDate-u!=0)&&u>c?d?s.setStartDate(c,!1):s.setEndDate(u,!1):t.onInvalidResize({context:e}),t.destroyTip()}onInvalidResize({context:e}){const t=this;t.resize.reset(),e.rangeBodyEl.parentElement.lastDomConfig=e.rangeBodyEl.lastDomConfig=null,t.renderRanges(),t.destroyTip()}}t(re,"configurable",{store:{modelClass:M},currentTimeLineUpdateInterval:1e4,currentDateFormat:"HH:mm",showCurrentTimeLine:!1}),re._$name="TimeRanges",T.registerFeature(re,!1,["Scheduler","Gantt"]);var ne=e=>class extends(e||r){static get $name(){return"SchedulerDom"}getElementFromAssignmentRecord(e,t=!1){if(this.isPainted&&e){var r,n,s;let o=null===(r=this.foregroundCanvas.syncIdMap)||void 0===r?void 0:r[e.id];if(!o&&e.resource.hasLinks)for(const t of e.resource.$links){var i;if(o=null===(i=this.foregroundCanvas.syncIdMap)||void 0===i?void 0:i[`${e.id}_${t.id}`],o)break}return t?o:null===(n=o)||void 0===n||null===(s=n.syncIdMap)||void 0===s?void 0:s.event}return null}getElementFromEventRecord(e,t=(()=>{var t;return null===(t=e.resources)||void 0===t?void 0:t[0]})(),r=!1){if(e.isResourceTimeRange){var n;const t=null===(n=this.foregroundCanvas.syncIdMap)||void 0===n?void 0:n[e.domId];return r?t:null==t?void 0:t.syncIdMap.event}const s=this.assignmentStore.getAssignmentForEventAndResource(e,t);return this.getElementFromAssignmentRecord(s,r)}getElementsFromEventRecord(e,t,r=!1){return t?[this.getElementFromEventRecord(e,t,r)]:e.resources.reduce(((t,n)=>{const s=this.getElementFromEventRecord(e,n,r);return s&&t.push(s),t}),[])}resolveResourceRecord(e,t){return this.currentOrientation.resolveRowRecord(e,t)}resolveRowRecord(e){return this.resolveResourceRecord(e)}resolveEventRecord(e){var t;e instanceof Event&&(e=e.target);const r=null===(t=e)||void 0===t?void 0:t.closest(this.eventSelector);if(r){if(r.dataset.eventId)return this.eventStore.getById(r.dataset.eventId);if(r.dataset.assignmentId)return this.assignmentStore.getById(r.dataset.assignmentId).event}return null}resolveTimeSpanRecord(e){return this.resolveEventRecord(e)}resolveAssignmentRecord(e){const t=e.closest(this.eventSelector),r=t&&this.assignmentStore.getById(t.dataset.assignmentId),n=t&&this.eventStore.getById(t.dataset.eventId);return this.assignmentStore.getOccurrence(r,n)}isRowVisible(e){return this.store.indexOf(e)>=0}get widgetClass(){}},se=e=>class extends(e||r){static get $name(){return"SchedulerDomEvents"}getTimeSpanMouseEventParams(e,t){const r=this.resolveEventRecord(e);return r&&{eventRecord:r,resourceRecord:this.resolveResourceRecord(e),assignmentRecord:this.resolveAssignmentRecord(e),eventElement:e,event:t}}getScheduleMouseEventParams(e,t){return{resourceRecord:this.isVertical?this.resolveResourceRecord(t):this.store.getById(e.id)}}onElementKeyDown(e){const t=super.onElementKeyDown(e),r=this;return r.selectedEvents.length&&r.trigger(r.scheduledEventName+"KeyDown",{eventRecords:r.selectedEvents,assignmentRecords:r.selectedAssignments,event:e,eventRecord:r.selectedEvents,assignmentRecord:r.selectedAssignments}),t}onElementKeyUp(e){super.onElementKeyUp(e);const t=this;t.selectedEvents.length&&t.trigger(t.scheduledEventName+"KeyUp",{eventRecords:t.selectedEvents,assignmentRecords:t.selectedAssignments,event:e,eventRecord:t.selectedEvents,assignmentRecord:t.selectedAssignments})}get widgetClass(){}},ie=e=>class extends(e||r){static get $name(){return"SchedulerEventRendering"}static get configurable(){return{milestoneTextPosition:"outside",milestoneAlign:"center",milestoneCharWidth:10,milestoneLayoutMode:"default",eventLayout:"stack",overlappingEventSorter:null,horizontalEventSorterFn:null,resourceMargin:null,useInitialAnimation:!0,eventRenderer:null,eventRendererThisObj:null,eventBarTextField:"name",eventBodyTemplate:null,horizontalLayoutPackClass:U,horizontalLayoutStackClass:_,resourceColumns:null,resourceImagePath:null,defaultResourceImageName:null,resourceImageExtension:".jpg",isFirstRender:!0,initialAnimationDuration:2e3,narrowEventWidth:10,internalEventLayout:null,eventPositionMode:"translate",eventScrollMode:"move"}}changeEventLayout(e){return this.internalEventLayout=e,this.internalEventLayout.type}changeInternalEventLayout(e){return this.getEventLayout(e)}updateInternalEventLayout(e,t){const r=this;t&&r.element.classList.remove(`b-eventlayout-${t.type}`),r.element.classList.add(`b-eventlayout-${e.type}`),r.isConfiguring||(r.refreshWithTransition(),r.trigger("stateChange"))}changeHorizontalEventSorterFn(e){m.deprecate("Scheduler","6.0.0","Replaced by overlappingEventSorter()"),this.overlappingEventSorter=e}updateOverlappingEventSorter(e){this.isConfiguring||this.refreshWithTransition()}getEventLayout(e){var t;return null!==(t=e)&&void 0!==t&&t.isModel&&(e=e.eventLayout||this.internalEventLayout),"string"==typeof e&&(e={type:e}),e}getEventLayoutHandler(e){const t=this;if(!t.isHorizontal)return null;const{timeAxisViewModel:r,horizontal:n}=t,{type:s}=e;switch(t.layouts||(t.layouts={}),s){case"stack":return t.layouts.horizontalStack||(t.layouts.horizontalStack=new t.horizontalLayoutStackClass(i.assign({scheduler:t,timeAxisViewModel:r,bandIndexToPxConvertFn:n.layoutEventVerticallyStack,bandIndexToPxConvertThisObj:n},e))),t.layouts.horizontalStack;case"pack":return t.layouts.horizontalPack||(t.layouts.horizontalPack=new t.horizontalLayoutPackClass(i.assign({scheduler:t,timeAxisViewModel:r,bandIndexToPxConvertFn:n.layoutEventVerticallyPack,bandIndexToPxConvertThisObj:n},e))),t.layouts.horizontalPack;default:return null}}get resourceColumns(){var e;return(null===(e=this.timeAxisColumn)||void 0===e?void 0:e.resourceColumns)||this._resourceColumns}get resourceColumnWidth(){var e;return(null===(e=this.resourceColumns)||void 0===e?void 0:e.columnWidth)||null}getEventsToRender(e,t){return t}repaintEventsForResource(e){this.currentOrientation.repaintEventsForResource(e)}repaintEvent(e){this.eventStore.getResourcesForEvent(e).forEach((e=>this.repaintEventsForResource(e)))}getResourceMargin(e){var t;return null!==(t=null==e?void 0:e.resourceMargin)&&void 0!==t?t:this.resourceMargin}getBarMargin(e){var t;return null!==(t=null==e?void 0:e.barMargin)&&void 0!==t?t:this.barMargin}getResourceHeight(e){var t;return null!==(t=e.rowHeight)&&void 0!==t?t:this.isHorizontal?this.rowHeight:this.getResourceWidth(e)}getResourceWidth(e){var t;return null!==(t=e.columnWidth)&&void 0!==t?t:this.resourceColumnWidth}getAppliedResourceHeight(e){var t;const r=this.getRowById(e);return null!==(t=null==r?void 0:r.maxRequestedHeight)&&void 0!==t?t:this.getResourceHeight(e)}getResourceLayoutSettings(e,t=null){const r=this.getResourceMargin(e,t),n=this.getAppliedResourceHeight(e,t);return{barMargin:this.getBarMargin(e,t),contentHeight:Math.max(n-2*r,1),rowHeight:n,resourceMargin:r}}getEventStyle(e,t){return e.eventStyle||t.eventStyle||this.eventStyle}getEventColor(e,t){var r,n;return e.eventColor||(null===(r=e.event)||void 0===r?void 0:r.eventColor)||(null===(n=e.parent)||void 0===n?void 0:n.eventColor)||t.eventColor||this.eventColor}generateRenderData(e,t,r={viewport:!0}){const n=this,s=n.currentOrientation.getTimeSpanRenderData(e,t,r),{isEvent:o}=e,{eventResize:a}=n.features,l=!e.meta.isDragCreating&&e.isMilestone,u=o&&e.assignments.find((e=>e.resourceId===t.$originalId)),h={className:"b-sch-event-content",role:"presentation",dataset:{taskBarFeature:"content"}};if(s){var m;s.tabIndex="0";let r=e.isResizable;a&&r&&(s.startsOutsideView&&(!0===r?r="end":"start"===r&&(r=!1)),s.endsOutsideView&&(!0===r?r="start":"end"===r&&(r=!1)),r&&(n.isHorizontal?!n.rtl&&!a.leftHandle||n.rtl&&!a.rightHandle?r="start"!==r&&"end":(!n.rtl&&!a.rightHandle||n.rtl&&!a.leftHandle)&&(r="end"!==r&&"start"):a.topHandle?a.bottomHandle||(r="end"!==r&&"start"):r="start"!==r&&"end"));const f=Boolean(e.hasPersistableChanges||(null==u?void 0:u.hasPersistableChanges)),R={[t.cls]:t.cls,[n.generatedIdCls]:!e.isOccurrence&&e.hasGeneratedId,[n.dirtyCls]:f,[n.committingCls]:e.isCommitting,[n.endsOutsideViewCls]:s.endsOutsideView,[n.startsOutsideViewCls]:s.startsOutsideView,"b-clipped-start":s.clippedStart,"b-clipped-end":s.clippedEnd,"b-iscreating":e.isCreating,"b-rtl":n.rtl},E={[`${n.eventCls}-parent`]:t.isParent,"b-readonly":e.readOnly||(null==u?void 0:u.readOnly),"b-linked-resource":t.isLinked,"b-original-resource":t.hasLinks},y=e.isResourceTimeRange?new v:e.internalCls.clone(),C=e.isResourceTimeRange?e.internalCls.clone():new v;if(s.wrapperStyle="",s.isWrap=!0,o){const o=u&&n.isAssignmentSelected(u);i.assign(R,{[n.eventCls]:1,"b-milestone":l,"b-sch-event-narrow":!l&&s.width<n.narrowEventWidth,[n.fixedEventCls]:!1===e.isDraggable,[`b-sch-event-resizable-${r}`]:Boolean((null==a?void 0:a.enabled)&&!e.readOnly),[n.eventSelectedCls]:o,[n.eventAssignHighlightCls]:n.eventAssignHighlightCls&&!o&&n.isEventSelected(e),"b-recurring":e.isRecurring,"b-occurrence":e.isOccurrence,"b-inactive":e.inactive}),s.eventId=e.id;const c=n.getEventStyle(e,t),h=n.getEventColor(e,t),g=n.isFirstRender&&n.useInitialAnimation&&!0!==globalThis.bryntum.noAnimations;if(i.assign(E,{[`${n.eventCls}-wrap`]:1,"b-milestone-wrap":l}),g){const e=(s.row?s.row.index:(s.top-n.scrollTop)/n.tickSize)/20*1e3;s.wrapperStyle=`animation-delay: ${e}ms;`,n.maxDelay=Math.max(n.maxDelay||0,e),n.initialAnimationDetacher||(n.initialAnimationDetacher=d.on({element:n.foregroundCanvas,delegate:n.eventSelector,once:!0,animationend:()=>n.setTimeout({fn:"stopInitialAnimation",delay:n.maxDelay,cancelOutstanding:!0}),expires:{alt:"stopInitialAnimation",delay:n.initialAnimationDuration+n.maxDelay},thisObj:n}))}s.eventColor=h,s.eventStyle=c,s.assignmentRecord=s.assignment=u}if(s.wrapperCls=i.assign(C,E),s.cls=i.assign(y,R),s.iconCls=new v(e.get(n.eventBarIconClsField)||e.iconCls),e.isResourceTimeRange?(s.style="",s.wrapperStyle+=e.style||""):s.style=e.style||"",s.resource=s.resourceRecord=t,s.resourceId=s.rowId,o){let r,i=null,o=null;if(n.eventRenderer){const i=n.eventRenderer.call(n.eventRendererThisObj||n,{eventRecord:e,resourceRecord:t,assignmentRecord:s.assignmentRecord,renderData:s});"string"==typeof s.cls&&(s.cls=new v(s.cls)),"string"==typeof s.wrapperCls&&(s.wrapperCls=new v(s.wrapperCls)),"string"==typeof s.iconCls&&(s.iconCls=new v(s.iconCls)),r=n.eventBodyTemplate?n.eventBodyTemplate(i):i}else n.eventBodyTemplate?r=n.eventBodyTemplate(e):n.eventBarTextField&&(r=g.encodeHtml(e[n.eventBarTextField]||""));var p;if(!n.eventBodyTemplate||Array.isArray(r))h.children=[],!l||"default"!==n.milestoneLayoutMode&&"always-outside"!==n.milestoneTextPosition||null==r||""===r||h.children.unshift(o={tag:"label",children:[]}),null!==(p=s.iconCls)&&void 0!==p&&p.length&&h.children.unshift({tag:"i",className:s.iconCls}),Array.isArray(r)?(o||h).children.push(...r):g.isHtml(r)?h.children.length?i={tag:"span",class:"b-event-text-wrap",html:r}:(h.children=null,h.html=r):"string"==typeof r||"object"==typeof r?i=r:null!=r&&(i=String(r)),null!=i&&((o||h).children.push(i),s.cls.add("b-has-content")),(null!=h.html||h.children.length)&&s.children.push(h);else h.html=r,s.children.push(h)}const{eventStyle:S,eventColor:D}=s;if(s.wrapperCls[`b-sch-style-${S||"none"}`]=1,c.isNamedColor(D))s.wrapperCls[`b-sch-color-${D}`]=D;else if(D){const e=S?"color":"background-color";s.style=`${e}:${D};`+s.style,s.wrapperCls["b-sch-custom-color"]=1}else s.wrapperCls["b-sch-color-none"]=1;s.style&&l&&h&&(h.style=s.style,delete s.style),s.cls["b-sch-event-withicon"]=null===(m=s.iconCls)||void 0===m?void 0:m.length,s.eventContent=h,s.wrapperChildren=[],n.onEventDataGenerated(s)}return s}onEventDataGenerated(e){}changeUseInitialAnimation(e){return!0===e?"fade-in":e}updateUseInitialAnimation(e,t){const{classList:r}=this.element;t&&r.remove(`b-initial-${t}`),e&&(r.add(`b-initial-${e}`),p.isFirefox&&r.add("b-prevent-event-transitions"))}restartInitialAnimation(e){var t;const r=this;null===(t=r.initialAnimationDetacher)||void 0===t||t.call(r),r.initialAnimationDetacher=null,r.useInitialAnimation=e,r.isFirstRender=!0,r.refresh()}stopInitialAnimation(){const e=this;e.initialAnimationDetacher(),e.isFirstRender=!1,e.useInitialAnimation=!1,p.isFirefox&&e.setTimeout((()=>e.element.classList.remove("b-prevent-event-transitions")),100)}getMilestoneLabelWidth(e,t){const r=this,n=r.milestoneLayoutMode,s=r.getResourceLayoutSettings(t).contentHeight;if("measure"===n){const n=g.encodeHtml(e.name),i=r.getEventColor(e,t),a=r.getEventStyle(e,t),l=r.milestoneMeasureElement||(r.milestoneMeasureElement=c.createElement({className:{"b-sch-event-wrap":1,"b-milestone-wrap":1,"b-measure":1,[`b-sch-color-${i}`]:i,[`b-sch-style-${a}`]:a},children:[{className:"b-sch-event b-milestone",children:[{className:"b-sch-event-content",children:[{tag:"label"}]}]}],parent:r.foregroundCanvas}));if(l.retainElement=!0,l.style.fontSize=`${s}px`,"always-outside"===r.milestoneTextPosition){const e=l.firstElementChild.firstElementChild.firstElementChild;e.innerHTML=n;const t=o.from(e,e.parentElement);return t.left+t.width+2}return l.firstElementChild.firstElementChild.innerHTML=`<label></label>${n}`,l.firstElementChild.offsetWidth}return"estimate"===n?e.name.length*r.milestoneCharWidth+("always-outside"===r.milestoneTextPosition?s:0):"data"===n?e.milestoneWidth:0}updateMilestoneLayoutMode(e){const t=this,r="always-outside"===t.milestoneTextPosition;t.element.classList.toggle("b-sch-layout-milestones","default"!==e&&!r),t.element.classList.toggle("b-sch-layout-milestone-labels","default"!==e&&r),t.isConfiguring||t.refreshWithTransition()}updateMilestoneTextPosition(e){this.element.classList.toggle("b-sch-layout-milestone-text-position-inside","inside"===e),this.updateMilestoneLayoutMode(this.milestoneLayoutMode)}updateMilestoneAlign(){this.isConfiguring||this.refreshWithTransition()}updateMilestoneCharWidth(){this.isConfiguring||this.refreshWithTransition()}get widgetClass(){}},oe=e=>class extends(S(e||r)){static get $name(){return"SchedulerStores"}static get projectStores(){return{resourceStore:{dataName:"resources"},eventStore:{dataName:"events",listeners:{batchedUpdate:"onEventStoreBatchedUpdate",changePreCommit:"onInternalEventStoreChange",commitStart:"onEventCommitStart",commit:"onEventCommit",exception:"onEventException",idchange:"onEventIdChange",beforeLoad:"applyStartEndParameters"}},assignmentStore:{dataName:"assignments",listeners:{changePreCommit:"onAssignmentChange",commitStart:"onAssignmentCommitStart",commit:"onAssignmentCommit",exception:"onAssignmentException",beforeRemove:{fn:"onAssignmentBeforeRemove",prio:-1e3}}},dependencyStore:{dataName:"dependencies"},calendarManagerStore:{},timeRangeStore:{},resourceTimeRangeStore:{}}}static get configurable(){return{store:null,startParamName:"startDate",endParamName:"endDate",passStartEndParameters:!1,crudManagerClass:null,crudManager:null}}updateProject(e,t){super.updateProject(e,t),this.detachListeners("schedulerStores"),e.ion({name:"schedulerStores",refresh:"onProjectRefresh",thisObj:this})}onProjectRefresh({isInitialCommit:e}){const t=this;t.isVisible?(e&&t.isVertical&&(t.refreshAfterProjectRefresh=!1,t.refreshWithTransition()),t.navigateToAfterRefresh&&(t.navigateTo(t.navigateToAfterRefresh),t.navigateToAfterRefresh=null),t.refreshAfterProjectRefresh&&(t.refreshWithTransition(!1,!e),t.refreshAfterProjectRefresh=!1)):t.whenVisible("refresh",t,[!0])}changeCrudManager(e){const t=this;e&&!e.isCrudManager&&(e=t.crudManagerClass.new({scheduler:t},e)),t._crudManager=e,t.bindCrudManager(e)}get store(){return!this._store&&this.isVertical&&(this._store=new f({data:[{id:"verticalTimeAxisRow",cls:"b-verticaltimeaxis-row"}]})),super.store}set store(e){super.store=e}refreshFromRowOnStoreAdd(e,{isExpand:t,records:r}){const n=arguments;this.runWithTransition((()=>{this.currentOrientation.suspended=!t&&!r.some((e=>e.isLinked)),super.refreshFromRowOnStoreAdd(e,...n),this.currentOrientation.suspended=!1}),!t)}onStoreAdd(e){super.onStoreAdd(e),this.isPainted&&this.calculateRowHeights(e.records)}onStoreUpdateRecord({source:e,record:t,changes:r}){let n=0;"assigned"in r&&n++,"calendar"in r&&n++,n!==Object.keys(r).length&&super.onStoreUpdateRecord(...arguments)}updateResourceStore(e){e&&this.isHorizontal&&(e.metaMapId=this.id,this.store=e)}get usesDisplayStore(){return this.store!==this.resourceStore}onEventIdChange(e){this.currentOrientation.onEventStoreIdChange&&this.currentOrientation.onEventStoreIdChange(e)}onEventStoreBatchedUpdate(e){if(this.listenToBatchedUpdates)return this.onInternalEventStoreChange(e)}onInternalEventStoreChange(e){this.isPainted&&this._mode&&!e.isAssign&&!this.assignmentStore.isRemovingAssignment&&this.currentOrientation.onEventStoreChange(e)}onEventCommit({changes:e}){let t=[...e.added,...e.modified].map((e=>this.eventStore.getResourcesForEvent(e)));t=Array.prototype.concat.apply([],t),new Set(t).forEach((e=>this.repaintEventsForResource(e)))}onEventCommitStart({changes:e}){const{currentOrientation:t,committingCls:r}=this;[...e.added,...e.modified].forEach((e=>e.assignments.forEach((e=>t.toggleCls(e,r,!0)))))}onEventException({action:e}){if("commit"===e){const{changes:e}=this.eventStore;[...e.added,...e.modified,...e.removed].forEach((e=>this.repaintEvent(e)))}}onAssignmentCommit({changes:e}){this.repaintEventsForAssignmentChanges(e)}onAssignmentCommitStart({changes:e}){const{currentOrientation:t,committingCls:r}=this;[...e.added,...e.modified].forEach((e=>{t.toggleCls(e,r,!0)}))}onAssignmentException({action:e}){"commit"===e&&this.repaintEventsForAssignmentChanges(this.assignmentStore.changes)}repaintEventsForAssignmentChanges(e){const t=[...e.added,...e.modified,...e.removed].map((e=>e.getResource()));new Set(t).forEach((e=>this.repaintEventsForResource(e)))}onAssignmentBeforeRemove({records:e,removingAll:t}){if(t)return;const r=this;let n;if(!r.isConfiguring&&(r.navigateToAfterRefresh||r.activeAssignment&&e.includes(r.activeAssignment))){if(e.includes(r.navigateToAfterRefresh)&&(r.navigateToAfterRefresh=null),"key"===R.lastInteractionType)for(let t=0,s=e.length;t<s&&!n;t++){const s=e[t];if(s.resource&&s.resource.isModel){let t=r.getNext(s);t&&!e.includes(t)||(t=r.getPrevious(s)),t&&!e.includes(t)&&(n=t)}}n?(r.navigateTo(n),r.navigateToAfterRefresh=n):c.focusWithoutScrolling(r.focusElement)}}set timeRanges(e){this.project.timeRanges=e}get timeRanges(){return this.project.timeRanges}set resourceTimeRanges(e){this.project.resourceTimeRanges=e}get resourceTimeRanges(){return this.project.resourceTimeRanges}applyStartEndParameters({source:e,params:t}){const r=this,n=e.modelClass.fieldMap.startDate;r.passStartEndParameters&&(t[r.startParamName]=n.print(r.startDate),t[r.endParamName]=n.print(r.endDate))}getResourcesEventsPerTick(e,t){const{timeAxis:r,resourceStore:n}=this,s=[];return(e=e||n.records).forEach((e=>{e.events.forEach((n=>{if(!r.isTimeSpanInAxis(n)||t&&!t.call(this,{resource:e,event:n}))return;let i=Math.floor(r.getTickFromDate(n.startDate)),o=Math.ceil(r.getTickFromDate(n.endDate));-1==i&&(i=0),-1===o&&(o=r.ticks.length);do{s[i]?s[i].push(n):s[i]=[n]}while(++i<o)}))})),s}get widgetClass(){}};const ae={block:"nearest",edgeOffset:20},le={highlight:!1,focus:!1};var ce=e=>class extends(e||r){static get $name(){return"SchedulerScroll"}async scrollEventIntoView(e,t=ae){const r=e.resources||[e];if(r.length>1)throw new Error("scrollEventIntoView() is not applicable for events with multiple assignments, please use scrollResourceEventIntoView() instead.");r.length||console.warn("You have asked to scroll to an event which is not assigned to a resource"),await this.scrollResourceEventIntoView(r[0],e,t)}scrollAssignmentIntoView(e,...t){return this.scrollResourceEventIntoView(e.resource,e.event,...t)}async scrollResourceEventIntoView(e,t,r=ae){const n=this,s=t.startDate,i=t.endDate,o=t.isScheduled&&s<n.timeAxis.startDate|(i>n.timeAxis.endDate)<<1;let a;if(arguments.length>3&&(r=arguments[3]),null==r.edgeOffset&&(r.edgeOffset=20),o&&!1!==r.extendTimeAxis){const e=n.timeAxis.endDate-n.timeAxis.startDate;3===o?n.setTimeSpan(new Date(s.valueOf()-e/2),new Date(i.getTime()+e/2)):1&o?n.setTimeSpan(new Date(s),new Date(s.valueOf()+e)):n.setTimeSpan(new Date(i.valueOf()-e),new Date(i))}var l;n.store.tree&&await(null===(l=n.expandTo)||void 0===l?void 0:l.call(n,e));if(t.parent&&!t.parent.isRoot&&await this.scrollEventIntoView(t.parent),a=n.getElementFromEventRecord(t,e),a){c.isFocusable(a)||(a=a.parentNode);const e=n.timeAxisSubGrid.scrollable;n.timeAxisSubGrid.forceScrollUpdate=!0,await e.scrollIntoView(a,r)}else o&&!1===r.extendTimeAxis?console.warn("You have asked to scroll to an event which is outside the current view and extending timeaxis is disabled"):t.isOccurrence||n.eventStore.isAvailable(t)?t.isScheduled?await n.scrollUnrenderedEventIntoView(e,t,r):await n.scrollResourceIntoView(e,r):console.warn("You have asked to scroll to an event which is not available")}scrollUnrenderedEventIntoView(e,t,r=ae){return new Promise((n=>{const s=this,i=Object.assign({edgeOffset:20},r,le),o=s.timeAxisSubGrid.scrollable,a=s.getResourceEventBox(t,e),l=o.viewport;if(!l||!a)return void n();a.x=Math.ceil(a.x),a.y=Math.ceil(a.y),s.rtl&&a.translate(-s.timeAxisViewModel.totalSize+l.width,0),a.translate(l.x-o.scrollLeft,l.y-o.y);const d=s.ion({renderEvent:async({eventRecord:e,element:s,targetElement:i})=>{if(e===t){const e=s||i;d(),await u,r.highlight&&c.highlight(e),r.focus&&e.focus(),n()}}}),u=o.scrollIntoView(a,i)}))}scrollResourceIntoView(e,t=ae){return this.isVertical?this.currentOrientation.scrollResourceIntoView(e,t):this.scrollRowIntoView(e,t)}get widgetClass(){}},de=e=>class extends(e||r){static get $name(){return"SchedulerRegions"}getScheduleRegion(e,t,r=!0,n){return this.currentOrientation.getScheduleRegion(...arguments)}getResourceRegion(e,t,r){return this.currentOrientation.getRowRegion(...arguments)}getAssignmentEventBox(e,t){return this.getResourceEventBox(e.event,e.resource,t)}getResourceEventBox(e,t,r=!1,n=!1){return this.currentOrientation.getResourceEventBox(...arguments)}getItemBox(e,t=!1){return e.resources.map((r=>this.getResourceEventBox(e,r,t)))}get widgetClass(){}};const ue=["eventLayout","mode","eventColor","eventStyle","tickSize","fillTicks"];var he=e=>class extends(e||r){static get $name(){return"SchedulerState"}getState(){return i.copyProperties(super.getState(),this,ue)}applyState(e){var t;this.suspendRefresh();let r=ue.slice();"layoutFn"===(null==e?void 0:e.eventLayout)&&(delete e.eventLayout,r.splice(r.indexOf("eventLayout"),1)),null!=e&&null!==(t=e.zoomLevelOptions)&&void 0!==t&&t.width&&(r=r.filter((e=>"tickSize"!==e))),i.copyProperties(this,e,r),super.applyState(e),this.resumeRefresh(!0)}get widgetClass(){}};const ge={releaseElement:1,reuseElement:1},me={newElement:1,reuseOwnElement:1,reuseElement:1},ve=({startDateMS:e},{startDateMS:t})=>e-t,pe={startDate:1,endDate:1,duration:1};function fe(e,t,r,n,s){var i;const{timeAxis:o}=e,a=t.isBatchUpdating&&!s?t.get(n):t[n],l=null===(i=t.hasBatchedChange)||void 0===i?void 0:i.call(t,n);if(e.fillTicks&&(!t.meta.isResizing||!l)){let e=o.getTickFromDate(a);if(e>=0){r&&e===Math.round(e)&&e>0&&e--;const t=Math.floor(e);return o.getAt(t)[n].getTime()}}return null==a?void 0:a.getTime()}class Re extends(r.mixin(C)){static get configurable(){return{scrollBuffer:0,bufferSize:150,verticalBufferSize:150}}static get properties(){return{resourceMap:new Map,rowMap:new Map,eventConfigs:[],isFirstRefresh:!0,toDrawOnProjectRefresh:new Set,toDrawOnDataReady:new Set}}construct(e){const t=this;t.client=t.scheduler=e,t.eventSorter=t.eventSorter.bind(e),e.scrollable.ion({scroll:"onEarlyScroll",prio:1,thisObj:t}),e.rowManager.ion({name:"rowManager",renderDone:"onRenderDone",removeRows:"onRemoveRows",translateRow:"onTranslateRow",offsetRows:"onOffsetRows",beforeRowHeight:"onBeforeRowHeightChange",thisObj:t}),super.construct({})}init(){}updateVerticalBufferSize(){const{rowManager:e}=this.scheduler;this.scheduler.isPainted&&e.renderRows(e.rows)}get visibleDateRange(){return this._visibleDateRange}getDateFromXY(e,t,r,n=!1){const{scheduler:s}=this;let i=e[0];return r||(i=this.translateToScheduleCoordinate(i)),i=s.getRtlX(i),s.timeAxisViewModel.getDateFromPosition(i,t,n)}translateToScheduleCoordinate(e){const{scheduler:t}=this,{scrollable:r}=t.timeAxisSubGrid;let n=e-t.timeAxisSubGridElement.getBoundingClientRect().left-globalThis.scrollX;return t.rtl?n+=r.maxX-Math.abs(t.scrollLeft):n+=t.scrollLeft,n}translateToPageCoordinate(e){const{scheduler:t}=this,{scrollable:r}=t.timeAxisSubGrid;let n=e+t.timeAxisSubGridElement.getBoundingClientRect().left;return t.rtl?n-=r.maxX-Math.abs(t.scrollLeft):n-=t.scrollLeft,n}getScheduleRegion(e,t,r=!0,n,s=!1){var i,a;const l=this,{scheduler:c}=l,{timeAxisSubGridElement:d,timeAxis:h}=c,g=(!s||e)&&c.getResourceMargin(e)||0;let m;if(e){const r=t&&c.getElementsFromEventRecord(t,e)[0];if(m=o.from(c.getRowById(e.id).getElement("normal"),d),r){const e=o.from(r,d);m.y=e.y,m.bottom=e.bottom}else m.y=m.y+g,m.bottom=m.bottom-g}else m=o.from(d).moveTo(null,0),m.width=d.scrollWidth,m.y=m.y+g,m.bottom=m.bottom-g;const v=h.startDate,p=h.endDate;n=(null===(i=n)||void 0===i?void 0:i.start)&&n||(null===(a=c.getDateConstraints)||void 0===a?void 0:a.call(c,e,t))||{start:v,end:p};let f=c.getCoordinateFromDate(n.start?u.max(v,n.start):v),R=c.getCoordinateFromDate(n.end?u.min(p,n.end):p);return r||(f=l.translateToPageCoordinate(f),R=l.translateToPageCoordinate(R)),m.left=Math.min(f,R),m.right=Math.max(f,R),m}getRowRegion(e,t,r){const{scheduler:n}=this,{timeAxis:s}=n,i=n.getRowById(e.id);if(!i)return null;const a=s.startDate,l=s.endDate,c=t?u.max(a,t):a,d=r?u.min(l,r):l,h=n.getCoordinateFromDate(c),g=n.getCoordinateFromDate(d,!0,!0),m=i.top,v=Math.min(h,g),p=m+i.offsetHeight;return new o(v,m,Math.max(h,g)-v,p-m)}getResourceEventBox(e,t,r,n=!1){const s=this.resourceMap.get(t.id);let i=null,a=!1;if(s&&(i=s.eventsData.find((t=>t.eventRecord===e))),i||(i=this.getTimeSpanRenderData(e,t,{viewport:!0,timeAxis:r}),a=!0),i){const e=this.scheduler.rowManager.getRecordCoords(t,!0,n),r=i.top+e.top,s=new o(i.left,r,i.width,i.height);return s.layout=!a,s.rowTop=e.top,s.rowBottom=e.bottom,s.resourceId=t.id,s}return null}resolveRowRecord(e){const t=this,{scheduler:r}=t,n=e.nodeType?e:e.target,s=n.nodeType===Element.TEXT_NODE?n.parentElement:n,i=s.closest(r.eventSelector);return i?t.resourceStore.getById(i.dataset.resourceId):r.getRecordFromElement(s)}attachToProject(e){super.attachToProject(e),this.refreshAllWhenReady=!0,this.scheduler.isConfiguring||this.clearAll({clearDom:!0}),null==e||e.ion({name:"project",refresh:"onProjectRefresh",commitFinalized:"onProjectCommitFinalized",thisObj:this})}onProjectCommitFinalized(){const{scheduler:e,toDrawOnDataReady:t,project:r}=this;e.isVisible?e.isPainted&&!e.refreshSuspended&&(!t.size&&r.timeZone&&r.ignoreRecordChanges&&t.add(...r.resourceStore.records.flatMap((e=>e.id))),t.size&&(this.clearResources(t),this.refreshResources(t)),t.clear()):e.whenVisible("refreshRows")}onProjectRefresh({isCalculated:e,isInitialCommit:t}){const r=this,{scheduler:n,toDrawOnProjectRefresh:s}=r;if(n.isVisible){if(n.isPainted&&!n.isConfiguring&&!n.refreshSuspended){if(r.refreshAllWhenReady||t&&e){n.calculateAllRowHeights(!0);const{rowManager:s}=n;s.topRow?(r.clearAll(),n.refreshAfterProjectRefresh||(s.topRow.dataIndex>=n.store.count?n.renderRows(!1):n.refreshWithTransition(!1,!r.isFirstRefresh&&e&&!t)),r.isFirstRefresh=!1):s.reinitialize(),r.refreshAllWhenReady=!1}else s.size&&r.refreshResources(s);s.clear()}}else n.whenVisible("refresh",n,[!0])}attachToAssignmentStore(e){this.refreshAllWhenReady=!0,super.attachToAssignmentStore(e),e&&e.ion({name:"assignmentStore",changePreCommit:"onAssignmentStoreChange",refreshPreCommit:"onAssignmentStoreRefresh",thisObj:this})}onAssignmentStoreChange({source:e,action:t,records:r=[],replaced:n,changes:s}){const i=this,{scheduler:o}=i,a=new Set(r.flatMap((e=>{var t,r,n;return[e.resourceId,...null!==(t=null===(r=e.resource)||void 0===r||null===(n=r.$links)||void 0===n?void 0:n.map((e=>e.id)))&&void 0!==t?t:[]]})));if(!i.resourceStore.isRemoving&&!i.resourceStore.isChangingId)switch(t){case"dataset":return void(i.eventStore.usesSingleAssignment||(a.size?i.refreshResourcesWhenReady(a):(i.clearAll(),o.refreshWithTransition())));case"add":case"remove":case"updateMultiple":return void i.refreshResourcesWhenReady(a);case"removeall":return void(i.refreshAllWhenReady=!0);case"replace":return n.forEach((([e,t])=>{a.add(e.resourceId),a.add(t.resourceId)})),void i.refreshResourcesWhenReady(a);case"filter":return i.clearAll(),o.calculateAllRowHeights(!0),void o.refreshWithTransition();case"update":("eventId"in s||"resourceId"in s||"id"in s)&&("resourceId"in s&&a.add(s.resourceId.oldValue),e===o.project.assignmentStore?i.refreshResourcesOnDataReady(a):i.refreshResources(a));break;case"clearchanges":{const{added:e,modified:t,removed:r}=s;t?o.refreshWithTransition():(e.forEach((e=>a.add(e.resourceId))),r.forEach((e=>a.add(e.resourceId))),i.refreshResourcesOnDataReady(a))}}}onAssignmentStoreRefresh({action:e,records:t}){"batch"===e&&(this.clearAll(),this.scheduler.refreshWithTransition())}attachToEventStore(e){this.refreshAllWhenReady=!0,super.attachToEventStore(e),e&&e.ion({name:"eventStore",refreshPreCommit:"onEventStoreRefresh",thisObj:this})}onEventStoreRefresh({action:e}){if("batch"===e){const{scheduler:e}=this;e.isEngineReady&&e.isPainted&&(this.clearAll(),e.refreshWithTransition())}}onEventStoreChange({action:e,records:t=[],record:r,replaced:n,changes:s,source:i}){const o=this,{scheduler:a}=o,l=i.isResourceTimeRangeStore,c=new Set;if(a.isPainted)if(t.forEach((e=>{var t;const r=null===(t=e.$linkedResources)||void 0===t?void 0:t.filter((e=>o.resourceStore.includes(e)));null==r||r.forEach((e=>c.add(e.id)))})),l){switch(e){case"removeall":case"dataset":return o.clearAll(),void a.refreshWithTransition()}o.refreshResources(c)}else{switch(e){case"batch":case"sort":case"group":case"move":case"remove":return;case"clearchanges":return o.clearAll(),void a.refreshWithTransition();case"dataset":return o.clearAll(),void(a.isEngineReady?a.refreshWithTransition():o.refreshAllWhenReady=!0);case"add":case"updateMultiple":break;case"replace":n.forEach((([,e])=>{e.resources.map((e=>c.add(e.id)))}));break;case"removeall":case"filter":return a.isEngineReady?(o.clearAll(),a.calculateAllRowHeights(!0),void a.refreshWithTransition()):void(o.refreshAllWhenReady=!0);case"update":{const e=r.$entity?!Object.keys(s).some((e=>!r.$entity.getField(e))):!Object.keys(s).some((e=>!pe[e]));let t=0;var d,u;if("startDate"in s&&t++,"endDate"in s&&t++,"duration"in s&&t++,"resourceId"in s&&c.add(s.resourceId.oldValue),c.size&&(!e||t&&(!("duration"in s)||1!==t)||"percentDone"in s||"inactive"in s||"segments"in s))null!==(d=o.project)&&void 0!==d&&d.propagatingLoadChanges||null!==(u=o.project)&&void 0!==u&&u.isWritingData?o.refreshResourcesOnDataReady(c):o.refreshResources(c);return}}o.refreshResourcesWhenReady(c)}}attachToResourceStore(e){this.refreshAllWhenReady=!0,super.attachToResourceStore(e),e&&(this.clearAll({clearLayoutCache:!0}),e.ion({name:"resourceStore",changePreCommit:"onResourceStoreChange",thisObj:this}))}get resourceStore(){return this.client.store}onResourceStoreChange({action:e,isExpand:t,records:r,changes:n}){const s=this,i=null==r?void 0:r.flatMap((e=>e.isLinked?[e.id,e.$originalId]:[e.id]));if(s.scheduler.isPainted){switch(e){case"add":return void(t||(r.every((e=>e.isLinked))?s.refreshResources(i):s.refreshResourcesWhenReady(i)));case"update":return void(s.project.isBatchingChanges||n.isLeaf||s.refreshResources(i));case"filter":return;case"removeall":return void s.clearAll({clearLayoutCache:!0});case"dataset":return}i&&s.clearResources(i)}}onTranslateRow({row:e}){null!=e.id&&this.refreshEventsForResource(e,!1)}onOffsetRows(){this.clearAll(),this.doUpdateTimeView()}calculateRowHeight(e){var t;const{scheduler:r}=this,n=r.getResourceHeight(e),s=r.getEventLayout(e);if("stack"===s.type&&r.isEngineReady&&!e.isSpecialRow&&(null===(t=e.assigned)||void 0===t?void 0:t.size)>1){const{assignmentStore:t,eventStore:n,timeAxis:i}=r,{barMargin:o,resourceMargin:a,contentHeight:l}=r.getResourceLayoutSettings(e),c=(n.isFiltered||t.isFiltered)&&(r=>r.assignments.some((r=>r.resource===e.$original&&t.includes(r)))),d=n.getEvents({resourceRecord:e,includeOccurrences:r.enableRecurringEvents,startDate:i.startDate,endDate:i.endDate,filter:c}).sort(ve).map((t=>{const r=t.isBatchUpdating?t.get("startDate"):t.startDate,n=t.isBatchUpdating?t.get("endDate"):t.endDate||r;return{eventRecord:t,resourceRecord:e,startMS:r.getTime(),endMS:n.getTime()}})),u=r.getEventLayoutHandler(s),h=u.layoutEventsInBands(d,!0);return"layoutFn"===u.type?h:h*l+(h-1)*o+2*a}return n}doUpdateTimeView(){const{scrollable:e}=this.scheduler.timeAxisSubGrid;this.updateFromHorizontalScroll(e.x)}onTimeAxisViewModelUpdate(){const e=this,{scheduler:t}=e;e.clearAll(),t.refreshSuspended&&(e.detachListeners("renderingSuspend"),t.ion({name:"renderingSuspend",resumeRefresh({trigger:r}){t.isEngineReady&&r&&e.doUpdateTimeView()},thisObj:e,once:!0})),e.doUpdateTimeView()}getConnectorStartSide(e){return"start"}getConnectorEndSide(e){return"end"}refreshRows(e){e&&this.clearAll()}onLocaleChange(){this.clearAll()}onViewportResize(e,t,r,n){t>n&&this.onRenderDone()}onDragAbort({context:e,dragData:t}){this.resourceStore.indexOf(t.record.resource)<this.scheduler.topRow.dataIndex&&e.element.remove()}toggleCls(e,t,r=!0,n=!1){const s=this.client.getElementFromAssignmentRecord(e,n),i=this.resourceMap.get(e.isModel?e.get("resourceId"):e.resourceId),o=null==i?void 0:i.eventsData.find((t=>t.eventId===e.eventId));o&&(o[n?"wrapperCls":"cls"][t]=r),s&&(s.classList[r?"add":"remove"](t),s.lastDomConfig.className[t]=r)}onRemoveRows({rows:e}){e.forEach((e=>this.rowMap.delete(e))),this.onRenderDone()}onEarlyScroll(){this.rendererCalled=!1}updateFromVerticalScroll(){this.fromScroll=!0,this.rendererCalled||this.onRenderDone()}updateFromHorizontalScroll(e){const t=this,{scheduler:r,scrollBuffer:n}=t,{timeAxisSubGrid:s,timeAxis:i,rtl:o}=r,{width:a}=s,{totalSize:l}=r.timeAxisViewModel,c=e,d=0!==s.scrollable.maxX&&Math.abs(s.scrollable.maxX)<=Math.round(c)+5,u=r.getDateFromCoord({coord:Math.max(0,c-n),ignoreRTL:!0}),h=d?i.endDate:r.getDateFromCoord({coord:c+a+n,ignoreRTL:!0})||i.endDate;if(u&&!r._viewPresetChanging){t._visibleDateRange={startDate:u,endDate:h,startMS:u.getTime(),endMS:h.getTime()},t.viewportCoords=o?{left:l-e-a+n,right:l-e-n}:{left:e-n,right:e+a+n};const s=r.timeView.range={startDate:u,endDate:h};if(r.onVisibleDateRangeChange(s),!r.refreshSuspended&&r.rowManager.rows.length){if(null===r.rowManager.rows[0].id)return;t.fromScroll=!0,r.rowManager.rows.forEach((e=>t.refreshEventsForResource(e,!1,!1))),t.onRenderDone()}}}repaintEventsForResource(e){this.refreshResources([e.id])}onBeforeRowHeightChange(){this.clearAll()}refreshResourcesOnDataReady(e){e.forEach((e=>this.toDrawOnDataReady.add(e)))}refreshResourcesWhenReady(e){this.clearResources(e),e.forEach((e=>this.toDrawOnProjectRefresh.add(e)))}refreshResources(e,t=!0){const{scheduler:r}=this,n=[],s=[];this.clearResources(e),r.refreshSuspended||(e.forEach((e=>{const t=r.getRowById(e);t?n.push(t):s.push(t)})),r.runWithTransition((()=>{r.calculateRowHeights(s.map((e=>this.resourceStore.getById(e))),!0),r.rowManager.renderRows(n)}),t))}layoutEventVerticallyStack(e,t,r){const{barMargin:n,resourceMargin:s,contentHeight:i}=this.scheduler.getResourceLayoutSettings(r,t.parent);return 0===e?s:s+e*i+e*n}layoutEventVerticallyPack(e,t,r,n){const{barMargin:s,resourceMargin:i,contentHeight:o}=this.scheduler.getResourceLayoutSettings(n,r.parent),a=1/t,l=e*a,c=(o-(a-1)*s)*t;return{top:i+l*c+l*s,height:c}}addTemporaryDragElement(e,t=e.resource){const{scheduler:r}=this,n=r.generateRenderData(e,t,{timeAxis:!0,viewport:!0});n.absoluteTop=n.row?n.top+n.row.top:r.getResourceEventBox(e,t,!0).top;const s=this.renderEvent(n),{dataset:i}=s;delete s.tabIndex,delete i.eventId,delete i.resourceId,delete i.assignmentId,delete i.syncId,i.transient=!0,s.parent=this.scheduler.foregroundCanvas,s.retainElement=!0;const o=c.createElement(s);return o.innerElement=o.firstChild,e.instanceMeta(r).hasTemporaryDragElement=!0,o}eventSorter(e,t){if(this.overlappingEventSorter)return this.overlappingEventSorter(e.eventRecord||e,t.eventRecord||t);const r=e.isModel?e.startDateMS:e.dataStartMS||e.startMS,n=e.isModel?e.endDateMS:e.dataEndMS||e.endMS,s=t.isModel?t.startDateMS:t.dataStartMS||t.startMS,i=t.isModel?t.endDateMS:t.dataEndMS||t.endMS,o=e.isModel?e.name:e.eventRecord.name,a=t.isModel?t.name:t.eventRecord.name;return r-s||i-n||(o<a?-1:o==a?0:1)}calculateMS(e,t,r,n,s){const{scheduler:i}=this,{timeAxisViewModel:o}=i;let a=fe(i,e,!1,t,n),l=fe(i,e,!0,r,n),c=l-a;if("default"!==i.milestoneLayoutMode&&0===c){const t=o.getSingleUnitInPixels("minute");if(c=60*(i.getMilestoneLabelWidth(e,s)*(1/t))*1e3,"always-outside"===i.milestoneTextPosition){a-=i.getResourceLayoutSettings(s,e.parent).contentHeight*(1/t)*60*1e3/2,l=a+c}else switch(i.milestoneAlign){case"start":case"left":l=a+c;break;case"end":case"right":l=a,a=l-c;break;default:l=a+c/2,a=l-c}}return{startMS:a,endMS:l,durationMS:c}}setupRenderData(e,t){var r;const n=this,{scheduler:s}=n,{timeAxis:i,timeAxisViewModel:o}=s,{preamble:a,postamble:l}=e,c=n.isProHorizontalRendering&&(null===(r=s.features.eventBuffer)||void 0===r?void 0:r.enabled)&&(a||l)&&!e.isMilestone,d=o.getSingleUnitInPixels("minute"),{isBatchUpdating:u}=e,h=c?"wrapStartDate":"startDate",g=c?"wrapEndDate":"endDate",m=u&&!c?e.get(h):e[h],v=u&&!c?e.get(g):e[g]||m,p=i.startMS,f=i.endMS,{startMS:R,endMS:E,durationMS:y}=n.calculateMS(e,h,g,c,t),C=R<p|(R>f)<<1,S=E>f|(E<=p)<<1,D=S?d*(y/6e4):null,b=s.getRowById(t);return{eventRecord:e,taskRecord:e,start:m,end:v,rowId:t.id,children:[],startMS:R,endMS:E,durationMS:y,startsOutsideView:C,endsOutsideView:S,width:D,row:b,useEventBuffer:c}}fillTimeSpanHorizontalPosition(e){const{startMS:t,endMS:r,durationMS:n}=e,s=null!=t&&null!=r&&this.calculateHorizontalPosition(e,t,r,n);return!!s&&(Object.assign(e,s),!0)}calculateHorizontalPosition(e,t,r,n){const{scheduler:s}=this,{timeAxis:i,timeAxisViewModel:o}=s,{startsOutsideView:a,endsOutsideView:l,eventRecord:c}=e,d=i.startMS,u=o.getSingleUnitInPixels("minute"),h=l?u*(n/6e4):null;let g,m=s.getCoordinateFromDate(r,{local:!0,respectExclusion:!0,isEnd:!0}),v=!1,f=!1;return a?(g=(t-d)/6e4*u,s.rtl&&(g=s.timeAxisSubGrid.scrollable.scrollWidth-g)):(g=s.getCoordinateFromDate(t,{local:!0,respectExclusion:!0,isEnd:!1,snapToNextIncluded:-1!==m}),v=-1===g),l?m=p.isSafari&&s.features.stickyEvents?s.getCoordinateFromDate(i.endMS):g+h*(s.rtl?-1:1):f=-1===m,f&&!v&&(m=s.getCoordinateFromDate(r,{local:!0,respectExclusion:!0,isEnd:!0,snapToNextIncluded:!0})),h>9999999&&(1===a?1===l?(g=-100,m=s.timeAxisColumn.width+100):g=m-9999999:1===l&&(m=g+9999999)),v&&f&&(g=s.getCoordinateFromDate(t,{local:!0,respectExclusion:!0,isEnd:!1,snapToNextIncluded:!0,max:r}),m=s.getCoordinateFromDate(r,{local:!0,respectExclusion:!0,isEnd:!0,snapToNextIncluded:!0,min:t}),g===m)?(c.instanceMeta(s).excluded=!0,null):{left:Math.min(g,m),width:Math.abs(m-g)||(c.isMilestone&&!c.meta.isDragCreating?0:6),clippedStart:v,clippedEnd:f}}fillTimeSpanVerticalPosition(e,t){const{scheduler:r}=this,{start:n,end:s}=e,{resourceMargin:i,contentHeight:o}=r.getResourceLayoutSettings(t);r.fillTicks&&(e.dataStartMS=n.getTime(),e.dataEndMS=s.getTime()),e.top=Math.max(0,i),r.managedEventSizing&&(e.height=o)}getTimeSpanRenderData(e,t,r=!1){const n=this,{scheduler:s}=n,{timeAxis:i}=s,o=!0===r||r.timeAxis,a=!0===r||r.viewport;if(o||i.isTimeSpanInAxis(e)){if(s.getRowById(t)||a){const r=n.setupRenderData(e,t);return n.fillTimeSpanHorizontalPosition(r)?(n.fillTimeSpanVerticalPosition(r,t),r):null}}}layoutEvents(e,t,r=!1,n,s){const{scheduler:i}=this,{timeAxis:o}=i,a=t.reduce(((t,n)=>{if(r||o.isTimeSpanInAxis(n)){const r=i.generateRenderData(n,e,!1);r&&t.push(r)}return t}),[]);a.sort(null!=s?s:this.eventSorter);let l=i.getAppliedResourceHeight(e,n);const c=a.filter((({eventRecord:e})=>e.isEvent&&!e.meta.excludeFromLayout)),d=i.getEventLayout(e,n),u=i.getEventLayoutHandler(d);if(u){const{barMargin:t,resourceMargin:r,contentHeight:s}=i.getResourceLayoutSettings(e,n),o=u.applyLayout(c,e)||1;l="layoutFn"===u.type?o:o*s+(o-1)*t+2*r}else if(c.length>0)for(let e=0;e<c.length;e++){c[e].wrapperStyle+=`;z-index:${e+5}`}return{rowHeight:l,eventsData:a}}layoutResourceEvents(e,t=!1){const{scheduler:r}=this,{eventStore:n,assignmentStore:s,timeAxis:i}=r,o=n.getEvents({includeOccurrences:r.enableRecurringEvents,resourceRecord:e,startDate:i.startDate,endDate:i.endDate,filter:(s.isFiltered||n.isFiltered)&&(t=>t.assignments.some((t=>t.resource===e.$original&&s.includes(t))))}),a=r.getEventsToRender(e,o)||[];return this.layoutEvents(e,a,t)}renderEvent(e,t){const{scheduler:r}=this,{resourceRecord:n,assignmentRecord:s,eventRecord:i}=e,{milestoneLayoutMode:o,milestoneTextPosition:a}=r,l=s?this.assignmentStore.getOccurrence(s,i).id:e.eventId,c={className:e.cls,style:e.style||"",children:e.children,role:"presentation",dataset:{taskFeature:"event"},syncOptions:{syncIdField:"taskBarFeature"}},d={className:e.wrapperCls,tabIndex:"tabIndex"in e?e.tabIndex:-1,children:[c,...e.wrapperChildren],style:{top:e.absoluteTop,left:e.left,height:e.fillSize?t:e.height,width:!i.isMilestone||i.meta.isDragCreating||("default"!==o||"outside"!==a&&("inside"!==a||e.width))&&"always-outside"!==a?e.width:e.height,style:e.wrapperStyle,fontSize:e.height+"px"},dataset:{resourceId:n.id,eventId:e.eventId,syncId:n.isLinked?`${l}_${n.id}`:l},elementData:e,retainElement:(null==s?void 0:s.instanceMeta(r).retainElement)||i.instanceMeta(r).retainElement,syncOptions:{syncIdField:"taskFeature",releaseThreshold:0}};return e.fillSize&&(e.height=t),e.zIndex&&(d.zIndex=e.zIndex),s&&(d.dataset.assignmentId=s.id),e.elementConfig=d,d}refreshEventsForResource(e,t=!0,r=!0){const n=this,s=n.scheduler.store.getById(e.isRow?e.id:e),i=n.scheduler.rowManager.getRowFor(s);t&&n.clearResources([s]),i&&s&&(n.renderer({row:i,record:s}),t&&r&&n.onRenderDone())}getResourceLayout(e){const t=this;let r=t.resourceMap.get(e.id);if(!r||r.invalid){if(t.suspended)return;r=t.layoutResourceEvents(e,!1),t.resourceMap.set(e.id,r)}return r}getEventDOMConfigForCurrentView(e,t,r,n){const s=this,{bufferSize:i,scheduler:o}=s,{labels:a,eventBuffer:l}=o.features,c=(null==l?void 0:l.enabled)||(null==a?void 0:a.enabled)&&(a.left||a.right||a.before||a.after),{eventsData:d}=e,u=s.fromScroll?s.rowMap.get(t):null,h=[];let g,m;for(let o=0;o<d.length;o++){const a=d[o];if(g=r,m=n,(c||0===a.width)&&(g-=i,m+=i),a.left+a.width>=g&&a.left<=m){a.absoluteTop=a.top+t.top;const r=null==u?void 0:u.find((e=>e.elementData.eventId===a.eventId));h.push(null!=r?r:s.renderEvent(a,e.rowHeight))}}return h}renderer({row:e,record:t,size:r={}}){const n=this;if(t.isSpecialRow)return void n.rowMap.delete(e);const{left:s,right:i}=n.viewportCoords,o=n.getResourceLayout(t);if(!o)return;r.height=o.rowHeight,r.transient=!0;const a=n.getEventDOMConfigForCurrentView(o,e,s,i);n.rowMap.set(e,a),n.rendererCalled=!0}onRenderDone(){var t;const{scheduler:r,rowMap:n,verticalBufferSize:s}=this,i=[],o=null!==(t=r._scrollTop)&&void 0!==t?t:0,a=o-s,l=o+r._bodyRectangle.height+s,d=s<0,u=!r.managedEventSizing;n.forEach(((t,r)=>{if(d||r.bottom>a&&r.top<l)for(let e=0;e<t.length;e++){const r=t[e],n=r.elementData,{absoluteTop:s,eventRecord:o}=n;(d||u||o.meta.isDragCreating||o.meta.isResizing||s+n.height>a&&s<l)&&i.push(r)}for(let r=0;r<t.length;r++)t[r]=e({},t[r])})),this.fromScroll=!1,this.visibleEventDOMConfigs=i,h.sync({domConfig:{onlyChildren:!0,children:i},targetElement:r.foregroundCanvas,syncIdField:"syncId",callback({action:e,domConfig:t,lastDomConfig:n,targetElement:s,jsx:i}){var o,a;const{reactComponent:l}=r,d=ge[e],u=me[e];if((d||null===(o=r.processEventContent)||void 0===o||!o.call(r,{jsx:i,action:e,domConfig:t,targetElement:s,isRelease:d,reactComponent:l}))&&"none"!==e&&null!=t&&null!==(a=t.elementData)&&void 0!==a&&a.isWrap){if(d&&null!=n&&n.elementData){var h;const{eventRecord:e,resourceRecord:t,assignmentRecord:i}=n.elementData,o={renderData:n.elementData,element:s,eventRecord:e,resourceRecord:t,assignmentRecord:i};null===(h=r.processEventContent)||void 0===h||h.call(r,{isRelease:d,targetElement:s,reactComponent:l,assignmentRecord:i}),s===c.getActiveElement(s)&&r.focusElement.focus(),r.trigger("releaseEvent",o)}if(u){const{eventRecord:n,resourceRecord:i,assignmentRecord:o}=t.elementData,a={renderData:t.elementData,element:s,isReusingElement:"reuseElement"===e,isRepaint:"reuseOwnElement"===e,eventRecord:n,resourceRecord:i,assignmentRecord:o};r.trigger("renderEvent",a)}}}})}clearResources(e){(e=E.asArray(e)).map(y.asId).forEach((e=>{const t=this.resourceMap.get(e);t&&(t.invalid=!0);const r=this.scheduler.getRowById(e);r&&this.rowMap.delete(r)}))}clearAll({clearDom:e=!1,clearLayoutCache:t=!1}={}){const r=this,{layouts:n,foregroundCanvas:s}=r.scheduler;if(t&&n)for(const e in n)n[e].clearCache();if(s&&e){s.syncIdMap=s.lastDomConfig=null;for(const e of s.children)e.lastDomConfig=e.elementData=null}r.resourceMap.clear(),r.rowMap.clear()}}t(Re,"$name","HorizontalRendering"),Re._$name="HorizontalRendering";class Ee extends(j()){static get defaultConfig(){return{coordProp:"leftFactor",sizeProp:"widthFactor"}}applyLayout(e,t,r,n,s,i){const o=this,a=i.type;return o.packEventsInBands(e,((e,s,i,l)=>{if("none"===a)e.width=t-2*r,e.left+=r;else{e.widthFactor=l;const o=e.leftFactor=i.start+s*l,c=Math.round(1/l),d=o/l,u=t-2*r-n*(c-1);"mixed"===a&&2===c?(e.left+=o*t/5+n,e.width=t-o*t/5-2*n,e.zIndex=5+d):(e.width=l*u,e.left+=o*u+r+n*d)}e.cls["b-sch-event-narrow"]=e.width<o.scheduler.narrowEventWidth}))}}Ee._$name="VerticalLayout";const ye={releaseElement:1,reuseElement:1},Ce={newElement:1,reuseOwnElement:1,reuseElement:1},Se={startDate:1,endDate:1,duration:1},De=Object.freeze({});class be extends(r.mixin(l,C)){static get properties(){return{eventMap:new Map,resourceMap:new Map,releasedElements:{},toDrawOnProjectRefresh:new Set,resourceBufferSize:1}}construct(e){this.client=this.scheduler=e,this.verticalLayout=new Ee({scheduler:e}),super.construct({})}init(){const e=this,{scheduler:t,resourceColumns:r}=e;r.resourceStore=e.resourceStore,r.ion({name:"resourceColumns",columnWidthChange:"onResourceColumnWidthChange",thisObj:e}),e.initialized=!0,t.isPainted&&e.renderer(),r.availableWidth=t.timeAxisSubGridElement.offsetWidth}resolveRowRecord(e,t){const r=this,{scheduler:n}=r,s=e.nodeType?null:e,i=s?s.target:e,o=s?[s.borderOffsetX,s.borderOffsetY]:t,a=(i.nodeType===Element.TEXT_NODE?i.parentElement:i).closest(n.eventSelector);if(a)return n.resourceStore.getById(a.dataset.resourceId);if(!i.closest(".b-sch-timeaxis-cell"))return null;if(!o)throw new Error("Vertical mode needs coordinates to resolve this element. Can also be called with a browser\n                event instead of element to extract element and coordinates from");if(n.variableColumnWidths||n.resourceStore.isGrouped){let e=0;for(const t of r.resourceStore)if(t.isSpecialRow||(e+=t.columnWidth||r.resourceColumns.columnWidth),e>=o[0])return t;return null}const l=Math.floor(o[0]/r.resourceColumns.columnWidth);return r.allResourceRecords[l]}toggleCls(e,t,r=!0,n=!1){var s;const i=null===(s=this.eventMap.get(e.eventId))||void 0===s?void 0:s[e.resourceId];if(i){i.renderData[n?"wrapperCls":"cls"][t]=r;const s=this.client.getElementFromAssignmentRecord(e,n);s&&s.classList[r?"add":"remove"](t)}}getDateFromXY(e,t,r,n=!1){let s=e[1];return r||(s=this.translateToScheduleCoordinate(s)),this.scheduler.timeAxisViewModel.getDateFromPosition(s,t,n)}translateToScheduleCoordinate(e){return e-this.scheduler.timeAxisSubGridElement.getBoundingClientRect().top-globalThis.scrollY}translateToPageCoordinate(e){return e+this.scheduler.timeAxisSubGridElement.getBoundingClientRect().top+globalThis.scrollY}getResourceEventBox(e,t){var r;const n=e.id,s=t.id;let{renderData:i}=(null===(r=this.eventMap.get(n))||void 0===r?void 0:r[s])||De;var a,l;i||(this.layoutResource(this.scheduler.resourceStore.getById(s)),i=null===(a=this.eventMap.get(n))||void 0===a||null===(l=a[s])||void 0===l?void 0:l.renderData);return i?new o(i.left,i.top,i.width,i.bottom-i.top):null}getScheduleRegion(e,t,r){var n;const s=this,{scheduler:i}=s,a=o.from(i.timeAxisSubGridElement,i.timeAxisSubGridElement);e&&(a.left=s.allResourceRecords.indexOf(e)*i.resourceColumnWidth,a.right=a.left+i.resourceColumnWidth);const l=i.timeAxis.startDate,c=i.timeAxis.endDate,d=(null===(n=i.getDateConstraints)||void 0===n?void 0:n.call(i,e,t))||{start:l,end:c},h=i.getCoordinateFromDate(u.max(l,d.start)),g=i.getCoordinateFromDate(u.min(c,d.end));return r?(a.top=h,a.bottom=g):(a.top=s.translateToPageCoordinate(h),a.bottom=s.translateToPageCoordinate(g)),a}getRowRegion(e,t,r){const{scheduler:n}=this,s=this.allResourceRecords.indexOf(e)*n.resourceColumnWidth,i=n.timeAxis.startDate,a=n.timeAxis.endDate,l=t?u.max(i,t):i,c=r?u.min(a,r):a,d=n.getCoordinateFromDate(l),h=n.getCoordinateFromDate(c,!0,!0),g=Math.min(d,h),m=Math.abs(d-h);return new o(s,g,n.resourceColumnWidth,m)}get visibleDateRange(){const e=this.scheduler,t=e.scrollable.y,r=e.scrollable.clientHeight,n=e.getDateFromCoordinate(t)||e.timeAxis.startDate,s=e.getDateFromCoordinate(t+r)||e.timeAxis.endDate;return{startDate:n,endDate:s,startMS:n.getTime(),endMS:s.getTime()}}onResourceColumnWidthChange({width:e,oldWidth:t}){const r=this,{scheduler:n}=r;r.resourceColumns.width=n.timeAxisColumn.width=r.allResourceRecords.length*e,r.clearAll(),r.refresh(Math.abs(e-t)>30)}attachToProject(e){super.attachToProject(e),e&&e.ion({name:"project",refresh:"onProjectRefresh",thisObj:this})}onProjectRefresh(){const e=this,{scheduler:t,toDrawOnProjectRefresh:r}=e;t.isVisible?t.rendered&&!t.refreshSuspended&&(e.refreshAllWhenReady?(e.clearAll(),e.refresh(),e.refreshAllWhenReady=!1):r.size&&e.refresh(),r.clear()):t.whenVisible("refresh",t,[!0])}attachToEventStore(e){super.attachToEventStore(e),this.refreshAllWhenReady=!0,e&&e.ion({name:"eventStore",refreshPreCommit:"onEventStoreRefresh",thisObj:this})}onEventStoreRefresh({action:e}){"batch"===e&&(this.refreshAllWhenReady=!0)}onEventStoreChange({action:e,records:t=[],record:r,replaced:n,changes:s,isAssign:i}){const o=this,a=new Set;switch(t.forEach((e=>{var t;const r=null===(t=e.$linkedResources)||void 0===t?void 0:t.filter((e=>o.resourceStore.includes(e)));null==r||r.forEach((e=>a.add(e.id)))})),e){case"sort":case"group":case"move":case"remove":return;case"dataset":return void o.refreshAllResourcesWhenReady();case"add":case"updateMultiple":break;case"replace":n.forEach((([,e])=>{e.resources.map((e=>a.add(e.id)))})),o.clearResources(a);break;case"removeall":case"filter":return o.clearAll(),void o.refresh();case"update":{const e=r.$entity?!Object.keys(s).some((e=>!r.$entity.getField(e))):!Object.keys(s).some((e=>!Se[e]));let t=0;return"startDate"in s&&t++,"endDate"in s&&t++,"duration"in s&&t++,void((!e||t||"percentDone"in s||"inactive"in s||"segments"in s)&&(o.clearResources(a),o.refresh()))}}o.refreshResourcesWhenReady(a)}attachToResourceStore(e){const t=this;super.attachToResourceStore(e),t.refreshAllWhenReady=!0,t.resourceColumns&&(t.resourceColumns.resourceStore=e),e.ion({name:"resourceStore",changePreCommit:"onResourceStoreChange",refreshPreCommit:"onResourceStoreRefresh",load:()=>t.scheduler.unmaskBody(),thisObj:t,prio:1}),t.initialized&&t.scheduler.isPainted&&(t.firstResource=t.lastResource=null,t.clearAll(),t.renderer())}onResourceStoreChange({source:e,action:t,records:r=[],record:n,replaced:s,changes:i}){const o=this,a=s?s.map((e=>e[1])):r,l=new Set(a.map((e=>e.id)));o.firstResource=o.lastResource=null,e._allResourceRecords=null;const{allResourceRecords:c}=e;if(o.scheduler.isEngineReady){switch(t){case"update":null!=i&&i.id?o.clearResources([i.id.oldValue,i.id.value]):o.clearResources([n.id]);break;case"filter":o.clearAll()}i&&"columnWidth"in i&&o.clearAll(),o.refresh(!0)}else{switch(t){case"dataset":case"remove":case"removeall":return void o.refreshAllResourcesWhenReady();case"replace":case"add":for(let e=a.reduce(((e,t)=>Math.min(e,c.indexOf(t))),c.length);e<c.length;e++)l.add(c[e].id)}o.refreshResourcesWhenReady(l)}}onResourceStoreRefresh({action:e}){const t=this;"sort"!==e&&"group"!==e||(t.firstResource=t.lastResource=t.resourceStore._allResourceRecords=null,t.clearAll(),t.refresh())}attachToAssignmentStore(e){super.attachToAssignmentStore(e),this.refreshAllWhenReady=!0,e&&e.ion({name:"assignmentStore",changePreCommit:"onAssignmentStoreChange",refreshPreCommit:"onAssignmentStoreRefresh",thisObj:this})}onAssignmentStoreChange({action:e,records:t=[],replaced:r,changes:n}){const s=this,i=new Set(t.map((e=>e.resourceId)));if(s.scheduler.isEngineReady){switch(e){case"remove":s.clearResources(i);break;case"filter":s.clearAll();break;case"update":if("resourceId"in n&&i.add(n.resourceId.oldValue),!Object.keys(n).filter((e=>"resource"!==e&&"event"!==e)).length)return;s.clearResources(i)}s.refresh(!0)}else{switch(n&&"resourceId"in n&&i.add(n.resourceId.oldValue),e){case"removeall":return void s.refreshAllResourcesWhenReady();case"replace":r.forEach((([e,t])=>{i.add(e.resourceId),i.add(t.resourceId)}))}s.refreshResourcesWhenReady(i)}}onAssignmentStoreRefresh({action:e,records:t}){"batch"===e&&(this.clearAll(),this.refreshAllResourcesWhenReady())}refreshRows(e){e&&(this.clearAll(),this.scheduler.refreshFromRerender=!1)}repaintEventsForResource(e){this.renderResource(e)}updateFromHorizontalScroll(e){e!==this.prevScrollX&&(this.renderer(),this.prevScrollX=e)}updateFromVerticalScroll(){this.renderer()}scrollResourceIntoView(e,t){const{scheduler:r}=this,n=this.allResourceRecords.indexOf(e)*r.resourceColumnWidth;return r.scrollHorizontallyTo(n,t)}get allResourceRecords(){return this.scheduler.resourceStore.allResourceRecords}onViewportResize(e){this.resourceColumns.availableWidth=e,this.renderer()}get resourceColumns(){var e;return null===(e=this.scheduler.timeAxisColumn)||void 0===e?void 0:e.resourceColumns}onLocaleChange(){this.clearAll()}onDragAbort(){}onBeforeRowHeightChange(){}onTimeAxisViewModelUpdate(){}updateElementId(){}releaseTimeSpanDiv(){}getConnectorStartSide(e){return"top"}getConnectorEndSide(e){return"bottom"}refreshResourcesWhenReady(e){this.clearResources(e),e.forEach((e=>this.toDrawOnProjectRefresh.add(e)))}refreshAllResourcesWhenReady(){this.clearAll(),this.refreshAllWhenReady=!0}get resourceRange(){return this.getResourceRange(!0)}get visibleResources(){const{first:e,last:t}=this.getResourceRange();return{first:this.allResourceRecords[e],last:this.allResourceRecords[t]}}getResourceRange(e){const{scheduler:t,resourceStore:r}=this,{resourceColumnWidth:n,scrollX:s}=t,{scrollWidth:i}=t.timeAxisSubGrid.scrollable,o=e?this.resourceBufferSize:0,a=s-o,l=s+i+o;if(null==r||!r.count)return{first:-1,last:-1};if(t.variableColumnWidths){let e,r,n,s=0;return this.allResourceRecords.forEach(((i,o)=>{if(i.instanceMeta(t).insetStart=n=s,s=n+i.columnWidth,n>l)return!1;s>a&&null==e?e=o:n<l&&(r=o)})),{first:e,last:r}}return{first:Math.max(Math.floor(s/n)-o,0),last:Math.min(Math.floor((s+t.timeAxisSubGrid.width)/n)+o,this.allResourceRecords.length-1)}}get dateRange(){const{scheduler:e}=this;let t=e.getDateFromCoordinate(Math.min(e.scrollTop+e.bodyHeight+e.tickSize-1,(e.virtualScrollHeight||e.scrollable.scrollHeight)-1));t||(t=e.timeAxis.last.endDate);let r=e.getDateFromCoordinate(Math.max(e.scrollTop-e.tickSize,0));return r||(r=e.timeAxis.first.startDate,t=e.getDateFromCoordinate(e.bodyHeight+e.tickSize-1)),{topDate:r,bottomDate:t}}getTimeSpanRenderData(e,t,r=!1){var n;const s=this,{scheduler:i}=s,{preamble:o,postamble:a}=e,{variableColumnWidths:l}=i,c=(null===(n=i.features.eventBuffer)||void 0===n?void 0:n.enabled)&&s.isProVerticalRendering&&(o||a)&&!e.isMilestone,d=c?"wrapStartDate":"startDate",u=c?"wrapEndDate":"endDate",h=e.isBatchUpdating&&e.hasBatchedChange(d)&&!c?e.get(d):e[d],g=e.isBatchUpdating&&e.hasBatchedChange(u)&&!c?e.get(u):e[u],m=i.getResourceMargin(t),v=i.getCoordinateFromDate(h),p=t.instanceMeta(i),f=l?p.insetStart:s.allResourceRecords.indexOf(t)*i.resourceColumnWidth,R=i.getResourceWidth(t),E=R-2*m,y=h.getTime(),C=g.getTime();let S=i.getCoordinateFromDate(g),D=S-v;return-1===S&&(D=Math.round((C-y)*i.timeAxisViewModel.getSingleUnitInPixels("millisecond")),S=v+D),{eventRecord:e,resourceRecord:t,left:f,top:v,bottom:S,resourceWidth:R,width:E,height:D,startDate:h,endDate:g,startDateMS:y,endDateMS:C,useEventBuffer:c,children:[],start:h,end:g,startMS:y,endMS:C}}eventSorter(e,t){const r=e.dataStartMs||e.startDateMS,n=e.dataEndMs||e.endDateMS,s=t.dataStartMs||t.startDateMS,i=t.dataEndMs||t.endDateMS,o=e.isModel?e.name:e.eventRecord.name,a=t.isModel?t.name:t.eventRecord.name;return r-s||i-n||(o<a?-1:o==a?0:1)}layoutResource(e){const t=this,{scheduler:r}=t,{variableColumnWidths:n}=r,{id:s}=e,o=e.instanceMeta(r),{assignmentStore:a,eventStore:l,timeAxis:c}=r,d=t.resourceMap.set(s,{}).get(s),u=t.allResourceRecords.indexOf(e),{barMargin:h,resourceMargin:g}=r.getResourceLayoutSettings(e);let m=l.getEvents({includeOccurrences:r.enableRecurringEvents,resourceRecord:e,startDate:c.startDate,endDate:c.endDate,filter:(a.isFiltered||l.isFiltered)&&(t=>t.assignments.some((t=>t.resource===e&&a.includes(t))))});m=r.getEventsToRender(e,m);const v=m.reduce(((a,l)=>{if(l.isScheduled){const c=r.generateRenderData(l,e,!1),h={renderData:c};i.getMapPath(t.eventMap,c.eventId,{})[s]=h,d[c.eventId]=h,c.fillSize?(c.left=n?o.insetStart:u*r.resourceColumnWidth,c.width=r.getResourceWidth(e)):a.push(c)}return a}),[]);return v.sort(t.eventSorter),t.verticalLayout.applyLayout(v,r.getResourceWidth(e),g,h,u,r.getEventLayout(e)),d}addTemporaryDragElement(e){const{scheduler:t}=this,r=t.generateRenderData(e,e.resource,{timeAxis:!0,viewport:!0});r.top=r.row?r.top+r.row.top:t.getResourceEventBox(e,e.resource,!0).top;const n=this.renderEvent({renderData:r}),{dataset:s}=n;delete n.tabIndex,delete s.eventId,delete s.resourceId,delete s.assignmentId,delete s.syncId,s.transient=!0,n.parent=this.scheduler.foregroundCanvas,n.retainElement=!0;const i=c.createElement(n);return i.innerElement=i.firstChild,e.instanceMeta(t).hasTemporaryDragElement=!0,i}renderEvent(e){const{scheduler:t}=this,r=e.renderData,{resourceRecord:n,assignmentRecord:s,eventRecord:i}=r,o={className:r.wrapperCls,tabIndex:-1,children:[{role:"presentation",className:r.cls,style:(r.internalStyle||"")+(r.style||""),children:r.children,dataset:{taskFeature:"event"},syncOptions:{syncIdField:"taskBarFeature"}},...r.wrapperChildren],style:{top:r.top,[t.rtl?"right":"left"]:r.left,height:i.isMilestone?"1em":r.height,width:r.width,style:r.wrapperStyle||"",fontSize:i.isMilestone?Math.min(r.width,40):null},dataset:{resourceId:n.id,eventId:r.eventId,syncId:s?this.assignmentStore.getOccurrence(s,i).id:r.eventId},elementData:e,retainElement:(s||i).instanceMeta(this.scheduler).retainElement,syncOptions:{syncIdField:"taskFeature",releaseThreshold:0}};return o.className["b-sch-vertical"]=1,r.zIndex&&(o.zIndex=r.zIndex),s&&(o.dataset.assignmentId=s.id),e.elementConfig=o,o}renderResource(e){const t=this,{topDateMS:r,bottomDateMS:n}=t,s=[];let i=t.resourceMap.get(e.id);i||(i=t.layoutResource(e));for(const e in i){const a=i[e],{endDateMS:l,startDateMS:c,eventRecord:d}=a.renderData;if(l>=r&&c<=n&&!d.instanceMeta(t.scheduler).hasTemporaryDragElement){var o;const e="b-released"!==(null===(o=a.elementConfig)||void 0===o?void 0:o.className)&&a.elementConfig||t.renderEvent(a);s.push(e)}}return s}isEventElement(e){const t=e&&e.className;return t&&t[this.scheduler.eventCls+"-wrap"]}renderer(){const e=this,{scheduler:t}=e,{first:r,last:n}=e.resourceRange,{topDate:s,bottomDate:i}=e.dateRange,o=[],a=[];if(e.initialized&&(t.isEngineReady||t.isCreating)){if(!u.isEqual(s,e.topDate)||!u.isEqual(i,e.bottomDate)){e.topDate=s,e.bottomDate=i,e.topDateMS=s.getTime(),e.bottomDateMS=i.getTime();const r=e.timeView.range={startDate:s,endDate:i};t.onVisibleDateRangeChange(r)}if(-1!==r&&-1!==n)for(let t=r;t<=n;t++)o.push.apply(o,e.renderResource(e.allResourceRecords[t]));if(t.getForegroundDomConfigs(a),o.push.apply(o,a),h.sync({domConfig:{onlyChildren:!0,children:o},targetElement:t.foregroundCanvas,syncIdField:"syncId",callback({action:r,domConfig:n,lastDomConfig:s,targetElement:i,jsx:o}){var a;const{reactComponent:l}=t;if(e.isEventElement(n)||o||null!=n&&null!==(a=n.elementData)&&void 0!==a&&a.jsx){var d;const a=ye[r],h=Ce[r];if(null!==(d=t.processEventContent)&&void 0!==d&&d.call(t,{action:r,domConfig:n,isRelease:!1,targetElement:i,reactComponent:l,jsx:o}))return;if(a&&e.isEventElement(s)&&!s.isReleased){var u;const e=s.elementData.renderData,r={renderData:e,assignmentRecord:e.assignmentRecord,eventRecord:e.eventRecord,resourceRecord:e.resourceRecord,element:i};null===(u=t.processEventContent)||void 0===u||u.call(t,{isRelease:a,targetElement:i,reactComponent:l,assignmentRecord:e.assignmentRecord}),i===c.getActiveElement(i)&&t.focusElement.focus(),t.trigger("releaseEvent",r)}if(h){const e=n.elementData.renderData,s={renderData:e,assignmentRecord:e.assignmentRecord,eventRecord:e.eventRecord,resourceRecord:e.resourceRecord,element:i,isReusingElement:"reuseElement"===r,isRepaint:"reuseOwnElement"===r};s.reusingElement="reuseElement"===r,t.trigger("renderEvent",s)}}}}),e.firstResource!==r||e.lastResource!==n){const s=e.resourceColumns.visibleResources={firstResource:r,lastResource:n};e.firstResource=r,e.lastResource=n,t.onVisibleResourceRangeChange(s),t.trigger("resourceRangeChange",s)}}}refresh(e){this.scheduler.runWithTransition((()=>this.renderer()),e)}refreshResources(e){this.clearResources(e),this.refresh()}refreshEventsForResource(e,t=!0,r=!0){this.refreshResources([e.id])}onRenderDone(){}get timeView(){return this.scheduler.timeView}clearResources(e){const{resourceMap:t,eventMap:r}=this;e.forEach((e=>{t.has(e)&&(Object.values(t.get(e)).forEach((({renderData:{eventId:t}})=>{delete r.get(t)[e]})),t.delete(e))}))}clearAll(){this.resourceMap.clear(),this.eventMap.clear()}}be._$name="VerticalRendering";const we={month:"MMMM, YYYY",week:["MMMM YYYY (Wp)","S{MMM} - E{MMM YYYY} (S{Wp})"],day:"MMMM D, YYYY"};class xe extends(B.mixin(I,z,ne,se,oe,ce,he,ie,de,W,D,b)){static get $name(){return"SchedulerBase"}static get type(){return"schedulerbase"}static get configurable(){return{date:{value:null,$config:{equal:"date"}},stepUnit:"week",range:"week",getDateConstraints:null,verticalTimeAxisColumn:{},createEventOnDblClick:!0,schedulableAreaSelector:".b-sch-timeaxis-cell",scheduledEventName:"event",sortFeatureStore:"resourceStore"}}static get defaultConfig(){return{mode:"horizontal",eventCls:"b-sch-event",timeCellCls:"b-sch-timeaxis-cell",overScheduledEventClass:"b-sch-event-hover",allowOverlap:!0,rowHeight:60,preCalculateHeightLimit:1e4,crudManagerClass:V,testConfig:{loadMaskError:{autoClose:10,showDelay:0}}}}afterConstruct(){const e=this;super.afterConstruct(),e.ion({scroll:"onVerticalScroll",thisObj:e}),e.createEventOnDblClick&&e.ion({scheduledblclick:e.onTimeAxisCellDblClick})}onPaintOverride(){}get store(){return super.store}set store(e){super.store=e}get visibleResources(){var e,t;const r=this;return r.isVertical?r.currentOrientation.visibleResources:{first:r.store.getById(null===(e=r.firstVisibleRow)||void 0===e?void 0:e.id),last:r.store.getById(null===(t=r.lastVisibleRow)||void 0===t?void 0:t.id)}}onLocaleChange(){this.currentOrientation.onLocaleChange(),super.onLocaleChange()}onTimeAxisCellDblClick({date:e,resourceRecord:t,row:r}){this.readOnly||t.isSpecialRow||t.readOnly||this.createEvent(e,t,r)}onVerticalScroll({scrollTop:e}){this.currentOrientation.updateFromVerticalScroll(e)}onEventCreated(e){}get isHorizontal(){return"horizontal"===this.mode}get isVertical(){return"vertical"===this.mode}get mode(){return this._mode}set mode(e){const t=this;t._mode=e,t[e]||(t.element.classList.add(`b-sch-${e}`),"horizontal"===e?(t.horizontal=new Re(t),t.isPainted&&t.horizontal.init()):"vertical"===e&&(t.vertical=new be(t),t.rendered&&t.vertical.init()))}get currentOrientation(){return this[this.mode]}onElementKeyDown(e){return super.onElementKeyDown(e)}onElementKeyUp(e){return super.onElementKeyUp(e)}onElementMouseOver(e){return super.onElementMouseOver(e)}onElementMouseOut(e){return super.onElementMouseOut(e)}processEventDrop(){}processCrossSchedulerEventDrop(){}beforeEventDragStart(){}afterEventDragStart(){}afterEventDragAbortFinalized(){}checkEventDragValidity(){}afterEventResizeStart(){}get hasEventEditor(){const{eventEdit:e,taskEdit:t,simpleEventEdit:r}=this.features;return Boolean((null==e?void 0:e.enabled)||(null==t?void 0:t.enabled)||(null==r?void 0:r.enabled))}editEvent(e,t,r){const n=this,{eventStore:s,assignmentStore:i}=n;if(!n.hasEventEditor)return!1;if(e.eventStore!==s){const{enableEventAnimations:r}=n,o=[];e.isCreating=!0;let a=[];if(t&&(o.push(t),a=i.assignEventToResource(e,t)),!1===n.trigger("beforeEventAdd",{eventRecord:e,resourceRecords:o,assignmentRecords:a}))return null==i||i.remove(a),!1;n.enableEventAnimations=!1,s.add(e),n.project.commitAsync().then((()=>n.enableEventAnimations=r)),n.refreshRows()}}async createEvent(e,t){var r,n,s;const i=this,{enableEventAnimations:o,features:a,eventStore:l,assignmentStore:c}=i,d=[t],h=i.createEventOnDblClick.useEventModelDefaults,g=h?l.modelClass.defaultValues.duration:1,m=h?l.modelClass.defaultValues.durationUnit:i.timeAxis.unit,v=l.createRecord({startDate:e,endDate:u.add(e,g,m),duration:g,durationUnit:m,name:i.L("L{Object.newEvent}")}),p=Boolean((null===(r=a.eventEdit)||void 0===r?void 0:r.enabled)||(null===(n=a.taskEdit)||void 0===n?void 0:n.enabled)||(null===(s=a.simpleEventEdit)||void 0===s?void 0:s.enabled));if(i.readOnly||t.isSpecialRow||!i.allowOverlap&&!i.isDateRangeAvailable(v.startDate,v.endDate,null,t))return;v.isCreating=p,i.onEventCreated(v);const f=null==c?void 0:c.assignEventToResource(v,t);!1!==i.trigger("beforeEventAdd",{eventRecord:v,resourceRecords:d,assignmentRecords:f})?(i.enableEventAnimations=!1,l.add(v),i.project.commitAsync().then((()=>i.enableEventAnimations=o)),i.isCreating=!0,i.refreshRows(),i.isCreating=!1,i.trigger("eventAutoCreated",{eventRecord:v,resourceRecord:t}),p&&i.editEvent(v,t,i.getEventElement(v))):null==c||c.remove(f)}isDateRangeAvailable(e,t,r,n){return this.eventStore.isDateRangeAvailable(e,t,r,n)}async resumeRefresh(e){super.resumeRefresh(!1);const t=this;if(!t.refreshSuspended&&e){if(!t.isEngineReady)return t.currentOrientation.refreshAllWhenReady=!0,t.project.commitAsync();t.isDestroyed||t.refreshWithTransition()}}toggleEmptyText(){const e=this;var t;e.bodyContainer&&c.toggleClasses(e.bodyContainer,"b-grid-empty",!(e.resourceStore.count>0||null!==(t=e.crudManager)&&void 0!==t&&t.isLoading))}getRowHeight(e){if(this.isHorizontal){const t=this.currentOrientation.calculateRowHeight(e);return this.rowManager.storeKnownHeight(e.id,t),t}}calculateRowHeights(e,t=!1){e.forEach((e=>e&&this.getRowHeight(e))),t||this.rowManager.estimateTotalHeight(!0)}calculateAllRowHeights(e=!1){const{store:t,rowManager:r}=this,n=Math.min(t.count,this.preCalculateHeightLimit);if(n){r.clearKnownHeights();for(let e=0;e<n;e++)this.getRowHeight(t.getAt(e));e||r.estimateTotalHeight(!0)}}get dateBounds(){const e=this,t=[e.startDate];return"week"===e.range&&t.push(e.lastDate),t}get defaultDescriptionFormat(){return we[this.range]}get lastDate(){const e=this.endDate;return e&&u.add(e,-1,"day")}getEventRecord(e){return e=c.getEventElement(e),this.resolveEventRecord(e)}getEventElement(e){return this.getElementFromEventRecord(e)}changeRange(e){return u.normalizeUnit(e)}updateRange(e){if(!this.isConfiguring){const t=this.date,r=this.date=u.startOf(t,e);t.getTime()===r.getTime()&&this.updateDate(r)}}changeStepUnit(e){return u.normalizeUnit(e)}updateDate(e){const t=this,r=u.startOf(e,t.range);t.setTimeSpan(r,u.add(r,1,t.range)),t.visibleDate={date:u.max(e,t.timeAxis.startDate),block:"start",animate:!0},t.trigger("descriptionChange")}previous(){this.date=u.add(this.date,-1,this.stepUnit)}next(){this.date=u.add(this.date,1,this.stepUnit)}async scheduleEvent({startDate:e,eventRecord:t,resourceRecord:r,element:n}){const s=this;if(s.eventStore.includes(t)||([t]=s.eventStore.add(t)),t.startDate=e,t.assign(r),n){const e=o.from(n,s.foregroundCanvas);c.setTranslateXY(n,0,0),c.setTopLeft(n,e.y,e.x),h.addChild(s.foregroundCanvas,n,t.assignments[0].id)}await s.project.commitAsync()}onSelectionDrag(e){e.target.classList.contains("b-timeaxis-cell")||super.onSelectionDrag(e)}}t(xe,"properties",{timeCellSelector:".b-sch-timeaxis-cell",resourceTimeRangeSelector:".b-sch-resourcetimerange"}),xe.initClass(),xe._$name="SchedulerBase";export{K as DependencyEdit,q as EventCopyPaste,Z as EventDrag,J as EventDragCreate,Q as EventTooltip,U as HorizontalLayoutPack,_ as HorizontalLayoutStack,Re as HorizontalRendering,G as ResourceTimeRangesBase,X as ScheduleContext,xe as SchedulerBase,ne as SchedulerDom,se as SchedulerDomEvents,ie as SchedulerEventRendering,de as SchedulerRegions,ce as SchedulerScroll,he as SchedulerState,oe as SchedulerStores,te as StickyEvents,re as TimeRanges,be as VerticalRendering,$ as VerticalTimeAxisColumn};
//# sourceMappingURL=SchedulerBase.js.map
