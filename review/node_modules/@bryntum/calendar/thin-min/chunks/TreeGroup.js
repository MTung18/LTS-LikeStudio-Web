/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{_defineProperty as e,Delayable as r,InstancePlugin as t,Rectangle as o,DomHelper as i,ObjectHelper as a}from"./Editor.js";import{GridFeatureManager as n}from"./GridBase.js";import{DragHelper as s}from"./MessageDialog.js";import{TreeColumn as l}from"./Tree.js";class d extends(r(t)){construct(e,r){this.grid=e,super.construct(...arguments)}doDestroy(){var e;null===(e=this.dragHelper)||void 0===e||e.destroy(),super.doDestroy()}init(){const e=this,{grid:r}=e;e.dragHelper=s.new({name:"rowReorder",cloneTarget:!0,dragThreshold:10,proxyTopOffset:10,targetSelector:".b-grid-row",lockX:!0,dragWithin:r.bodyContainer,allowDropOutside:!0,scrollManager:r.scrollManager,outerElement:e.targetSubGridElement,touchStartDelay:e.touchStartDelay,isElementDraggable:e.isElementDraggable.bind(e),monitoringConfig:{scrollables:[{element:r.scrollable.element,direction:"vertical"}]},setXY(e,r,t){const{context:a}=this;if(!a.started){const e=o.from(a.element,this.dragWithin),r=a.startPageY-window.pageYOffset-a.element.getBoundingClientRect().top;t=e.top+r+this.proxyTopOffset}i.setTranslateXY(e,r,t)},ignoreSamePositionDrop:!1,createProxy(e){const t=e.cloneNode(!0),o=document.createElement("div");if(o.classList.add("b-row-reorder-proxy"),t.removeAttribute("id"),t.style.transform="",o.appendChild(t),r.selectedRecords.length>1){const e=t.cloneNode(!0);e.classList.add("b-row-dragging-multiple"),o.appendChild(e)}return i.removeClsGlobally(o,"b-selected","b-hover","b-focused"),o},internalListeners:{beforedragstart:"onBeforeDragStart",dragstart:"onDragStart",drag:"onDrag",drop:"onDrop",reset:"onReset",prio:1e4,thisObj:e}},e.dragHelperConfig),e.relayEvents(e.dragHelper,["beforeDragStart","dragStart","drag","abort"],"gridRow"),e.dropIndicator=i.createElement({className:"b-row-drop-indicator"}),e.dropOverTargetCls=["b-row-reordering-target","b-hover"]}get targetSubGridElement(){const e=this.grid.regions[0];return this.grid.subGrids[e].element}isElementDraggable(e,r){if(!e.closest(".b-grid-cell .b-widget")){if(!this.gripOnly)return!0;{const t=e.closest(".b-grid-cell:first-child");if(t){const e=getComputedStyle(t,":before"),o=this.grid.rtl?t.getBoundingClientRect().width-r.borderOffsetX:r.borderOffsetX;return i.roundPx(o)<=i.roundPx(parseFloat(e.width))}}}}onBeforeDragStart({event:e,source:r,context:t}){const o=this,{grid:i}=o,a=o.targetSubGridElement;if(o.disabled||i.readOnly||i.isTreeGrouped||!a.contains(t.element))return!1;const n=t.startRecord=i.getRecordFromElement(t.element);if(n.readOnly||n.isSpecialRow)return!1;t.originalRowTop=i.rowManager.getRowFor(n).top,i.selectionMode.checkboxOnly||("touch"===r.startEvent.pointerType?i.isSelected(n)||i.selectRow({record:n,addToSelection:!1}):i.isSelected(n)||e.shiftKey||e.ctrlKey||i.selectRow({record:n}));const s=i.selectedRecords.filter((e=>!e.readOnly));return t.records=[n],s.includes(n)&&(t.records.push(...s.filter((e=>e!==n))),t.records.sort(((e,r)=>i.store.indexOf(e)-i.store.indexOf(r)))),!0}onDragStart({context:e}){var r,t;const o=this,{grid:i}=o,{cellEdit:a,cellMenu:n,headerMenu:s}=i.features;a&&(o.cellEditDisabledState=a.disabled,a.disabled=!0),null==n||null===(r=n.hideContextMenu)||void 0===r||r.call(n,!1),null==s||null===(t=s.hideContextMenu)||void 0===t||t.call(s,!1),i.element.classList.add("b-row-reordering");const l=e.element.querySelector(".b-focused");null==l||l.classList.remove("b-focused"),e.element.firstElementChild.classList.remove("b-selected","b-hover"),i.bodyContainer.appendChild(o.dropIndicator)}onDrag({context:e,event:r}){const t=this,{grid:o}=t,{store:a,rowManager:n}=o,{clientY:s}=r;let l,d,c,g,p,u=!0,f=n.getRowAt(s);if(f){const e=f.top+o._bodyRectangle.y-o.scrollable.y,i=f.height/4,n=e+i,p=e+f.height/2,u=e+3*i;d=f.dataIndex,l=a.getAt(d),a.tree?g=(l.isParent||t.dropOnLeaf)&&s>n&&s<u:a.isGrouped&&(g=l.isGroupHeader&&l.meta.collapsed),c=!g&&r.clientY>=p}else r.pageY<o._bodyRectangle.y?(d=0,l=a.first,c=!1):(d=a.count-1,l=a.last,c=!0),f=o.rowManager.getRow(d);if(l!==t.overRecord||t.after!==c||t.over!==g){var h;if(t.overRecord!==l)null===(h=n.getRowById(t.overRecord))||void 0===h||h.removeCls(t.dropOverTargetCls);t.overRecord=l,t.after=c,t.over=g,(l===e.startRecord||!c&&!g&&0===d&&a.isGrouped||c&&l.isGroupHeader&&l.meta.collapsed&&a.indexOf(l)===a.count-1)&&(u=!1),a.tree?(p=c?l.nextSibling:l,e.records.some((e=>e.contains(l)))&&(u=!1),e.parent=u&&g?l:l.parent,t.clearTimeout(t.hoverTimer),l&&l.isParent&&!l.isExpanded(a)&&(t.hoverTimer=t.setTimeout((()=>o.expand(l)),t.hoverExpandTimeout))):p=c?a.getAt(d+1):l,f.toggleCls(t.dropOverTargetCls,u&&g),!g&&d===a.indexOf(e.startRecord)+(c?-1:1)&&e.parent&&e.startRecord.parent===e.parent&&(u=!1),f&&i.setTranslateY(t.dropIndicator,Math.max(f.top+(c?f.element.getBoundingClientRect().height:0),1)),t.dropIndicator.style.visibility=g?"hidden":"visible",t.dropIndicator.classList.toggle("b-drag-invalid",!u),e.insertBefore=p,e.valid=t.reorderValid=u}else e.valid=t.reorderValid}async onDrop(e){const r=this,{context:t}=e;if(t.valid=t.valid&&r.reorderValid,t.valid){t.async=!0,r.client.store.tree&&(t.oldPositionContext=t.records.map((e=>{var r;return{record:e,parentId:null===(r=e.parent)||void 0===r?void 0:r.id,parentIndex:e.parentIndex}})));!1===await r.trigger("gridRowBeforeDropFinalize",e)&&(t.valid=!1),await r.dragHelper.animateProxyTo(r.dropIndicator,{align:"l0-l0"}),await r.finalizeReorder(t)}r.clearTimeout(r.hoverTimer),r.overRecord=r.after=r.over=null,r.trigger("gridRowDrop",e)}async finalizeReorder(e){const r=this,{grid:t}=r,{store:o,focusedCell:i}=t;let{records:a}=e;if(e.valid=e.valid&&!a.some((e=>!o.includes(e))),e.valid){let l;var n,s;if(o.tree)a=a.filter((e=>!e.parent||e.bubbleWhile((e=>!a.includes(e)),!0))),l=await e.parent.tryInsertChild(a,r.over?null===(n=e.parent.children)||void 0===n?void 0:n[0]:e.insertBefore),t.rowManager.forEach((e=>e.removeCls(r.dropOverTargetCls))),!e.parent.isExpanded()&&null!==(s=e.parent.children)&&void 0!==s&&s.length&&t.expand(e.parent),e.valid=!1!==l;else o.isGrouped&&r.over?o.move(a,o.getAt(o.indexOf(e.insertBefore)+1)):o.move(a,e.insertBefore);(null==i?void 0:i._rowIndex)>=0&&(t._focusedCell=null,t.focusCell({grid:t,record:i.record,columnId:i.columnId})),o.clearSorters()}e.finalize(e.valid),t.element.classList.remove("b-row-reordering")}onReset(){const e=this,{grid:r}=e,t=r.features.cellEdit;r.element.classList.remove("b-row-reordering"),t&&(t.disabled=e.cellEditDisabledState),e.dropIndicator.remove(),i.removeClsGlobally(r.element,...e.dropOverTargetCls)}onPaint({firstPaint:e}){e&&this.init()}updateShowGrip(e){this.grid.element.classList.toggle("b-row-reorder-with-grip",e)}}e(d,"$name","RowReorder"),e(d,"configurable",{showGrip:null,gripOnly:null,hoverExpandTimeout:1e3,touchStartDelay:300,dropOnLeaf:!1,dragHelperConfig:null}),e(d,"pluginConfig",{after:["onPaint"]}),d.featureClass="",d._$name="RowReorder",n.registerFeature(d,!1),n.registerFeature(d,!0,"Gantt");class c extends t{construct(e,r){if(super.construct(e,r),!e.hasFeature("tree"))throw new Error("The TreeGroup feature requires the Tree feature to be enabled")}processParentData(e){this.parentCls&&(e.cls=this.parentCls)}processTransformedData(e){}async waitForReadiness(){if(this.originalStore.isLoading&&(await this.originalStore.await("load",!1),this.isDestroyed))return;const{crudManager:e}=this.client;if(e){if(e.isLoadingOrSyncing&&(await e.await("requestDone"),this.isDestroyed))return;await this.client.project.commitAsync()}}async applyLevels(e){const r=this,{client:t}=r,o=t.columns.find((e=>e instanceof l));let{store:i}=t,n=null;if(r._levels=e,r.isApplying++,t.suspendRefresh(),e&&!r.originalStore&&(r.originalStore=i,i=new i.constructor({tree:!0,modelClass:i.modelClass}),t.store=i),await r.waitForReadiness(),!r.isDestroyed)return e?(i.data=r.originalStore.allRecords.flatMap((e=>e.isLeaf?[e.link()]:[])),n=i.treeify(e,(e=>{a.setPath(e,i.modelClass.getFieldDataSource(o.field),e.key),r.processParentData(e)})),r.processTransformedData(n),i.data=n.children):(t.store=r.originalStore,r.originalStore=null),r.isApplying--,t.resumeRefresh(),t.rowManager.reinitialize(),n}updateLevels(e){!e&&this.isConfiguring||this.applyLevels(e)}async group(e){a.assertArray(e,"group()"),await this.applyLevels(e)}async clearGroups(){this.isGrouped&&await this.applyLevels(null)}get isGrouped(){return Boolean(this._levels)}}e(c,"$name","TreeGroup"),e(c,"configurable",{levels:null,parentCls:"b-generated-parent"}),e(c,"pluginConfig",{assign:["group","clearGroups"]}),e(c,"properties",{isApplying:0,originalStore:null}),c._$name="TreeGroup",n.registerFeature(c);export{d as RowReorder,c as TreeGroup};
//# sourceMappingURL=TreeGroup.js.map
