/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Base as e,StringHelper as t,ObjectHelper as s,Store as n,_defineProperty as r,DateHelper as i,Collection as o,ArrayHelper as l}from"./Editor.js";import{AbstractCrudManagerMixin as c,ProjectCrudManager as a,AjaxTransport as d,JsonEncoder as g,ProjectModel as h,ResourceStore as u,EventStore as S,AssignmentStore as v,DependencyStore as m}from"./ProjectModel.js";class p extends(e.mixin(c)){get revision(){return this.crudRevision}set revision(e){this.crudRevision=e}get json(){return t.safeJsonStringify(this)}set json(e){"string"==typeof e&&(e=t.safeJsonParse(e)),this.forEachCrudStore((t=>{const s=`${t.storeId}Data`;e[s]&&(t.data=e[s])}))}static get defaultConfig(){return{stores:null}}construct(e={}){e.stores&&(e.crudStores=e.stores,delete e.stores),super.construct(e)}toJSON(){const e={};return this.forEachCrudStore(((t,s)=>e[`${s}Data`]=t.toJSON())),e}get inlineData(){return this.toJSON()}set inlineData(e){this.json=e}set stores(e){e!==this.crudStores&&(this.crudStores=e)}get stores(){return this.crudStores}get isLoading(){return this.isCrudManagerLoading}addStore(...e){return this.addCrudStore(...e)}removeStore(...e){return this.removeCrudStore(...e)}getStore(...e){return this.getCrudStore(...e)}hasChanges(...e){return this.crudStoreHasChanges(...e)}loadData(...e){return this.loadCrudManagerData(...e)}}p._$name="AbstractCrudManager";class C extends(p.mixin(a,d,g)){static get defaultConfig(){return{projectClass:h,resourceStoreClass:u,eventStoreClass:S,assignmentStoreClass:v,dependencyStoreClass:m,resourceStore:{},eventStore:{},assignmentStore:{},dependencyStore:{},project:null}}buildProject(){return new this.projectClass(this.buildProjectConfig())}buildProjectConfig(){return s.cleanupProperties({eventStore:this.eventStore,resourceStore:this.resourceStore,assignmentStore:this.assignmentStore,dependencyStore:this.dependencyStore,resourceTimeRangeStore:this.resourceTimeRangeStore})}set project(e){const t=this;e!==t._project&&(t.detachListeners("beforeDataReady"),t.detachListeners("afterDataReady"),t._project=e,e&&(t.eventStore=e.eventStore,t.resourceStore=e.resourceStore,t.assignmentStore=e.assignmentStore,t.dependencyStore=e.dependencyStore,t.timeRangeStore=e.timeRangeStore,t.resourceTimeRangeStore=e.resourceTimeRangeStore,e.ion({name:"beforeDataReady",dataReady:()=>t.suspendChangesTracking(),prio:100,thisObj:t}),e.ion({name:"afterDataReady",dataReady:()=>t.resumeChangesTracking(),prio:-100,thisObj:t})),t.eventStore||(t.eventStore={}),t.resourceStore||(t.resourceStore={}),t.assignmentStore||(t.assignmentStore={}),t.dependencyStore||(t.dependencyStore={}))}get project(){return this._project}get timeRangeStore(){var e;return null===(e=this._timeRangeStore)||void 0===e?void 0:e.store}set timeRangeStore(e){var t;this.setFeaturedStore("_timeRangeStore",e,null===(t=this.project)||void 0===t?void 0:t.timeRangeStoreClass)}get resourceTimeRangeStore(){var e;return null===(e=this._resourceTimeRangeStore)||void 0===e?void 0:e.store}set resourceTimeRangeStore(e){var t;this.setFeaturedStore("_resourceTimeRangeStore",e,null===(t=this.project)||void 0===t?void 0:t.resourceTimeRangeStoreClass)}get resourceStore(){var e;return null===(e=this._resourceStore)||void 0===e?void 0:e.store}set resourceStore(e){this.setFeaturedStore("_resourceStore",e,this.resourceStoreClass)}get eventStore(){var e;return null===(e=this._eventStore)||void 0===e?void 0:e.store}set eventStore(e){this.setFeaturedStore("_eventStore",e,this.eventStoreClass)}get assignmentStore(){var e;return null===(e=this._assignmentStore)||void 0===e?void 0:e.store}set assignmentStore(e){this.setFeaturedStore("_assignmentStore",e,this.assignmentStoreClass)}get dependencyStore(){var e;return null===(e=this._dependencyStore)||void 0===e?void 0:e.store}set dependencyStore(e){this.setFeaturedStore("_dependencyStore",e,this.dependencyStoreClass)}setFeaturedStore(e,t,s){var r;const i=this,o=null===(r=i[e])||void 0===r?void 0:r.store;var l;o!==t&&(t=n.getStore(t,(null===(l=t)||void 0===l?void 0:l.storeClass)||s),o&&i.removeStore(o),i[e]=t&&{store:t}||null,i.addPrioritizedStore(i[e]));return i[e]}getChangesetPackage(){const e=super.getChangesetPackage();return e&&this.eventStore.usesSingleAssignment&&(delete e[this.assignmentStore.storeId],!this.crudStores.some((t=>e[t.storeId])))?null:e}get crudLoadValidationMandatoryStores(){return[this._eventStore.storeId,this._resourceStore.storeId]}}r(C,"$name","CrudManager"),C._$name="CrudManager";var f=t=>class extends(t||e){static get $name(){return"PackMixin"}static get defaultConfig(){return{coordProp:"top",sizeProp:"height",inBandCoordProp:"inBandTop",inBandSizeProp:"inBandHeight"}}isSameGroup(e,t){return!this.grouped||e.group===t.group}packEventsInBands(e,t){const s=this,{coordProp:n,sizeProp:r}=s;let i,o,l,c;for(let a=0,d=e.length;a<d;a++){if(o=e[a],i=s.findStartSlot(e,o),l=s.getCluster(e,a),l.length>1){for(o[n]=i.start,o[r]=i.end-i.start,c=1;c<l.length-1&&l[c+1].start-o.start==0;)c++;const t=s.findStartSlot(e,l[c]);t&&t.start<.8&&(l.length=c)}const d=l.length,g=(i.end-i.start)/d;for(c=0;c<d;c++)t(l[c],c,i,g);a+=d-1}return 1}findStartSlot(e,t){const{inBandSizeProp:s,inBandCoordProp:n,coordProp:r,sizeProp:i}=this,o=this.getPriorOverlappingEvents(e,t);let l;if(0===o.length)return{start:0,end:1};for(l=0;l<o.length;l++){const e=o[l],t=n in e?n:r,c=s in e?s:i;if(0===l&&e[t]>0)return{start:0,end:e[t]};if(e[t]+e[c]<(l<o.length-1?o[l+1][t]:1))return{start:e[t]+e[c],end:l<o.length-1?o[l+1][t]:1}}return!1}getPriorOverlappingEvents(e,t){const s=t.start,n=t.end,r=[];for(let o=0,l=e.indexOf(t);o<l;o++){const l=e[o];this.isSameGroup(l,t)&&i.intersectSpans(s,n,l.start,l.end)&&r.push(l)}return r.sort(this.sortOverlappers.bind(this)),r}sortOverlappers(e,t){const{coordProp:s}=this;return e[s]-t[s]}getCluster(e,t){const s=e[t],n=[s];if(t>=e.length-1)return n;let{start:r,end:o}=s;for(let l=t+1,c=e.length;l<c;l++){const t=e[l];if(!this.isSameGroup(t,s)||!i.intersectSpans(r,o,t.start,t.end))break;n.push(t),r=i.max(r,t.start),o=i.min(t.end,o)}return n}};const E=e=>!e||Array.isArray(e)?e:[e],A=(e,t,s)=>e&&!0!==e[t]?e[t]:s;var R=t=>{var s;return r(s=class extends(t||e){get dateBounds(){return[this.date]}get description(){var e;const t=this,{dateBounds:s,dateFormat:n,descriptionRenderer:r}=t,o=null!==(e=t.descriptionFormat)&&void 0!==e?e:E(t.defaultDescriptionFormat);let l,c;if(r)c=t.callback(r,t,[t]);else{const e=A(o,0,n);c=i.format(s[0],e),l=s.length>1&&(null==o?void 0:o.length)>1&&i.format(s[0],e)!==i.format(s[1],e),l&&(c=i.formatRange(s,A(o,1,`S${n}${t.dateSeparator}E${n}`)))}return c}changeDescriptionFormat(e){return E(e)}get widgetClass(){}},"$name","Describable"),r(s,"configurable",{dateFormat:"MMMM d, YYYY",dateSeparator:" - ",descriptionFormat:null,descriptionRenderer:null}),s},y=t=>class extends(t||e){static get $name(){return"EventSelection"}static get configurable(){return{highlightPredecessors:!1,highlightSuccessors:!1,deselectOnClick:!1}}static get defaultConfig(){return{multiEventSelect:!1,eventSelectionDisabled:!1,eventSelectedCls:"b-sch-event-selected",triggerSelectionChangeOnRemove:!1,maintainSelectionOnDatasetChange:!0,eventAssignHighlightCls:"b-sch-event-assign-selected",selectedCollection:{}}}afterConstruct(){var e;super.afterConstruct(),null===(e=this.navigator)||void 0===e||e.ion({navigate:"onEventNavigate",thisObj:this})}set selectedCollection(e){e instanceof o||(e=new o(e)),this._selectedCollection=e,e.ion({change:(...e)=>this.project.deferUntilRepopulationIfNeeded("onSelectedCollectionChange",((...e)=>!this.isDestroying&&this.onSelectedCollectionChange(...e)),e),beforeSplice:"onBeforeSelectedCollectionSplice",thisObj:this})}get selectedCollection(){return this._selectedCollection}getActionType(e,t,s){return e.length>0?t.length>0&&s.length>0?"update":t.length>0?"select":"deselect":"clear"}getEventsFromAssignments(e){return l.unique(e.map((e=>e.event)))}get selectedEvents(){return this.getEventsFromAssignments(this.selectedCollection.values)}set selectedEvents(e){var t;const s=[];null===(t=e=l.asArray(e))||void 0===t||t.forEach((e=>{!1!==this.isEventSelectable(e)&&s.push(...e.assignments)})),this.selectedCollection.splice(0,this.selectedCollection.count,s)}get selectedAssignments(){return this.selectedCollection.values}set selectedAssignments(e){this.selectedCollection.splice(0,this.selectedCollection.count,e||[])}isEventSelected(e){const{selectedCollection:t}=this;return Boolean(t.count&&t.includes(e.assignments))}isEventSelectable(e){}isAssignmentSelected(e){return this.selectedCollection.includes(e)}select(e,t=!1){e.isAssignment?this.selectAssignment(e,t):this.selectEvent(e,t)}selectEvent(e,t=!1){this.isEventSelected(e)||this.selectEvents([e],t)}selectAssignment(e,t=!1,s){this.isAssignmentSelected(e)||(t?this.selectedCollection.add(e):this.selectedAssignments=e)}deselect(e){e.isAssignment?this.deselectAssignment(e):this.deselectEvent(e)}deselectEvent(e){this.isEventSelected(e)&&this.selectedCollection.remove(...e.assignments)}deselectAssignment(e){this.isAssignmentSelected(e)&&this.selectedCollection.remove(e)}selectEvents(e,t=!1){if(t){const t=e.reduce(((e,t)=>(!1!==this.isEventSelectable(t)&&e.push(...t.assignments),e)),[]);this.selectedCollection.add(t)}else this.selectedEvents=e}deselectEvents(e){this.selectedCollection.remove(e.reduce(((e,t)=>(e.push(...t.assignments),e)),[]))}selectAssignments(e){this.selectedCollection.add(e)}deselectAssignments(e){this.selectedCollection.remove(e)}clearEventSelection(){this.selectedAssignments=[]}onBeforeSelectedCollectionSplice({toAdd:e,toRemove:t,index:s}){const n=this,r=n._selectedCollection.values,i=e,o=t>0?i.slice(s,t+s):[],l=n.getActionType(r,i,o);return!1!==n.trigger("beforeEventSelectionChange",{action:l,selection:n.getEventsFromAssignments(r)||[],selected:n.getEventsFromAssignments(i)||[],deselected:n.getEventsFromAssignments(o)||[]})&&(!1!==n.trigger("beforeAssignmentSelectionChange",{action:l,selection:r,selected:i,deselected:o})&&void 0)}onSelectedCollectionChange({added:e,removed:t}){const s=this,n=s.selectedAssignments,r=e||[],i=t||[];function o(e,t){const n=e.event;if(n){const{eventAssignHighlightCls:r}=s,i=s.getElementFromAssignmentRecord(e);s.currentOrientation.toggleCls(e,s.eventSelectedCls,t),r&&s.getElementsFromEventRecord(n).forEach((e=>{if(e!==i){const n=s.resolveAssignmentRecord(e);s.currentOrientation.toggleCls(n,r,t),t&&(e.style.animation="none",e.offsetHeight,e.style.animation=""),e.classList.toggle(r,t)}}))}}if(i.forEach((e=>o(e,!1))),r.forEach((e=>o(e,!0))),(s.highlightSuccessors||s.highlightPredecessors)&&s.highlightLinkedEvents(s.selectedEvents),s.$selectedAssignments=n.map((e=>({eventId:e.eventId,resourceId:e.resourceId}))),!s.silent){const e=this.getActionType(n,r,i);s.trigger("assignmentSelectionChange",{action:e,selection:n,selected:r,deselected:i}),s.trigger("eventSelectionChange",{action:e,selection:s.selectedEvents,selected:s.getEventsFromAssignments(r),deselected:s.getEventsFromAssignments(i)})}}onAssignmentChange(e){super.onAssignmentChange(e);const t=this,{action:s,records:n}=e;if(t.silent=!t.triggerSelectionChangeOnRemove,"remove"===s)t.deselectAssignments(n);else if("removeall"!==s||t.eventStore.isSettingData){if("dataset"===s&&t.$selectedAssignments)if(t.maintainSelectionOnDatasetChange){const e=t.$selectedAssignments.map((e=>n.find((t=>t.eventId===e.eventId&&t.resourceId===e.resourceId))));t.selectedAssignments=l.clean(e)}else t.clearEventSelection()}else t.clearEventSelection();t.silent=!1}onInternalEventStoreChange({source:e,action:t,records:s}){e.isResourceTimeRangeStore||"dataset"!==t||s.length||this.clearEventSelection(),super.onInternalEventStoreChange(...arguments)}onAssignmentSelectionClick(e,t){const s=this;s.isAssignmentSelected(t)?(s.deselectOnClick||e.ctrlKey)&&s.deselectAssignment(t,s.multiEventSelect,e):!1!==this.isEventSelectable(t.event)&&s.selectAssignment(t,e.ctrlKey&&s.multiEventSelect,e)}onEventNavigate({event:e,item:t}){if(!this.eventSelectionDisabled){const s=t&&(t.nodeType===Element.ELEMENT_NODE?this.resolveAssignmentRecord(t):t);s?this.onAssignmentSelectionClick(e,s):this.clearEventSelection()}}changeHighlightSuccessors(e){return this.changeLinkedEvents(e)}changeHighlightPredecessors(e){return this.changeLinkedEvents(e)}changeLinkedEvents(e){const t=this;return e?(t.highlighted=t.highlighted||new Set,t.highlightLinkedEvents(t.selectedEvents)):t.highlighted&&t.highlightLinkedEvents(),e}highlightLinkedEvents(e=[]){const t=this,{highlighted:s,eventStore:n}=t,r=t.features.dependencies;s.forEach((t=>{e.includes(t)||(t.meta.highlight=!1,s.delete(t),n.includes(t)&&t.dependencies.forEach((e=>r.unhighlight(e,"b-highlight"))))})),e.forEach((e=>{const n=[e];for(;n.length;){const e=n.pop();s.add(e),t.highlightSuccessors&&e.outgoingDeps.forEach((e=>{r.highlight(e,"b-highlight"),!s.has(e.toEvent)&&n.push(e.toEvent)})),t.highlightPredecessors&&e.incomingDeps.forEach((e=>{r.highlight(e,"b-highlight"),!s.has(e.fromEvent)&&n.push(e.fromEvent)}))}s.forEach((e=>e.meta.highlight=!0))})),t.element.classList.toggle("b-highlighting",e.length>0),t.refreshWithTransition()}onEventDataGenerated(e){(this.highlightSuccessors||this.highlightPredecessors)&&(e.cls["b-highlight"]=e.eventRecord.meta.highlight),super.onEventDataGenerated(e)}updateProject(e,t){this.clearEventSelection(),super.updateProject(e,t)}doDestroy(){var e;null===(e=this._selectedCollection)||void 0===e||e.destroy(),super.doDestroy()}get widgetClass(){}};export{p as AbstractCrudManager,C as CrudManager,R as Describable,f as PackMixin,y as SchedulerEventSelection};
//# sourceMappingURL=EventSelection.js.map
