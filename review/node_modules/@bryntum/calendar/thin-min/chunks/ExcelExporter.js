/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{InstancePlugin as e,ObjectHelper as t,DomHelper as r,Base as o,DateHelper as s}from"./Editor.js";import{GridFeatureManager as n}from"./GridBase.js";import{SummaryFormatter as i}from"./PdfExport.js";class l extends(i(e)){static get $name(){return"GroupSummary"}static get configurable(){return{collapseToHeader:null,target:"footer"}}construct(e,t){if(this.grid=e,super.construct(e,t),!e.features.group)throw new Error("Requires Group feature to work, please enable");this.bindStore(e.store),e.rowManager.ion({beforeRenderRow:"onBeforeRenderRow",renderCell:"renderCell",prio:1e3,thisObj:this})}bindStore(e){this.detachListeners("store"),e.ion({name:"store",update:"onStoreUpdate",prio:1,thisObj:this})}get store(){return this.grid.store}doDisable(e){this.updateTarget(this.target),super.doDisable(e)}changeTarget(e){return t.assertString(e,"target"),e}updateTarget(e){this.store.useGroupFooters=!this.disabled&&"footer"===e,this.isConfiguring||this.store.group()}changeCollapseToHeader(e){return t.assertBoolean(e,"collapseToHeader"),e}updateCollapseToHeader(){this.isConfiguring||this.store.group()}static get pluginConfig(){return{chain:["bindStore"]}}onBeforeRenderRow({row:e,record:t}){e.isGroupFooter&&!("groupFooterFor"in t.meta)?(e.isGroupFooter=!1,e.forceInnerHTML=!0):e.isGroupHeader&&!t.meta.collapsed&&e.eachElement(this.removeSummaryElements)}removeSummaryElements(e){}renderCell({column:e,cellElement:t,row:r,record:o,size:s,isFirstColumn:n}){const i=this,{meta:l}=o,{rowHeight:a}=i.grid,u="groupRowFor"in l,p="groupFooterFor"in l,m="header"===i.target,d={"b-group-footer":0,"b-header-summary":0},c=u&&(m||i.collapseToHeader&&l.collapsed)&&!n||p&&!m;if((u||p)&&(s.height=a),i.store.isGrouped&&c&&!i.disabled){e.clearCell(t);const n=u?o:l.groupRecord;r.isGroupFooter=p,r.isGroupHeader=u,p?d["b-group-footer"]=1:d["b-header-summary"]=1;const c=i.updateSummaryHtml(t,e,n),g="number"==typeof c?c:c.count;g>1&&(s.height+=l.collapsed&&!m?0:g*a*.1),c.height&&(s.height+=c.height)}r.assignCls(d)}updateSummaryHtml(e,t,o){const s=o.groupChildren.slice();s[s.length-1].isGroupFooter&&s.pop();const n=this.generateHtml(t,s,"b-grid-group-summary",o,o.meta.groupField,o.meta.groupRowFor);return e.children.length?r.sync(n,e.firstElementChild):e.innerHTML=n,t.summaries?t.summaries.length:t.sum?1:0}onStoreUpdate({source:e,changes:t}){if(!this.disabled&&e.isGrouped){if(t&&e.groupers.find((e=>e.field in t)))return;Object.keys(t).some((e=>{const t=this.grid.columns.get(e);return Boolean(t)&&(Boolean(t.sum)||Boolean(t.summaries))}))&&(this.grid.forceFullRefresh=!0)}}refresh(){this.grid.columns.visibleColumns.forEach((e=>{this.hasSummary(e)&&this.grid.refreshColumn(e)}))}hasSummary(e){return e.sum||e.summaries}}l.featureClass="b-group-summary",l._$name="GroupSummary",n.registerFeature(l);class a extends o{static get defaultConfig(){return{target:null,defaultColumnWidth:100,exportDateAsInstance:!0,showGroupHeader:!0,columns:null,indent:!0,indentationSymbol:"    "}}export(e={}){const r=this;return e=t.assign({},r.config,e),r.normalizeColumns(e),r.generateExportData(e)}generateExportData(e){const t=this.generateColumns(e);return{rows:this.generateRows(e),columns:t}}normalizeColumns(e){const t=e.columns||this.target.columns.visibleColumns.filter((e=>!1!==e.exportable));e.columns=t.map((e=>"string"==typeof e?this.target.columns.find((t=>t.field===e))||{field:e}:e))}generateColumns(e){return e.columns.map((t=>this.processColumn(t,e)))}generateRows(e){const{columns:t,rows:r}=e;if(0===t.length||0===(null==r?void 0:r.length))return[];const o=this,{target:s}=o;return(r||s.store).map((r=>o.processRecord(r,t,e))).filter((e=>null==e?void 0:e.length))}getColumnType(e,t=this.target.store){let r=e.exportedType||"object";if(void 0===e.exportedType&&e.field){const o=t.modelClass.getFieldDefinition(e.field);o&&"auto"!==o.type&&(r=o.type)}return r}processColumn(e,t){const{target:r}=this,{defaultColumnWidth:o}=t;let{field:s,text:n,width:i,minWidth:l}=e;if(s in r.store.modelClass.fieldMap||(s=""),!n||!i){const e=r.columns.find((e=>e.field===s));n||(n=e&&e.text||s),null==i&&(i=e&&e.width||o)}return i=Math.max(i||o,l||o),{field:s,value:n,width:i,type:this.getColumnType(e)}}processRecord(e,t,o){const{target:s}=this,{showGroupHeader:n,indent:i,indentationSymbol:l}=o;let a;return e?e.isSpecialRow?n&&e.meta.groupRowFor&&(a=t.map((t=>s.features.group.buildGroupHeader({cellElement:r.createElement(),grid:s,record:e,column:t})))):a=t.map((t=>{var r;let n=null!==(r=t.field)&&void 0!==r&&r.includes(".")?e.get(t.field):e[t.field];const a=t.renderer||t.defaultRenderer;return!a||n&&t.isDateColumn&&o.exportDateAsInstance||(n=a.call(t,{value:n,record:e,column:t,grid:s,isExport:!0})),i&&t.tree&&(n=`${l.repeat(e.childLevel)}${n}`),n})):a=t.map((()=>"")),a}}a._$name="TableExporter";class u{constructor(e){this._value=e}get value(){return this._value}toString(){return Boolean(this.value)?"✓":""}}u._$name="BooleanUnicodeSymbol";class p extends e{static get $name(){return"ExcelExporter"}static get defaultConfig(){return{filename:null,dateFormat:"YYYY-MM-DD",exporterClass:a,exporterConfig:null,zipcelx:null,convertEmptyValueToEmptyString:!0}}processValue(e){return null==e||Number.isNaN(e)||"function"==typeof e||"object"==typeof e&&"[object Object]"===String(e)?"":e}generateExportData(e){const t=this,{rows:r,columns:o}=t.exporter.export(e.exporterConfig);return{rows:r.map((r=>r.map(((r,n)=>{var i;r instanceof Date?r=s.format(r,e.dateFormat):"boolean"==typeof r&&(r=new u(r)),t.convertEmptyValueToEmptyString&&(r=t.processValue(r));return{value:r,type:"number"===(null===(i=o[n])||void 0===i?void 0:i.type)?"number":"string"}})))),columns:o.map((e=>{let{field:t,value:r,width:o,type:s}=e;return s="string",{field:t,value:r,width:o,type:s}}))}}export(e={}){const r=this,o=r.zipcelx||globalThis.zipcelx;if(!o)throw new Error('ExcelExporter: "zipcelx" library is required');if(r.disabled)return;(e=t.assign({},r.config,e)).filename||(e.filename=r.client.$$name);const{filename:s}=e,{rows:n,columns:i}=r.generateExportData(e);return o({filename:s,sheet:{data:[i].concat(n),cols:i}})}construct(e,t){super.construct(e,t),this.zipcelx||"undefined"!=typeof zipcelx&&(this.zipcelx=globalThis.zipcelx)}get exporter(){const e=this;return e._exporter||(e._exporter=e.exporterClass.new({target:e.client},e.exporterConfig))}}p._$name="ExcelExporter",n.registerFeature(p,!1,"Grid");export{p as ExcelExporter,l as GroupSummary,a as TableExporter};
//# sourceMappingURL=ExcelExporter.js.map
