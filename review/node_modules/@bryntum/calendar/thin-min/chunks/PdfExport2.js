/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{ColumnStore as e,Column as t,GridFeatureManager as r}from"./GridBase.js";import{VersionHelper as a,StringHelper as s,InstancePlugin as n,Editor as i,EventHelper as o,DateHelper as l,DomHelper as c,DomSync as d,Tooltip as u,Rectangle as m,Combo as h,Field as g,ObjectHelper as p}from"./Editor.js";import{AvatarRendering as f}from"./AvatarRendering.js";import{Summary as b,MultiPageExporter as v,MultiPageVerticalExporter as x,ExportDialog as E,SinglePageExporter as w,PdfExport as y}from"./PdfExport.js";class C extends t{static get $name(){return"ResourceInfoColumn"}static get type(){return"resourceInfo"}static get fields(){return["showEventCount","showRole","showMeta","showImage","validNames","autoScaleThreshold","useNameAsImageName"]}static get defaults(){return{showImage:!0,showEventCount:!0,showMeta:null,showRole:!1,validNames:null,autoScaleThreshold:40,useNameAsImageName:!0,field:"name",htmlEncode:!1,width:140,cellCls:"b-resourceinfo-cell",editor:!a.isTestEnv&&"text"}}construct(...e){super.construct(...e),this.avatarRendering=new f({element:this.grid.element})}doDestroy(){super.doDestroy(),this.avatarRendering.destroy()}getImageURL(e){const t=this.grid.resourceImagePath||"",r=t.split("//"),a=r.length>1?r[1]:t,n=s.joinPaths([a||"",e||""]);return r.length>1?r[0]+"//"+n:n}template(e,t){const r=this,{showImage:a,showRole:s,showMeta:n,showEventCount:i,grid:o}=r,{timeAxis:l,resourceImageExtension:c="",defaultResourceImageName:d}=o,u="string"==typeof s?s:"role",m=i&&e.eventStore.getEvents({includeOccurrences:o.enableRecurringEvents,resourceRecord:e,startDate:l.startDate,endDate:l.endDate}).length;let h;if(a&&!1!==e.image)if(e.imageUrl)h=e.imageUrl;else{const s="string"==typeof a?a:e.image||t&&r.useNameAsImageName&&t.toLowerCase()+c||d||"";h=s&&r.getImageURL(s),h&&!s.includes(".")&&(r.validNames&&!r.validNames.includes(s)||(h+=c))}return{class:"b-resource-info",children:[a&&r.avatarRendering.getResourceAvatar({resourceRecord:e,initials:e.initials,color:e.eventColor,iconCls:e.iconCls,imageUrl:h,defaultImageUrl:d&&this.getImageURL(d)}),s||i||n?{tag:"dl",children:[{tag:"dt",text:t},s?{tag:"dd",class:"b-resource-role",text:e[u]}:null,i?{tag:"dd",class:"b-resource-events",html:r.L("L{eventCountText}",m)}:null,n?{tag:"dd",class:"b-resource-meta",html:r.showMeta(e)}:null]}:t]}}defaultRenderer({grid:e,record:t,cellElement:r,value:a,isExport:s}){let n;return t.isSpecialRow?n="":s?n=a:(this.autoScaleThreshold&&e.rowHeight<this.autoScaleThreshold?r.style.fontSize=e.rowHeight/40+"em":r.style.fontSize="",n=this.template(t,a)),n}}e.registerColumnType(C),C._$name="ResourceInfoColumn";const S=["top","before","after","bottom"],R=(e,t)=>{switch(e){case"top":return"b-b";case"after":return t.rtl?"r-r":"l-l";case"right":return"l-l";case"bottom":return"t-t";case"before":return t.rtl?"l-l":"r-r";case"left":return"r-r"}},L={top:1,bottom:1},M={estimate:1,measure:1},D={before:1,after:1};class T extends n{static get $name(){return"Labels"}static get configurable(){return{labelCls:"b-sch-label",top:null,after:null,right:null,bottom:null,before:null,left:null,thisObj:null,blurAction:"cancel",labelLayoutMode:"default",labelCharWidth:7}}static get pluginConfig(){return{chain:["onEventDataGenerated"]}}construct(e,t){const r=this;if(e.isVertical)throw new Error("Labels feature is not supported in vertical mode");r.scheduler=e,super.construct(e,t),(r.top||r.bottom||r.before||r.after)&&r.updateHostClasslist()}updateHostClasslist(){const{top:e,bottom:t}=this,{classList:r}=this.scheduler.element;r.remove("b-labels-topbottom"),r.remove("b-labels-top"),r.remove("b-labels-bottom"),(e||t)&&(r.add("b-labels-topbottom"),e&&r.add("b-labels-top"),t&&r.add("b-labels-bottom"))}onLabelDblClick(e){const t=this,r=e.target;if(r&&!t.scheduler.readOnly){const{side:a}=r.dataset,s=t[a],{editor:n,field:o}=s;if(n){const l=this.scheduler.resolveEventRecord(e.target);if(l.readOnly)return;return n instanceof i||(s.editor=new i({blurAction:t.blurAction,inputField:n,scrollAction:"realign"})),s.editor.render(t.scheduler.element),s.editor.startEdit({target:r,align:R(a,t.client),matchSize:!1,record:l,field:o}),e.stopImmediatePropagation(),!1}}}changeTop(e){return this.processLabelSpec(e,"top")}updateTop(){this.updateHostClasslist()}changeAfter(e){return this.processLabelSpec(e,"after")}updateAfter(){this.updateHostClasslist()}changeRight(e){this[this.client.rtl?"before":"after"]=e}changeBottom(e){return this.processLabelSpec(e,"bottom")}updateBottom(){this.updateHostClasslist()}changeBefore(e){return this.processLabelSpec(e,"before")}updateBefore(){this.updateHostClasslist()}changeLeft(e){this[this.client.rtl?"after":"before"]=e}processLabelSpec(e,t){if("function"==typeof e)e={renderer:e};else if("string"==typeof e)e={field:e};else{if(!e)return null;e=Object.setPrototypeOf({},e)}const{scheduler:r}=this,{eventStore:a,resourceStore:s,taskStore:n,id:i}=r,{field:l,editor:c}=e;if(L[t]&&(r.milestoneWidth=null),e.recordType=a&&!n?"event":"task",l){let t;a&&!n&&(t=a.modelClass.fieldMap[l],t?(e.fieldDef=t,e.recordType="event"):Reflect.has(a.modelClass.prototype,l)&&(e.recordType="event")),!t&&n&&(t=n.modelClass.fieldMap[l],t?(e.fieldDef=t,e.recordType="task"):Reflect.has(s.modelClass.prototype,l)&&(e.recordType="task")),!t&&s&&(t=s.modelClass.fieldMap[l],t?(e.fieldDef=t,e.recordType="resource"):Reflect.has(s.modelClass.prototype,l)&&(e.recordType="resource")),c&&("boolean"==typeof c?r.editor={type:"textfield"}:"string"==typeof c&&(r.editor={type:c}),o.on({element:r.timeAxisSubGrid.element,delegate:".b-sch-label",dblclick:"onLabelDblClick",thisObj:this}))}return e}doDisable(e){super.doDisable(e),this.client.isPainted&&this.client.refresh()}generateLabelConfigs(e){const t=this,r=[];for(const a of S)if(t[a]){const{field:n,fieldDef:i,recordType:o,renderer:c,thisObj:d}=t[a],u={tag:"label",className:{[t.labelCls]:1,[`${t.labelCls}-${a}`]:1},dataset:{side:a,taskFeature:`label-${a}`}};let m;const h=`${o}Record`,g=e[h];c?m=c.call(d||t.thisObj||t,{[h]:g,resourceRecord:e.resourceRecord,assignmentRecord:e.assignmentRecord,domConfig:u}):(m=g[n],m="date"!==(null==i?void 0:i.type)||c?s.encodeHtml(m):l.format(m,t.client.displayDateFormat)),u.html=m||"Â ",r.push(u)}return r}measureLabels(e,t){const r=this,a=r.client.timeAxisViewModel.getSingleUnitInPixels("millisecond");for(const s of e)if(D[s.dataset.side]){let{html:e}=s,n=0;if("estimate"===r.labelLayoutMode)e.includes("<")&&(e=c.stripTags(e)),n=e.length*r.labelCharWidth+18;else{const e=r.labelMeasureElement||(r.labelMeasureElement=c.createElement({className:"b-sch-event-wrap b-measure-label",parent:r.client.foregroundCanvas}));e.retainElement=!0,d.sync({targetElement:e,childrenOnly:!0,domConfig:{children:[s]}}),n=e.firstElementChild.offsetWidth}const i=n/a;switch(s.dataset.side){case"before":t.startMS-=i;break;case"after":t.endMS+=i}}}onEventDataGenerated(e){var t;if(!(this.disabled||null!==(t=e.eventRecord)&&void 0!==t&&t.isResourceTimeRange)){const t=this.generateLabelConfigs(e);M[this.labelLayoutMode]&&this.measureLabels(t,e),e.wrapperChildren.push(...t)}}updateLabelLayoutMode(){this.isConfiguring||this.client.refreshWithTransition()}updateLabelCharWidth(){this.isConfiguring||this.client.refreshWithTransition()}}T.featureClass="b-sch-labels",T._$name="Labels",r.registerFeature(T,!1,"Scheduler");class P extends b{static get $name(){return"TimelineSummary"}static get configurable(){return{showTooltip:!0}}static get pluginConfig(){return{chain:["renderRows","updateProject"]}}construct(e,t){const r=this;super.construct(e,t),r.summaries||(r.summaries=[{renderer:r.renderer}]),e.isTimelineBase&&(r.updateProject(e.project),e.ion({timeAxisViewModelUpdate:r.renderRows,thisObj:r}))}updateProject(e){this.detachListeners("summaryProject"),e.ion({name:"summaryProject",dataReady:"updateTimelineSummaries",thisObj:this})}renderRows(){this.client.isHorizontal&&this.client.timeAxisSubGrid.footer.element.querySelector(".b-grid-footer").classList.add("b-sch-summarybar"),super.renderRows(),this.disabled||this.render()}get summaryBarElement(){return this.client.element.querySelector(".b-sch-summarybar")}render(){const e=this,{client:t}=e,r=t.isHorizontal?"width":"height",a=t.timeAxisViewModel.columnConfig,s=e.summaryBarElement;s&&(!e._tip&&e.showTooltip&&e.summaries.some((e=>e.label))&&(e._tip=new u({id:`${t.id}-summary-tip`,cls:"b-timeaxis-summary-tip",hoverDelay:0,hideDelay:100,forElement:s,anchorToTarget:!0,trackMouse:!1,forSelector:".b-timeaxis-tick",getHtml:({activeTarget:e})=>e._tipHtml})),s.innerHTML=a[a.length-1].map((e=>`<div class="b-timeaxis-tick" style="${r}: ${e.width}px"></div>`)).join(""),e.updateTimelineSummaries())}refresh(){super.refresh(),this.updateTimelineSummaries()}doDisable(e){var t;const{isConfiguring:r}=this.client;super.doDisable(e),null===(t=this.summaryColumn)||void 0===t||t.toggle(!e),r||e||this.render()}doDestroy(){var e;null===(e=this._tip)||void 0===e||e.destroy(),super.doDestroy()}}P._$name="TimelineSummary";const A={completeview:"completeview",currentview:"currentview",daterange:"daterange"},H=Promise.resolve();var j=e=>class extends e{async scrollRowIntoView(e,t){const{rowManager:r,scrollable:a}=e,s=a.y;return t<e.store.count&&(a.scrollTo(null,r.calculateTop(t)),a.y!==s)?new Promise((a=>{const s=e.ion({scroll({scrollTop:e}){null!=e&&r.getRow(t)&&(s(),a())}})})):H}async scrollToDate(e,t){let r=!1;const a=[],s=e.timeAxisSubGrid.scrollable.ion({scrollStart({x:e}){null!=e&&(r=!0)}});a.push(e.scrollToDate(t,{block:"start"})),s(),r&&a.push(e.timeAxisSubGrid.header.scrollable.await("scrollEnd",{checkLog:!1})),await Promise.all(a)}cloneElement(e,t,r){super.cloneElement(e,t,r);const a=this.element.querySelector(".b-schedulerbase");null==a||a.classList.remove(...["fade-in","slide-from-left","slide-from-top","zoom-in"].map((e=>`b-initial-${e}`)))}async prepareComponent(e){const t=this,{client:r}=e,{currentOrientation:a}=r,s=r.timeAxisSubGrid.width>0;switch(e.scheduleRange){case A.completeview:e.rangeStart=r.startDate,e.rangeEnd=r.endDate;break;case A.currentview:{const{startDate:t,endDate:a}=r.visibleDateRange;e.rangeStart=t,e.rangeEnd=a;break}}await r.waitForAnimations(),e.infiniteScroll=r.infiniteScroll,r.infiniteScroll=!1,s&&(r.setTimeSpan(e.rangeStart,e.rangeEnd),r.svgCanvas),t._oldEnableEventAnimations=r.enableEventAnimations,r.enableEventAnimations=!1,a.isHorizontalRendering&&(t._oldScrollBuffer=a.scrollBuffer,t._oldVerticalBuffer=a.verticalBufferSize,a.scrollBuffer=100,a.verticalBufferSize=-1),r.ignoreViewBox=!0,await super.prepareComponent(e);const{exportMeta:n,element:i}=t,o=i.querySelector(".b-sch-foreground-canvas"),d=i.querySelector(".b-horizontaltimeaxis");if(n.includeTimeline=s,s&&e.scheduleRange!==A.completeview){n.totalWidth-=n.subGrids.normal.width,n.totalWidth+=n.subGrids.normal.width=r.timeAxisViewModel.getDistanceBetweenDates(e.rangeStart,e.rangeEnd);const t=Math.ceil(n.totalWidth/n.pageWidth),a=t*n.verticalPages;n.horizontalPages=t,n.totalPages=a,n.subGrids.normal.scrollLeft=r.getCoordinateFromDate(e.rangeStart)}if(n.timeAxisHeaders=[],n.timeAxisPlaceholders=[],n.headersColleted=!1,c.forEachSelector(d,".b-sch-header-row",(e=>{n.timeAxisPlaceholders.push(t.createPlaceholder(e)),n.timeAxisHeaders.push(new Map)})),n.subGrids.normal.eventsPlaceholder=t.createPlaceholder(o,!1),c.removeEachSelector(o,".b-sch-event-wrap,.b-sch-resourcetimerange"),c.removeEachSelector(t.element,".b-released"),n.eventsBoxes=new Map,n.client=r,r.hasActiveFeature("columnLines")){const e=i.querySelector(".b-column-lines-canvas");n.columnLinesPlaceholder=t.createPlaceholder(e),n.columnLines={lines:new Map,majorLines:new Map}}if(r.hasActiveFeature("timeRanges")){const e=i.querySelector(".b-sch-timeaxiscolumn .b-sch-timeranges-canvas"),r=i.querySelector(".b-sch-foreground-canvas .b-sch-timeranges-canvas");n.timeRanges={},e&&(n.timeRanges.header={},n.timeRangesHeaderPlaceholder=t.createPlaceholder(e)),n.timeRanges.body={},n.timeRangesBodyPlaceholder=t.createPlaceholder(r)}if(r.hasActiveFeature("dependencies")){r.features.dependencies.fillDrawingCache();const e=i.querySelector(`[id="${r.svgCanvas.getAttribute("id")}"]`);e&&(n.dependencyCanvasEl=e,n.dependenciesPlaceholder=t.createPlaceholder(e,!1,{ns:"http://www.w3.org/2000/svg",tag:"path"}),c.removeEachSelector(e,".b-sch-dependency"))}s&&!l.betweenLesser(e.rangeStart,r.startDate,r.endDate)&&await t.scrollToDate(r,e.rangeStart)}async restoreState(e){let t=!1;const{client:r}=e,a=[],s=r.timeAxisSubGrid.scrollable.ion({scrollStart({x:e}){this.element.scrollLeft!==e&&(t=!0)}});a.push(super.restoreState(e)),s(),t&&a.push(r.timeAxisSubGrid.header.scrollable.await("scrollEnd",{checkLog:!1})),await Promise.all(a)}async restoreComponent(e){const{client:t}=e,{currentOrientation:r}=t;t.ignoreViewBox=!1,t.infiniteScroll=e.infiniteScroll,t.enableEventAnimations=this._oldEnableEventAnimations,r.isHorizontalRendering&&(r.scrollBuffer=this._oldScrollBuffer,r.verticalBufferSize=this._oldVerticalBuffer),await super.restoreComponent(e)}async onRowsCollected(e,t){const r=this;if(await super.onRowsCollected(e,t),r.exportMeta.includeTimeline){const{client:a,enableDirectRendering:s}=t,{timeView:n}=a,{pageRangeStart:i,pageRangeEnd:o}=r.getCurrentPageDateRange(t);if(s)i&&o&&(r.renderHeaders(t,i,o),r.renderLines(t,i,o),r.renderRanges(t,i,o),r.renderEvents(t,e,i,o));else{if(i){let s=!1;for(await r.scrollToDate(a,i);!s;)if(r.collectLines(t),r.collectHeaders(t),r.collectRanges(t),r.collectEvents(e,t),l.timeSpanContains(n.startDate,n.endDate,i,o))s=!0;else if(n.endDate.getTime()>=o.getTime())s=!0;else{const e=n.endDate;if(await r.scrollToDate(a,n.endDate),e.getTime()===n.endDate.getTime())throw new Error("Could not scroll to date")}}await r.scrollToDate(a,t.rangeStart)}}}getCurrentPageDateRange({rangeStart:e,rangeEnd:t,enableDirectRendering:r,client:a}){const{exportMeta:s}=this,{horizontalPages:n,horizontalPosition:i,pageWidth:o,subGrids:l}=s;let c,d;if(n>1){const e=i*o,s=(i+1)*o,n=l.locked.width+l.locked.splitterWidth;if(s<=n)d=c=null;else{const{scrollLeft:i=0}=l.normal;c=a.getDateFromCoordinate(Math.max(e-n+i,0));const o=r?1:1.2;d=a.getDateFromCoordinate((s-n+i)*o)||t}}else c=e,d=t;return{pageRangeStart:c,pageRangeEnd:d}}prepareExportElement(){const{element:e,exportMeta:t}=this,{id:r,headerId:a,footerId:s,scrollLeft:n}=t.subGrids.normal,i=e.querySelector(`[id="${r}"]`);return[".b-sch-background-canvas",".b-sch-foreground-canvas"].forEach((e=>{const r=i.querySelector(e);r&&(t.lastExportedRowBottom?r.style.height=`${t.lastExportedRowBottom}px`:r.style.height="",n&&(r.style.marginLeft=`-${n}px`))})),n&&[a,s].forEach((t=>{const r=e.querySelector(`[id="${t}"] .b-widget-scroller`);r&&(r.style.marginLeft=`-${n}px`)})),super.prepareExportElement()}collectHeaders(e){const{client:t}=e,{exportMeta:r}=this;if(!r.headersCollected){const e=t.timeView.element,a=r.timeAxisHeaders;c.forEachSelector(e,".b-sch-header-row",((e,s,n)=>{const i=a[s];c.forEachSelector(e,".b-sch-header-timeaxis-cell",(e=>{i.has(e.dataset.tickIndex)||i.set(e.dataset.tickIndex,e.outerHTML)})),s===n.length-1&&i.has(String(t.timeAxis.count-1))&&(r.headersCollected=!0)}))}}collectRanges(e){const{client:t}=e,{exportMeta:r}=this,{timeRanges:a}=r;if(!r.headersCollected&&a){const{headerCanvas:e,bodyCanvas:r}=t.features.timeRanges;e&&c.forEachSelector(e,".b-sch-timerange",(e=>{a.header[e.dataset.id]=e.outerHTML})),c.forEachSelector(r,".b-sch-timerange",(e=>{a.body[e.dataset.id]=e.outerHTML}))}}collectLines(e){const{client:t}=e,{exportMeta:r}=this,{columnLines:a}=r;if(!r.headersCollected&&a){const e=t.backgroundCanvas;c.forEachSelector(e,".b-column-line, .b-column-line-major",(e=>{if(e.classList.contains("b-column-line")){const t=Number(e.dataset.line.replace(/line-/,""));a.lines.set(t,e.outerHTML)}else{const t=Number(e.dataset.line.replace(/major-/,""));a.majorLines.set(t,e.outerHTML)}}))}}collectEvents(e,t){const r=e.length,{client:a}=t,s=this.exportMeta.subGrids.normal.rows;e.forEach(((e,t)=>{var n,i;const o=s[s.length-r+t],l=a.store.getAt(e.dataIndex),c=o[3];null===(n=l.events)||void 0===n||n.forEach((e=>{if(e.isScheduled){let t=a.getElementFromEventRecord(e,l);t&&(t=t.parentElement)&&!c.has(e.id)&&c.set(e.id,[t.outerHTML,m.from(t,t.offsetParent)])}})),null===(i=l.timeRanges)||void 0===i||i.forEach((e=>{var t;const r=(null===(t=a.features.resourceTimeRanges)||void 0===t?void 0:t.generateElementId(e))||"",s=a.foregroundCanvas.syncIdMap[r];s&&!c.has(r)&&c.set(r,[s.outerHTML,m.from(s,s.offsetParent)])}))}))}renderHeaders(e,t,r){const{exportMeta:a}=this,{client:s}=e,n=a.timeAxisHeaders,{timeAxisView:i}=s.timeAxisColumn,o=i.buildCells(t,r),l=document.createElement("div");d.sync({targetElement:l,domConfig:o}),c.forEachSelector(l,".b-sch-header-row",((e,t)=>{const r=n[t];c.forEachSelector(e,".b-sch-header-timeaxis-cell",(e=>{r.has(e.dataset.tickIndex)||r.set(e.dataset.tickIndex,e.outerHTML)}))}))}renderEvents(e,t,r,a){const{client:s}=e,n=this.exportMeta.subGrids.normal.rows;t.forEach(((e,t)=>{const i=n[t][3],o=s.store.getAt(e.dataIndex),l=s.currentOrientation.getResourceLayout(o),c=s.getCoordinateFromDate(r),u=s.getCoordinateFromDate(a),h=s.currentOrientation.getEventDOMConfigForCurrentView(l,e,c,u),g=document.createElement("div");h.forEach((e=>{const{eventId:t}=e.dataset,{left:r,top:a,width:s,height:n}=e.style;d.sync({targetElement:g,domConfig:e}),i.set(t,[g.outerHTML,new m(r,a,s,n)])}))}))}renderLines(e,t,r){const{client:a}=e,{exportMeta:s}=this,{columnLines:n}=s;if(n){const e=a.features.columnLines.getColumnLinesDOMConfig(t,r),s=document.createElement("div");d.sync({targetElement:s,domConfig:{children:e},onlyChildren:!0}),n.lines.set(0,s.innerHTML)}}renderRanges(e,t,r){const{client:a}=e,{exportMeta:s}=this,{timeRanges:n}=s;if(n){const e=a.features.timeRanges.getDOMConfig(t,r),s=document.createElement("div");e.forEach(((e,t)=>{d.sync({targetElement:s,domConfig:{children:e,onlyChildren:!0}}),0===t?n.body=s.innerHTML:n.header=s.innerHTML}))}}buildPageHtml(e){const t=this,{subGrids:r,timeAxisHeaders:a,timeAxisPlaceholders:s,columnLines:n,columnLinesPlaceholder:i,timeRanges:o,timeRangesHeaderPlaceholder:l,timeRangesBodyPlaceholder:c}=t.exportMeta,{enableDirectRendering:d}=e;let u=t.prepareExportElement();if(Object.values(r).forEach((({placeHolder:r,eventsPlaceholder:a,rows:s,mergedCellsHtml:n})=>{const i=r.outerHTML,{resources:o,events:l}=t.positionRows(s,e);let c=o.join("");null!=n&&n.length&&(c+=`<div class="b-grid-merged-cells-container">${n.join("")}</div>`),u=u.replace(i,c),a&&(u=u.replace(a.outerHTML,l.join("")))})),a.forEach(((e,t)=>{u=u.replace(s[t].outerHTML,Array.from(e.values()).join(""))})),n){const e=Array.from(n.lines.values()).concat(Array.from(n.majorLines.values()));u=u.replace(i.outerHTML,e.join("")),d&&(t.exportMeta.columnLines.lines.clear(),t.exportMeta.columnLines.majorLines.clear())}return o&&(d?(u=u.replace(c.outerHTML,o.body),l&&(u=u.replace(l.outerHTML,o.header)),t.exportMeta.timeRanges={}):(u=u.replace(c.outerHTML,Object.values(o.body).join("")),l&&(u=u.replace(l.outerHTML,Object.values(o.body).join(""))))),u=t.buildDependenciesHtml(u),u}getEventBox(e){const{eventsBoxes:t,enableDirectRendering:r}=this.exportMeta,a=e&&t.get(String(e.id));return r&&a&&e.isMilestone&&a.translate(-a.width/2,0),a}renderDependencies(){const e=this,{client:t,eventsBoxes:r}=e.exportMeta,{dependencies:a}=t,s=t.features.dependencies,n=c.createElement();let i=!1;return a.forEach((t=>{if(!r.has(String(t.from))&&!r.has(String(t.to))||!s.isDependencyVisible(t))return;const a=e.getEventBox(t.fromEvent),n=e.getEventBox(t.toEvent);s.drawDependency(t,!0,{from:null==a?void 0:a.clone(),to:null==n?void 0:n.clone()}),i=!0})),i&&s.domSync(n),n.innerHTML}buildDependenciesHtml(e){const{dependenciesPlaceholder:t,includeTimeline:r}=this.exportMeta;if(t&&r){const r=t.outerHTML;e=e.replace(r,this.renderDependencies())}return e}};class B extends(j(v)){static get $name(){return"MultiPageExporter"}static get type(){return"multipage"}async stateNextPage(e){await super.stateNextPage(e),this.exportMeta.eventsBoxes.clear()}positionRows(e){const t=[],r=[];return e.forEach((([e,a,s,n])=>{t.push(e),n&&Array.from(n.entries()).forEach((([e,[t,a,s=[]]])=>{r.push(t+s.join("")),this.exportMeta.eventsBoxes.set(String(e),a)}))})),{resources:t,events:r}}}B._$name="MultiPageExporter";class $ extends(j(x)){static get $name(){return"MultiPageVerticalExporter"}static get type(){return"multipagevertical"}async stateNextPage(e){await super.stateNextPage(e),this.exportMeta.eventsBoxes.clear()}async prepareComponent(e){await super.prepareComponent(e),e.scheduleRange!==A.completeview&&this.estimateTotalPages(e)}positionRows(e){const t=[],r=[];return e.forEach((([e,,,a])=>{t.push(e),a&&Array.from(a.entries()).forEach((([e,[t,a,s=[]]])=>{r.push(t+s.join("")),this.exportMeta.eventsBoxes.set(String(e),a)}))})),{resources:t,events:r}}}$._$name="MultiPageVerticalExporter";class I extends h{static get $name(){return"ScheduleRangeCombo"}static get type(){return"schedulerangecombo"}static get defaultConfig(){return{editable:!1,localizeDisplayFields:!0,displayField:"text",buildItems:()=>Object.entries(A).map((([e,t])=>({value:e,text:"L{"+t+"}"})))}}}I.initClass(),I._$name="ScheduleRangeCombo";class F extends E{static get $name(){return"SchedulerExportDialog"}static get type(){return"schedulerexportdialog"}static get configurable(){return{defaults:{localeClass:this},items:{scheduleRangeField:{type:"schedulerangecombo",label:"L{Schedule range}",value:"completeview",weight:150,onChange({value:e}){this.parent.widgetMap.rangesContainer.hidden=e!==A.daterange}},rangesContainer:{type:"container",flex:"1 0 100%",weight:151,hidden:!0,defaults:{localeClass:this},items:{filler:{weight:0,type:"widget"},rangeStartField:{type:"datefield",label:"L{Export from}",labelWidth:"3em",flex:"1 0 25%",weight:10,onChange({value:e}){this.parent.widgetMap.rangeEndField.min=l.add(e,1,"d")}},filler2:{type:"widget",weight:20,width:"0.5em"},rangeEndField:{type:"datefield",label:"L{Export to}",labelWidth:"1em",flex:"1 0 25%",weight:30,onChange({value:e}){this.parent.widgetMap.rangeStartField.max=l.add(e,-1,"d")}}}}}}}onLocaleChange(){const e=this.L("labelWidth");this.width=this.L("L{width}"),this.items.forEach((t=>{t instanceof g?t.labelWidth=e:"rangesContainer"===t.ref&&(t.items[0].width=e)}))}applyInitialValues(e){super.applyInitialValues(e);const{client:t,scheduleRange:r}=e,a=e.items=e.items||{},s=a.scheduleRangeField=a.scheduleRangeField||{},n=a.rangesContainer=a.rangesContainer||{},i=n.items=n.items||{},o=i.filler=i.filler||{},c=i.rangeStartField=i.rangeStartField||{},d=i.rangeEndField=i.rangeEndField||{};o.width=this.L("labelWidth"),s.value=s.value||r,s.value===A.daterange&&(n.hidden=!1);const u=c.value=c.value||t.startDate;c.max=l.max(t.startDate,l.add(t.endDate,-1,"d"));let m=d.value||t.endDate;m<=u&&(m=l.add(u,1,"d")),d.value=m,d.min=l.min(t.endDate,l.add(t.startDate,1,"d"))}}F._$name="SchedulerExportDialog";class k extends(j(w)){static get $name(){return"SinglePageExporter"}static get type(){return"singlepage"}collectDependencies(){}positionRows(e,t){const r=[],a=[],s=/translate\((\d+.?\d*)px, (\d+.?\d*)px\)/,n=/top:.+?px/;if(t.enableDirectRendering)e.forEach((([e,,,t])=>{r.push(e),t&&Array.from(t.entries()).forEach((([e,[t,r,s=[]]])=>{this.exportMeta.eventsBoxes.set(String(e),r),a.push(t+s.join(""))}))}));else{let t=0;e.forEach((([e,i,o,l])=>{r.push(e.replace(s,`translate($1px, ${t}px)`));const c=t-i;l&&Array.from(l.entries()).forEach((([e,[t,r]])=>{r.translate(0,c),this.exportMeta.eventsBoxes.set(String(e),r),a.push(t.replace(n,`top: ${r.y}px`))})),t+=o}))}return{resources:r,events:a}}}k._$name="SinglePageExporter";class O extends y{static get $name(){return"PdfExport"}static get defaultConfig(){return{exporters:[k,B,$],dialogClass:F,scheduleRange:"completeview",rangeStart:null,rangeEnd:null}}get defaultExportDialogConfig(){return p.copyProperties(super.defaultExportDialogConfig,this,["scheduleRange"])}buildExportConfig(e){e=super.buildExportConfig(e);const{scheduleRange:t,rangeStart:r,rangeEnd:a}=this;return e.columns&&!e.columns.find((e=>"timeAxis"===e.type))&&e.columns.push(e.client.timeAxisColumn.id),p.assign({scheduleRange:t,rangeStart:r,rangeEnd:a},e)}}O._$name="PdfExport",r.registerFeature(O,!1,"Scheduler");export{T as Labels,B as MultiPageExporter,$ as MultiPageVerticalExporter,O as PdfExport,C as ResourceInfoColumn,A as ScheduleRange,I as ScheduleRangeCombo,F as SchedulerExportDialog,k as SinglePageExporter,P as TimelineSummary};
//# sourceMappingURL=PdfExport2.js.map
