/*!
 *
 * Bryntum Calendar 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Base as t,Delayable as e,_objectSpread2 as o,Events as n,Identifiable as r,EventHelper as s,DomDataStore as a,DomHelper as i,Objects as l,_defineProperty as d,Factoryable as c,ObjectHelper as g,Tooltip as u,StringHelper as h}from"./Editor.js";const m=()=>{throw new Error("Abstract method call!")};class p extends t{get type(){return this.constructor.name}undo(){m()}redo(){m()}}p._$name="ActionBase";const v=()=>{throw new Error("Abstract method call!")},S=()=>{throw new Error("Method cannot be called at this state!")};class y extends t{canUndo(t){v()}canRedo(t){v()}onUndo(t){v()}onRedo(t){v()}onStartTransaction(t){v()}onStopTransaction(t){v()}onStopTransactionDelayed(t){v()}onRejectTransaction(t){v()}onEnable(t){v()}onDisable(t){v()}onAutoRecordOn(t){v()}onAutoRecordOff(t){v()}onResetQueue(t){v()}onModelUpdate(t){v()}onStoreModelAdd(t){v()}onStoreModelInsert(t){v()}onStoreModelRemove(t){v()}onStoreModelRemoveAll(t){v()}onModelInsertChild(t){v()}onModelRemoveChild(t){v()}}y._$name="StateBase";const R=Symbol("STATE_PROP"),f=Symbol("STORES_PROP"),b=Symbol("QUEUE_PROP"),D=Symbol("POS_PROP"),M=Symbol("TRANSACTION_PROP"),T=Symbol("TRANSACTION_TIMER_PROP"),A=Symbol("AUTO_RECORD_PROP");Object.freeze([R,f,b,D,M,T,A]);const E=new Map;var C=(t,e)=>{E.set(t,e)},I=t=>("string"==typeof t&&(t=E.get(t)),t);const O=(t,e)=>{const{undo:o,redo:n}=e;let r;return r=o&&!n?{[b]:t[b].slice(t.position),[D]:0}:n&&!o?{[b]:t[b].slice(0,t.position)}:{[b]:[],[D]:0},[r,()=>{t.notifyStoresAboutQueueReset(e)}]};const P=new class extends y{canUndo(){return!1}canRedo(){return!1}onUndo(){S()}onRedo(){S()}onEnable(t){return t.autoRecord?"autoreadystate":"readystate"}onDisable(){S()}onAutoRecordOn(){return{[A]:!0}}onAutoRecordOff(){return{[A]:!1}}onStartTransaction(){S()}onStopTransaction(){S()}onStopTransactionDelayed(){S()}onRejectTransaction(){S()}onResetQueue(t,e){return O(t,e)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}};C("disabledstate",P);const x=Symbol("ACTION_QUEUE_PROP");class w extends t{get defaultConfig(){return{title:null}}construct(...t){this[x]=[],super.construct(...t)}get queue(){return this[x].slice(0)}get length(){return this[x].length}addAction(t){this[x].push(t)}undo(){const t=this[x];for(let e=t.length-1;e>=0;--e)t[e].undo()}redo(){const t=this[x];for(let e=0,o=t.length;e<o;++e)t[e].redo()}}w._$name="Transaction";class _ extends y{canUndo(t){return 0<t.position&&t.position<=t.length}canRedo(t){return 0<=t.position&&t.position<t.length}onUndo(t,e){let o=t.position;const n=t[b],r=Math.max(0,o-e);return[{[R]:"restoringstate",[D]:r},()=>{t.notifyStoresAboutStateRestoringStart();const e=[];for(;o!==r;){const t=n[--o];t.undo(),e.push(t)}return[t.autoRecord?"autoreadystate":"readystate",()=>{t.notifyStoresAboutStateRestoringStop({cause:"undo",transactions:e})}]}]}onRedo(t,e){let o=t.position;const n=t[b],r=Math.min(n.length,o+e);return[{[R]:"restoringstate",[D]:r},()=>{t.notifyStoresAboutStateRestoringStart();const e=[];do{const t=n[o++];t.redo(),e.push(t)}while(o!==r);return[t.autoRecord?"autoreadystate":"readystate",()=>{t.notifyStoresAboutStateRestoringStop({cause:"redo",transactions:e})}]}]}onEnable(){S()}onDisable(){return"disabledstate"}onAutoRecordOn(){return{[R]:"autoreadystate",[A]:!0}}onAutoRecordOff(){S()}onStartTransaction(t,e){const o=new w({title:e});return[{[R]:"recordingstate",[M]:o},()=>{t.notifyStoresAboutStateRecordingStart(o)}]}onStopTransaction(){S()}onStopTransactionDelayed(){S()}onRejectTransaction(){S()}onResetQueue(t,e){return O(t,e)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}}const L=new _;C("readystate",L);class U extends y{canUndo(){return!1}canRedo(){return!1}onEnable(){}onDisable(t){const e=t[M];return t.notifyStoresAboutStateRecordingStop(e,{disabled:!0}),{[R]:"disabledstate",[M]:null}}onAutoRecordOn(t){return[{[R]:"autorecordingstate",[A]:!0},()=>{t.stopTransactionDelayed()}]}onAutoRecordOff(){S()}onStartTransaction(){S()}onStopTransaction(t,e){const o=t[M],n=t[b];let r=t[D];return o.length&&(o.title||e||!t.getTransactionTitle?e&&(o.title=e):o.title=t.getTransactionTitle(o),n[r]=o,n.length=++r),[{[R]:"readystate",[D]:r,[M]:null},()=>{t.notifyStoresAboutStateRecordingStop(o,{stop:!0})}]}onRejectTransaction(t){const e=t[M];return[{[R]:"restoringstate",[M]:null},()=>(e.length&&e.undo(),["readystate",()=>{t.notifyStoresAboutStateRecordingStop(e,{rejected:!0})}])]}onStopTransactionDelayed(){S()}onResetQueue(t,e){return O(t,e)}onModelUpdate(t,e,o,n,r){t[M].addAction(t.makeModelUpdateAction(e,o,n,r))}onModelInsertChild(t,e,o,n,r,s){t[M].addAction(t.makeModelInsertChildAction(e,o,n,r,s))}onModelRemoveChild(t,e,o,n){t[M].addAction(t.makeModelRemoveChildAction(e,o,n))}onStoreModelAdd(t,e,o,n){t[M].addAction(t.makeStoreModelAddAction(e,o,n))}onStoreModelInsert(t,e,o,n,r,s){t[M].addAction(t.makeStoreModelInsertAction(e,o,n,r,s))}onStoreModelRemove(t,e,o,n,r){t[M].addAction(t.makeStoreModelRemoveAction(e,o,n,r))}onStoreRemoveAll(t,e,o,n){t[M].addAction(t.makeStoreRemoveAllAction(e,o,n))}}const k=new U;C("recordingstate",k);const $=new class extends y{static get $name(){return"RestoringStateClass"}canUndo(){return!1}canRedo(){return!1}onUndo(){S()}onRedo(){S()}onEnable(){S()}onDisable(){S()}onAutoRecordOn(){return{[A]:!0}}onAutoRecordOff(){return{[A]:!1}}onStartTransaction(){S()}onStopTransaction(){S()}onStopTransactionDelayed(){S()}onRejectTransaction(){S()}onQueueReset(){S()}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}};C("restoringstate",$);const K=new class extends _{onAutoRecordOn(){S()}onAutoRecordOff(){return{[R]:"readystate",[A]:!1}}onStartTransaction(t,e){const o=new w({title:e});return[{[R]:"autorecordingstate",[M]:o},()=>{t.notifyStoresAboutStateRecordingStart(o),t.stopTransactionDelayed()}]}onModelUpdate(t,e,o,n){t.startTransaction(),t.onModelUpdate(e,o,n)}onModelInsertChild(t,e,o,n,r){t.startTransaction(),t.onModelInsertChild(e,o,n,r)}onModelRemoveChild(t,e,o,n){t.startTransaction(),t.onModelRemoveChild(e,o,n)}onStoreModelAdd(t,e,o,n){t.startTransaction(),t.onStoreModelAdd(e,o,n)}onStoreModelInsert(t,e,o,n,r,s){t.startTransaction(),t.onStoreModelInsert(e,o,n,r,s)}onStoreModelRemove(t,e,o,n,r){t.startTransaction(),t.onStoreModelRemove(e,o,n,r)}onStoreRemoveAll(t,e,o,n){t.startTransaction(),t.onStoreRemoveAll(e,o,n)}};C("autoreadystate",K);class z extends(U.mixin(e)){onDisable(t){const e=t[M],o=t[T];return o&&this.clearTimeout(o),t.notifyStoresAboutStateRecordingStop(e,{disabled:!0}),{[R]:"disabledstate",[M]:null,[T]:null}}onAutoRecordOn(t){S()}onAutoRecordOff(t){const e=t[T];return e&&this.clearTimeout(e),{[R]:"recordingstate",[A]:!1,[T]:null}}onStopTransaction(t,e){const o=t[M],n=t[T],r=t[b];let s=t[D];return n&&this.clearTimeout(n),o.length&&(o.title||e||!t.getTransactionTitle?e&&(o.title=e):o.title=t.getTransactionTitle(o),r[s]=o,r.length=++s),[{[R]:"autoreadystate",[D]:s,[M]:null,[T]:null},()=>{t.notifyStoresAboutStateRecordingStop(o,{stop:!0})}]}onStopTransactionDelayed(t){let e=t[T];return e&&this.clearTimeout(e),e=this.setTimeout((()=>{t.stopTransaction()}),t.autoRecordTransactionStopTimeout),{[R]:j,[T]:e}}onResetQueue(t,e){return O(t,e)}onRejectTransaction(t){const e=t[M],o=t[T];return o&&this.clearTimeout(o),[{[R]:"restoringstate",[M]:null,[T]:null},()=>(e.length&&e.undo(),["autoreadystate",()=>{t.notifyStoresAboutStateRecordingStop(e,{rejected:!0})}])]}onModelUpdate(t,...e){super.onModelUpdate(t,...e),t.stopTransactionDelayed()}onModelInsertChild(t,...e){super.onModelInsertChild(t,...e),t.stopTransactionDelayed()}onModelRemoveChild(t,...e){super.onModelRemoveChild(t,...e),t.stopTransactionDelayed()}onStoreModelAdd(t,...e){super.onStoreModelAdd(t,...e),t.stopTransactionDelayed()}onStoreModelInsert(t,...e){super.onStoreModelInsert(t,...e),t.stopTransactionDelayed()}onStoreModelRemove(t,...e){super.onStoreModelRemove(t,...e),t.stopTransactionDelayed()}onStoreRemoveAll(t,...e){super.onStoreRemoveAll(t,...e),t.stopTransactionDelayed()}}const j=new z;C("autorecordingstate",j);const N=Symbol("MODEL_PROP"),F=Symbol("NEW_DATA_PROP"),Q=Symbol("OLD_DATA_PROP");class B extends p{static get defaultConfig(){return{model:void 0,newData:void 0,oldData:void 0,isInitialUserAction:!1}}get type(){return"UpdateAction"}get model(){return this[N]}set model(t){this[N]=t}get newData(){return this[F]}set newData(t){this[F]=o({},t)}get oldData(){return this[Q]}set oldData(t){this[Q]=o({},t)}undo(){const{model:t,oldData:e}=this;t.$&&Object.assign(t,e),t.set(e,null,null,null,!0)}redo(){const{model:t,newData:e}=this;t.$&&Object.assign(t,e),t.set(e,null,null,null,!0)}}B._$name="UpdateAction";const X=Symbol("PARENT_MODEL_PROP"),W=Symbol("CHILD_MODELS_PROP"),q=Symbol("INSERT_INDEX_PROP"),G=Symbol("CONTEXT_PROP");class H extends p{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,insertIndex:void 0,context:void 0}}get type(){return"InsertChildAction"}get parentModel(){return this[X]}set parentModel(t){this[X]=t}get childModels(){return this[W]}set childModels(t){this[W]=t.slice(0)}get insertIndex(){return this[q]}set insertIndex(t){this[q]=t}get context(){return this[G]}set context(t){this[G]=t}undo(){const{parentModel:t,context:e,childModels:o}=this;o.sort(((t,o)=>{const{lhsParent:n,lhsIndex:r}=e.get(t)||{},{rhsParent:s,rhsIndex:a}=e.get(o)||{};return n&&n===s?r-a:0})),o.forEach((o=>{const{parent:n,index:r}=e.get(o)||{};if(n)if(n===t){let t;t=r>o.parentIndex?r+1:r,t=r===n.children.length-1?null:t;const e=n.children[t];n.insertChild(o,e)}else n.insertChild(o,n.children[r]);else t.removeChild(o)}))}redo(){const{parentModel:t,insertIndex:e,childModels:o}=this,n=t.children[e];t.insertChild(o,n)}}H._$name="InsertChildAction";const Y=Symbol("PARENT_MODEL_PROP"),J=Symbol("CHILD_MODELS_PROP"),V=Symbol("CONTEXT_PROP");class Z extends p{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,context:void 0}}get type(){return"RemoveChildAction"}get parentModel(){return this[Y]}set parentModel(t){this[Y]=t}get childModels(){return this[J]}set childModels(t){this[J]=t.slice(0)}get context(){return this[V]}set context(t){this[V]=t}undo(){const{parentModel:t,context:e,childModels:o}=this;o.sort(((t,o)=>e.get(t)-e.get(o))),o.forEach((o=>{t.insertChild(o,e.get(o))}))}redo(){this.parentModel.removeChild(this.childModels)}}Z._$name="RemoveChildAction";const tt=Symbol("STORE_PROP"),et=Symbol("MODEL_LIST_PROP");class ot extends p{static get defaultConfig(){return{store:void 0,modelList:void 0,silent:!1}}get type(){return"AddAction"}get store(){return this[tt]}set store(t){this[tt]=t}get modelList(){return this[et]}set modelList(t){this[et]=t.slice(0)}undo(){this.store.remove(this.modelList,this.silent)}redo(){this.store.add(this.modelList,this.silent)}}ot._$name="AddAction";const nt=Symbol("STORE_PROP"),rt=Symbol("MODEL_LIST_PROP"),st=Symbol("INSERT_INDEX_PROP"),at=Symbol("CONTEXT_PROP");class it extends p{static get defaultConfig(){return{store:void 0,modelList:void 0,insertIndex:void 0,context:void 0,silent:!1}}get type(){return"InsertAction"}get store(){return this[nt]}set store(t){this[nt]=t}get modelList(){return this[rt]}set modelList(t){this[rt]=t.slice(0)}get insertIndex(){return this[st]}set insertIndex(t){this[st]=t}get context(){return this[at]}set context(t){this[at]=t}undo(){const{store:t,modelList:e,context:o,silent:n}=this;e.sort(((t,e)=>{const n=o.get(t),r=o.get(e);return void 0!==n&&void 0!==r?n-r:0})),e.forEach((e=>{const r=o.get(e);e._undoingInsertion=!0,void 0!==r?t.insert(r,e,n):t.remove(e,n),e._undoingInsertion=!1}))}redo(){const t=this;t.store.insert(t.insertIndex,t.modelList,t.silent)}}it._$name="InsertAction";const lt=Symbol("STORE_PROP"),dt=Symbol("MODEL_LIST_PROP"),ct=Symbol("CONTEXT_PROP");class gt extends p{static get defaultConfig(){return{store:void 0,modelList:void 0,context:void 0,silent:!1}}get type(){return"RemoveAction"}get store(){return this[lt]}set store(t){this[lt]=t}get modelList(){return this[dt]}set modelList(t){this[dt]=t.slice(0)}get context(){return this[ct]}set context(t){this[ct]=t}undo(){const{store:t,context:e,modelList:o,silent:n}=this;o.sort(((t,o)=>e.get(t)-e.get(o))),o.forEach((o=>{const r=e.get(o);t.insert(r,o,n)}))}redo(){this.store.remove(this.modelList,this.silent)}}gt._$name="RemoveAction";const ut=Symbol("STORE_PROP"),ht=Symbol("ALL_RECORDS_PROP");class mt extends p{static get defaultConfig(){return{store:void 0,allRecords:void 0,silent:!1}}get type(){return"RemoveAllAction"}get store(){return this[ut]}set store(t){this[ut]=t}get allRecords(){return this[ht]}set allRecords(t){this[ht]=t.slice(0)}undo(){const{store:t,allRecords:e,silent:o}=this;t.add(e,o)}redo(){this.store.removeAll(this.silent)}}mt._$name="RemoveAllAction";const pt=(t,e,o,n)=>new B({model:t,newData:e,oldData:o,isInitialUserAction:n}),vt=(t,e,o,n)=>new H({parentModel:t,childModels:o,insertIndex:e,context:n}),St=(t,e,o)=>new Z({parentModel:t,childModels:e,context:o}),yt=(t,e,o)=>new ot({store:t,modelList:e,silent:o}),Rt=(t,e,o,n,r)=>new it({store:t,insertIndex:e,modelList:o,context:n,silent:r}),ft=(t,e,o,n)=>new gt({store:t,modelList:e,context:o,silent:n}),bt=(t,e,o)=>new mt({store:t,allRecords:e,silent:o}),Dt=(t,e,...o)=>{const n=t.state,r=e.call(t[R],t,...o);if("string"==typeof r)t[R]=I(r);else if(r instanceof y)t[R]=r;else if(Array.isArray(r)){const[e,n]=r;"string"==typeof e?t[R]=I(e):e instanceof y?t[R]=e:e&&"object"==typeof e&&((t=Object.assign(t,e))[R]=I(t[R])),"function"==typeof n&&Dt(t,n,...o)}else r&&"object"==typeof r&&((t=Object.assign(t,r))[R]=I(t[R]));n!==L&&n!==K&&r!==L&&r!==K&&t.trigger("ready")};class Mt extends(n(t)){static get defaultConfig(){return{disabled:!0,autoRecord:!1,autoRecordTransactionStopTimeout:100,makeModelUpdateAction:pt,makeModelInsertChildAction:vt,makeModelRemoveChildAction:St,makeStoreModelAddAction:yt,makeStoreModelInsertAction:Rt,makeStoreModelRemoveAction:ft,makeStoreRemoveAllAction:bt,getTransactionTitle:null}}construct(...t){Object.assign(this,{[R]:L,[f]:[],[b]:[],[D]:0,[M]:null,[T]:null,[A]:!1}),super.construct(...t)}get state(){return this[R]}get position(){return this[D]}get length(){return this[b].length}get stores(){return Array.from(this[f])}hasStore(t){return this[f].includes(t)}addStore(t){this.hasStore(t)||(this[f].push(t),t.stm=this)}removeStore(t){this.hasStore(t)&&(this[f]=this[f].filter((e=>e!==t)),t.stm=null)}forEachStore(t){this[f].forEach((e=>t(e,e.id)))}get disabled(){return this.state===P}set disabled(t){const e=this;e.disabled!==t&&(Dt(e,t?e.state.onDisable:e.state.onEnable,e),e.trigger("stmDisabled",{disabled:t}),e.trigger("disabled",{disabled:t}))}get enabled(){return!this.disabled}enable(){this.disabled=!1}disable(){this.disabled=!0}get isReady(){return this.state===L||this.state===K}waitForReadiness(){return this.await("ready",!1)}get isRecording(){return this.state===k||this.state===j}get autoRecord(){return this[A]}set autoRecord(t){const e=this;e.autoRecord!=t&&Dt(e,t?e.state.onAutoRecordOn:e.state.onAutoRecordOff,e)}startTransaction(t=null){Dt(this,this.state.onStartTransaction,t)}stopTransaction(t=null){Dt(this,this.state.onStopTransaction,t)}stopTransactionDelayed(){Dt(this,this.state.onStopTransactionDelayed)}rejectTransaction(){Dt(this,this.state.onRejectTransaction)}get transaction(){return this[M]}get queue(){return this[b].map((t=>t.title))}get isRestoring(){return this.state===$}get canUndo(){return this.state.canUndo(this)}get canRedo(){return this.state.canRedo(this)}async undo(t=1){this.isReady||await this.waitForReadiness(),Dt(this,this.state.onUndo,t)}async undoAll(){this.isReady||await this.waitForReadiness(),this.undo(this.length)}async redo(t=1){this.isReady||await this.waitForReadiness(),Dt(this,this.state.onRedo,t)}async redoAll(){this.isReady||await this.waitForReadiness(),this.redo(this.length)}resetQueue(t={undo:!0,redo:!0}){Dt(this,this.state.onResetQueue,t)}resetUndoQueue(){this.resetQueue({undo:!0})}resetRedoQueue(){this.resetQueue({redo:!0})}notifyStoresAboutStateRecordingStart(t){this.forEachStore((e=>{var o;return null===(o=e.onStmRecordingStart)||void 0===o?void 0:o.call(e,this,t)})),this.trigger("recordingStart",{stm:this,transaction:t})}notifyStoresAboutStateRecordingStop(t,e){this.forEachStore((o=>{var n;return null===(n=o.onStmRecordingStop)||void 0===n?void 0:n.call(o,this,t,e)})),this.trigger("recordingStop",{stm:this,transaction:t,reason:e})}notifyStoresAboutStateRestoringStart(){this.forEachStore((t=>{var e;return null===(e=t.onStmRestoringStart)||void 0===e?void 0:e.call(t,this)})),this.trigger("restoringStart",{stm:this})}notifyStoresAboutStateRestoringStop({cause:t,transactions:e}){this.forEachStore((t=>{var e;return null===(e=t.onStmRestoringStop)||void 0===e?void 0:e.call(t,this)})),this.trigger("restoringStop",{stm:this,cause:t,transactions:e})}notifyStoresAboutQueueReset(t){this.forEachStore((e=>{var o;return null===(o=e.onStmQueueReset)||void 0===o?void 0:o.call(e,this,t)})),this.trigger("queueReset",{stm:this,options:t})}onModelUpdate(t,e,o,n){Dt(this,this.state.onModelUpdate,t,e,o,n)}onModelInsertChild(t,e,o,n){Dt(this,this.state.onModelInsertChild,t,e,o,n)}onModelRemoveChild(t,e,o){Dt(this,this.state.onModelRemoveChild,t,e,o)}onStoreModelAdd(t,e,o){Dt(this,this.state.onStoreModelAdd,t,e,o)}onStoreModelInsert(t,e,o,n,r){Dt(this,this.state.onStoreModelInsert,t,e,o,n,r)}onStoreModelRemove(t,e,o,n){Dt(this,this.state.onStoreModelRemove,t,e,o,n)}onStoreRemoveAll(t,e,o){Dt(this,this.state.onStoreRemoveAll,t,e,o)}onUndoKeyPress(t){const e=this;e.enabled&&(t.shiftKey?e.canRedo&&(t.preventDefault(),e.redo()):e.canUndo&&(t.preventDefault(),e.undo()))}stash(){this.transaction&&(this.stashedTransaction=this.transaction,this.rejectTransaction())}applyStash(){this.stashedTransaction&&(this.startTransaction(this.stashedTransaction.title),this.stashedTransaction.redo(),delete this.stashedTransaction)}}Mt._$name="StateTrackingManager";var Tt=e=>class extends(e||t){static get $name(){return"Finalizable"}construct(...t){super.construct(...t),this.finalizer=null,this.finalizing=null,this.isFinalized=!1,this.isFinalizing=!1}doFinalize(){this.destroy()}finalize(){const t=this;let e=t.finalizing;return e||t.isFinalized||(t.isFinalizing=!0,t.finalizing=e=t._awaitFinalizer()),e}async _awaitFinalizer(){const t=this;try{await t.finalizer}finally{t.finalizing=null,t.isFinalized=!0,t.doFinalize()}}};const At=Symbol("dragAbort"),Et=Symbol("dragInit"),Ct=Symbol("dragDrag"),It=Symbol("dragDrop"),Ot={x:"horizontal",y:"vertical"};class Pt extends(t.mixin(Tt,e,r)){static get configurable(){return{itemElement:null,scrollManager:null,monitoringConfig:null,source:null,target:null,targetElement:null,threshold:5,touchStartDelay:300}}static get identifiable(){return{}}construct(...t){super.construct(...t);const e=this,{event:o}=e;Object.assign(e,{altKey:null,cleaners:[],ctrlKey:null,data:new Map,element:o.target,endEvent:null,lastMoveEvent:null,metaKey:null,previousTarget:null,scrollerAction:null,shiftKey:null,state:Et,startEvent:o,touchStartTimer:null,_valid:!0}),"touches"in o&&e.touchStartDelay&&(e.touchStartTimer=e.setTimeout((()=>e.touchStartTimer=null),e.touchStartDelay,"touchStartDelay")),s.on({element:globalThis,blur:"onWindowBlur",thisObj:e})}doDestroy(){const t=this,{source:e,target:o}=t;t.cleanup(),(null==o?void 0:o.dropping)===t&&(o.dropping=null),(null==e?void 0:e.dragging)===t&&(e.dragging=null),super.doDestroy()}onWindowBlur(){this.started&&this.abort()}get aborted(){return this.state===At}get completed(){return this.isDestroying||this.aborted||null!==this.endEvent}get pending(){return this.state===Et}get started(){return this.state!==Et&&!this.aborted}get valid(){return this.started&&null!=this.targetElement&&this._valid}set valid(t){this._valid=t}async get(t){if(this.aborted)throw new Error("Data is not available on aborted drag");if(!this.completed)throw new Error("Data is not available until drag completion");if(Array.isArray(t))return Promise.all(t.map((t=>this.get(t))));let e=this.data.get(t);return"function"==typeof e&&(e=await e(),this.data.set(t,e)),e}has(t){return this.data.has(t)}peek(t){if(this.aborted)throw new Error("Data is not available on aborted drag");if(Array.isArray(t))return t.map((t=>this.peek(t)));let e=this.data.get(t);return"function"==typeof e&&(e=!0),e}set(t,e){this.data.set(t,e)}changeTarget(t,e){if(t!==e){const o=this;o._target=t,o.previousTarget=e,e&&(e.dropping=null),t&&(t.dropping=o,t.dropping!==o&&(t=null,o.valid=!1)),o._target=e}return t}updateTarget(t,e){const o=this;e&&o.source.dragLeaveTarget(o,e),t&&(o.valid=!0,t.dragMove(o),o.source.dragEnterTarget(o))}updateTargetElement(t){let e,o,n,r,s;for(s=t;s;s=s.parentElement)if(o=a.get(s,"droppables"),o)for(r=0;r<o.length;++r)if(e=o[r],e.dropRootElement.contains(t)&&(n=e.droppableSelector,(!n||t.closest(`#${i.getId(e.dropRootElement)} ${n}`))&&(this.target=e,this.target===e)))return}abort(){const t=this,{element:e,source:o}=t;null==e||e.getBoundingClientRect(),t.state!==It&&(t.state=At,t.cleanup()),null==o||o.endDrag(t)}begin(){const t=this,{source:e}=t,o=e.beforeDrag(t);return!1!==o&&(e.dragging=t),o}cleanup(){let t;for(;t=this.cleaners.pop();)t()}end(t){const e=this,{lastMoveEvent:o,target:n}=e,{dragSwallowClickTime:r}=e.source;e.event=e.endEvent=t,e.syncFlags(),e.started&&((null==o?void 0:o.clientX)===t.clientX&&(null==o?void 0:o.clientY)===t.clientY&&(null==o?void 0:o.target)===t.target||e.track(),r&&s.on({element:document,capture:!0,expires:r,once:!0,click(t){t.stopPropagation()}}),e.state=It,n!==e.source&&(null==n||n.dragDrop(e)))}fakeKey(t,e){const o=this,{lastMoveEvent:n}=o;if(n&&o.element){let r;n.isKey=!0,"Alt"===t.key?o.altKey!==e&&(o.altKey=e,r=!0):"Control"===t.key&&o.ctrlKey!==e&&(o.ctrlKey=e,r=!0),r&&(o.event=n,o.track())}}keyDown(t){this.completed||("Escape"===t.key?this.abort():this.isDragToggleKey(t.key)&&this.fakeKey(t,!0))}keyUp(t){!this.completed&&this.isDragToggleKey(t.key)&&this.fakeKey(t,!1)}getDistance(t){return s.getDistanceBetween(this.startEvent,t)}isDragToggleKey(t){return"Control"===t||"Alt"===t}move(t){const e=this,{target:o}=t,n=e.getDistance(t)>=e.threshold;if(e.syncFlags(),e.touchStartTimer)n&&e.abort();else if(o&&o.nodeType===Node.ELEMENT_NODE){if(n&&!e.started&&(e.event=t,!1===e.start()))return void e.abort();e.started&&!e.completed&&(e.lastMoveEvent=e.event=t,"touchmove"===t.type&&(t.preventDefault(),t.stopImmediatePropagation()),e.track())}}start(){const t=this,{scrollManager:e,monitoringConfig:o,source:n}=t,{draggingBodyCls:r,dragLock:s}=n,a=n.dragRootElement;if(t.state=Ct,e){const n=e.startMonitoring(l.merge({scrollables:[{element:a}],direction:Ot[s]||s||"both",callback(e){const{lastMoveEvent:o}=t;o&&t.element&&(o.isScroll=!0,t.event=o,t.scrollerAction=e,t.track(),t.scrollerAction=null)}},o));t.cleaners.push(n)}const i=n.dragRootElement.closest(".b-outer")||document.body;if(i.classList.add(r),t.cleaners.push((()=>i.classList.remove(r))),!1===n.startDrag(t))return t.cleanup(),!1}syncFlags(){const t=this,{event:e}=t;t.altKey=e.altKey,t.ctrlKey=e.ctrlKey||e.metaKey,t.metaKey=e.metaKey,t.shiftKey=e.shiftKey}track(){const t=this,{event:e,source:o,target:n}=t;let r,s=e.target;"touchmove"===e.type&&(r=e.changedTouches[0],s=i.elementFromPoint(r.clientX,r.clientY)),t.targetElement=s,n===t.target&&(null==n||n.dragMove(t)),o.trackDrag(t)}}d(Pt,"$name","DragContext"),Pt.prototype.STATE=Pt.STATE=Object.freeze({ABORTED:At,INIT:Et,DRAGGING:Ct,DROPPED:It}),Pt._$name="DragContext";class xt extends(t.mixin(c)){static get type(){return"default"}static get configurable(){return{dragging:null}}static get factoryable(){return{defaultType:xt}}updateDragging(t,e){e&&this.close(e),t&&this.open(t)}close(t){}open(t){}dragStart(t){this.dragging=t}dragMove(t){}dragEnd(t){this.dragging=null}}xt.initClass(),xt._$name="DragProxy";var wt=e=>class extends(e||t){static get $name(){return"Draggable"}static get configurable(){return{dragging:{$config:"nullify",value:null},draggingClsSelector:null,dragDocumentListeners:{element:document,keydown:"onDragKeyDown",keyup:"onDragKeyUp",contextmenu:"onDragContextMenu",mousemove:"onDragPointerMove",mouseup:"onDragPointerUp",pointerup:"onDragPointerUp",touchend:"onDragPointerUp",touchmove:{handler:"onDragPointerMove",passive:!1}},dragItemSelector:null,dragItemOverCls:null,dragLock:null,dragMinDistance:1,dragProxy:{$config:["lazy","nullify"],value:null},dragRootElement:{$config:"nullify",value:null},dragSameTargetDrop:!1,dragSelector:null,ignoreSelector:null,dragSwallowClickTime:50,dragThreshold:5,dragTouchStartDelay:300,dropTargetSelector:null,overItem:null,testConfig:{dragSwallowClickTime:50}}}static get properties(){return{draggingCls:"b-draggable-active",draggingBodyCls:"b-draghelper-active",draggingItemCls:"b-dragging-item",draggingStartedCls:"b-draggable-started",draggableCls:"b-draggable"}}beforeDrag(t){const{dragRootElement:e,dragSelector:o,ignoreSelector:n}=this,r=o&&t.element.closest(o);return!o||Boolean(r&&r===e||e.contains(r)&&(!n||!t.element.matches(n)))}dragStart(t){}dragOver(t){}dragEnterTarget(t){}dragLeaveTarget(t,e){}dragDrop(t){}dragEnd(t){}get activeDrag(){const{dragging:t}=this;return null!=t&&t.started&&!t.completed?t:null}get dragEventer(){return this.trigger?this:null}get draggingClassElement(){const{draggingClsSelector:t,dragRootElement:e}=this;return t?null==e?void 0:e.closest(t):e}beginDrag(t){const{draggingCls:e,draggingClassElement:o}=this;e&&o&&(o.classList.add(e),t.cleaners.push((()=>o.classList.remove(e))))}async endDrag(t){const e=this,{dragEventer:o,dragProxy:n}=e;t.valid&&await e.dragDrop(t),e.isDestroyed||(t.pending?t.destroy():(e.dragEnd(t),null==n||n.dragEnd(t),null==o||o.trigger(t.valid?"drop":"dragCancel",{drag:t,event:t.event}),e.finalizeDrag(t)))}async finalizeDrag(t){var e;await(null===(e=t.finalize)||void 0===e?void 0:e.call(t))}moveDrag(t){if(!1!==this.dragOver(t)){const{dragEventer:e,dragProxy:o}=this;null==o||o.dragMove(t),null==e||e.trigger("drag",{drag:t,event:t.event})}}setupDragContext(t){const e=this,{dragItemSelector:o,id:n}=e,{target:r}=t;return{event:t,id:n?`${n}-drag-${e._nextDragId=(e._nextDragId||0)+1}`:null,itemElement:o?r.closest(o):r,touchStartDelay:e.dragTouchStartDelay,source:e,threshold:e.dragThreshold}}startDrag(t){const{draggingStartedCls:e,draggingClassElement:o,draggingItemCls:n,dragEventer:r,dragProxy:s}=this,{itemElement:a}=t;if(!1===(null==r?void 0:r.trigger("beforeDragStart",{drag:t,event:t.event})))return!1;e&&o&&(o.classList.add(e),t.cleaners.push((()=>o.classList.remove(e)))),n&&a&&(a.classList.add(n),t.cleaners.push((()=>a.classList.remove(n)))),null==s||s.dragStart(t);const i=this.dragStart(t);return!1!==i&&(null==r||r.trigger("dragStart",{drag:t,event:t.event})),i}trackDrag(t){var e;const{dropTargetSelector:o}=this;t.valid=!(o&&(null===(e=t.targetElement)||void 0===e||!e.closest(o))),this.moveDrag(t)}configureListeners(t){const e=g.assign({thisObj:this},this.dragDocumentListeners);return"touches"in t.startEvent?(delete e.mousemove,delete e.mouseup):(delete e.contextmenu,delete e.touchmove,delete e.touchend,delete e.pointerup),e}updateDragging(t,e){const o=this;if(t){const e=o.configureListeners(t);t.cleaners.push(s.on(e)),o.beginDrag(t)}else e&&e.destroy()}changeDragProxy(t,e){return xt.reconfigure(e,t,{owner:this,defaults:{owner:this}})}updateDragRootElement(t,e){var o;const n=this,{draggableCls:r,dragItemSelector:a,onDragItemMouseMove:i}=n;if(null==e||e.classList.remove(r),null===(o=n._dragRootDetacher)||void 0===o||o.call(n),t){const e={thisObj:n,element:t,mousedown:"onDragMouseDown",touchstart:"onDragTouchStart",pointerdown:t=>{var e,o;return t.pointerId&&(null===(e=(o=t.target).releasePointerCapture)||void 0===e?void 0:e.call(o,t.pointerId))}};i&&(e.mousemove={delegate:a,handler:"onDragItemMouseMove"}),(n.dragItemOverCls||i||n.onDragItemMouseEnter||n.onDragItemMouseLeave)&&Object.assign(e,{mouseover:{delegate:a,handler:"onDragItemMouseOver"},mouseout:{delegate:a,handler:"onDragItemMouseOut"}}),t.classList.add(r),n._dragRootDetacher=s.on(e)}}onDragItemMouseOver(t){this.overItem=t}onDragItemMouseOut(t){this.dragging||(this.overItem=t)}changeOverItem(t){var e;return this.enterLeaveEvent=t,"mouseout"===t.type?(null===(e=t.relatedTarget)||void 0===e?void 0:e.closest(this.dragItemSelector))||null:t.target.closest(this.dragItemSelector)}updateOverItem(t,e){const o=this,{dragItemOverCls:n}=o;var r,s;e&&(n&&e.classList.remove(n),null===(r=o.onDragItemMouseLeave)||void 0===r||r.call(o,o.enterLeaveEvent,e));t&&(n&&t.classList.add(n),null===(s=o.onDragItemMouseEnter)||void 0===s||s.call(o,o.enterLeaveEvent,t))}onDragContextMenu(t){t.preventDefault()}onDragKeyDown(t){this.dragging.keyDown(t)}onDragKeyUp(t){this.dragging.keyUp(t)}onDragMouseDown(t){0===t.button&&this.onDragPointerDown(t)}onDragPointerDown(t){let{dragging:e}=this;e?e.isFinalizing||e.abort():(e=this.setupDragContext(t),e&&(e=new Pt(e),!1===e.begin()&&e.destroy()))}changeDragging(t,e){return null==e||e.destroy(),t}onDragPointerMove(t){const{dragging:e}=this;e&&!e.completed&&(null==e||e.move(t))}onDragPointerUp(t){const{dragging:e}=this;e&&!e.completed&&(e.end(t),this.endDrag(e))}onDragTouchStart(t){1===t.touches.length&&this.onDragPointerDown(t)}},_t=e=>class extends(e||t){static get $name(){return"Droppable"}static get configurable(){return{droppableSelector:null,dropping:null,dropRootElement:{$config:"nullify",value:null}}}get dropEventer(){return this.trigger?this:null}get droppableCls(){return"b-droppable"}dragEnter(t){var e;return null===(e=this.dropEventer)||void 0===e?void 0:e.trigger("dragEnter",{drag:t,event:t.event})}dragMove(t){var e;return null===(e=this.dropEventer)||void 0===e?void 0:e.trigger("dragMove",{drag:t,event:t.event})}dragDrop(t){var e;return null===(e=this.dropEventer)||void 0===e?void 0:e.trigger("drop",{drag:t,event:t.event})}dragLeave(t){var e;return null===(e=this.dropEventer)||void 0===e?void 0:e.trigger("dragLeave",{drag:t,event:t.event})}changeDropping(t,e){if(t!==e){const o=this;e&&(!e.aborted&&e.completed||o.dragLeave(e)),t&&(o._dropping=t,!1===o.dragEnter(t)&&(t=null),o._dropping=e)}return t}updateDropRootElement(t,e){const o=this,{droppableCls:n}=o;let r,s,i;e&&(r=a.get(e,"droppables"),i=!0,Array.isArray(r)&&(s=r.indexOf(o))>-1&&(r.length<2?a.remove(e,"droppables"):(r.splice(s,1),r.forEach((t=>{n===t.droppableCls&&(i=!1)})))),i&&e.classList.remove(n)),t&&(r=a.get(t,"droppables"),r?r.push(o):a.set(t,"droppables",[o]),t.classList.add(n))}};class Lt extends t{static get $name(){return"AvatarRendering"}static get configurable(){return{element:null,colorPrefix:"b-sch-",tooltip:null,size:null}}doDestroy(){var t;null===(t=this.tooltip)||void 0===t||t.destroy(),super.doDestroy()}updateElement(t){s.on({element:t,delegate:".b-resource-image",error:"onImageErrorEvent",thisObj:this,capture:!0})}changeTooltip(t){return u.new({forElement:this.element,forSelector:".b-resource-avatar",cls:"b-resource-avatar-tooltip"},t)}static get failedUrls(){return this._failedUrls||(this._failedUrls=new Set),this._failedUrls}getResourceAvatar({initials:t,color:e,iconCls:o,imageUrl:n,defaultImageUrl:r,dataset:s={},resourceRecord:a,alt:i=h.encodeHtml(null==a?void 0:a.name)}){return this.getImageConfig(t,e,n,r,s,i)||this.getIconConfig(o,s)||this.getResourceInitialsConfig(t,e,s)}getImageConfig(t,e,n,r,s,a){const{size:i}=this;if(n=Lt.failedUrls.has(n)?r:n||r)return o(o({tag:"img",draggable:"false",loading:"lazy",class:{"b-resource-avatar":1,"b-resource-image":1}},i?{style:{height:i+"px",width:i+"px"}}:void 0),{},{alt:a,elementData:{defaultImageUrl:r,imageUrl:n,initials:t,color:e,dataset:s},src:n,dataset:s})}getIconConfig(t,e){if(t)return t&&{tag:"i",class:{"b-resource-avatar":1,"b-resource-icon":1,[t]:1},dataset:e}}getResourceInitialsConfig(t,e,n){const{size:r}=this,s=i.isNamedColor(e)&&e,a=!s&&e;return{tag:"div",class:{"b-resource-avatar":1,"b-resource-initials":1,[`${this.colorPrefix}${s}`]:s},style:o({backgroundColor:a||null},r?{height:r+"px",width:r+"px"}:void 0),children:[t],dataset:n}}onImageErrorEvent({target:t}){if(!t.matches(".b-resource-avatar"))return;const{defaultImageUrl:e,initials:o,color:n,imageUrl:r,dataset:s}=t.elementData;if(e&&!t.src.endsWith(e.replace(/^[./]*/gm,"")))t.src=e;else{const e=i.createElement(this.getResourceInitialsConfig(o,n,s));e.elementData=t.elementData,t.parentElement.replaceChild(e,t)}Lt.failedUrls.add(r)}}Lt._$name="AvatarRendering";export{p as ActionBase,Lt as AvatarRendering,Pt as DragContext,xt as DragProxy,wt as Draggable,_t as Droppable,Tt as Finalizable,y as StateBase,Mt as StateTrackingManager,w as Transaction,B as UpdateAction};
//# sourceMappingURL=AvatarRendering.js.map
