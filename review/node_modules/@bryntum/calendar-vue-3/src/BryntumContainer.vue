<!-- Vue 3 wrapper for Bryntum Container -->

<template>
    <div ref="refElement">

    </div>
</template>

<script>
import { Container, Layout, Model, Rectangle, Scroller, Widget } from '@bryntum/calendar';
import { getCurrentInstance, onBeforeUnmount, onMounted, ref, watch, provide } from 'vue';
import useWrapperHelper from './WrapperHelper.js';
import useWrapperHelperVue3 from './WrapperHelperVue3.js';

export default {
    name : 'BryntumContainer',

    props : {

         // Configs only
        adopt                   : { type : [HTMLElement, String], default : undefined },
        align                   : { type : [Object, String], default : undefined },
        anchor                  : { type : Boolean, default : undefined },
        ariaDescription         : { type : String, default : undefined },
        ariaLabel               : { type : String, default : undefined },
        autoUpdateRecord        : { type : Boolean, default : undefined },
        bubbleEvents            : { type : Object, default : undefined },
        callOnFunctions         : { type : Boolean, default : undefined },
        centered                : { type : Boolean, default : undefined },
        config                  : { type : Object, default : undefined },
        constrainTo             : { type : [HTMLElement, Widget, Rectangle], default : undefined },
        contentElementCls       : { type : [String, Object], default : undefined },
        defaultBindProperty     : { type : String, default : undefined },
        defaultFocus            : { type : Function, default : undefined },
        defaults                : { type : Object, default : undefined },
        dock                    : { type : [String, Object], default : undefined },
        draggable               : { type : [Boolean, Object], default : undefined },
        floating                : { type : Boolean, default : undefined },
        hideAnimation           : { type : [Boolean, Object], default : undefined },
        hideWhenEmpty           : { type : Boolean, default : undefined },
        htmlCls                 : { type : [String, Object], default : undefined },
        ignoreParentReadOnly    : { type : Boolean, default : undefined },
        itemCls                 : { type : String, default : undefined },
        lazyItems               : { type : [Object, Array], default : undefined },
        listeners               : { type : Object, default : undefined },
        localeClass             : { type : Function, default : undefined },
        localizable             : { type : Boolean, default : undefined },
        localizableProperties   : { type : Array, default : undefined },
        maskDefaults            : { type : Object, default : undefined },
        masked                  : { type : [Boolean, String, Object], default : undefined },
        monitorResize           : { type : Boolean, default : undefined },
        namedItems              : { type : Object, default : undefined },
        owner                   : { type : Widget, default : undefined },
        positioned              : { type : Boolean, default : undefined },
        preventTooltipOnTouch   : { type : Boolean, default : undefined },
        relayStoreEvents        : { type : Boolean, default : undefined },
        ripple                  : { type : [Boolean, Object], default : undefined },
        rootElement             : { type : ShadowRoot, default : undefined },
        scrollAction            : { type : [String, null], default : undefined },
        showAnimation           : { type : [Boolean, Object], default : undefined },
        showTooltipWhenDisabled : { type : Boolean, default : undefined },
        tab                     : { type : [Boolean, Object], default : undefined },
        tag                     : { type : String, default : undefined },
        textAlign               : { type : String, default : undefined },
        textContent             : { type : Boolean, default : undefined },
        title                   : { type : String, default : undefined },
        ui                      : { type : [String, Object], default : undefined },
        weight                  : { type : Number, default : undefined },

         // Configs and properties
        alignSelf    : { type : String, default : undefined },
        appendTo     : { type : [HTMLElement, String], default : undefined },
        cls          : { type : [String, Object], default : undefined },
        content      : { type : String, default : undefined },
        dataset      : { type : Object, default : undefined },
        disabled     : { type : Boolean, default : undefined },
        extraData    : { type : [String, Number, Boolean, Object], default : undefined },
        flex         : { type : [Number, String], default : undefined },
        height       : { type : [Number, String], default : undefined },
        hidden       : { type : Boolean, default : undefined },
        html         : { type : [String, Function], default : undefined },
        id           : { type : String, default : undefined },
        insertBefore : { type : [HTMLElement, String], default : undefined },
        insertFirst  : { type : [HTMLElement, String], default : undefined },
        items        : { type : [Array, Object], default : undefined },
        layout       : { type : [Layout, String, Object], default : undefined },
        layoutStyle  : { type : Object, default : undefined },
        margin       : { type : [Number, String], default : undefined },
        maxHeight    : { type : [String, Number], default : undefined },
        maxWidth     : { type : [String, Number], default : undefined },
        minHeight    : { type : [String, Number], default : undefined },
        minWidth     : { type : [String, Number], default : undefined },
        readOnly     : { type : Boolean, default : undefined },
        scrollable   : { type : [Scroller, Boolean, Object], default : undefined },
        tooltip      : { type : [String, Object], default : undefined },
        width        : { type : [Number, String], default : undefined },
        x            : { type : Number, default : undefined },
        y            : { type : Number, default : undefined },

         // Properties only
        anchorSize      : { type : Array, default : undefined },
        isSettingValues : { type : Boolean, default : undefined },
        isValid         : { type : Boolean, default : undefined },
        record          : { type : Model, default : undefined },
        type            : { type : String, default : undefined },
        values          : { type : Object, default : undefined },

         // Events
        onBeforeDestroy   : { type : Function, default : undefined },
        onBeforeHide      : { type : Function, default : undefined },
        onBeforeSetRecord : { type : Function, default : undefined },
        onBeforeShow      : { type : Function, default : undefined },
        onCatchAll        : { type : Function, default : undefined },
        onDestroy         : { type : Function, default : undefined },
        onFocusIn         : { type : Function, default : undefined },
        onFocusOut        : { type : Function, default : undefined },
        onHide            : { type : Function, default : undefined },
        onPaint           : { type : Function, default : undefined },
        onReadOnly        : { type : Function, default : undefined },
        onRecompose       : { type : Function, default : undefined },
        onResize          : { type : Function, default : undefined },
        onShow            : { type : Function, default : undefined },

    },

    emits : [
        'beforedestroy',
        'beforehide',
        'beforesetrecord',
        'beforeshow',
        'catchall',
        'destroy',
        'focusin',
        'focusout',
        'hide',
        'paint',
        'recompose',
        'resize',
        'show'
    ],

    data : () => {
        return {
            instanceClass : Container,
            instanceName : 'Container',

            configNames : [
                'adopt',
                'align',
                'anchor',
                'ariaDescription',
                'ariaLabel',
                'autoUpdateRecord',
                'bubbleEvents',
                'callOnFunctions',
                'centered',
                'config',
                'constrainTo',
                'contentElementCls',
                'defaultBindProperty',
                'defaultFocus',
                'defaults',
                'dock',
                'draggable',
                'floating',
                'hideAnimation',
                'hideWhenEmpty',
                'htmlCls',
                'ignoreParentReadOnly',
                'itemCls',
                'lazyItems',
                'listeners',
                'localeClass',
                'localizable',
                'localizableProperties',
                'maskDefaults',
                'masked',
                'monitorResize',
                'namedItems',
                'owner',
                'positioned',
                'preventTooltipOnTouch',
                'relayStoreEvents',
                'ripple',
                'rootElement',
                'scrollAction',
                'showAnimation',
                'showTooltipWhenDisabled',
                'tab',
                'tag',
                'textAlign',
                'textContent',
                'title',
                'ui',
                'weight'
            ],

            propertyConfigNames : [
                'alignSelf',
                'appendTo',
                'cls',
                'content',
                'dataset',
                'disabled',
                'extraData',
                'flex',
                'height',
                'hidden',
                'html',
                'id',
                'insertBefore',
                'insertFirst',
                'items',
                'layout',
                'layoutStyle',
                'margin',
                'maxHeight',
                'maxWidth',
                'minHeight',
                'minWidth',
                'onBeforeDestroy',
                'onBeforeHide',
                'onBeforeSetRecord',
                'onBeforeShow',
                'onCatchAll',
                'onDestroy',
                'onFocusIn',
                'onFocusOut',
                'onHide',
                'onPaint',
                'onReadOnly',
                'onRecompose',
                'onResize',
                'onShow',
                'readOnly',
                'scrollable',
                'tooltip',
                'width',
                'x',
                'y'
            ],

            propertyNames : [
                'anchorSize',
                'isSettingValues',
                'isValid',
                'record',
                'type',
                'values'
            ],

            eventNames : [
                'beforeDestroy',
                'beforeHide',
                'beforeSetRecord',
                'beforeShow',
                'catchAll',
                'destroy',
                'focusIn',
                'focusOut',
                'hide',
                'paint',
                'recompose',
                'resize',
                'show'
            ]
        };
    },

    setup(props, { emit }) {
        const instance = {};
        const refElement = ref(null);

        // Storage for teleports (in-cell Vue component instances)
        // automatically renderer by template
        const teleports = ref(new Map());

        const { createWidget, relayStores, watchProps } = useWrapperHelper();
        const { processCellContent, hasFrameworkRenderer } = useWrapperHelperVue3();

        // Provide teleports for processCellContent
        provide('teleports', teleports);

        onMounted(() => {
            const
                me = getCurrentInstance(),
                uncapitalize = str => str.charAt(0).toLowerCase() + str.slice(1),
                eventName = str => uncapitalize(str.slice(2)),
                // Collect event listeners from me.props where they are `on` functions
                listeners = Object.keys(me.props)
                    .filter(prop => typeof me.props[prop] === 'function' && prop.startsWith('on') && prop.length > 2)
                    .map(eventName);

            instance.value = createWidget({
                me,
                props   : me.props,
                data    : me.data,
                listeners,
                emit,
                element : refElement.value
            });

            const watcher = (prop, newValue) => watch(() => me.props[prop], newValue);
            watchProps(me, instance.value, me.props, me.data, watcher);
        });

        onBeforeUnmount(() => {
            if (instance.value) {
                instance.value.destroy();
            }
        });

        return { instance, refElement, teleports };
    }
};
</script>
