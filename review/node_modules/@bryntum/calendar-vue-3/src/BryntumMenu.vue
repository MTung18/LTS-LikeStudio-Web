<!-- Vue 3 wrapper for Bryntum Menu -->

<template>
    <div ref="refElement">

    </div>
</template>

<script>
import { Layout, Menu, Model, PanelCollapser, Rectangle, Scroller, StateProvider, Tool, Widget } from '@bryntum/calendar';
import { getCurrentInstance, onBeforeUnmount, onMounted, ref, watch, provide } from 'vue';
import useWrapperHelper from './WrapperHelper.js';
import useWrapperHelperVue3 from './WrapperHelperVue3.js';

export default {
    name : 'BryntumMenu',

    props : {

         // Configs only
        adopt                   : { type : [HTMLElement, String], default : undefined },
        align                   : { type : [Object, String], default : undefined },
        anchor                  : { type : Boolean, default : undefined },
        ariaDescription         : { type : String, default : undefined },
        ariaLabel               : { type : String, default : undefined },
        autoClose               : { type : Boolean, default : undefined },
        autoShow                : { type : Boolean, default : undefined },
        autoUpdateRecord        : { type : Boolean, default : undefined },
        bbar                    : { type : Object, default : undefined },
        bodyCls                 : { type : [String, Object], default : undefined },
        bubbleEvents            : { type : Object, default : undefined },
        callOnFunctions         : { type : Boolean, default : undefined },
        centered                : { type : Boolean, default : undefined },
        closable                : { type : Boolean, default : undefined },
        closeAction             : { type : String, default : undefined },
        collapsed               : { type : Boolean, default : undefined },
        collapsible             : { type : [Boolean, PanelCollapser], default : undefined },
        config                  : { type : Object, default : undefined },
        constrainTo             : { type : [HTMLElement, Widget, Rectangle], default : undefined },
        contentElementCls       : { type : [String, Object], default : undefined },
        defaultBindProperty     : { type : String, default : undefined },
        defaultFocus            : { type : Function, default : undefined },
        defaults                : { type : Object, default : undefined },
        dock                    : { type : [String, Object], default : undefined },
        draggable               : { type : [Boolean, Object], default : undefined },
        floating                : { type : Boolean, default : undefined },
        focusOnHover            : { type : Boolean, default : undefined },
        focusOnToFront          : { type : Boolean, default : undefined },
        footer                  : { type : [Object, String], default : undefined },
        forElement              : { type : HTMLElement, default : undefined },
        header                  : { type : [String, Boolean, Object], default : undefined },
        hideAnimation           : { type : [Boolean, Object], default : undefined },
        hideWhenEmpty           : { type : Boolean, default : undefined },
        htmlCls                 : { type : [String, Object], default : undefined },
        ignoreParentReadOnly    : { type : Boolean, default : undefined },
        itemCls                 : { type : String, default : undefined },
        lazyItems               : { type : [Object, Array], default : undefined },
        listeners               : { type : Object, default : undefined },
        localeClass             : { type : Function, default : undefined },
        localizable             : { type : Boolean, default : undefined },
        localizableProperties   : { type : Array, default : undefined },
        maskDefaults            : { type : Object, default : undefined },
        masked                  : { type : [Boolean, String, Object], default : undefined },
        maximizable             : { type : Boolean, default : undefined },
        modal                   : { type : Boolean, default : undefined },
        monitorResize           : { type : Boolean, default : undefined },
        namedItems              : { type : Object, default : undefined },
        owner                   : { type : Widget, default : undefined },
        positioned              : { type : Boolean, default : undefined },
        preventTooltipOnTouch   : { type : Boolean, default : undefined },
        relayStoreEvents        : { type : Boolean, default : undefined },
        ripple                  : { type : [Boolean, Object], default : undefined },
        rootElement             : { type : ShadowRoot, default : undefined },
        scrollAction            : { type : [String, null], default : undefined },
        showAnimation           : { type : [Boolean, Object], default : undefined },
        showOnClick             : { type : Boolean, default : undefined },
        showTooltipWhenDisabled : { type : Boolean, default : undefined },
        stateful                : { type : [Boolean, Object, Array], default : undefined },
        statefulEvents          : { type : [Object, Array], default : undefined },
        stateId                 : { type : String, default : undefined },
        stateProvider           : { type : StateProvider, default : undefined },
        strips                  : { type : Object, default : undefined },
        tab                     : { type : [Boolean, Object], default : undefined },
        tag                     : { type : String, default : undefined },
        tbar                    : { type : Object, default : undefined },
        textAlign               : { type : String, default : undefined },
        textContent             : { type : Boolean, default : undefined },
        trapFocus               : { type : Boolean, default : undefined },
        ui                      : { type : [String, Object], default : undefined },
        weight                  : { type : Number, default : undefined },

         // Configs and properties
        alignSelf    : { type : String, default : undefined },
        appendTo     : { type : [HTMLElement, String], default : undefined },
        cls          : { type : [String, Object], default : undefined },
        content      : { type : String, default : undefined },
        dataset      : { type : Object, default : undefined },
        disabled     : { type : Boolean, default : undefined },
        extraData    : { type : [String, Number, Boolean, Object], default : undefined },
        flex         : { type : [Number, String], default : undefined },
        height       : { type : [Number, String], default : undefined },
        hidden       : { type : Boolean, default : undefined },
        html         : { type : [String, Function], default : undefined },
        id           : { type : String, default : undefined },
        insertBefore : { type : [HTMLElement, String], default : undefined },
        insertFirst  : { type : [HTMLElement, String], default : undefined },
        items        : { type : [Array, Object], default : undefined },
        layout       : { type : [Layout, String, Object], default : undefined },
        layoutStyle  : { type : Object, default : undefined },
        margin       : { type : [Number, String], default : undefined },
        maxHeight    : { type : [String, Number], default : undefined },
        maximized    : { type : Boolean, default : undefined },
        maxWidth     : { type : [String, Number], default : undefined },
        minHeight    : { type : [String, Number], default : undefined },
        minWidth     : { type : [String, Number], default : undefined },
        readOnly     : { type : Boolean, default : undefined },
        scrollable   : { type : [Scroller, Boolean, Object], default : undefined },
        title        : { type : String, default : undefined },
        tools        : { type : Object, default : undefined },
        tooltip      : { type : [String, Object], default : undefined },
        width        : { type : [Number, String], default : undefined },
        x            : { type : Number, default : undefined },
        y            : { type : Number, default : undefined },

         // Properties only
        anchorSize      : { type : Array, default : undefined },
        isSettingValues : { type : Boolean, default : undefined },
        isValid         : { type : Boolean, default : undefined },
        parentMenu      : { type : Menu, default : undefined },
        record          : { type : Model, default : undefined },
        selectedElement : { type : HTMLElement, default : undefined },
        state           : { type : Object, default : undefined },
        type            : { type : String, default : undefined },
        values          : { type : Object, default : undefined },

         // Events
        onBeforeClose     : { type : Function, default : undefined },
        onBeforeDestroy   : { type : Function, default : undefined },
        onBeforeHide      : { type : Function, default : undefined },
        onBeforeSetRecord : { type : Function, default : undefined },
        onBeforeShow      : { type : Function, default : undefined },
        onCatchAll        : { type : Function, default : undefined },
        onDestroy         : { type : Function, default : undefined },
        onFocusIn         : { type : Function, default : undefined },
        onFocusOut        : { type : Function, default : undefined },
        onHide            : { type : Function, default : undefined },
        onItem            : { type : Function, default : undefined },
        onPaint           : { type : Function, default : undefined },
        onReadOnly        : { type : Function, default : undefined },
        onRecompose       : { type : Function, default : undefined },
        onResize          : { type : Function, default : undefined },
        onShow            : { type : Function, default : undefined },
        onToggle          : { type : Function, default : undefined },
        onToolClick       : { type : Function, default : undefined },

    },

    emits : [
        'beforeclose',
        'beforedestroy',
        'beforehide',
        'beforesetrecord',
        'beforeshow',
        'catchall',
        'destroy',
        'focusin',
        'focusout',
        'hide',
        'item',
        'paint',
        'recompose',
        'resize',
        'show',
        'toggle',
        'toolclick'
    ],

    data : () => {
        return {
            instanceClass : Menu,
            instanceName : 'Menu',

            configNames : [
                'adopt',
                'align',
                'anchor',
                'ariaDescription',
                'ariaLabel',
                'autoClose',
                'autoShow',
                'autoUpdateRecord',
                'bbar',
                'bodyCls',
                'bubbleEvents',
                'callOnFunctions',
                'centered',
                'closable',
                'closeAction',
                'collapsed',
                'collapsible',
                'config',
                'constrainTo',
                'contentElementCls',
                'defaultBindProperty',
                'defaultFocus',
                'defaults',
                'dock',
                'draggable',
                'floating',
                'focusOnHover',
                'focusOnToFront',
                'footer',
                'forElement',
                'header',
                'hideAnimation',
                'hideWhenEmpty',
                'htmlCls',
                'ignoreParentReadOnly',
                'itemCls',
                'lazyItems',
                'listeners',
                'localeClass',
                'localizable',
                'localizableProperties',
                'maskDefaults',
                'masked',
                'maximizable',
                'modal',
                'monitorResize',
                'namedItems',
                'owner',
                'positioned',
                'preventTooltipOnTouch',
                'relayStoreEvents',
                'ripple',
                'rootElement',
                'scrollAction',
                'showAnimation',
                'showOnClick',
                'showTooltipWhenDisabled',
                'stateful',
                'statefulEvents',
                'stateId',
                'stateProvider',
                'strips',
                'tab',
                'tag',
                'tbar',
                'textAlign',
                'textContent',
                'trapFocus',
                'ui',
                'weight'
            ],

            propertyConfigNames : [
                'alignSelf',
                'appendTo',
                'cls',
                'content',
                'dataset',
                'disabled',
                'extraData',
                'flex',
                'height',
                'hidden',
                'html',
                'id',
                'insertBefore',
                'insertFirst',
                'items',
                'layout',
                'layoutStyle',
                'margin',
                'maxHeight',
                'maximized',
                'maxWidth',
                'minHeight',
                'minWidth',
                'onBeforeClose',
                'onBeforeDestroy',
                'onBeforeHide',
                'onBeforeSetRecord',
                'onBeforeShow',
                'onCatchAll',
                'onDestroy',
                'onFocusIn',
                'onFocusOut',
                'onHide',
                'onItem',
                'onPaint',
                'onReadOnly',
                'onRecompose',
                'onResize',
                'onShow',
                'onToggle',
                'onToolClick',
                'readOnly',
                'scrollable',
                'title',
                'tools',
                'tooltip',
                'width',
                'x',
                'y'
            ],

            propertyNames : [
                'anchorSize',
                'isSettingValues',
                'isValid',
                'parentMenu',
                'record',
                'selectedElement',
                'state',
                'type',
                'values'
            ],

            eventNames : [
                'beforeClose',
                'beforeDestroy',
                'beforeHide',
                'beforeSetRecord',
                'beforeShow',
                'catchAll',
                'destroy',
                'focusIn',
                'focusOut',
                'hide',
                'item',
                'paint',
                'recompose',
                'resize',
                'show',
                'toggle',
                'toolClick'
            ]
        };
    },

    setup(props, { emit }) {
        const instance = {};
        const refElement = ref(null);

        // Storage for teleports (in-cell Vue component instances)
        // automatically renderer by template
        const teleports = ref(new Map());

        const { createWidget, relayStores, watchProps } = useWrapperHelper();
        const { processCellContent, hasFrameworkRenderer } = useWrapperHelperVue3();

        // Provide teleports for processCellContent
        provide('teleports', teleports);

        onMounted(() => {
            const
                me = getCurrentInstance(),
                uncapitalize = str => str.charAt(0).toLowerCase() + str.slice(1),
                eventName = str => uncapitalize(str.slice(2)),
                // Collect event listeners from me.props where they are `on` functions
                listeners = Object.keys(me.props)
                    .filter(prop => typeof me.props[prop] === 'function' && prop.startsWith('on') && prop.length > 2)
                    .map(eventName);

            instance.value = createWidget({
                me,
                props   : me.props,
                data    : me.data,
                listeners,
                emit,
                element : refElement.value
            });

            const watcher = (prop, newValue) => watch(() => me.props[prop], newValue);
            watchProps(me, instance.value, me.props, me.data, watcher);
        });

        onBeforeUnmount(() => {
            if (instance.value) {
                instance.value.destroy();
            }
        });

        return { instance, refElement, teleports };
    }
};
</script>
