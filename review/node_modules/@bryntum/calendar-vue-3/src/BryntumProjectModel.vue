<!-- Vue 3 wrapper for Bryntum ProjectModel -->

<template>
    <div ref="refElement">

    </div>
</template>

<script>
import { AssignmentModel, AssignmentStore, DependencyModel, DependencyStore, EventModel, EventStore, Model, ProjectModel, ResourceModel, ResourceStore, ResourceTimeRangeModel, ResourceTimeRangeStore, StateTrackingManager, Store, TimeSpan } from '@bryntum/calendar';
import { getCurrentInstance, onBeforeUnmount, onMounted, ref, watch, provide } from 'vue';
import useWrapperHelper from './WrapperHelper.js';
import useWrapperHelperVue3 from './WrapperHelperVue3.js';

export default {
    name : 'BryntumProjectModel',

    props : {

         // Configs only
        assignmentModelClass        : { type : Function, default : undefined },
        assignmentsData             : { type : [Array, Object], default : undefined },
        assignmentStoreClass        : { type : Function, default : undefined },
        dependenciesData            : { type : [Array, Object], default : undefined },
        dependencyModelClass        : { type : Function, default : undefined },
        dependencyStoreClass        : { type : Function, default : undefined },
        eventModelClass             : { type : Function, default : undefined },
        eventsData                  : { type : [Array, Object], default : undefined },
        eventStoreClass             : { type : Function, default : undefined },
        orderedParentIndex          : { type : Number, default : undefined },
        parentId                    : { type : [String, Number, null], default : undefined },
        parentIndex                 : { type : Number, default : undefined },
        resourceModelClass          : { type : Function, default : undefined },
        resourcesData               : { type : [Array, Object], default : undefined },
        resourceStoreClass          : { type : Function, default : undefined },
        resourceTimeRangesData      : { type : Array, default : undefined },
        resourceTimeRangeStoreClass : { type : Function, default : undefined },
        silenceInitialCommit        : { type : Boolean, default : undefined },
        timeRangeModelClass         : { type : Function, default : undefined },
        timeRangesData              : { type : Array, default : undefined },
        timeRangeStoreClass         : { type : Function, default : undefined },

         // Configs and properties
        assignments            : { type : [Array, Object], default : undefined },
        assignmentStore        : { type : [AssignmentStore, Object], default : undefined },
        children               : { type : [Boolean, Array], default : undefined },
        dependencies           : { type : [Array, Object], default : undefined },
        dependencyStore        : { type : [DependencyStore, Object], default : undefined },
        events                 : { type : [Array, Object], default : undefined },
        eventStore             : { type : [EventStore, Object], default : undefined },
        id                     : { type : [String, Number], default : undefined },
        json                   : { type : String, default : undefined },
        readOnly               : { type : Boolean, default : undefined },
        resources              : { type : [Array, Object], default : undefined },
        resourceStore          : { type : [ResourceStore, Object], default : undefined },
        resourceTimeRanges     : { type : [Array, Object], default : undefined },
        resourceTimeRangeStore : { type : [ResourceTimeRangeStore, Object], default : undefined },
        stm                    : { type : [StateTrackingManager, Object], default : undefined },
        timeRanges             : { type : [Array, Object], default : undefined },
        timeRangeStore         : { type : [Store, Object], default : undefined },
        timeZone               : { type : [String, Number], default : undefined },

         // Properties only
        allChildren                : { type : Array, default : undefined },
        autoExposeFields           : { type : Boolean, default : undefined },
        childrenField              : { type : String, default : undefined },
        convertEmptyParentToLeaf   : { type : [Boolean, Object], default : undefined },
        defaults                   : { type : Object, default : undefined },
        descendantCount            : { type : Number, default : undefined },
        hasGeneratedId             : { type : Boolean, default : undefined },
        idField                    : { type : String, default : undefined },
        inlineData                 : { type : Object, default : undefined },
        internalId                 : { type : Number, default : undefined },
        isCommitting               : { type : Boolean, default : undefined },
        isCreating                 : { type : Boolean, default : undefined },
        isValid                    : { type : Boolean, default : undefined },
        previousSiblingsTotalCount : { type : Number, default : undefined },
        relations                  : { type : Object, default : undefined },
        visibleDescendantCount     : { type : Number, default : undefined },

         // Events
        onChange    : { type : Function, default : undefined },
        onDataReady : { type : Function, default : undefined },

    },

    emits : [
        'change',
        'dataready'
    ],

    data : () => {
        return {
            instanceClass : ProjectModel,
            instanceName : 'ProjectModel',

            configNames : [
                'assignmentModelClass',
                'assignmentsData',
                'assignmentStoreClass',
                'dependenciesData',
                'dependencyModelClass',
                'dependencyStoreClass',
                'eventModelClass',
                'eventsData',
                'eventStoreClass',
                'orderedParentIndex',
                'parentId',
                'parentIndex',
                'resourceModelClass',
                'resourcesData',
                'resourceStoreClass',
                'resourceTimeRangesData',
                'resourceTimeRangeStoreClass',
                'silenceInitialCommit',
                'timeRangeModelClass',
                'timeRangesData',
                'timeRangeStoreClass'
            ],

            propertyConfigNames : [
                'assignments',
                'assignmentStore',
                'children',
                'dependencies',
                'dependencyStore',
                'events',
                'eventStore',
                'id',
                'json',
                'onChange',
                'onDataReady',
                'readOnly',
                'resources',
                'resourceStore',
                'resourceTimeRanges',
                'resourceTimeRangeStore',
                'stm',
                'timeRanges',
                'timeRangeStore',
                'timeZone'
            ],

            propertyNames : [
                'allChildren',
                'autoExposeFields',
                'childrenField',
                'convertEmptyParentToLeaf',
                'defaults',
                'descendantCount',
                'hasGeneratedId',
                'idField',
                'inlineData',
                'internalId',
                'isCommitting',
                'isCreating',
                'isValid',
                'previousSiblingsTotalCount',
                'relations',
                'visibleDescendantCount'
            ],

            eventNames : [
                'change',
                'dataReady'
            ]
        };
    },

    setup(props, { emit }) {
        const instance = {};
        const refElement = ref(null);

        // Storage for teleports (in-cell Vue component instances)
        // automatically renderer by template
        const teleports = ref(new Map());

        const { createWidget, relayStores, watchProps } = useWrapperHelper();
        const { processCellContent, hasFrameworkRenderer } = useWrapperHelperVue3();

        // Provide teleports for processCellContent
        provide('teleports', teleports);

        onMounted(() => {
            const
                me = getCurrentInstance(),
                uncapitalize = str => str.charAt(0).toLowerCase() + str.slice(1),
                eventName = str => uncapitalize(str.slice(2)),
                // Collect event listeners from me.props where they are `on` functions
                listeners = Object.keys(me.props)
                    .filter(prop => typeof me.props[prop] === 'function' && prop.startsWith('on') && prop.length > 2)
                    .map(eventName);

            instance.value = createWidget({
                me,
                props   : me.props,
                data    : me.data,
                listeners,
                emit,
                element : refElement.value
            });

            const watcher = (prop, newValue) => watch(() => me.props[prop], newValue);
            watchProps(me, instance.value, me.props, me.data, watcher);
        });

        onBeforeUnmount(() => {
            if (instance.value) {
                instance.value.destroy();
            }
        });

        return { instance, refElement, teleports };
    }
};
</script>
