<!-- Vue 3 wrapper for Bryntum ResourceView -->

<template>
    <div ref="refElement">

    </div>
</template>

<script>
import { Layout, Model, PanelCollapser, Rectangle, ResourceView, Scroller, StateProvider, Tool, Widget } from '@bryntum/calendar';
import { getCurrentInstance, onBeforeUnmount, onMounted, ref, watch, provide } from 'vue';
import useWrapperHelper from './WrapperHelper.js';
import useWrapperHelperVue3 from './WrapperHelperVue3.js';

export default {
    name : 'BryntumResourceView',

    props : {

         // Configs only
        adopt                   : { type : [HTMLElement, String], default : undefined },
        align                   : { type : [Object, String], default : undefined },
        anchor                  : { type : Boolean, default : undefined },
        ariaDescription         : { type : String, default : undefined },
        ariaLabel               : { type : String, default : undefined },
        autoCreate              : { type : [Object, String, Boolean], default : undefined },
        autoUpdateRecord        : { type : Boolean, default : undefined },
        bbar                    : { type : Object, default : undefined },
        bodyCls                 : { type : [String, Object], default : undefined },
        breakpoints             : { type : Object, default : undefined },
        bubbleEvents            : { type : Object, default : undefined },
        callOnFunctions         : { type : Boolean, default : undefined },
        centered                : { type : Boolean, default : undefined },
        collapsed               : { type : Boolean, default : undefined },
        collapsible             : { type : [Boolean, PanelCollapser], default : undefined },
        config                  : { type : Object, default : undefined },
        constrainTo             : { type : [HTMLElement, Widget, Rectangle], default : undefined },
        contentElementCls       : { type : [String, Object], default : undefined },
        defaultBindProperty     : { type : String, default : undefined },
        defaultFocus            : { type : Function, default : undefined },
        defaults                : { type : Object, default : undefined },
        dock                    : { type : [String, Object], default : undefined },
        draggable               : { type : [Boolean, Object], default : undefined },
        eventHeight             : { type : [Number, String], default : undefined },
        eventSorter             : { type : Function, default : undefined },
        floating                : { type : Boolean, default : undefined },
        footer                  : { type : [Object, String], default : undefined },
        header                  : { type : [String, Boolean, Object], default : undefined },
        hideAnimation           : { type : [Boolean, Object], default : undefined },
        hideWhenEmpty           : { type : Boolean, default : undefined },
        htmlCls                 : { type : [String, Object], default : undefined },
        ignoreParentReadOnly    : { type : Boolean, default : undefined },
        includeTimeRanges       : { type : Boolean, default : undefined },
        itemCls                 : { type : String, default : undefined },
        lazyItems               : { type : [Object, Array], default : undefined },
        listeners               : { type : Object, default : undefined },
        localeClass             : { type : Function, default : undefined },
        localizable             : { type : Boolean, default : undefined },
        localizableProperties   : { type : Array, default : undefined },
        maskDefaults            : { type : Object, default : undefined },
        masked                  : { type : [Boolean, String, Object], default : undefined },
        meta                    : { type : [String, Function], default : undefined },
        monitorResize           : { type : Boolean, default : undefined },
        namedItems              : { type : Object, default : undefined },
        nonWorkingDays          : { type : Object, default : undefined },
        owner                   : { type : Widget, default : undefined },
        positioned              : { type : Boolean, default : undefined },
        preventTooltipOnTouch   : { type : Boolean, default : undefined },
        relayStoreEvents        : { type : Boolean, default : undefined },
        resourceImagePath       : { type : String, default : undefined },
        responsive              : { type : Object, default : undefined },
        responsiveRoot          : { type : Boolean, default : undefined },
        responsiveState         : { type : String, default : undefined },
        responsiveTarget        : { type : [String, Widget], default : undefined },
        ripple                  : { type : [Boolean, Object], default : undefined },
        rootElement             : { type : ShadowRoot, default : undefined },
        scrollAction            : { type : [String, null], default : undefined },
        shortDateFormat         : { type : String, default : undefined },
        shortDateTimeFormat     : { type : String, default : undefined },
        shortEventCls           : { type : String, default : undefined },
        shortEventDuration      : { type : [String, Number], default : undefined },
        showAnimation           : { type : [Boolean, Object], default : undefined },
        showAvatars             : { type : Boolean, default : undefined },
        showResourceAvatars     : { type : [Boolean, String], default : undefined },
        showTooltipWhenDisabled : { type : Boolean, default : undefined },
        stableResourceOrder     : { type : Boolean, default : undefined },
        stateful                : { type : [Boolean, Object, Array], default : undefined },
        statefulEvents          : { type : [Object, Array], default : undefined },
        stateId                 : { type : String, default : undefined },
        stateProvider           : { type : StateProvider, default : undefined },
        strips                  : { type : Object, default : undefined },
        syncViewDate            : { type : Boolean, default : undefined },
        tab                     : { type : [Boolean, Object], default : undefined },
        tag                     : { type : String, default : undefined },
        tbar                    : { type : Object, default : undefined },
        textAlign               : { type : String, default : undefined },
        textContent             : { type : Boolean, default : undefined },
        timeFormat              : { type : String, default : undefined },
        trapFocus               : { type : Boolean, default : undefined },
        ui                      : { type : [String, Object], default : undefined },
        weekStartDay            : { type : Number, default : undefined },
        weight                  : { type : Number, default : undefined },

         // Configs and properties
        alignSelf          : { type : String, default : undefined },
        animateTimeShift   : { type : Boolean, default : undefined },
        appendTo           : { type : [HTMLElement, String], default : undefined },
        cls                : { type : [String, Object], default : undefined },
        content            : { type : String, default : undefined },
        dataset            : { type : Object, default : undefined },
        disabled           : { type : Boolean, default : undefined },
        extraData          : { type : [String, Number, Boolean, Object], default : undefined },
        flex               : { type : [Number, String], default : undefined },
        height             : { type : [Number, String], default : undefined },
        hidden             : { type : Boolean, default : undefined },
        hideNonWorkingDays : { type : Boolean, default : undefined },
        html               : { type : [String, Function], default : undefined },
        id                 : { type : String, default : undefined },
        insertBefore       : { type : [HTMLElement, String], default : undefined },
        insertFirst        : { type : [HTMLElement, String], default : undefined },
        items              : { type : [Array, Object], default : undefined },
        layout             : { type : [Layout, String, Object], default : undefined },
        layoutStyle        : { type : Object, default : undefined },
        margin             : { type : [Number, String], default : undefined },
        maxDate            : { type : [Date, String], default : undefined },
        maxHeight          : { type : [String, Number], default : undefined },
        maxWidth           : { type : [String, Number], default : undefined },
        minDate            : { type : [Date, String], default : undefined },
        minHeight          : { type : [String, Number], default : undefined },
        minWidth           : { type : [String, Number], default : undefined },
        readOnly           : { type : Boolean, default : undefined },
        resourceWidth      : { type : [Number, String], default : undefined },
        scrollable         : { type : [Scroller, Boolean, Object], default : undefined },
        title              : { type : String, default : undefined },
        tools              : { type : Object, default : undefined },
        tooltip            : { type : [String, Object], default : undefined },
        view               : { type : Object, default : undefined },
        width              : { type : [Number, String], default : undefined },
        x                  : { type : Number, default : undefined },
        y                  : { type : Number, default : undefined },

         // Properties only
        anchorSize       : { type : Array, default : undefined },
        dayCellCls       : { type : String, default : undefined },
        firstVisibleCell : { type : HTMLElement, default : undefined },
        firstVisibleDate : { type : Date, default : undefined },
        isSettingValues  : { type : Boolean, default : undefined },
        isValid          : { type : Boolean, default : undefined },
        lastVisibleCell  : { type : HTMLElement, default : undefined },
        lastVisibleDate  : { type : Date, default : undefined },
        record           : { type : Model, default : undefined },
        state            : { type : Object, default : undefined },
        type             : { type : String, default : undefined },
        values           : { type : Object, default : undefined },

         // Events
        onBeforeChangeDate            : { type : Function, default : undefined },
        onBeforeDestroy               : { type : Function, default : undefined },
        onBeforeHide                  : { type : Function, default : undefined },
        onBeforeResponsiveStateChange : { type : Function, default : undefined },
        onBeforeSetRecord             : { type : Function, default : undefined },
        onBeforeShow                  : { type : Function, default : undefined },
        onCatchAll                    : { type : Function, default : undefined },
        onDestroy                     : { type : Function, default : undefined },
        onEventAutoCreated            : { type : Function, default : undefined },
        onFocusIn                     : { type : Function, default : undefined },
        onFocusOut                    : { type : Function, default : undefined },
        onHide                        : { type : Function, default : undefined },
        onPaint                       : { type : Function, default : undefined },
        onReadOnly                    : { type : Function, default : undefined },
        onRecompose                   : { type : Function, default : undefined },
        onRefresh                     : { type : Function, default : undefined },
        onResize                      : { type : Function, default : undefined },
        onResponsiveHeightChange      : { type : Function, default : undefined },
        onResponsiveStateChange       : { type : Function, default : undefined },
        onResponsiveWidthChange       : { type : Function, default : undefined },
        onShow                        : { type : Function, default : undefined },
        onToolClick                   : { type : Function, default : undefined },
        onViewCreate                  : { type : Function, default : undefined },

    },

    emits : [
        'beforechangedate',
        'beforedestroy',
        'beforehide',
        'beforeresponsivestatechange',
        'beforesetrecord',
        'beforeshow',
        'catchall',
        'destroy',
        'eventautocreated',
        'focusin',
        'focusout',
        'hide',
        'paint',
        'recompose',
        'refresh',
        'resize',
        'responsiveheightchange',
        'responsivestatechange',
        'responsivewidthchange',
        'show',
        'toolclick',
        'viewcreate'
    ],

    data : () => {
        return {
            instanceClass : ResourceView,
            instanceName : 'ResourceView',

            configNames : [
                'adopt',
                'align',
                'anchor',
                'ariaDescription',
                'ariaLabel',
                'autoCreate',
                'autoUpdateRecord',
                'bbar',
                'bodyCls',
                'breakpoints',
                'bubbleEvents',
                'callOnFunctions',
                'centered',
                'collapsed',
                'collapsible',
                'config',
                'constrainTo',
                'contentElementCls',
                'defaultBindProperty',
                'defaultFocus',
                'defaults',
                'dock',
                'draggable',
                'eventHeight',
                'eventSorter',
                'floating',
                'footer',
                'header',
                'hideAnimation',
                'hideWhenEmpty',
                'htmlCls',
                'ignoreParentReadOnly',
                'includeTimeRanges',
                'itemCls',
                'lazyItems',
                'listeners',
                'localeClass',
                'localizable',
                'localizableProperties',
                'maskDefaults',
                'masked',
                'meta',
                'monitorResize',
                'namedItems',
                'nonWorkingDays',
                'owner',
                'positioned',
                'preventTooltipOnTouch',
                'relayStoreEvents',
                'resourceImagePath',
                'responsive',
                'responsiveRoot',
                'responsiveState',
                'responsiveTarget',
                'ripple',
                'rootElement',
                'scrollAction',
                'shortDateFormat',
                'shortDateTimeFormat',
                'shortEventCls',
                'shortEventDuration',
                'showAnimation',
                'showAvatars',
                'showResourceAvatars',
                'showTooltipWhenDisabled',
                'stableResourceOrder',
                'stateful',
                'statefulEvents',
                'stateId',
                'stateProvider',
                'strips',
                'syncViewDate',
                'tab',
                'tag',
                'tbar',
                'textAlign',
                'textContent',
                'timeFormat',
                'trapFocus',
                'ui',
                'weekStartDay',
                'weight'
            ],

            propertyConfigNames : [
                'alignSelf',
                'animateTimeShift',
                'appendTo',
                'cls',
                'content',
                'dataset',
                'disabled',
                'extraData',
                'flex',
                'height',
                'hidden',
                'hideNonWorkingDays',
                'html',
                'id',
                'insertBefore',
                'insertFirst',
                'items',
                'layout',
                'layoutStyle',
                'margin',
                'maxDate',
                'maxHeight',
                'maxWidth',
                'minDate',
                'minHeight',
                'minWidth',
                'onBeforeChangeDate',
                'onBeforeDestroy',
                'onBeforeHide',
                'onBeforeResponsiveStateChange',
                'onBeforeSetRecord',
                'onBeforeShow',
                'onCatchAll',
                'onDestroy',
                'onEventAutoCreated',
                'onFocusIn',
                'onFocusOut',
                'onHide',
                'onPaint',
                'onReadOnly',
                'onRecompose',
                'onRefresh',
                'onResize',
                'onResponsiveHeightChange',
                'onResponsiveStateChange',
                'onResponsiveWidthChange',
                'onShow',
                'onToolClick',
                'onViewCreate',
                'readOnly',
                'resourceWidth',
                'scrollable',
                'title',
                'tools',
                'tooltip',
                'view',
                'width',
                'x',
                'y'
            ],

            propertyNames : [
                'anchorSize',
                'dayCellCls',
                'firstVisibleCell',
                'firstVisibleDate',
                'isSettingValues',
                'isValid',
                'lastVisibleCell',
                'lastVisibleDate',
                'record',
                'state',
                'type',
                'values'
            ],

            eventNames : [
                'beforeChangeDate',
                'beforeDestroy',
                'beforeHide',
                'beforeResponsiveStateChange',
                'beforeSetRecord',
                'beforeShow',
                'catchAll',
                'destroy',
                'eventAutoCreated',
                'focusIn',
                'focusOut',
                'hide',
                'paint',
                'recompose',
                'refresh',
                'resize',
                'responsiveHeightChange',
                'responsiveStateChange',
                'responsiveWidthChange',
                'show',
                'toolClick',
                'viewCreate'
            ]
        };
    },

    setup(props, { emit }) {
        const instance = {};
        const refElement = ref(null);

        // Storage for teleports (in-cell Vue component instances)
        // automatically renderer by template
        const teleports = ref(new Map());

        const { createWidget, relayStores, watchProps } = useWrapperHelper();
        const { processCellContent, hasFrameworkRenderer } = useWrapperHelperVue3();

        // Provide teleports for processCellContent
        provide('teleports', teleports);

        onMounted(() => {
            const
                me = getCurrentInstance(),
                uncapitalize = str => str.charAt(0).toLowerCase() + str.slice(1),
                eventName = str => uncapitalize(str.slice(2)),
                // Collect event listeners from me.props where they are `on` functions
                listeners = Object.keys(me.props)
                    .filter(prop => typeof me.props[prop] === 'function' && prop.startsWith('on') && prop.length > 2)
                    .map(eventName);

            instance.value = createWidget({
                me,
                props   : me.props,
                data    : me.data,
                listeners,
                emit,
                element : refElement.value
            });

            const watcher = (prop, newValue) => watch(() => me.props[prop], newValue);
            watchProps(me, instance.value, me.props, me.data, watcher);
        });

        onBeforeUnmount(() => {
            if (instance.value) {
                instance.value.destroy();
            }
        });

        return { instance, refElement, teleports };
    }
};
</script>
