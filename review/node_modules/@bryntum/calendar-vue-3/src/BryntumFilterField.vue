<!-- Vue 3 wrapper for Bryntum FilterField -->

<template>
    <div ref="refElement">

    </div>
</template>

<script>
import { FieldContainer, FilterField, Rectangle, Scroller, Store, Widget } from '@bryntum/calendar';
import { getCurrentInstance, onBeforeUnmount, onMounted, ref, watch, provide } from 'vue';
import useWrapperHelper from './WrapperHelper.js';
import useWrapperHelperVue3 from './WrapperHelperVue3.js';

export default {
    name : 'BryntumFilterField',

    props : {

         // Configs only
        adopt                   : { type : [HTMLElement, String], default : undefined },
        align                   : { type : [Object, String], default : undefined },
        anchor                  : { type : Boolean, default : undefined },
        ariaDescription         : { type : String, default : undefined },
        ariaLabel               : { type : String, default : undefined },
        autoComplete            : { type : String, default : undefined },
        autoSelect              : { type : Boolean, default : undefined },
        bubbleEvents            : { type : Object, default : undefined },
        callOnFunctions         : { type : Boolean, default : undefined },
        centered                : { type : Boolean, default : undefined },
        clearable               : { type : [Boolean, Object], default : undefined },
        config                  : { type : Object, default : undefined },
        constrainTo             : { type : [HTMLElement, Widget, Rectangle], default : undefined },
        container               : { type : [Object, FieldContainer], default : undefined },
        containValues           : { type : [Boolean, String, Function], default : undefined },
        contentElementCls       : { type : [String, Object], default : undefined },
        defaultBindProperty     : { type : String, default : undefined },
        dock                    : { type : [String, Object], default : undefined },
        draggable               : { type : [Boolean, Object], default : undefined },
        editable                : { type : Boolean, default : undefined },
        field                   : { type : String, default : undefined },
        filterFunction          : { type : Function, default : undefined },
        floating                : { type : Boolean, default : undefined },
        hideAnimation           : { type : [Boolean, Object], default : undefined },
        highlightExternalChange : { type : Boolean, default : undefined },
        hint                    : { type : [String, Function], default : undefined },
        hintHtml                : { type : [String, Function], default : undefined },
        htmlCls                 : { type : [String, Object], default : undefined },
        ignoreParentReadOnly    : { type : Boolean, default : undefined },
        inline                  : { type : Boolean, default : undefined },
        inputAlign              : { type : String, default : undefined },
        inputAttributes         : { type : Object, default : undefined },
        inputType               : { type : String, default : undefined },
        inputWidth              : { type : [String, Number], default : undefined },
        keyStrokeChangeDelay    : { type : Number, default : undefined },
        labelCls                : { type : [String, Object], default : undefined },
        labelPosition           : { type : String, default : undefined },
        labels                  : { type : Array, default : undefined },
        labelWidth              : { type : [String, Number], default : undefined },
        listeners               : { type : Object, default : undefined },
        localeClass             : { type : Function, default : undefined },
        localizable             : { type : Boolean, default : undefined },
        localizableProperties   : { type : Array, default : undefined },
        maskDefaults            : { type : Object, default : undefined },
        masked                  : { type : [Boolean, String, Object], default : undefined },
        maxLength               : { type : Number, default : undefined },
        minLength               : { type : Number, default : undefined },
        monitorResize           : { type : Boolean, default : undefined },
        name                    : { type : String, default : undefined },
        owner                   : { type : Widget, default : undefined },
        placeholder             : { type : String, default : undefined },
        positioned              : { type : Boolean, default : undefined },
        preventTooltipOnTouch   : { type : Boolean, default : undefined },
        relayStoreEvents        : { type : Boolean, default : undefined },
        required                : { type : Boolean, default : undefined },
        revertOnEscape          : { type : Boolean, default : undefined },
        ripple                  : { type : [Boolean, Object], default : undefined },
        rootElement             : { type : ShadowRoot, default : undefined },
        scrollAction            : { type : [String, null], default : undefined },
        showAnimation           : { type : [Boolean, Object], default : undefined },
        showTooltipWhenDisabled : { type : Boolean, default : undefined },
        spellCheck              : { type : Boolean, default : undefined },
        store                   : { type : Store, default : undefined },
        tab                     : { type : [Boolean, Object], default : undefined },
        tabIndex                : { type : Number, default : undefined },
        tag                     : { type : String, default : undefined },
        textAlign               : { type : String, default : undefined },
        title                   : { type : String, default : undefined },
        ui                      : { type : [String, Object], default : undefined },
        validateOnInput         : { type : Boolean, default : undefined },
        weight                  : { type : Number, default : undefined },

         // Configs and properties
        alignSelf    : { type : String, default : undefined },
        appendTo     : { type : [HTMLElement, String], default : undefined },
        badge        : { type : String, default : undefined },
        cls          : { type : [String, Object], default : undefined },
        content      : { type : String, default : undefined },
        dataset      : { type : Object, default : undefined },
        disabled     : { type : Boolean, default : undefined },
        extraData    : { type : [String, Number, Boolean, Object], default : undefined },
        flex         : { type : [Number, String], default : undefined },
        height       : { type : [Number, String], default : undefined },
        hidden       : { type : Boolean, default : undefined },
        html         : { type : [String, Function], default : undefined },
        id           : { type : String, default : undefined },
        insertBefore : { type : [HTMLElement, String], default : undefined },
        insertFirst  : { type : [HTMLElement, String], default : undefined },
        label        : { type : String, default : undefined },
        margin       : { type : [Number, String], default : undefined },
        maxHeight    : { type : [String, Number], default : undefined },
        maxWidth     : { type : [String, Number], default : undefined },
        minHeight    : { type : [String, Number], default : undefined },
        minWidth     : { type : [String, Number], default : undefined },
        readOnly     : { type : Boolean, default : undefined },
        scrollable   : { type : [Scroller, Boolean, Object], default : undefined },
        tooltip      : { type : [String, Object], default : undefined },
        triggers     : { type : Object, default : undefined },
        value        : { type : [Object, String], default : undefined },
        width        : { type : [Number, String], default : undefined },
        x            : { type : Number, default : undefined },
        y            : { type : Number, default : undefined },

         // Properties only
        anchorSize : { type : Array, default : undefined },
        input      : { type : HTMLElement, default : undefined },
        type       : { type : String, default : undefined },

         // Events
        onAction        : { type : Function, default : undefined },
        onBeforeDestroy : { type : Function, default : undefined },
        onBeforeHide    : { type : Function, default : undefined },
        onBeforeShow    : { type : Function, default : undefined },
        onCatchAll      : { type : Function, default : undefined },
        onChange        : { type : Function, default : undefined },
        onClear         : { type : Function, default : undefined },
        onDestroy       : { type : Function, default : undefined },
        onFocusIn       : { type : Function, default : undefined },
        onFocusOut      : { type : Function, default : undefined },
        onHide          : { type : Function, default : undefined },
        onInput         : { type : Function, default : undefined },
        onPaint         : { type : Function, default : undefined },
        onReadOnly      : { type : Function, default : undefined },
        onRecompose     : { type : Function, default : undefined },
        onResize        : { type : Function, default : undefined },
        onShow          : { type : Function, default : undefined },
        onTrigger       : { type : Function, default : undefined },

    },

    emits : [
        'action',
        'beforedestroy',
        'beforehide',
        'beforeshow',
        'catchall',
        'change',
        'clear',
        'destroy',
        'focusin',
        'focusout',
        'hide',
        'paint',
        'recompose',
        'resize',
        'show',
        'trigger'
    ],

    data : () => {
        return {
            instanceClass : FilterField,
            instanceName : 'FilterField',

            configNames : [
                'adopt',
                'align',
                'anchor',
                'ariaDescription',
                'ariaLabel',
                'autoComplete',
                'autoSelect',
                'bubbleEvents',
                'callOnFunctions',
                'centered',
                'clearable',
                'config',
                'constrainTo',
                'container',
                'containValues',
                'contentElementCls',
                'defaultBindProperty',
                'dock',
                'draggable',
                'editable',
                'field',
                'filterFunction',
                'floating',
                'hideAnimation',
                'highlightExternalChange',
                'hint',
                'hintHtml',
                'htmlCls',
                'ignoreParentReadOnly',
                'inline',
                'inputAlign',
                'inputAttributes',
                'inputType',
                'inputWidth',
                'keyStrokeChangeDelay',
                'labelCls',
                'labelPosition',
                'labels',
                'labelWidth',
                'listeners',
                'localeClass',
                'localizable',
                'localizableProperties',
                'maskDefaults',
                'masked',
                'maxLength',
                'minLength',
                'monitorResize',
                'name',
                'owner',
                'placeholder',
                'positioned',
                'preventTooltipOnTouch',
                'relayStoreEvents',
                'required',
                'revertOnEscape',
                'ripple',
                'rootElement',
                'scrollAction',
                'showAnimation',
                'showTooltipWhenDisabled',
                'spellCheck',
                'store',
                'tab',
                'tabIndex',
                'tag',
                'textAlign',
                'title',
                'ui',
                'validateOnInput',
                'weight'
            ],

            propertyConfigNames : [
                'alignSelf',
                'appendTo',
                'badge',
                'cls',
                'content',
                'dataset',
                'disabled',
                'extraData',
                'flex',
                'height',
                'hidden',
                'html',
                'id',
                'insertBefore',
                'insertFirst',
                'label',
                'margin',
                'maxHeight',
                'maxWidth',
                'minHeight',
                'minWidth',
                'onAction',
                'onBeforeDestroy',
                'onBeforeHide',
                'onBeforeShow',
                'onCatchAll',
                'onChange',
                'onClear',
                'onDestroy',
                'onFocusIn',
                'onFocusOut',
                'onHide',
                'onInput',
                'onPaint',
                'onReadOnly',
                'onRecompose',
                'onResize',
                'onShow',
                'onTrigger',
                'readOnly',
                'scrollable',
                'tooltip',
                'triggers',
                'value',
                'width',
                'x',
                'y'
            ],

            propertyNames : [
                'anchorSize',
                'input',
                'type'
            ],

            eventNames : [
                'action',
                'beforeDestroy',
                'beforeHide',
                'beforeShow',
                'catchAll',
                'change',
                'clear',
                'destroy',
                'focusIn',
                'focusOut',
                'hide',
                'paint',
                'recompose',
                'resize',
                'show',
                'trigger'
            ]
        };
    },

    setup(props, { emit }) {
        const instance = {};
        const refElement = ref(null);

        // Storage for teleports (in-cell Vue component instances)
        // automatically renderer by template
        const teleports = ref(new Map());

        const { createWidget, relayStores, watchProps } = useWrapperHelper();
        const { processCellContent, hasFrameworkRenderer } = useWrapperHelperVue3();

        // Provide teleports for processCellContent
        provide('teleports', teleports);

        onMounted(() => {
            const
                me = getCurrentInstance(),
                uncapitalize = str => str.charAt(0).toLowerCase() + str.slice(1),
                eventName = str => uncapitalize(str.slice(2)),
                // Collect event listeners from me.props where they are `on` functions
                listeners = Object.keys(me.props)
                    .filter(prop => typeof me.props[prop] === 'function' && prop.startsWith('on') && prop.length > 2)
                    .map(eventName);

            instance.value = createWidget({
                me,
                props   : me.props,
                data    : me.data,
                listeners,
                emit,
                element : refElement.value
            });

            const watcher = (prop, newValue) => watch(() => me.props[prop], newValue);
            watchProps(me, instance.value, me.props, me.data, watcher);
        });

        onBeforeUnmount(() => {
            if (instance.value) {
                instance.value.destroy();
            }
        });

        return { instance, refElement, teleports };
    }
};
</script>
