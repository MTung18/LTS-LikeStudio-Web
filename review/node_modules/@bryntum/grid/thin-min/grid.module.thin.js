/*!
 *
 * Bryntum Grid 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{_defineProperty as e,_objectSpread2 as t,Tooltip as n,DomHelper as o,ArrayHelper as r,DateHelper as l,VersionHelper as i,InstancePlugin as s,BrowserHelper as a,Objects as d,Editor as c,Delayable as u,GlobalEvents as g,EventHelper as h,Rectangle as m,StringHelper as f,DomSync as p,DomClassList as C,DomDataStore as b,Combo as x,ObjectHelper as v}from"./chunks/Editor.js";import{ColumnStore as w,Column as y,GridFeatureManager as R,Location as E}from"./chunks/GridBase.js";export{Bar,CellEdit,CellMenu,CheckColumn,Column,ColumnDragToolbar,ColumnPicker,ColumnReorder,ColumnResize,ColumnStore,Filter,FilterBar,Footer,GridBase,GridElementEvents,GridFeatureManager,GridFeatures,GridFieldFilterPicker,GridFieldFilterPickerGroup,GridResponsive,GridSelection,GridState,GridSubGrids,Group,Header,HeaderMenu,Location,Row,RowManager,RowNumberColumn,Sort,Stripe,SubGrid,WidgetColumn}from"./chunks/GridBase.js";import{NumberColumn as I}from"./chunks/RegionResize.js";export{NumberColumn,RegionResize}from"./chunks/RegionResize.js";export{DateColumn}from"./chunks/DateColumn.js";export{Tree,TreeColumn}from"./chunks/Tree.js";export{GridRowModel}from"./chunks/GridRowModel.js";export{ColumnAutoWidth,Grid,RowCopyPaste}from"./chunks/Grid.js";export{ExcelExporter,GroupSummary,TableExporter}from"./chunks/ExcelExporter.js";export{RowReorder,TreeGroup}from"./chunks/TreeGroup.js";export{ExportDialog,ExportOrientationCombo,ExportRowsCombo,MultiPageExporter,MultiPageVerticalExporter,PdfExport,SinglePageExporter,Summary}from"./chunks/PdfExport.js";export{Exporter,FileFormat,Orientation,PaperFormat,RowsRange}from"./chunks/Exporter.js";export{TreeGrid}from"./chunks/TreeGrid.js";import"./chunks/MessageDialog.js";class S extends y{get groupHeaderReserved(){return!0}construct(e,t){const n=this;super.construct(...arguments),e.width||e.flex||n.grid.ion({paint:"updateAutoWidth",thisObj:n}),n.disableIfGridReadOnly&&n.grid.element.classList.add("b-actioncolumn-readonly"),n.externalRenderer=n.renderer,n.renderer=n.internalRenderer}internalRenderer({grid:e,column:o,record:r,callExternalRenderer:l=!0}){var i;const s=r&&"groupRowFor"in r.meta,{subGrid:a}=o;var d;l&&(null===(d=this.externalRenderer)||void 0===d||d.call(this,...arguments));return{className:{"b-action-ct":1},children:null===(i=o.actions)||void 0===i?void 0:i.map(((e,l)=>{var i;if("visible"in e){if("function"==typeof e.visible&&!1===e.visible({record:r}))return"";if(!1===e.visible)return""}if(s&&!e.showForGroup||!s&&e.showForGroup)return"";const{tooltip:d,renderer:c}=e,u="function"==typeof d||null!=d&&null!==(i=d.startsWith)&&void 0!==i&&i.call(d,"up.")?a.callback(d,a,[{record:r}]):d||"";if(c){const i=a.callback(c,a,[{index:l,record:r,column:o,tooltip:u,action:e}]);return"string"==typeof i?{tag:"span",dataset:t(t({},n.encodeConfig(u)),{},{index:l}),html:i}:(i.dataset=i.dataset||{},i.dataset.index=l,i)}return{tag:"button",dataset:t(t({},n.encodeConfig(u)),{},{index:l}),"aria-label":u,className:{"b-tool":1,"b-action-item":1,[e.cls]:e.cls}}}))}}onCellClick({grid:e,column:t,record:n,target:o}){var r;if(t!==this||!o.classList.contains("b-action-item"))return;let l=o.dataset.index;l||(l=o.parentElement.dataset&&o.parentElement.dataset.index);const i=null===(r=t.actions)||void 0===r?void 0:r[l],s=i&&i.onClick;s&&this.callback(s,t,[{record:n,action:i,target:o}])}updateAutoWidth(){const e=this,n=[],{actions:r}=e;if(!e.element)return;const l=e.actions=[];null==r||r.forEach((e=>{const o=t({},e);delete o.visible,o.showForGroup?(delete o.showForGroup,n.push(o)):l.push(o)})),n.length>l.length&&(e._actions=n);const i=o.createElement(e.internalRenderer({column:e,callExternalRenderer:!1})).outerHTML;e.width=o.measureText(i,e.element,!0,e.element.parentElement),e.actions=r}}e(S,"type","action"),e(S,"fields",[{name:"actions",type:"array"},{name:"disableIfGridReadOnly",defaultValue:!1}]),e(S,"defaults",{filterable:!1,groupable:!1,sortable:!1,editor:!1,searchable:!1,htmlEncode:!1,resizable:!1,minWidth:30}),w.registerColumnType(S),S.exposeProperties(),S._$name="ActionColumn";class T extends I{static get defaults(){return{function:"sum",includeParentInChangeSet:!1}}construct(e,t){this.configuredAlign="align"in e,this.configuredEditor="editor"in e,super.construct(...arguments);const{grid:n}=t;"sum"===this.function&&(this.function="sumChildren"),n&&(this.store=n.store)}set store(e){const t=this,n={update:"onRecordUpdate",thisObj:t,prio:1e3},o=t._store;if(e!==o){o&&o.un(n),t._store=e;const{modelClass:r}=e,l=r.fieldMap[t.field];l&&"number"===l.type&&(t.configuredAlign||(t.align="end"),t.configuredEditor||(t.editor="number")),e.ion(n)}}canEdit(e){return e.isLeaf}get store(){return this._store}sumChildren(...e){let t=0;for(let n=0,{length:o}=e;n<o;n++)t+=parseFloat(e[n]||0,10);return t}avg(...e){let t=0;const{length:n}=e;for(let o=0;o<n;o++)t+=parseFloat(e[o]||0,10);return t/n}onRecordUpdate({record:e,changes:t}){const n=this,{rowManager:o}=n.grid;n.field in t&&e.isLeaf&&e.bubble((e=>{const t=o.getRowFor(e);if(t){const e=t.getCell(n.field);e&&t.renderCell(e)}}),!0)}getRawValue(e){var t;let n=0;if(null!==(t=e.children)&&void 0!==t&&t.length){const t=this,o=t.function,r="string"==typeof o&&"function"==typeof Math[o],{handler:l,thisObj:i}=r?{handler:Math[o],thisObj:Math}:t.resolveCallback(o);n=l.apply(i,e.children.map((e=>t.getRawValue(e)))),t.includeParentInChangeSet?e.set(t.field,n,!0):e.setData(t.field,n)}else n=e[this.field];return n}canFillValue(){return!1}}e(T,"type","aggregate"),e(T,"fields",["function","includeParentInChangeSet"]),w.registerColumnType(T,!0),T.exposeProperties(),T._$name="AggregateColumn";class M extends I{static get defaults(){return{min:0,max:100,showValue:!1,lowThreshold:20,htmlEncode:!1,searchable:!1,summaryRenderer:e=>`${e}%`,fitMode:!1}}constructor(e,t){super(...arguments),this.internalCellCls="b-percent-bar-cell"}defaultRenderer({value:e}){return{className:"b-percent-bar-outer",role:"progressbar","aria-Valuemin":0,"aria-Valuemax":100,"aria-Valuenow":e=e||0,tabIndex:0,children:[{tag:"div",className:{"b-percent-bar":1,"b-zero":0===e,"b-low":e<this.lowThreshold},style:{width:e+"%"},children:[this.showValue?{tag:"span",text:e+"%"}:void 0]}]}}resizeToFitContent(){}}e(M,"type","percent"),e(M,"fieldType","number"),e(M,"fields",["showValue","lowThreshold"]),M.sum="average",w.registerColumnType(M,!0),M._$name="PercentColumn";class F extends I{static get defaults(){return{min:0,max:5,emptyIcon:"b-icon b-icon-star",filledIcon:"b-icon b-icon-star",editable:!0,filterType:"number",searchable:!1,width:"11.2em",htmlEncode:!1,minWidth:"11.2em",editor:!1,fitMode:"value"}}renderer({value:e}){return{className:{"b-rating-cell-inner":1,"b-not-editable":!this.editable},children:r.populate(this.max,(t=>{const n=t<e;return{tag:"i",className:{"b-rating-icon":!0,"b-filled":n,"b-empty":!n,[n?this.filledIcon:this.emptyIcon]:!0}}}))}}onCellClick({grid:e,column:t,record:n,target:o,event:r}){if(o.classList.contains("b-rating-icon")&&!e.readOnly&&t.editable){let e=[].indexOf.call(o.parentNode.childNodes,o);o.classList.contains("b-filled")&&(r.metaKey||r.shiftKey)&&(e-=1),1===n.get(t.field)&&0===e&&(e=-1),n.set(t.field,e+1)}}}e(F,"$name","RatingColumn"),e(F,"type","rating"),e(F,"fieldType","number"),e(F,"fields",["emptyIcon","filledIcon","editable"]),w.registerColumnType(F,!0),F.exposeProperties(),F._$name="RatingColumn";class k extends y{static get defaults(){return{htmlEncode:!1}}constructor(e,t){super(...arguments);if(!this.template)throw new Error("TemplateColumn needs a template");if("function"!=typeof this.template)throw new Error("TemplateColumn.template must be a function")}renderer(e){if(!e.record.isSpecialRow)return this.template({value:e.value,record:e.record,field:e.column.field})}}e(k,"type","template"),e(k,"fields",["template"]),w.registerColumnType(k,!0),k.exposeProperties(),k._$name="TemplateColumn";class H extends y{static get defaults(){return{format:"LT",minWidth:140,filterType:"time"}}defaultRenderer({value:e}){return e?this.formatValue(e):""}groupRenderer({cellElement:e,groupRowFor:t}){e.innerHTML=this.formatValue(t)}formatValue(e){return"string"==typeof e&&(e=l.parse(e,this.format)),l.format(e,this.format)}set format(e){const{editor:t}=this;this.set("format",e),t&&(t.format=e)}get format(){return this.get("format")}get defaultEditor(){return{name:this.field,type:"time",format:this.format}}}e(H,"type","time"),e(H,"fieldType","date"),e(H,"fields",["format"]),w.registerColumnType(H,!0),H.exposeProperties(),H._$name="TimeColumn";class L extends s{constructor(...t){super(...t),e(this,"entityName","cell")}afterConstruct(){super.afterConstruct(),this.afterSelectionModeChange()}afterSelectionModeChange(){const e=this;e.client.selectionMode.cell?e._disabledBySelectionMode&&(e.disabled=!1,delete e._disabledBySelectionMode):e.disabled=!0}get copyOnly(){var e;return this._copyOnly||!(null!==(e=this.client.features.cellEdit)&&void 0!==e&&e.enabled)}get canCopy(){return!this.disabled&&!this.client.selectedRecords.length&&this.client.selectedCells.length}get canCutPaste(){var e;return this.canCopy&&!this.copyOnly&&!(null!==(e=this.client.features.cellEdit)&&void 0!==e&&e.isEditing)&&!this.client.readOnly}isActionAvailable(e,t){return this.canCopy&&("copy"===t||this.canCutPaste)}async sendToClipboard(e){const t=this;let n=0,o=0,r="";e.sort(((e,t)=>e.rowIndex===t.rowIndex?e.columnIndex-t.columnIndex:e.rowIndex-t.rowIndex));for(const a of e){var l,i;const{record:e,column:d,rowIndex:c,columnIndex:u}=a;c>n?(r.length>0&&(r+="\n".repeat(c-n)),n=c,o=u):u>o&&(r.length>0&&(r+="\t".repeat(u-o)),o=u);let g=null===(l=d.toClipboardString)||void 0===l?void 0:l.call(d,a);var s;if(void 0===g)g=null===(s=e.get(d.field))||void 0===s?void 0:s.toString();t.toCopyString&&(g=t.toCopyString({currentValue:g,column:d,record:e})),g=null===(i=g)||void 0===i?void 0:i.replace(/[\n\t]/," "),r+=g||t.emptyValueChar}return await a.writeToClipboard(r,this.useNativeClipboard),r}async cut(){await this.copy(!0)}async copy(e){const t=this,{client:n,entityName:o}=t,r="boolean"==typeof e&&e,l=r?n.selectedCells.filter((e=>{var t;return!(null!==(t=e.record)&&void 0!==t&&t.readOnly)})):n.selectedCells;if(l){if((r?!t.canCutPaste:!t.canCopy)||!1===n.trigger("beforeCopy",{cells:l,isCut:r,entityName:o}))return;const e=await t.sendToClipboard(l);if(!0===r)for(const e of l)e.column.readOnly||e.record.set(e.column.field,null);n.trigger("copy",{cells:l,copiedDataString:e,isCut:r,entityName:o})}}async paste(){const e=this,{client:t,entityName:n}=e,o=await a.readFromClipboard(e.useNativeClipboard),r=t.selectedCells[0];if(!e.canCutPaste||null==o||!o.length||!r||!1===t.trigger("beforePaste",{clipboardData:o,targetCell:r,entityName:n}))return;const l=new Set,i=e.stringAs2dArray(o),s=[],{_shiftSelectRange:d}=t;if(null!=i&&i.length){if(null!=d&&d.some((e=>e.equals(r)))){const t=e.cellSelectorsAs2dArray(d);if((null==t?void 0:t.length)%i.length==0&&t.columnCount%i.columnCount==0)for(let e=0;e<t.length;e+=i.length)for(let n=0;n<t.columnCount;n+=i.columnCount)s.push(t[e][n])}s.length||s.push(r);for(const n of s)for(let o=0;o<i.length;o++){const r=i[o],s=t.store.getAt(n.rowIndex+o);if(s&&!s.readOnly)for(let o=0;o<r.length;o++){const i=t.columns.getAt(n.columnIndex+o),a=null==i?void 0:i.field;let d=r[o];a&&d&&!i.readOnly&&(d===e.emptyValueChar&&(d=null),i.fromClipboardString&&(d=i.fromClipboardString({string:d,record:s})),e.toPasteValue&&(d=e.toPasteValue({currentValue:d,record:s,column:i,field:a})),s.set(a,d,!1,!1,!1,!0),l.add(s))}}t.trigger("paste",{clipboardData:o,targetCell:r,modifiedRecords:[...l],entityName:n})}}cellSelectorsAs2dArray(e){const t=[];let n,o=null;for(const r of e)r.id!==o&&(o=r.id,n=[],t.push(n)),n.push(r);return t.columnCount=t[0].length,!t.some((e=>e.length!==t.columnCount))&&t}stringAs2dArray(e){const t=[],n=e.split(/\r\n|(?!\r\n)[\n-\r\x85\u2028\u2029]/);for(const e of n){const n=e.split("\t");if(t.columnCount&&n.length!==t.columnCount)return!1;t.columnCount=n.length,t.push(n)}return t}populateCellMenu({record:e,items:t}){const n=this;n.canCopy&&(t.cutCell={text:n.cutText,localeClass:n,icon:"b-icon b-icon-cut",weight:115,disabled:e.readOnly||!n.canCutPaste,onItem:()=>n.cut()},t.pasteCell={text:n.pasteText,localeClass:n,icon:"b-icon b-icon-paste",weight:120,disabled:e.readOnly||!n.canCutPaste,onItem:()=>n.paste()},t.copyCell={text:n.copyText,localeClass:n,cls:"b-separator",icon:"b-icon b-icon-copy",weight:110,onItem:()=>n.copy()})}}e(L,"$name","CellCopyPaste"),e(L,"pluginConfig",{chain:["populateCellMenu","afterSelectionModeChange"]}),e(L,"configurable",{copyOnly:null,emptyValueChar:" ",keyMap:{"Ctrl+C":"copy","Ctrl+X":"cut","Ctrl+V":"paste"},useNativeClipboard:!i.isTestEnv,toCopyString:null,toPasteValue:null,copyText:"L{copy}",cutText:"L{cut}",pasteText:"L{paste}"}),L._$name="CellCopyPaste",R.registerFeature(L);class A extends s{construct(e,t){super.construct(e,this.processConfig(t))}initTip(){const e=this;e.tip=n.new({forElement:e.client.element,forSelector:".b-grid-row:not(.b-group-row) .b-grid-cell, .b-grid-merged-cells",hoverDelay:1e3,trackMouse:!1,cls:"b-celltooltip-tip",getHtml:e.getTooltipContent.bind(e),internalListeners:{pointerOver:"onPointerOver",thisObj:e},listeners:e.configuredListeners},e.initialConfig),e.relayEvents(e.tip,["beforeShow","show"])}onPointerOver({target:e}){const t=this.client.getColumnFromElement(e);return!1!==t.tooltipRenderer&&Boolean(t.tooltipRenderer||this.tooltipRenderer)}processConfig(e){return"function"==typeof e?{tooltipRenderer:e}:e}setConfig(e){super.setConfig(this.processConfig(e))}doDestroy(){this.tip&&this.tip.destroy(),super.doDestroy()}doDisable(e){e?this.tip&&(this.tip.destroy(),this.tip=null):this.initTip(),super.doDisable(e)}getTooltipContent({tip:e,activeTarget:t,event:n}){const o=this,r=o.client.getRecordFromElement(t),l=o.client.getColumnFromElement(t),i={cellElement:t,record:r,column:l,event:n,tip:e,cellTooltip:o};let s;return o.forSelector||r!==o.lastRecord||r.generation!==o.lastRecordGeneration||l!==o.lastColumn?(o.lastRecord=r,o.lastRecordGeneration=r.generation,o.lastColumn=l,l.tooltipRenderer?s=l.tooltipRenderer(i):o.tooltipRenderer&&!1!==l.tooltipRenderer&&(s=o.tooltipRenderer(i)),d.isPromise(s)&&(o.lastRecord=o.lastRecordGeneration=o.lastColumn=null),s):o.tip._html}}e(A,"$name","CellTooltip"),e(A,"configurable",{tooltipRenderer:null}),A._$name="CellTooltip",R.registerFeature(A);class $ extends s{doDestroy(){var e;null===(e=this.editor)||void 0===e||e.destroy(),super.doDestroy()}static get pluginConfig(){return{after:["populateHeaderMenu"]}}populateHeaderMenu({items:e,column:t}){e.rename={weight:215,icon:"b-fw-icon b-icon-edit",text:this.L("L{rename}"),disabled:t.readOnly,onItem:()=>this.startEdit(t)}}startEdit(e){var t;e instanceof Event&&(e=null===(t=this.client.getHeaderDataFromEvent(e))||void 0===t?void 0:t.column);if(e){if(e.readOnly)return!1;const{textWrapper:t}=e;let{editor:n}=this;n||(this.editor=n=new c({owner:this.client,align:{align:"t0-t0"}})),n.render(t),n.startEdit({target:t,record:e,field:"text"})}}}e($,"$name","ColumnRename"),e($,"configurable",{keyMap:{F2:"startEdit"}}),$._$name="ColumnRename",R.registerFeature($,!1);class _ extends(s.mixin(u)){constructor(...t){super(...t),e(this,"delayable",{handleSelection:"raf"})}afterConstruct(){super.afterConstruct(),this.client.selectionMode.cell||(this.disabled=!0),this._fillListeners={}}onContentChange(){this.handleSelection()}afterColumnsChange(){this.handleSelection()}fixElementHeights(){this.handleSelection()}getCellDataFromEvent(e,t){return t&&(t=!e.target.classList.contains("b-fill-handle")),this.overridden.getCellDataFromEvent(e,t)}findPatternsIn2dRange(e,t,n){const o={};for(const n of e){const e=t?n.id:n.columnId;let r=n.record[n.column.field];r&&"string"==typeof r&&!isNaN(r)&&(r=parseFloat(r)),o[e]||(o[e]=[]),o[e].push(r)}for(const e in o)o[e].pattern=this.findPatternsIn1dRange(o[e],n);return o}findPatternsIn1dRange(e,t){const n=e[t?0:e.length-1],o={next:()=>n,lastValue:n};if(e.every((e=>"number"==typeof e))||e.every((e=>e instanceof Date))){const n=e.map(((t,n)=>t-e[n-1]));n.shift(),1===new Set(n).size&&(o.increaseBy=n[0]*(t?-1:1),o.next=()=>(o.lastValue instanceof Date?o.lastValue=new Date(o.lastValue.getTime()+o.increaseBy):o.lastValue+=o.increaseBy,o.lastValue))}else e.length>1&&(o.stringPattern=[...e],o.next=()=>(void 0===o.currentIndex?o.currentIndex=0:(o.currentIndex+=1,o.currentIndex>=o.stringPattern.length&&(o.currentIndex=0)),o.stringPattern[o.currentIndex]));return o}afterSelectionChange(){const e=this;g.isMouseDown()?(e.client.delayUntilMouseUp((()=>e.handleSelection(!0))),e.removeElements()):e.handleSelection(!0)}handleSelection(){if(!this._isExtending){const e=this.rangeSelection;e?this.drawFillHandleAndBorder(e[0],e[e.length-1]):this.removeElements()}}onMouseDown(e){this._fillListeners.mouseMoveOrUp=h.on({element:globalThis,mouseover:"onMouseOver",mouseup:"onMouseUp",thisObj:this}),e.stopImmediatePropagation(),e.handled=!0}onMouseUp(){const e=this,{client:t,currentRange:n,_isCropping:o}=e,r=e.rangeSelection,l=r&&n&&t.internalSelectRange(n.from,n.to),i=(null==l?void 0:l.selectedCells)||[],s=o?e.croppingCells:i.filter((e=>!r.some((t=>t.equals(e,!0)))));if(delete e._isCropping,e._isExtending&&(t.disableScrollingCloseToEdges(t.items),delete e._isExtending),null!=s&&s.length){if(t.suspendRefresh(),o)s.forEach((e=>e.record.set(e.column.field,null,!1,!1,!1,!0)));else{const[t]=s,n=r.some((e=>e.record===t.record)),o=n?t.columnIndex<r[0].columnIndex:t.rowIndex<r[0].rowIndex,l=e.findPatternsIn2dRange(r,n,o),i=new Map;o&&s.reverse();for(const t of s){const{column:o,record:s}=t;if(o.canFillValue({range:r,record:s,cell:t})){var a,d;let c=null===(a=e.calculateFillValue)||void 0===a?void 0:a.call(e,{range:r,column:o,record:s,cell:t}),u=i.get(s);if(u||(u={},i.set(s,u)),void 0===c){c=l[n?t.id:t.columnId].pattern.next()}u[o.field]=(null===(d=o.calculateFillValue)||void 0===d?void 0:d.call(o,{value:c,record:s,range:r}))||c}}for(const[e,t]of i)e.set(t,null,null,null,null,!0)}t.resumeRefresh(!0),t.performSelection(l),delete e.currentRange,e.handleSelection()}else e.handleSelection()}onMouseOver(e){var t,n;const o=this,{client:r,rangeSelection:l}=o,i=l[0],s=l[l.length-1],a=r.getCellDataFromEvent(e,!0);let d=a&&r.normalizeCellContext(a.cellSelector);if((null===(t=d)||void 0===t||null===(n=t._column)||void 0===n?void 0:n.region)===i._column.region){const e=l.some((e=>e.equals(d,!0)));let t;o._isExtending||r.enableScrollingCloseToEdges(r.items),e?o._isCropping=o.allowCropping&&(d.rowIndex<s.rowIndex||d.columnIndex<s.columnIndex):d.rowIndex>=i.rowIndex&&d.rowIndex<=s.rowIndex?(t=i.columnIndex>d.columnIndex,d=new E({grid:r,record:t?i.record:s.record,column:d.column})):(t=i.rowIndex>d.rowIndex,d=new E({grid:r,record:d.record,column:t?i.column:s.column}));const n=t?d:i,a=t||e&&!o._isCropping?s:d;o.currentRange={from:n,to:a},o._isExtending=!0,o.drawFillHandleAndBorder(n,a,!0)}}drawFillHandleAndBorder(e,t,n=!1){var r;const l=this,{client:i,currentRange:s,_fillListeners:a}=l,d=i.subGrids[e.column.region].element,{x:c}=m.from(e.cell||e.column.element,d),{right:u}=m.from(t.cell||t.column.element,d),{y:g}=i.getRecordCoords(e.record,!0),f=i.getRecordCoords(t.record,!0).bottom-1;let{borderElement:p,handleElement:C}=l;if(l.removeElements(n),p||(l.borderElement=p=o.createElement({className:"b-fill-selection-border"}),l.handleElement=C=o.createElement({className:"b-fill-handle"})),o.setRect(p,{y:g,x:c,width:u-c,height:f-g}),d.appendChild(p),o.setTopLeft(C,f,u>=d.scrollWidth?c:u),d.appendChild(C),l.toggleCroppingCls(!1),delete l.croppingCells,l._isCropping&&null!==(r=l.rangeSelection)&&void 0!==r&&r.length){const e=i.getRange(s.from,s.to);l.croppingCells=l.rangeSelection.filter((t=>!e.some((e=>e.equals(t,!0))))),l.toggleCroppingCls()}a.handleClick||(a.handleClick=h.on({element:globalThis,delegate:".b-fill-handle",mousedown:"onMouseDown",thisObj:l})),l.hasFillElements=!0}toggleCroppingCls(e=!0){var t;null===(t=this.croppingCells)||void 0===t||t.forEach((t=>{var n;return null===(n=this.client.getCell(t))||void 0===n?void 0:n.classList.toggle("b-indicate-crop",e)}))}removeElements(e=!1){var t,n;const o=this;null===(t=o.handleElement)||void 0===t||t.remove(),null===(n=o.borderElement)||void 0===n||n.remove(),e||o.removeListeners(),o.hasFillElements=!1}removeListeners(){const e=this;for(const t in e._fillListeners)e._fillListeners[t]();e._fillListeners={}}get rangeSelection(){var e;const{client:t}=this,{selectedCells:n}=t,o=null!==(e=t._shiftSelectRange)&&void 0!==e?e:1===n.length&&n;return!t.selectedRecords.length&&null!=o&&o.length&&o.length===n.length&&o.every((e=>n.some((t=>e.equals(t,!0)))&&e._column.parent&&e._column.region===o[0]._column.region&&t.store.isAvailable(e.id)))?o:null}}e(_,"$name","FillHandle"),e(_,"configurable",{calculateFillValue:null,allowCropping:!1}),e(_,"pluginConfig",{chain:["afterSelectionChange","onContentChange","afterColumnsChange","fixElementHeights"],override:["getCellDataFromEvent"]}),_._$name="FillHandle",R.registerFeature(_);const O={mousedown:"mouseDown",mousemove:"mouseMove",mouseup:"mouseUp",touchdown:"touchDown",touchmove:"touchMove",touchup:"touchUp",mouseover:"mouseOver",mouseout:"mouseOut",dblclick:"dblClick",keydown:"keyDown",keypress:"keyPress",keyup:"keyUp",contextmenu:"contextMenu"};class D extends s{constructor(...t){super(...t),e(this,"mergedRanges",[]),e(this,"mergedMap",{})}static get pluginConfig(){return{chain:["beforeRenderCell","afterRenderRow","bindStore","afterColumnsChange","afterRemove","afterToggleGroup","afterToggleSubGrid","handleEvent","populateHeaderMenu","afterSelectionChange"],before:["onInternalResize"],override:["getColumnFromElement","getRecordFromElement"]}}afterConstruct(){const e=this,{client:t}=e;t.eachSubGrid((t=>e.setupSubGrid(t))),t.rowManager.ion({renderDone:"onRenderDone",thisObj:e}),e.bindStore(t.store)}setupSubGrid(e){e.$mergedCellsElement=o.createElement({parent:e.element,className:{"b-grid-merged-cells-container":1}})}doDisable(e){this.isConfiguring||(this.isDisabling=!0,this.reset(),this.isDisabling=!1),super.doDisable(e)}updatePassthrough(e){this.client.element.classList.toggle("b-mergecells-passthrough",e)}bindStore(e){this.detachListeners("store"),e.ion({name:"store",change:"onStoreChange",refresh:{prio:1,fn:"onStoreRefresh"},thisObj:this})}onInternalResize(){this.refreshBounds()}beforeRenderCell(e){const{column:t,record:n,cellElement:o}=e,r=this.client.subGrids[t.region];if(!this.disabled&&t.mergeCells&&t.isSorted&&!n.isSpecialRow&&!r.collapsed){const r=this.getMergeRange(n,t);null!=r&&r.use&&(o.classList.add("b-merged-cell"),o.innerHTML="",e.cellElement=r.cellElement)}}afterRenderRow({row:e,oldId:t,oldHeight:n}){t===e.id&&n!==e.height&&(this.heightChanged=!0)}afterColumnsChange({action:e,changes:t,column:n}){if(!this.disabled)if("update"!==e||!t.mergeCells||n.mergeCells)this.refreshBounds();else{for(const e of this.mergedRanges.slice())e.column===n&&this.removeRange(e);this.syncDom()}}afterRemove(){!this.disabled&&this.reset()}afterToggleGroup(){!this.disabled&&this.reset()}afterToggleSubGrid(){!this.disabled&&this.reset()}afterSelectionChange(){if(!this.passthrough){const{client:e}=this,t=e.selectedRecords.map((t=>e.store.indexOf(t)));let n=!1;for(const e of this.mergedRanges){let o=!0;for(let n=e.fromIndex;n<=e.toIndex&&o;n++)o=t.includes(n);e.isSelected!==o&&(e.isSelected=o,n=!0)}n&&this.syncDom()}}getRecordFromElement(e){var t;return null!==(t=e.elementData)&&void 0!==t&&t.range?this.client.store.getAt(e.elementData.range.fromIndex):this.overridden.getRecordFromElement(e)}getColumnFromElement(e){var t;return null!==(t=e.elementData)&&void 0!==t&&t.range?e.elementData.range.column:this.overridden.getColumnFromElement(e)}populateHeaderMenu({column:e,items:t}){!1!==e.mergeable&&(t.mergeCells={text:"L{MergeCells.mergeCells}",icon:"b-fw-icon "+(e.mergeCells?"b-icon-checked":"b-icon-unchecked"),tooltip:"L{MergeCells.menuTooltip}",cls:"b-separator",weight:500,disabled:this.disabled,onItem:()=>e.mergeCells=!e.mergeCells})}async handleEvent(e){if(!this.passthrough){const n=e.target.closest(".b-grid-merged-cells");if(n){var t;const{client:o}=this,{range:r}=n.elementData,{cellEdit:l}=o.features,{column:i}=r,s=f.capitalize(null!==(t=O[e.type])&&void 0!==t?t:e.type),a={grid:o,records:[],column:i,cellElement:n.firstElementChild,target:e.target,event:e};for(let e=r.fromIndex;e<=r.toIndex;e++)a.records.push(o.store.getAt(e));if(o.trigger(`mergedCell${s}`,a),(null==l?void 0:l.triggerEvent.toLowerCase())===`cell${s}`.toLowerCase()){const t=o.rowManager.getRowAt(e.clientY);await l.startEditing({id:t.id,columnId:i.id})}else"click"===e.type&&this.onRangeClick({range:r})}}}onRangeClick({range:e}){const t=[];for(let n=e.fromIndex;n<=e.toIndex;n++)t.push(this.client.store.getAt(n));this.client.selectedRecords=t}onStoreChange(){!this.disabled&&this.reset()}onStoreRefresh({action:e}){"filter"!==e&&"dataset"!==e&&!this.disabled&&this.reset(!1)}createRangeElement(e){var t,n,r;const l=this.client.getSubGridFromColumn(e.column).$mergedCellsElement,i=`${e.fromIndex}-@-${e.column.id}`;let s=null!==(t=null===(n=l.syncIdMap)||void 0===n?void 0:n[i])&&void 0!==t?t:null===(r=l.releasedIdMap)||void 0===r?void 0:r[i];return l.releasedIdMap&&delete l.releasedIdMap[i],s||(s=o.createElement(this.createRangeDomConfig(e))),p.addChild(l,s,i),e.element=s,e.cellElement=s.firstElementChild,s}createRangeDomConfig(e){var t;const{column:n,fromIndex:o,toIndex:r,top:l,left:i,width:s,height:a}=e,{type:d}=n,c=this.client.store.getAt(o),u={className:{"b-grid-merged-cells":1,"b-selected":e.isSelected},elementData:{range:e},style:{top:l,left:i,height:a,width:s},dataset:{syncId:`${o}-@-${n.id}`,fromIndex:o,toIndex:r,column:n.field,columnId:n.id},children:[{className:new C(this.client.cellCls).assign({[`b-${null==d?void 0:d.toLowerCase()}-cell`]:d,[n.cellCls]:n.cellCls,[n.internalCellCls]:n.internalCellCls}).assign(n.autoCls),keepChildren:!0,elementData:{range:e},dataset:{column:n.field,columnId:n.id},style:{height:this.client.rowManager.rowHeight}}]};return null===(t=n.mergedRenderer)||void 0===t||t.call(n,{domConfig:u,value:n.getRawValue(c),record:c,column:n,fromIndex:o,toIndex:r}),u}buildMergedCellsConfig(e,t,n){var o,r,l,i;const s=this,{client:a}=s,{rowManager:d}=a;e=null!==(o=e)&&void 0!==o?o:null===(r=d.topRow)||void 0===r?void 0:r.dataIndex,t=null!==(l=t)&&void 0!==l?l:null===(i=d.bottomRow)||void 0===i?void 0:i.dataIndex;const c=a.regions.reduce(((e,t)=>(e[t]={className:{"b-grid-merged-cells-container":1},children:[]},e)),{});for(const o of s.mergedRanges)o.use&&o.fromIndex<=t&&o.toIndex>=e&&(s.updateRange(o,s.heightChanged,n),c[o.column.region].children.push(s.createRangeDomConfig(o)));return c}syncDom(e=!1){const t=this,{client:n}=t,{rowManager:o}=n;if(!e&&!o.topRow||t.disabled&&!t.isDisabling)return;const r=this.buildMergedCellsConfig();n.eachSubGrid((e=>{p.sync({targetElement:e.$mergedCellsElement,syncIdField:"syncId",domConfig:r[e.region]})})),t.heightChanged=!1}onRenderDone(){this.syncDom()}removeRange(e){r.remove(this.mergedRanges,e);for(let t=e.fromIndex;t<=e.toIndex;t++)delete this.mergedMap[`${t}-@-${e.column.id}`]}reset(e=!0){const t=this,n=t.client.columns.visibleColumns.filter((e=>e.mergeCells&&e.isSorted),!0),o=t.mergedRanges.length;if(t.mergedRanges=[],t.mergedMap={},e&&!t.client.refreshSuspended){for(const e of t.client.rowManager.rows)for(const t of n)e.renderCell(e.getCell(t.id));t.syncDom(o&&!t.client.rowManager.rowCount)}}refreshBounds(){const{mergedRanges:e}=this,t=new Map;for(const n of e.slice()){const{column:e}=n,{element:o}=e;if(o){let r=t.get(e);r||t.set(e,r=m.from(o,o.parentElement)),n.left=r.left,n.width=r.width}else this.removeRange(n)}this.syncDom()}updateRange(e,t,n=null){const{store:o,rowManager:r}=this.client,{topRendered:l,bottomRendered:i}=e,{rowOffsetHeight:s}=r;let a,d,{fromIndex:c,toIndex:u}=e;if((t=n?n.length>0:t)||!l||!i){if(!l||t){if(n){const e=n.findIndex((e=>e.dataIndex>=c));a=n[e],c=a.dataIndex}else do{a=r.getRowById(o.getAt(c))}while(!a&&c++<u);e.topRendered=c===e.fromIndex;const t=c-e.fromIndex;e.top=a.top-t*(n?a.offsetHeight:s)}if(!i||t){if(n){const e=n.findIndex((e=>e.dataIndex===u));d=n[-1===e?n.length-1:e],c=d.dataIndex}else do{d=r.getRowById(o.getAt(u))}while(!d&&u-- >c);e.bottomRendered=u===e.toIndex;const t=e.toIndex-u;e.bottom=d.bottom+t*(n?d.offsetHeight:s)}e.height=e.bottom-e.top}}getMergeRange(e,t){if(e.isSpecialRow)return;const n=this,{mergedMap:o}=n,{store:r}=n.client,l=t.id,i=r.indexOf(e),s=`${i}-@-${l}`;let a=o[s];if(!a){const d=t.getRawValue(e);a=o[s]={column:t},n.mergedRanges.push(a);let c,u,g=i;do{c=r.getAt(--g),u=c&&t.getRawValue(c),u===d&&(o[`${g}-@-${l}`]=a)}while(c&&u===d);let h,f,p=i;do{h=r.getAt(++p),f=h&&t.getRawValue(h),f===d&&(o[`${p}-@-${l}`]=a)}while(h&&f===d);if(a.fromIndex=g+1,a.toIndex=p-1,a.toIndex-a.fromIndex>0){const e=m.from(t.element,t.element.parentElement);a.left=e.left,a.width=e.width,a.use=!0}}return!a.element&&a.use&&n.createRangeElement(a),a}}e(D,"$name","MergeCells"),e(D,"configurable",{passthrough:!0}),D._$name="MergeCells",R.registerFeature(D);class N extends s{static get $name(){return"QuickFind"}static get pluginConfig(){return{chain:["onElementKeyPress","onCellNavigate"]}}static get properties(){return{hitCls:"b-quick-hit",hitCellCls:"b-quick-hit-cell",hitCellBadgeCls:"b-quick-hit-cell-badge",hitTextCls:"b-quick-hit-text"}}construct(e,t){super.construct(e,t),Object.assign(this,{grid:e,treeWalker:e.setupTreeWalker(e.element,o.NodeFilter.SHOW_TEXT,(()=>o.NodeFilter.FILTER_ACCEPT))})}isActionAvailable(){const{focusedCell:e}=this.grid;return!this.disabled&&(null==e?void 0:e.record)&&!e.isActionable&&this.find.length>0}doDisable(e){e&&this.clear(),super.doDisable(e)}get store(){return this.grid.store}showQuickFind(){const e=this,t=e.grid.getHeaderElement(e.columnId);if(t){if(!e.headerField){const[n,r,l]=o.createElement({tag:"div",className:"b-quick-hit-header",children:[{tag:"div",className:"b-quick-hit-field"},{tag:"div",className:"b-quick-hit-badge"}]},{returnAll:!0});"header"===e.mode?t.appendChild(n):(n.className+=" b-quick-hit-mode-grid",e.grid.element.appendChild(n)),e.headerField={header:n,field:r,badge:l,colHeader:t}}e.headerField.field.innerHTML=e.find,e.headerField.badge.innerHTML=e.found.length,t.classList.add("b-quick-find-header"),e.renderListenerInitialized||(e.grid.rowManager.ion({rendercell:e.renderCell,thisObj:e}),e.renderListenerInitialized=!0)}}hideQuickFind(){const e=this,{grid:t,headerField:n}=e;for(const n of e.prevFound||e.found){const o=t.getRowById(n.id);if(o){o.forceInnerHTML=!0;const t=o.getCell(e.columnId);t._content=null,o.renderCell(t),o.forceInnerHTML=!1}}n&&(n.header.parentNode.removeChild(n.header),n.colHeader.classList.remove("b-quick-find-header"),e.headerField=null),e.renderListenerInitialized&&(t.rowManager.un({rendercell:e.renderCell},e),e.renderListenerInitialized=!1),t.trigger("hideQuickFind")}search(e,t=this.columnId){const n=this,{grid:r}=n,l=r.columns.getById(t)||r.columns.get(t),i=n.store.findByField(l.field,e,l.mergeCells&&l.isSorted);let s=1;Object.assign(n,{foundMap:{},prevFound:n.found,found:i,find:e,columnId:l.id,findRe:new RegExp(`(\\s+)?(${f.escapeRegExp(String(e))})(\\s+)?`,"ig")}),e?n.showQuickFind():n.hideQuickFind();for(const e of o.children(r.element,`.${n.hitCls}`))e.classList.remove(n.hitCls,n.hitCellCls),e._originalContent&&(e.innerHTML=e._originalContent,e._originalContent=null);if(i){i.length>0&&n.gotoClosestHit(r.focusedCell,i);for(const e of i){n.foundMap[e.id]=s++;const t=r.getRowById(e.data.id);if(null==t||t.renderCell(t.getCell(l.id)),s>1e3)break}r.trigger("quickFind",{find:e,found:i})}}clear(){var e;(this.find||null!==(e=this.found)&&void 0!==e&&e.length)&&this.search("")}get foundCount(){var e,t;return null!==(e=null===(t=this.found)||void 0===t?void 0:t.length)&&void 0!==e?e:0}gotoHit(e){const t=this.found[e];return t&&this.grid.focusCell({columnId:this.columnId,id:t.id},{doSelect:!0}),!!t}gotoClosestHit(e,t){const n=e?this.grid.store.indexOf(e.id):0,o=t.slice().sort(((e,t)=>Math.abs(e.index-n)-Math.abs(t.index-n)));this.gotoHit(t.indexOf(o[0]))}gotoFirstHit(){this.gotoHit(0)}gotoLastHit(){this.gotoHit(this.found.length-1)}gotoNextHit(){var e,t,n;const o=this,{grid:r}=o,l=null!==(e=null===(t=r._focusedCell)||void 0===t?void 0:t.id)&&void 0!==e?e:null===(n=r.lastFocusedCell)||void 0===n?void 0:n.id,i=r.store.indexOf(l)||0,s=o.found.find((e=>e.index>i));s?r.focusCell({columnId:o.columnId,id:s.id},{doSelect:!0}):o.gotoFirstHit()}gotoPrevHit(){var e,t,n;const o=this,{grid:r,found:l}=o,i=null!==(e=null===(t=r._focusedCell)||void 0===t?void 0:t.id)&&void 0!==e?e:null===(n=r.lastFocusedCell)||void 0===n?void 0:n.id,s=r.store.indexOf(i)||0;let a;if(l.length){for(let e=l.length-1;e--;e>=0)if(l[e].index<s){a=l[e];break}a?r.focusCell({columnId:o.columnId,id:a.id},{doSelect:!0}):o.gotoLastHit()}}renderCell({cellElement:e,column:t,record:n}){var r;const l=this,{classList:i}=e,{treeWalker:s,findRe:a,hitTextCls:d}=l,c=l.columnId===t.id&&(null===(r=l.foundMap)||void 0===r?void 0:r[n.id]);if(c){i.add(l.hitCls),e.isQuickHit=!0,e._originalContent=e.innerHTML;const t=s.currentNode=o.down(e,".b-grid-cell-value,.b-tree-cell-value")||e;for(let e=s.nextNode();e&&t.contains(e);){const t=e,n=e.nodeValue,r=["<span>"];e=s.nextNode();let l=a.lastIndex;for(let e=a.exec(n);e;e=a.exec(n)){const t=n.substring(l,e.index),o=e[1]?" ":"",i=e[2],s=e[3]?" ":"";r.push(`${f.encodeHtml(t)}${o}<span class="${d}">${i}</span>${s}`),l=a.lastIndex}r.push(f.encodeHtml(n.substring(l)),"</span>"),t.parentNode.insertBefore(o.createElementFromTemplate(r.join(""),{fragment:!0}),t),t.remove()}o.createElement({parent:e,className:l.hitCellBadgeCls,text:c})}}onBackspace(e){const t=this;return!!t.find&&(t.find=t.find.substr(0,t.find.length-1),t.search(t.find),!0)}clearSearch(){return!!this.find&&(this.find="",this.search(this.find),!0)}showFilterEditor(){const e=this,{filter:t}=e.client.features;t&&e.columnId&&e.foundCount&&(e.clear(),t.showFilterEditor(e.client.columns.getById(e.columnId),e.find))}onElementKeyPress(e){var t;const n=this,{grid:o}=n,{focusedCell:r}=o;if(!e.handled&&!n.disabled&&null!=r&&r.record&&!r.isActionable&&1===(null===(t=e.key)||void 0===t?void 0:t.length)){const t=o.columns.getById(o._focusedCell.columnId);t&&!1!==t.searchable&&(n.columnId=o._focusedCell.columnId,n.find+=e.key,n.search(n.find))}}onCellNavigate(e,t,n){const o=this;!o.find||n&&n.columnId===o.columnId||o.clear()}}e(N,"configurable",{mode:"header",find:"",keyMap:{F3:"gotoNextHit","Shift+F3":"gotoPrevHit","Ctrl+g":"gotoNextHit","Ctrl+Shift+g":"gotoPrevHit","Ctrl+Shift+f":"showFilterEditor",Escape:"clearSearch",Backspace:"onBackspace"}}),N._$name="QuickFind",R.registerFeature(N);const P={remove:1,filter:1,dataset:1,replace:1};class G extends s{static get properties(){return{expanderBodyClass:"b-rowexpander-body",expandedRowClass:"b-rowexpander-row-expanded",recordStateMap:new Map,collapsingRecords:new Set}}static get pluginConfig(){return{chain:["afterColumnsChange","beforeRenderRow","processRowHeight","bindStore"],override:["onGridBodyFocusIn"]}}afterConstruct(){const e=this,{client:t}=e;e.renderer?(t.isGanttBase&&!1!==t.fixedRowHeight&&console.warn("When using RowExpander on a Gantt, the Gantt`s fixedRowHeight config must be set to false."),e.bindStore(t.store),e.triggerEvent&&t.ion({[e.triggerEvent]:"onTriggerEvent",thisObj:e}),e.addColumn()):console.warn("RowExpander requires implementing the renderer function.")}bindStore(e){const t=this;t.recordStateMap.clear(),t.collapsingRecords.clear(),t.detachListeners("clientStoreChange"),e.ion({name:"clientStoreChange",change:t.onStoreChange,thisObj:t})}doDisable(e){const{client:t}=this;e&&(this.recordStateMap.clear(),this.collapsingRecords.clear()),t.isConfiguring||t.rowManager.renderFromRow(),super.doDisable(e)}changeLoadingIndicatorText(e){return e?this.L(e):e}onGridBodyFocusIn(e){var t,n;null!==(t=this.client.lastMousedownEvent)&&void 0!==t&&null!==(n=t.target)&&void 0!==n&&n.closest(".b-rowexpander-body")||this.overridden.onGridBodyFocusIn(e)}get isAnimating(){return this.client.isAnimating}set isAnimating(e){const{client:t}=this,n=t.isAnimating;t.isAnimating=e,t.isAnimating!==n&&t.element.classList.toggle("b-rowexpander-animating")}afterColumnsChange(){this.addColumn()}changeColumn(e){return null==e?e:t(t({type:"action",actions:[{cls:"b-icon b-icon-collapse-down",tooltip:({record:e})=>this.L(this.recordStateMap.has(e)?"L{RowExpander.collapse}":"L{RowExpander.expand}"),onClick:({record:e})=>this.toggleExpand(e)}],width:40,hideable:!1,align:"center",region:this.client.regions[0]},e),{},{field:"expanderActionColumn"})}addColumn(){const e=this,{column:t}=e,{columns:n}=e.client;e._isAddingExpanderColumn||!t||e._expander&&n.includes(e._expander)||(e._isAddingExpanderColumn=!0,"last"===e.columnPosition?[e._expander]=n.add(t):[e._expander]=n.insert(0,t),e._isAddingExpanderColumn=!1)}onTriggerEvent({target:e}){this.disabled||null!=e&&e.closest(".b-action-cell")||!e.closest(".b-grid-cell")||this.toggleExpand(this.client.getRecordFromElement(e))}toggleExpand(e){e&&(this.recordStateMap.has(e)?this.collapse(e):this.expand(e))}onStoreChange({action:e,source:t,records:n}){const o=this,{recordStateMap:r,collapsingRecords:l}=o;if(!o.disabled)if("removeAll"===e)r.clear(),l.clear();else if(P[e])for(const[e]of r)t.includes(e)||(r.delete(e),l.delete(e));else if(o.refreshOnRecordChange&&null!=n&&n.length)if("update"===e){const e=r.get(n[0]);null!=e&&e.isCreated&&(e.isCreated=!1,o.client.rowManager.renderFromRecord(n[0]))}else if("updatemultiple"===e){let e,l;for(const o of n){const n=r.get(o);if(null!=n&&n.isCreated){n.isCreated=!1;const r=t.records.indexOf(o);(!l||e>r)&&(e=r,l=o)}}l&&o.client.rowManager.renderFromRecord(l)}}processRowHeight(e,t){var n;const o=this.recordStateMap.get(e);if(o){if(!o.isCreated&&o.isRenderingAsync)return this.loadingIndicatorHeight+t;if(!o.expanderBodyHeight)for(const e of this.client.regions){const t=o.expandElements[e].offsetHeight;t>o.expanderBodyHeight&&(o.expanderBodyHeight=t)}}return(null!==(n=null==o?void 0:o.expanderBodyHeight)&&void 0!==n?n:0)+t}beforeRenderRow({row:e,record:t}){const n=this,{regions:r}=n.client,{expandedRowClass:l}=n;e.cls.toggle("b-rowexpander-disabled",n.disabled),e.cls[l]?n.enableAnimations&&n.isAnimating&&n.collapsingRecords.has(t)?n.waitForTransition(e,(()=>{n.collapsingRecords.has(t)&&n.removeExpander(e)})):n.removeExpander(e):n.collapsingRecords.delete(t);const i=n.recordStateMap.get(t);if(!n.disabled&&i){i.isCreated||n.renderExpander(t,e,i),e.cls.add(l);for(const t of r){const o=e.getElement(t);i.isCreated?o.appendChild(i.expandElements[t]):n.renderLoadingIndicator(o,i),n.lockCellHeight(o,i.cellHeight,!1)}n._shouldScrollIntoView&&(n._shouldScrollIntoView=!1,o.isInView(i.expandElements[r[0]],!0)||n.client.rowManager.ion({once:!0,thisObj:n,renderDone:()=>n.scrollRowIntoView(e,t)}))}}scrollRowIntoView(e,t){this.isAnimating?this.waitForTransition(e,(()=>this.client.scrollRowIntoView(t))):this.client.scrollRowIntoView(t)}waitForTransition(e,t){h.onTransitionEnd({element:e.element,property:"height",handler:t,thisObj:this})}removeExpander(e){e.cls.remove(this.expandedRowClass);for(const t of this.client.regions){const n=e.getElement(t);n.classList.remove(this.expandedRowClass),o.removeEachSelector(n,"."+this.expanderBodyClass),this.lockCellHeight(n,null,!1)}}renderLoadingIndicator(e,t){o.createElement({parent:e,className:this.expanderBodyClass+" b-rowexpander-loading",style:{top:t.cellHeight,height:this.loadingIndicatorHeight},children:[{tag:"i",className:"b-icon b-icon-spinner"},this.loadingIndicatorText]})}renderExpander(e,t,n){var r;const l=this,i=null===(r=t.cells[0])||void 0===r?void 0:r.offsetHeight,s={},a=[],c=(e,t,n)=>{null!=e&&("string"==typeof e?t.innerHTML=e:(e=o.createElement(e),t.appendChild(e))),s[n]=t};if(!n.isRenderingAsync){Object.assign(n,{cellHeight:i,expandElements:s,expanderBodyHeight:0});for(const n of l.client.regions){const r=t.getElement(n);t.addCls(l.expandedRowClass);const s=o.createElement({parent:r,className:l.expanderBodyClass,style:{top:i+"px"}}),u=l.renderer({record:e,expanderElement:s,rowElement:r,region:n});d.isPromise(u)?a.push(u.then((e=>c(e,s,n)))):c(u,s,n)}a.length?(n.isRenderingAsync=!0,Promise.all(a).then((()=>{var t;n.isCreated=!0,null===(t=l.renderRowsWithAnimation)||void 0===t||t.call(l,e),n.isRenderingAsync=!1}))):n.isCreated=!0}}renderRowsWithAnimation(e){const t=this;if(t.enableAnimations){const n=t.client.rowManager.getRowById(e);n&&(t.isAnimating=!0,t.collapsingRecords.has(e)&&n.addCls("b-row-is-collapsing"),t.waitForTransition(n,(()=>{var e;(t.isAnimating=!1,n.isDestroyed)||(null===(e=n.removeCls)||void 0===e||e.call(n,"b-row-is-collapsing"))})))}t.client.rowManager.renderFromRecord(e)}lockCellHeight(e,t,n){for(let o=0;o<e.children.length;o++){const r=e.children[o];r.classList.contains(this.expanderBodyClass)||(r.style.height=n?"":t+"px")}}async expand(e){const t=this;t.disabled||!1!==await t.trigger("beforeExpand",{record:e})&&(t.recordStateMap.set(e,{isCreated:!1}),t.collapsingRecords.delete(e),t._shouldScrollIntoView=!0,t.renderRowsWithAnimation(e))}async collapse(e){const t=this;t.disabled||!1!==await t.trigger("beforeCollapse",{record:e})&&(t.recordStateMap.delete(e),t.collapsingRecords.add(e),t.renderRowsWithAnimation(e))}}e(G,"$name","RowExpander"),e(G,"configurable",{renderer:null,triggerEvent:null,column:{},columnPosition:"first",refreshOnRecordChange:!1,loadingIndicatorHeight:100,loadingIndicatorText:"L{loading}",enableAnimations:!0}),G._$name="RowExpander",R.registerFeature(G);class B extends(u(s)){static get $name(){return"Search"}static get configurable(){return{limit:1e3,showHitIndex:!0,keyMap:{F3:"gotoNextHit","Ctrl+g":"gotoNextHit","Shift+F3":"gotoPrevHit","Ctrl+Shift+g":"gotoPrevHit"}}}static get properties(){return{hitCls:"b-search-hit",hitCellCls:"b-search-hit-cell",hitCellBadgeCls:"b-search-hit-cell-badge",hitTextCls:"b-search-hit-text"}}construct(e,t){super.construct(e,t),Object.assign(this,{grid:e,text:"",hitEls:[],treeWalker:e.setupTreeWalker(e.element,o.NodeFilter.SHOW_TEXT,(()=>o.NodeFilter.FILTER_ACCEPT))}),e.ion({expandNode:"onTreeNodeExpand",thisObj:this})}isActionAvailable(){return Boolean(this.text)}onTreeNodeExpand(){this.text&&this.requestAnimationFrame(this.search,[this.text,!1,!0])}doDestroy(){this.clear(!0),super.doDestroy()}doDisable(e){e&&this.clear(),super.doDisable(e)}get store(){return this.grid.store}static get pluginConfig(){return{chain:["populateCellMenu"]}}async search(e,t=!0,n=!1,o){const r=this;if(!e)return r.clear();if(!n&&e===r.text||r.disabled)return;const{grid:l,store:i}=r,s=l.columns.visibleColumns.filter((e=>!1!==e.searchable)),a=[];o=o||s.map((e=>{var t;return a.push(null===(t=e.formatValue)||void 0===t?void 0:t.bind(e)),e.field}));const d=i.search(e,o,a);i.isTree&&d.length&&await l.expandTo(d.map((e=>e.id)));for(const e of s)if(e.mergeCells&&e.isSorted){let t=null,n=null;for(const o of d)if(o.field===e.field){const e=o.data[o.field];e===t&&(o.belongsTo=n),t=e,n=`${o.field}-${o.id}`}}let c=1;if(Object.assign(r,{foundMap:{},prevFound:r.found,found:d,text:e,findRe:new RegExp(`(\\s+)?(${f.escapeRegExp(String(e))})(\\s+)?`,"ig")}),r.clearHits(),d){for(const e of d)if(r.foundMap[`${e.field}-${e.id}`]=e.belongsTo?r.foundMap[e.belongsTo]:c++,c>r.limit)break;return r.listenersInitialized||(l.rowManager.ion({name:"renderCell",renderCell:"renderCell",thisObj:r}),i.ion({name:"storeRefresh",[`refresh${l.asyncEventSuffix}`]:"onStoreRefresh",thisObj:r}),r.listenersInitialized=!0),l.refreshRows(),l.trigger("search",{grid:l,find:e,found:d}),t&&!r.isHitFocused&&r.gotoNextHit(!0),d}}clearHits(){for(const e of o.children(this.grid.element,"."+this.hitCls)){e.classList.remove(this.hitCls,this.hitCellCls);const t=b.get(e).row;t&&(t.forceInnerHTML=!0,t.renderCell(e),t.forceInnerHTML=!1)}}clear(e=!1){const t=this,{grid:n}=t;t.foundMap&&delete t.foundMap,t.text=null,t.clearHits(),t.listenersInitialized&&(this.detachListeners("renderCell"),this.detachListeners("storeRefresh"),t.listenersInitialized=!1),e||n.trigger("clearSearch",{grid:n})}get foundCount(){var e,t;return null!==(e=null===(t=this.found)||void 0===t?void 0:t.length)&&void 0!==e?e:0}get isHitFocused(){var e;const t=this,{grid:n}=t,{focusedCell:r}=n;if(null!=r&&null!==(e=r.cell)&&void 0!==e&&e.contains(o.getActiveElement(n.element))){const{rowIndex:e,column:n}=r;return-1!==e&&t.found.some((t=>t.index===e&&n&&t.field===n.field))}}gotoNextHit(e=!1){var t;const n=this;if(null===(t=n.found)||void 0===t||!t.length)return;const{grid:o,store:r}=n,l=o.focusedCell||o.lastFocusedCell,i=l&&!0!==e?r.indexOf(l.record,void 0,!0):-1,s=n.found.findIndex((e=>e.index>i));-1!==s&&n.gotoHit(s)}gotoPrevHit(){var e;const t=this,{store:n}=t;if(null===(e=t.found)||void 0===e||!e.length)return;const{grid:o,found:r}=t,l=o.focusedCell||o.lastFocusedCell,i=l?n.indexOf(l.record,void 0,!0):0;for(let e=r.length-1;e--;e>=0){if(r[e].index<i){t.gotoHit(e);break}}}gotoHit(e){const{grid:t}=this,n=this.found[e];return n&&t.focusCell({field:n.field,id:n.id}),Boolean(n)}gotoFirstHit(){this.gotoHit(0)}gotoLastHit(){this.gotoHit(this.found.length-1)}renderCell({cellElement:e,column:t,record:n,value:r}){var l;const i=this,{treeWalker:s,findRe:a,hitTextCls:d,showHitIndex:c}=i,u=null===(l=i.foundMap)||void 0===l?void 0:l[t.field+"-"+n.id];if(u){var g;e.classList.add(i.hitCls),c&&(null===(g=e.querySelector(`.${i.hitCellBadgeCls}`))||void 0===g||g.remove());const t=o.down(e,".b-grid-cell-value,.b-tree-cell-value")||e;if(String(r).toLowerCase()===String(i.text).toLowerCase())t.innerHTML=`<span class="${i.hitTextCls}">${t.innerHTML}</span>${c?`<div class="${i.hitCellBadgeCls}">${u}</div>`:""}`;else{s.currentNode=t;for(let e=s.nextNode();e&&t.contains(e);){const t=e,n=e.nodeValue,r=["<span>"];e=s.nextNode();let l=a.lastIndex;for(let e=a.exec(n);e;e=a.exec(n)){const t=n.substring(l,e.index),o=e[1]?" ":"",i=e[2],s=e[3]?" ":"";r.push(`${f.encodeHtml(t)}${o}<span class="${d}">${i}</span>${s}`),l=a.lastIndex}r.push(f.encodeHtml(n.substring(l)),"<span>"),t.parentNode.insertBefore(o.createElementFromTemplate(r.join(""),{fragment:!0}),t),t.remove()}c&&o.createElement({parent:e,className:i.hitCellBadgeCls,text:u})}i.hitEls.push(e)}}populateCellMenu({column:e,record:t,items:n,cellElement:o}){const r=this;e.searchable&&(n.search={text:"L{searchForValue}",localeClass:r,icon:"b-fw-icon b-icon-search",cls:"b-separator",weight:200,disabled:r.disabled,onItem:()=>{let e=globalThis.getSelection().toString();e||(e=o.innerText),r.search(e)}})}onStoreRefresh(){this.search(this.text,!1,!0)}}B.featureClass="b-search",B._$name="Search",R.registerFeature(B);class V extends s{static get $name(){return"StickyCells"}static get defaultConfig(){return{contentSelector:null,currentTopRowCls:"b-sticky-cells-current-top-row"}}static get pluginConfig(){return{before:["renderRows"]}}construct(e,t){super.construct(e,t),e.ion({scroll:"onGridScroll",thisObj:this}),Object.assign(this,o.createElement({reference:"element",parent:e.element,className:"b-grid-sticky-row",children:[{reference:"contentElement",className:"b-grid-cell"}]})),this.removeClasses={"b-focused":!1,"b-hover":!1,"b-selected":!1,[this.currentTopRowCls]:!1}}renderRows(){this.element.classList.add("b-hide-visibility")}onGridScroll(){const e=this,{client:t,element:n,contentElement:r}=e,l=m.client(t.bodyContainer).roundPx(),i=t.rowManager.getRowAt(l.y),s=i!==e.currentTopRow;if(i){s&&(e.currentTopRow&&(e.currentTopRow.removeCls(e.currentTopRowCls),e.currentTopRow.removeCls("b-not-enough-height")),e.currentTopRow=i,i.addCls(e.currentTopRowCls),r.innerHTML="",r.appendChild(e.updateStickyContent()));const t=e.currentTopRow.bottom-e.client.scrollable.y<=e.stickyContentHeight;e.element.classList[t?"add":"remove"]("b-hide-visibility"),e.currentTopRow[t?"addCls":"removeCls"]("b-not-enough-height"),l.y+=e.stickyContentTop,o.alignTo(n,e.stickyEls[0],{align:"t0-t0",constrainTo:l},!0)}e.lastProcessedTopRow=i}updateStickyContent(){const e=this,{currentTopRow:t,removeClasses:n}=e,r={"b-grid-sticky-row":1},l={},i=e.stickyContent||(e.stickyContent=document.createDocumentFragment()),s=e.stickyEls||(e.stickyEls=[]);for(s.forEach((e=>{e.classList.remove("b-sticky-content-el")})),s.length=0,t.eachElement((t=>{s.push(...t.querySelectorAll(e.contentSelector))}));i.firstChild;)i.remove(i.firstChild);return e.stickyContentHeight=0,e.stickyContentTop=0,s.map((t=>{t.closest(".b-grid-cell").classList.forEach((e=>l[e]=1)),t.closest(".b-grid-row").classList.forEach((e=>r[e]=1)),Object.assign(l,n),Object.assign(r,n);const o=t.offsetTop;e.stickyContentTop=Math.max(e.stickyContentTop,o),t.style.alignSelf="flex-end",e.stickyContentHeight=Math.max(e.stickyContentHeight,e.currentTopRow.height-t.offsetTop+o),t.style.alignSelf="";const s=t.cloneNode(!0);return t.classList.add("b-sticky-content-el"),i.appendChild(s),s})),l["b-focused"]=!1,o.syncClassList(e.contentElement,l),o.syncClassList(e.element,r),i}}V._$name="StickyCells",R.registerFeature(V,!1);class j extends x{configure(e){super.configure(e);const t=this;t.ion({change(){t.picker.selectedRecords=t.value}})}changePicker(e,t){const n=this;return super.changePicker(v.assign({},e,{type:"treegrid",minWidth:"35em",readOnly:n.readOnly,disableGridRowModelWarning:!0,selectedRecords:n.value.map((e=>n.store.getById(e))),selectionMode:{row:!0,multiSelect:n.multiSelect,rowCheckboxSelection:!0},internalListeners:{selectionChange({selection:e}){n.value=e}}}),t)}}e(j,"$name","TreeCombo"),e(j,"type","treecombo"),e(j,"configurable",{multiSelect:!0,chipView:{itemTpl:e=>f.xss`${e.name}`,scrollable:{overflowX:"hidden-scroll"}}}),j.initClass(),j._$name="TreeCombo";export{S as ActionColumn,T as AggregateColumn,L as CellCopyPaste,A as CellTooltip,$ as ColumnRename,_ as FillHandle,D as MergeCells,M as PercentColumn,N as QuickFind,F as RatingColumn,G as RowExpander,B as Search,V as StickyCells,k as TemplateColumn,H as TimeColumn,j as TreeCombo};
//# sourceMappingURL=grid.module.thin.js.map
