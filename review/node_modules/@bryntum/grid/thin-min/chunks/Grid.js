/*!
 *
 * Bryntum Grid 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{GridFeatureManager as e,GridBase as t}from"./GridBase.js";import{Delayable as r,InstancePlugin as o,_defineProperty as s}from"./Editor.js";class i extends(r(o)){static get $name(){return"ColumnAutoWidth"}static get configurable(){return{default:null,delay:0}}static get pluginConfig(){return{after:{bindStore:"bindStore",unbindStore:"unbindStore",renderRows:"syncAutoWidthColumns",onInternalResize:"onInternalResize"},assign:["columnAutoWidthPending","syncAutoWidthColumns"]}}construct(e){super.construct(e);const{store:t}=this.client;t&&this.bindStore(t)}doDestroy(){this.unbindStore(),super.doDestroy()}bindStore(e){this.lastSync=null,e.ion({name:"store",[`change${this.client.asyncEventSuffix}`]:"onStoreChange",thisObj:this})}unbindStore(){this.detachListeners("store")}get columnAutoWidthPending(){return null===this.lastSync||this.hasTimeout("syncAutoWidthColumns")}onStoreChange({action:e}){if("move"!==e){const e=this,{cellEdit:t}=e.client.features;++e.storeGeneration,null!=t&&t.isEditing&&!t.editingStoppedByTapOutside?e.syncAutoWidthColumns():e.hasTimeout("syncAutoWidthColumns")||e.setTimeout("syncAutoWidthColumns",e.delay)}}onInternalResize(e,t,r,o){0===o&&(this.lastSync=null,this.syncAutoWidthColumns())}syncAutoWidthColumns(){const e=this,t=e.client,r=e.storeGeneration;if(e.lastSync!==r){let o,s;e.lastSync=r;for(const r of t.columns.visibleColumns)o=r.autoWidth,o&&(!0===o&&(o=e.default),t.resizingColumns=s=!0,r.resizeToFitContent(o));s&&(t.resizingColumns=!1,t.afterColumnsResized())}e.hasTimeout("syncAutoWidthColumns")&&e.clearTimeout("syncAutoWidthColumns")}}i.prototype.storeGeneration=0,i._$name="ColumnAutoWidth",e.registerFeature(i,!0);class n extends o{constructor(...e){super(...e),s(this,"entityName","row")}construct(e,t){super.construct(e,t),e.rowManager.ion({beforeRenderRow:"onBeforeRenderRow",thisObj:this}),this.grid=e}onBeforeRenderRow({row:e,record:t}){e.cls["b-cut-row"]=this._isCut&&this.clipboardRecords.includes(t)}isActionAvailable(e,t,r){var o;const{grid:s}=this,{cellEdit:i}=s.features,{target:n}=r;return!this.disabled&&0===globalThis.getSelection().toString().length&&(!i||!i.isEditing)&&(null===(o=s.selectedRecords)||void 0===o?void 0:o.length)>0&&(!n||Boolean(n.closest(".b-gridbase:not(.b-schedulerbase) .b-grid-subgrid,.b-grid-subgrid:not(.b-timeaxissubgrid)")))}copy(){this.copyRows()}cut(){this.copyRows(!0)}paste(e){this.pasteRows(null!=e&&e.isModel?e:null)}copyRows(e=!1){const t=this,{client:r,entityName:o}=t,s=t.selectedRecords.filter((t=>!t.readOnly||!e));s.length&&!r.readOnly&&!1!==r.trigger("beforeCopy",{records:s,isCut:e,entityName:o})&&(t._isCut=e,t.clipboardRecords.forEach((e=>{var t;return null===(t=r.rowManager.getRowById(e))||void 0===t?void 0:t.removeCls("b-cut-row")})),t.clipboardRecords=s.slice(),r.store.forEach((e=>{e.meta.isCut=t._isCut&&t.clipboardRecords.includes(e)})),s.forEach((t=>this.onRowCutOrCopy(t,e))),r.trigger("copy",{records:s,isCut:e,entityName:o}))}onRowCutOrCopy(e,t){var r;null===(r=this.client.rowManager.getRowById(e))||void 0===r||r.toggleCls("b-cut-row",t)}pasteRows(e){var t,r;const o=this,s=o.clipboardRecords,{client:i,entityName:n}=o,{store:c}=i,l=e||i.selectedRecord;if(i.readOnly||i.isTreeGrouped||!s.length||c.tree&&o._isCut&&s.some((e=>e.contains(l,!0)))||!1===i.trigger("beforePaste",{records:s,referenceRecord:l,isCut:o._isCut,entityName:n}))return[];o.sortByIndex(s);const d=o.extractParents(s,{});return o.insertCopiedRecords(d,l),o._isCut?o.clearClipboard():i.selectedRecords=d,i.trigger("paste",{records:d,originalRecords:s,isCut:o._isCut,referenceRecord:l,entityName:n}),null===(t=i.getRowFor(d[d.length-1]))||void 0===t||null===(r=t.cells)||void 0===r||r[0].focus(),d}clearClipboard(){this._isCut&&this.clipboardRecords.forEach((e=>{var t;return null===(t=this.client.rowManager.getRowById(e))||void 0===t?void 0:t.removeCls("b-cut-row")})),this._isCut=!1,this.clipboardRecords=[]}generateNewName(e){const t=e[this.nameField];let r=2;for(;this.client.store.findRecord(this.nameField,`${t} - ${r}`);)r++;return`${t} - ${r}`}insertCopiedRecords(e,t){const{store:r}=this.client,o=r.indexOf(t)+1;return r.tree?t.parent.insertChild(e,t.nextSibling,!1,{orderedBeforeNode:t.nextOrderedSibling}):this._isCut?void r.move(e,r.getAt(o)):r.insert(o,e)}get selectedRecords(){const e=[...this.client.selectedRecords];return this.client.selectedCells.forEach((t=>{e.includes(t.record)||e.push(t.record)})),e}getMenuItemText(e){var t;const r=this;let o=r[e+"RecordText"];return!0===(null===(t=r.client.features.cellCopyPaste)||void 0===t?void 0:t.enabled)&&r.client.selectedCells.length&&(o+=` (${r.selectedRecords.length>1?r.rowSpecifierTextPlural:r.rowSpecifierText})`),o}populateCellMenu({record:e,items:t}){const r=this,{client:o}=r;o.readOnly||o.isTreeGrouped||!1!==(null==e?void 0:e.isSpecialRow)||!r.selectedRecords.length||(t.cut={text:r.getMenuItemText("cut"),localeClass:r,icon:"b-icon b-icon-cut",weight:135,disabled:e.readOnly,onItem:()=>r.cut()},t.copy={text:r.getMenuItemText("copy"),localeClass:r,cls:"b-separator",icon:"b-icon b-icon-copy",weight:120,onItem:()=>r.copy()},t.paste={text:r.getMenuItemText("paste"),localeClass:r,icon:"b-icon b-icon-paste",weight:140,disabled:!r.clipboardRecords.length,onItem:()=>r.paste(e)})}sortByIndex(e){const{store:t}=this.client;return e.sort(((r,o)=>{const s=r.indexPath,i=o.indexPath;if(!e.includes(r.parent)&&!e.includes(o.parent))return t.indexOf(r)-t.indexOf(o);if(s.length===i.length){for(let e=0;e<s.length;e++){if(s[e]<i[e])return-1;if(s[e]>i[e])return 1}return 0}return s.length-i.length}))}extractParents(e,t){const r=this,{client:o,_isCut:s}=r;o.store.tree&&e.forEach((t=>{t.traverse((t=>{const r=t.getTopParent(!0);e.includes(t)||s&&e.some((e=>r.includes(e)))||e.push(t)}))}));const i=e.reduce(((e,i)=>{let n;const c=i.parentId||i.meta.modified;return s?(n=i,n.meta.isCut=!1):(n=i.copy(),n[r.nameField]=r.generateNewName(n),i.expanded&&(n.data.expanded=i.expanded)),t[i.id]=n,i.parent===o.store.rootNode?e.push(n):c in t?t[c].appendChild(n):e.push(n),e}),[]);return i.forEach((e=>{e.sortOrderedChildren(!0,!0)})),i}}s(n,"$name","RowCopyPaste"),s(n,"type","rowCopyPaste"),s(n,"pluginConfig",{assign:["copyRows","pasteRows"],chain:["populateCellMenu"]}),s(n,"properties",{clipboardRecords:[]}),s(n,"configurable",{nameField:"name",keyMap:{"Ctrl+C":"copy","Ctrl+X":"cut","Ctrl+V":"paste"},copyRecordText:"L{copyRecord}",cutRecordText:"L{cutRecord}",pasteRecordText:"L{pasteRecord}",rowSpecifierText:"L{row}",rowSpecifierTextPlural:"L{rows}",localizableProperties:["copyRecordText","cutRecordText","pasteRecordText","rowSpecifierText","rowSpecifierTextPlural"]}),n.featureClass="b-row-copypaste",n._$name="RowCopyPaste",e.registerFeature(n,!0,"Grid"),e.registerFeature(n,!1,"Gantt"),e.registerFeature(n,!1,"SchedulerPro"),e.registerFeature(n,!1,"ResourceHistogram");class c extends t{static get $name(){return"Grid"}static get type(){return"grid"}}c.initClass(),c._$name="Grid";export{i as ColumnAutoWidth,c as Grid,n as RowCopyPaste};
//# sourceMappingURL=Grid.js.map
