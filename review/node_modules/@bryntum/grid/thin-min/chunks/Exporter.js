/*!
 *
 * Bryntum Grid 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Delayable as e,Events as t,Localizable as r,Base as o,DomHelper as s,BrowserHelper as i,TemplateHelper as l,IdHelper as n,DomSync as a}from"./Editor.js";import{Row as d}from"./GridBase.js";const h={all:"all",visible:"visible"},c={A6:{width:4.11,height:5.81},A5:{width:5.81,height:8.25},A4:{width:8.25,height:11.69},A3:{width:11.69,height:16.49},Legal:{width:8.5,height:14},Letter:{width:8.5,height:11}},p={portrait:"portrait",landscape:"landscape"},u={pdf:"pdf",png:"png"},f={pdf:"application/pdf",png:"image/png"};class w extends(e(t(r(o)))){static get defaultConfig(){return{translateURLsToAbsolute:!0,keepPathName:!0,filterStyles:e=>e}}pageTpl(e){const{title:t,header:r,footer:o,styles:n,htmlClasses:a,bodyStyle:d,bodyClasses:h=[],paperHeight:c,paperWidth:p,html:u}=e;return h.push(`b-${this.constructor.type}`),s.scrollBarWidth?h.push("b-visible-scrollbar"):h.push("b-overlay-scrollbar"),i.isChrome?h.push("b-chrome"):i.isSafari?h.push("b-safari"):i.isFirefox&&h.push("b-firefox"),l.tpl`
            <!DOCTYPE html>
            <html class="${a}" style="width: ${p}in; height: ${c}in;">
                <head>
                    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
                    <title>${t}</title>
                    ${n.join("")}
                </head>
                <body class="b-export ${h.join(" ")}" style="width: ${p}in; height: ${c}in; ${d}">
                    <div class="b-export-content">
                        ${r&&`<div class="b-export-header" style="width: 100%">${r}</div>`}
                        <div class="b-export-body"><div class="b-export-viewport">${u}</div></div>
                        ${o&&`<div class="b-export-footer" style="width: 100%">${o}</div>`}
                    </div>
                </body>
            </html>`}get stylesheets(){const e=this;if(e._stylesheets)return e._stylesheets;const t=e.translateURLsToAbsolute,r=globalThis.origin,o=Array.from(document.querySelectorAll('link[rel="stylesheet"], style')),s=[];return o.forEach((o=>{if(o=o.cloneNode(!0),t&&o.href){let e;e=!0===t?o.href:this.keepPathName?o.href.replace(r,t):new URL(o.getAttribute("href"),t),o.setAttribute("href",e)}let i=o.outerHTML;if(t&&/style/i.test(o.tagName)){const r=e.getStyleTagURLConverter(t);i=i.replace(/url\(['"]?(.+?)['"]?\)/g,r)}s.push(i)})),s.push("<style>\n                body, html {\n                    overflow: auto;\n                }\n                body {\n                    position: relative;\n                    margin: 0;\n                }\n            </style>"),e._stylesheets=e.filterStyles(s)}set stylesheets(e){this._stylesheets=e?this.filterStyles(e):e}getStyleTagURLConverter(e){return function(t,r){let o;try{let s;/^#/.test(r)?o=t:(s=!0===e?globalThis.location.href:this.keepPathName?globalThis.location.href.replace(globalThis.location.origin,e):e,o=`url('${new URL(r,s).href}')`)}catch(e){o=t}return o}.bind(this)}saveState({client:e}){this.state=e.state}async restoreState({client:e}){const t=[],r=new Set;r.add(e.scrollable.ion({scroll(){t.push(e.scrollable.await("scrollEnd"))}})),e.eachSubGrid((({header:e,scrollable:o})=>{r.add(o.ion({scroll(){t.push(o.await("scrollEnd"))}})),r.add(e.scrollable.ion({scroll(){t.push(e.scrollable.await("scrollEnd"))}}))})),e.state=this.state,await Promise.all(t),r.forEach((e=>e()))}beforeExport(){this.element=document.createElement("div")}cloneElement(e,t=this.element,r=!0){r&&(t.innerHTML=""),t.appendChild(e.cloneNode(!0)),s.removeEachSelector(t,".b-grid-row,.b-grid-merged-cells-container");const o=t.querySelector(".b-gridbase > .b-mask");o&&o.remove()}createPlaceholder(e,t=!0,r={}){return t&&(e.innerHTML=""),s.createElement(Object.assign({parent:e,id:n.generateId("export")},r))}prepareElement({client:e}){const{tbar:t,bbar:r}=e;t&&this.element.querySelector(`#${t.id}`).remove(),r&&this.element.querySelector(`#${r.id}`).remove()}measureElement(e=""){e instanceof HTMLElement&&(e=e.outerHTML);const t=s.createElement({parent:document.body,style:{visibility:"hidden",position:"absolute"},html:`<div style="height: 1px"></div>${e}<div style="height: 1px"></div>`}),r=t.offsetHeight-2;return t.remove(),r}prepareHTML(e){e instanceof HTMLElement&&(e=e.outerHTML);const t=s.createElement({parent:document.body,style:{visibility:"hidden",position:"absolute"},html:e}),r=t.querySelectorAll("img");for(let e=0,t=r.length;e<t;e++)r[e].setAttribute("src",r[e].src);const o=t.innerHTML;return t.remove(),o}getVirtualScrollerHeight(e){let t=0;return e.eachSubGrid((e=>{e.overflowingHorizontally&&(t=s.scrollBarWidth)})),0===t?t:t+1}inchToPx(e){return 96*e}getScaleValue(e,t){return Math.floor(1e4*e/t)/1e4}getVisibleRowsCount(e){const t=e.rowManager,r=t.rows.indexOf(t.firstVisibleRow),o=t.rows.indexOf(t.lastVisibleRow);let s;return s=-1!==r?-1===o?e.store.count-r:o-r+1:e.store.count,s}async export(e){const t=this;let r;t.beforeExport(),t.saveState(e),await t.prepareComponent(e);try{r=await t.getPages(e)}finally{await t.restoreComponent(e),t.stylesheets=null,await new Promise((e=>t.requestAnimationFrame(e))),await t.restoreState(e)}return r}async getPages(e){const t=this.pagesExtractor(e),r=[];let o;for(;(o=await t.next())&&!o.done;)r.push(o.value);return r}adjustRowBuffer(e){const{contentHeight:t}=this.exportMeta,{rowManager:r}=e;this.oldRowManagerConfig={prependRowBuffer:r.prependRowBuffer,appendRowBuffer:r.appendRowBuffer};const o=Math.ceil(t/r.rowOffsetHeight);r.prependRowBuffer=o,r.appendRowBuffer=o,e.renderRows(),e.rowManager.jumpToPosition(e.scrollable.y)}restoreRowBuffer(e){e.rowManager.prependRowBuffer=this.oldRowManagerConfig.prependRowBuffer,e.rowManager.appendRowBuffer=this.oldRowManagerConfig.appendRowBuffer}async prepareComponent(e){const t=this,{client:r,columns:o,rowsRange:s,keepRegionSizes:i,enableDirectRendering:l}=e,{rowManager:n}=r,a=t.exportMeta={enableDirectRendering:l,totalWidth:0,totalHeight:0-(l?0:t.getVirtualScrollerHeight(r)),subGrids:{}};r.columns.forEach((e=>{o.includes(e.id)?e.show():e.hide()})),await new Promise((e=>r.requestAnimationFrame(e))),r.rowManager.rowCount>0&&(s===h.all?a.firstVisibleDataIndex=n.rows[0].dataIndex:(a.firstVisibleDataIndex=n.firstVisibleRow.dataIndex,e.alignRows=!0),l||await r.scrollRowIntoView(r.store.getAt(a.firstVisibleDataIndex),{block:"start"}));const{element:c}=t;let p;t.cloneElement(r.element),t.prepareElement(e),l&&(a.fakeRow=p=new d({cls:r.rowCls,rowManager:r.rowManager,grid:r,index:-10,dataIndex:-10})),r.eachSubGrid((e=>{var o,s,l;p&&(e.onAddRow({rows:[p],isExport:!0}),p.element.dataset.ownerCmp=r.id);const n=t.createPlaceholder(c.querySelector(`[id="${e.id}"]`),!1);let d;d=null!=i&&i[e.region]?e.element.offsetWidth:e.columns.visibleColumns.reduce(((e,t)=>("number"==typeof t.width?e+=t.width:e+=(r.hideHeaders?r.rowManager.rows[0].getCell(t.id):t.element).offsetWidth,e)),0),a.totalWidth+=d;const h=(null===(o=e.splitterElement)||void 0===o?void 0:o.offsetWidth)||0;a.totalWidth+=h,a.subGrids[e.region]={id:e.id,headerId:(null===(s=e.header)||void 0===s?void 0:s.id)||null,footerId:(null===(l=e.footer)||void 0===l?void 0:l.id)||null,rows:[],splitterWidth:h,placeHolder:n,width:d}}))}prepareExportElement(){const{element:e,exportMeta:t}=this;return Object.values(t.subGrids).forEach((({width:t,id:r,headerId:o,footerId:s})=>{[r,o,s].forEach((r=>{if(r){const o=e.querySelector(`[id="${r}"]`);o&&(o.style.width=`${t}px`,o.style.flex="")}}))})),e.innerHTML}async restoreComponent(e){this.exportMeta.fakeRow&&(this.exportMeta.fakeRow.destroy(),delete this.exportMeta.fakeRow)}async scrollRowIntoView(e,t){await e.scrollRowIntoView(e.store.getAt(t),{block:"start"}),await new Promise((e=>this.requestAnimationFrame(e)))}collectRow(e){const t=this.exportMeta.subGrids,r=/data-owner-cmp=".+?"/;Object.entries(e.elements).forEach((([o,s])=>{t[o].rows.push([s.outerHTML.replace(r,""),e.top,e.offsetHeight,new Map])}))}renderMergedCells(e,t,r,o){const{client:s}=e,{subGrids:i}=this.exportMeta,l=s.features.mergeCells.buildMergedCellsConfig(t,r,o);for(const e in i){const t=i[e],r=document.createElement("div");a.sync({targetElement:r,domConfig:{children:l[e].children}}),r.childNodes.length&&(r.childNodes.forEach((e=>{const{syncId:t}=e.dataset,r=s.features.mergeCells.mergedRanges.find((e=>{var r;return(null===(r=e.cellElement)||void 0===r?void 0:r.parentNode.dataset.syncId)===t}));r&&(e.innerHTML=r.cellElement.outerHTML)})),t.mergedCellsHtml=[r.innerHTML])}}}w.prototype.pagesExtractor=async function*(){throw new Error("Implement this method in a subclass")},w._$name="Exporter";export{w as Exporter,u as FileFormat,f as FileMIMEType,p as Orientation,c as PaperFormat,h as RowsRange};
//# sourceMappingURL=Exporter.js.map
