/*!
 *
 * Bryntum Grid 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Base as e,Delayable as t,_objectSpread2 as o,Events as n,Identifiable as r,EventHelper as s,DomDataStore as a,DomHelper as i,Objects as l,_defineProperty as d,Factoryable as c,ObjectHelper as g,VersionHelper as u,Tooltip as h,StringHelper as m}from"./Editor.js";const p=()=>{throw new Error("Abstract method call!")};class v extends e{get type(){return this.constructor.name}undo(){p()}redo(){p()}}v._$name="ActionBase";const S=()=>{throw new Error("Abstract method call!")},y=()=>{throw new Error("Method cannot be called at this state!")};class R extends e{canUndo(e){S()}canRedo(e){S()}onUndo(e){S()}onRedo(e){S()}onStartTransaction(e){S()}onStopTransaction(e){S()}onStopTransactionDelayed(e){S()}onRejectTransaction(e){S()}onEnable(e){S()}onDisable(e){S()}onAutoRecordOn(e){S()}onAutoRecordOff(e){S()}onResetQueue(e){S()}onModelUpdate(e){S()}onStoreModelAdd(e){S()}onStoreModelInsert(e){S()}onStoreModelRemove(e){S()}onStoreModelRemoveAll(e){S()}onModelInsertChild(e){S()}onModelRemoveChild(e){S()}}R._$name="StateBase";const f=Symbol("STATE_PROP"),b=Symbol("STORES_PROP"),D=Symbol("QUEUE_PROP"),M=Symbol("POS_PROP"),T=Symbol("TRANSACTION_PROP"),A=Symbol("TRANSACTION_TIMER_PROP"),E=Symbol("AUTO_RECORD_PROP");Object.freeze([f,b,D,M,T,A,E]);const O=new Map;var C=(e,t)=>{O.set(e,t)},I=e=>("string"==typeof e&&(e=O.get(e)),e);const P=(e,t)=>{const{undo:o,redo:n}=t;let r;return r=o&&!n?{[D]:e[D].slice(e.position),[M]:0}:n&&!o?{[D]:e[D].slice(0,e.position)}:{[D]:[],[M]:0},[r,()=>{e.notifyStoresAboutQueueReset(t)}]};const w=new class extends R{canUndo(){return!1}canRedo(){return!1}onUndo(){y()}onRedo(){y()}onEnable(e){return e.autoRecord?"autoreadystate":"readystate"}onDisable(){y()}onAutoRecordOn(){return{[E]:!0}}onAutoRecordOff(){return{[E]:!1}}onStartTransaction(){y()}onStopTransaction(){y()}onStopTransactionDelayed(){y()}onRejectTransaction(){y()}onResetQueue(e,t){return P(e,t)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}};C("disabledstate",w);const x=Symbol("ACTION_QUEUE_PROP");class _ extends e{get defaultConfig(){return{title:null}}construct(...e){this[x]=[],super.construct(...e)}get queue(){return this[x].slice(0)}get length(){return this[x].length}addAction(e){this[x].push(e)}undo(){const e=this[x];for(let t=e.length-1;t>=0;--t)e[t].undo()}redo(){const e=this[x];for(let t=0,o=e.length;t<o;++t)e[t].redo()}}_._$name="Transaction";class L extends R{canUndo(e){return 0<e.position&&e.position<=e.length}canRedo(e){return 0<=e.position&&e.position<e.length}onUndo(e,t){let o=e.position;const n=e[D],r=Math.max(0,o-t);return[{[f]:"restoringstate",[M]:r},()=>{e.notifyStoresAboutStateRestoringStart();const t=[];for(;o!==r;){const e=n[--o];e.undo(),t.push(e)}return[e.autoRecord?"autoreadystate":"readystate",()=>{e.notifyStoresAboutStateRestoringStop({cause:"undo",transactions:t})}]}]}onRedo(e,t){let o=e.position;const n=e[D],r=Math.min(n.length,o+t);return[{[f]:"restoringstate",[M]:r},()=>{e.notifyStoresAboutStateRestoringStart();const t=[];do{const e=n[o++];e.redo(),t.push(e)}while(o!==r);return[e.autoRecord?"autoreadystate":"readystate",()=>{e.notifyStoresAboutStateRestoringStop({cause:"redo",transactions:t})}]}]}onEnable(){y()}onDisable(){return"disabledstate"}onAutoRecordOn(){return{[f]:"autoreadystate",[E]:!0}}onAutoRecordOff(){y()}onStartTransaction(e,t){const o=new _({title:t});return[{[f]:"recordingstate",[T]:o},()=>{e.notifyStoresAboutStateRecordingStart(o)}]}onStopTransaction(){y()}onStopTransactionDelayed(){y()}onRejectTransaction(){y()}onResetQueue(e,t){return P(e,t)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}}const U=new L;C("readystate",U);class k extends R{canUndo(){return!1}canRedo(){return!1}onEnable(){}onDisable(e){const t=e[T];return e.notifyStoresAboutStateRecordingStop(t,{disabled:!0}),{[f]:"disabledstate",[T]:null}}onAutoRecordOn(e){return[{[f]:"autorecordingstate",[E]:!0},()=>{e.stopTransactionDelayed()}]}onAutoRecordOff(){y()}onStartTransaction(){y()}onStopTransaction(e,t){const o=e[T],n=e[D];let r=e[M];return o.length&&(o.title||t||!e.getTransactionTitle?t&&(o.title=t):o.title=e.getTransactionTitle(o),n[r]=o,n.length=++r),[{[f]:"readystate",[M]:r,[T]:null},()=>{e.notifyStoresAboutStateRecordingStop(o,{stop:!0})}]}onRejectTransaction(e){const t=e[T];return[{[f]:"restoringstate",[T]:null},()=>(t.length&&t.undo(),["readystate",()=>{e.notifyStoresAboutStateRecordingStop(t,{rejected:!0})}])]}onStopTransactionDelayed(){y()}onResetQueue(e,t){return P(e,t)}onModelUpdate(e,t,o,n,r){e[T].addAction(e.makeModelUpdateAction(t,o,n,r))}onModelInsertChild(e,t,o,n,r,s){e[T].addAction(e.makeModelInsertChildAction(t,o,n,r,s))}onModelRemoveChild(e,t,o,n){e[T].addAction(e.makeModelRemoveChildAction(t,o,n))}onStoreModelAdd(e,t,o,n){e[T].addAction(e.makeStoreModelAddAction(t,o,n))}onStoreModelInsert(e,t,o,n,r,s){e[T].addAction(e.makeStoreModelInsertAction(t,o,n,r,s))}onStoreModelRemove(e,t,o,n,r){e[T].addAction(e.makeStoreModelRemoveAction(t,o,n,r))}onStoreRemoveAll(e,t,o,n){e[T].addAction(e.makeStoreRemoveAllAction(t,o,n))}}const j=new k;C("recordingstate",j);const $=new class extends R{static get $name(){return"RestoringStateClass"}canUndo(){return!1}canRedo(){return!1}onUndo(){y()}onRedo(){y()}onEnable(){y()}onDisable(){y()}onAutoRecordOn(){return{[E]:!0}}onAutoRecordOff(){return{[E]:!1}}onStartTransaction(){y()}onStopTransaction(){y()}onStopTransactionDelayed(){y()}onRejectTransaction(){y()}onQueueReset(){y()}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}};C("restoringstate",$);const K=new class extends L{onAutoRecordOn(){y()}onAutoRecordOff(){return{[f]:"readystate",[E]:!1}}onStartTransaction(e,t){const o=new _({title:t});return[{[f]:"autorecordingstate",[T]:o},()=>{e.notifyStoresAboutStateRecordingStart(o),e.stopTransactionDelayed()}]}onModelUpdate(e,t,o,n){e.startTransaction(),e.onModelUpdate(t,o,n)}onModelInsertChild(e,t,o,n,r){e.startTransaction(),e.onModelInsertChild(t,o,n,r)}onModelRemoveChild(e,t,o,n){e.startTransaction(),e.onModelRemoveChild(t,o,n)}onStoreModelAdd(e,t,o,n){e.startTransaction(),e.onStoreModelAdd(t,o,n)}onStoreModelInsert(e,t,o,n,r,s){e.startTransaction(),e.onStoreModelInsert(t,o,n,r,s)}onStoreModelRemove(e,t,o,n,r){e.startTransaction(),e.onStoreModelRemove(t,o,n,r)}onStoreRemoveAll(e,t,o,n){e.startTransaction(),e.onStoreRemoveAll(t,o,n)}};C("autoreadystate",K);class z extends(k.mixin(t)){onDisable(e){const t=e[T],o=e[A];return o&&this.clearTimeout(o),e.notifyStoresAboutStateRecordingStop(t,{disabled:!0}),{[f]:"disabledstate",[T]:null,[A]:null}}onAutoRecordOn(e){y()}onAutoRecordOff(e){const t=e[A];return t&&this.clearTimeout(t),{[f]:"recordingstate",[E]:!1,[A]:null}}onStopTransaction(e,t){const o=e[T],n=e[A],r=e[D];let s=e[M];return n&&this.clearTimeout(n),o.length&&(o.title||t||!e.getTransactionTitle?t&&(o.title=t):o.title=e.getTransactionTitle(o),r[s]=o,r.length=++s),[{[f]:"autoreadystate",[M]:s,[T]:null,[A]:null},()=>{e.notifyStoresAboutStateRecordingStop(o,{stop:!0})}]}onStopTransactionDelayed(e){let t=e[A];return t&&this.clearTimeout(t),t=this.setTimeout((()=>{e.stopTransaction()}),e.autoRecordTransactionStopTimeout),{[f]:N,[A]:t}}onResetQueue(e,t){return P(e,t)}onRejectTransaction(e){const t=e[T],o=e[A];return o&&this.clearTimeout(o),[{[f]:"restoringstate",[T]:null,[A]:null},()=>(t.length&&t.undo(),["autoreadystate",()=>{e.notifyStoresAboutStateRecordingStop(t,{rejected:!0})}])]}onModelUpdate(e,...t){super.onModelUpdate(e,...t),e.stopTransactionDelayed()}onModelInsertChild(e,...t){super.onModelInsertChild(e,...t),e.stopTransactionDelayed()}onModelRemoveChild(e,...t){super.onModelRemoveChild(e,...t),e.stopTransactionDelayed()}onStoreModelAdd(e,...t){super.onStoreModelAdd(e,...t),e.stopTransactionDelayed()}onStoreModelInsert(e,...t){super.onStoreModelInsert(e,...t),e.stopTransactionDelayed()}onStoreModelRemove(e,...t){super.onStoreModelRemove(e,...t),e.stopTransactionDelayed()}onStoreRemoveAll(e,...t){super.onStoreRemoveAll(e,...t),e.stopTransactionDelayed()}}const N=new z;C("autorecordingstate",N);const F=Symbol("MODEL_PROP"),Q=Symbol("NEW_DATA_PROP"),B=Symbol("OLD_DATA_PROP");class X extends v{static get defaultConfig(){return{model:void 0,newData:void 0,oldData:void 0,isInitialUserAction:!1}}get type(){return"UpdateAction"}get model(){return this[F]}set model(e){this[F]=e}get newData(){return this[Q]}set newData(e){this[Q]=o({},e)}get oldData(){return this[B]}set oldData(e){this[B]=o({},e)}undo(){const{model:e,oldData:t}=this;e.$&&Object.assign(e,t),e.set(t,null,null,null,!0)}redo(){const{model:e,newData:t}=this;e.$&&Object.assign(e,t),e.set(t,null,null,null,!0)}}X._$name="UpdateAction";const V=Symbol("PARENT_MODEL_PROP"),W=Symbol("CHILD_MODELS_PROP"),q=Symbol("INSERT_INDEX_PROP"),G=Symbol("CONTEXT_PROP");class H extends v{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,insertIndex:void 0,context:void 0}}get type(){return"InsertChildAction"}get parentModel(){return this[V]}set parentModel(e){this[V]=e}get childModels(){return this[W]}set childModels(e){this[W]=e.slice(0)}get insertIndex(){return this[q]}set insertIndex(e){this[q]=e}get context(){return this[G]}set context(e){this[G]=e}undo(){const{parentModel:e,context:t,childModels:o}=this;o.sort(((e,o)=>{const{lhsParent:n,lhsIndex:r}=t.get(e)||{},{rhsParent:s,rhsIndex:a}=t.get(o)||{};return n&&n===s?r-a:0})),o.forEach((o=>{const{parent:n,index:r}=t.get(o)||{};if(n)if(n===e){let e;e=r>o.parentIndex?r+1:r,e=r===n.children.length-1?null:e;const t=n.children[e];n.insertChild(o,t)}else n.insertChild(o,n.children[r]);else e.removeChild(o)}))}redo(){const{parentModel:e,insertIndex:t,childModels:o}=this,n=e.children[t];e.insertChild(o,n)}}H._$name="InsertChildAction";const Y=Symbol("PARENT_MODEL_PROP"),J=Symbol("CHILD_MODELS_PROP"),Z=Symbol("CONTEXT_PROP");class ee extends v{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,context:void 0}}get type(){return"RemoveChildAction"}get parentModel(){return this[Y]}set parentModel(e){this[Y]=e}get childModels(){return this[J]}set childModels(e){this[J]=e.slice(0)}get context(){return this[Z]}set context(e){this[Z]=e}undo(){const{parentModel:e,context:t,childModels:o}=this;o.sort(((e,o)=>t.get(e)-t.get(o))),o.forEach((o=>{e.insertChild(o,t.get(o))}))}redo(){this.parentModel.removeChild(this.childModels)}}ee._$name="RemoveChildAction";const te=Symbol("STORE_PROP"),oe=Symbol("MODEL_LIST_PROP");class ne extends v{static get defaultConfig(){return{store:void 0,modelList:void 0,silent:!1}}get type(){return"AddAction"}get store(){return this[te]}set store(e){this[te]=e}get modelList(){return this[oe]}set modelList(e){this[oe]=e.slice(0)}undo(){this.store.remove(this.modelList,this.silent)}redo(){this.store.add(this.modelList,this.silent)}}ne._$name="AddAction";const re=Symbol("STORE_PROP"),se=Symbol("MODEL_LIST_PROP"),ae=Symbol("INSERT_INDEX_PROP"),ie=Symbol("CONTEXT_PROP");class le extends v{static get defaultConfig(){return{store:void 0,modelList:void 0,insertIndex:void 0,context:void 0,silent:!1}}get type(){return"InsertAction"}get store(){return this[re]}set store(e){this[re]=e}get modelList(){return this[se]}set modelList(e){this[se]=e.slice(0)}get insertIndex(){return this[ae]}set insertIndex(e){this[ae]=e}get context(){return this[ie]}set context(e){this[ie]=e}undo(){const{store:e,modelList:t,context:o,silent:n}=this;t.sort(((e,t)=>{const n=o.get(e),r=o.get(t);return void 0!==n&&void 0!==r?n-r:0})),t.forEach((t=>{const r=o.get(t);t._undoingInsertion=!0,void 0!==r?e.insert(r,t,n):e.remove(t,n),t._undoingInsertion=!1}))}redo(){const e=this;e.store.insert(e.insertIndex,e.modelList,e.silent)}}le._$name="InsertAction";const de=Symbol("STORE_PROP"),ce=Symbol("MODEL_LIST_PROP"),ge=Symbol("CONTEXT_PROP");class ue extends v{static get defaultConfig(){return{store:void 0,modelList:void 0,context:void 0,silent:!1}}get type(){return"RemoveAction"}get store(){return this[de]}set store(e){this[de]=e}get modelList(){return this[ce]}set modelList(e){this[ce]=e.slice(0)}get context(){return this[ge]}set context(e){this[ge]=e}undo(){const{store:e,context:t,modelList:o,silent:n}=this;o.sort(((e,o)=>t.get(e)-t.get(o))),o.forEach((o=>{const r=t.get(o);e.insert(r,o,n)}))}redo(){this.store.remove(this.modelList,this.silent)}}ue._$name="RemoveAction";const he=Symbol("STORE_PROP"),me=Symbol("ALL_RECORDS_PROP");class pe extends v{static get defaultConfig(){return{store:void 0,allRecords:void 0,silent:!1}}get type(){return"RemoveAllAction"}get store(){return this[he]}set store(e){this[he]=e}get allRecords(){return this[me]}set allRecords(e){this[me]=e.slice(0)}undo(){const{store:e,allRecords:t,silent:o}=this;e.add(t,o)}redo(){this.store.removeAll(this.silent)}}pe._$name="RemoveAllAction";const ve=(e,t,o,n)=>new X({model:e,newData:t,oldData:o,isInitialUserAction:n}),Se=(e,t,o,n)=>new H({parentModel:e,childModels:o,insertIndex:t,context:n}),ye=(e,t,o)=>new ee({parentModel:e,childModels:t,context:o}),Re=(e,t,o)=>new ne({store:e,modelList:t,silent:o}),fe=(e,t,o,n,r)=>new le({store:e,insertIndex:t,modelList:o,context:n,silent:r}),be=(e,t,o,n)=>new ue({store:e,modelList:t,context:o,silent:n}),De=(e,t,o)=>new pe({store:e,allRecords:t,silent:o}),Me=(e,t,...o)=>{const n=e.state,r=t.call(e[f],e,...o);if("string"==typeof r)e[f]=I(r);else if(r instanceof R)e[f]=r;else if(Array.isArray(r)){const[t,n]=r;"string"==typeof t?e[f]=I(t):t instanceof R?e[f]=t:t&&"object"==typeof t&&((e=Object.assign(e,t))[f]=I(e[f])),"function"==typeof n&&Me(e,n,...o)}else r&&"object"==typeof r&&((e=Object.assign(e,r))[f]=I(e[f]));n!==U&&n!==K&&r!==U&&r!==K&&e.trigger("ready")};class Te extends(n(e)){static get defaultConfig(){return{disabled:!0,autoRecord:!1,autoRecordTransactionStopTimeout:100,makeModelUpdateAction:ve,makeModelInsertChildAction:Se,makeModelRemoveChildAction:ye,makeStoreModelAddAction:Re,makeStoreModelInsertAction:fe,makeStoreModelRemoveAction:be,makeStoreRemoveAllAction:De,getTransactionTitle:null}}construct(...e){Object.assign(this,{[f]:U,[b]:[],[D]:[],[M]:0,[T]:null,[A]:null,[E]:!1}),super.construct(...e)}get state(){return this[f]}get position(){return this[M]}get length(){return this[D].length}get stores(){return Array.from(this[b])}hasStore(e){return this[b].includes(e)}addStore(e){this.hasStore(e)||(this[b].push(e),e.stm=this)}removeStore(e){this.hasStore(e)&&(this[b]=this[b].filter((t=>t!==e)),e.stm=null)}forEachStore(e){this[b].forEach((t=>e(t,t.id)))}get disabled(){return this.state===w}set disabled(e){const t=this;t.disabled!==e&&(Me(t,e?t.state.onDisable:t.state.onEnable,t),t.trigger("stmDisabled",{disabled:e}),t.trigger("disabled",{disabled:e}))}get enabled(){return!this.disabled}enable(){this.disabled=!1}disable(){this.disabled=!0}get isReady(){return this.state===U||this.state===K}waitForReadiness(){return this.await("ready",!1)}get isRecording(){return this.state===j||this.state===N}get autoRecord(){return this[E]}set autoRecord(e){const t=this;t.autoRecord!=e&&Me(t,e?t.state.onAutoRecordOn:t.state.onAutoRecordOff,t)}startTransaction(e=null){Me(this,this.state.onStartTransaction,e)}stopTransaction(e=null){Me(this,this.state.onStopTransaction,e)}stopTransactionDelayed(){Me(this,this.state.onStopTransactionDelayed)}rejectTransaction(){Me(this,this.state.onRejectTransaction)}get transaction(){return this[T]}get queue(){return this[D].map((e=>e.title))}get isRestoring(){return this.state===$}get canUndo(){return this.state.canUndo(this)}get canRedo(){return this.state.canRedo(this)}async undo(e=1){this.isReady||await this.waitForReadiness(),Me(this,this.state.onUndo,e)}async undoAll(){this.isReady||await this.waitForReadiness(),this.undo(this.length)}async redo(e=1){this.isReady||await this.waitForReadiness(),Me(this,this.state.onRedo,e)}async redoAll(){this.isReady||await this.waitForReadiness(),this.redo(this.length)}resetQueue(e={undo:!0,redo:!0}){Me(this,this.state.onResetQueue,e)}resetUndoQueue(){this.resetQueue({undo:!0})}resetRedoQueue(){this.resetQueue({redo:!0})}notifyStoresAboutStateRecordingStart(e){this.forEachStore((t=>{var o;return null===(o=t.onStmRecordingStart)||void 0===o?void 0:o.call(t,this,e)})),this.trigger("recordingStart",{stm:this,transaction:e})}notifyStoresAboutStateRecordingStop(e,t){this.forEachStore((o=>{var n;return null===(n=o.onStmRecordingStop)||void 0===n?void 0:n.call(o,this,e,t)})),this.trigger("recordingStop",{stm:this,transaction:e,reason:t})}notifyStoresAboutStateRestoringStart(){this.forEachStore((e=>{var t;return null===(t=e.onStmRestoringStart)||void 0===t?void 0:t.call(e,this)})),this.trigger("restoringStart",{stm:this})}notifyStoresAboutStateRestoringStop({cause:e,transactions:t}){this.forEachStore((e=>{var t;return null===(t=e.onStmRestoringStop)||void 0===t?void 0:t.call(e,this)})),this.trigger("restoringStop",{stm:this,cause:e,transactions:t})}notifyStoresAboutQueueReset(e){this.forEachStore((t=>{var o;return null===(o=t.onStmQueueReset)||void 0===o?void 0:o.call(t,this,e)})),this.trigger("queueReset",{stm:this,options:e})}onModelUpdate(e,t,o,n){Me(this,this.state.onModelUpdate,e,t,o,n)}onModelInsertChild(e,t,o,n){Me(this,this.state.onModelInsertChild,e,t,o,n)}onModelRemoveChild(e,t,o){Me(this,this.state.onModelRemoveChild,e,t,o)}onStoreModelAdd(e,t,o){Me(this,this.state.onStoreModelAdd,e,t,o)}onStoreModelInsert(e,t,o,n,r){Me(this,this.state.onStoreModelInsert,e,t,o,n,r)}onStoreModelRemove(e,t,o,n){Me(this,this.state.onStoreModelRemove,e,t,o,n)}onStoreRemoveAll(e,t,o){Me(this,this.state.onStoreRemoveAll,e,t,o)}onUndoKeyPress(e){const t=this;t.enabled&&(e.shiftKey?t.canRedo&&(e.preventDefault(),t.redo()):t.canUndo&&(e.preventDefault(),t.undo()))}stash(){this.transaction&&(this.stashedTransaction=this.transaction,this.rejectTransaction())}applyStash(){this.stashedTransaction&&(this.startTransaction(this.stashedTransaction.title),this.stashedTransaction.redo(),delete this.stashedTransaction)}}Te._$name="StateTrackingManager";var Ae=t=>class extends(t||e){static get $name(){return"Finalizable"}construct(...e){super.construct(...e),this.finalizer=null,this.finalizing=null,this.isFinalized=!1,this.isFinalizing=!1}doFinalize(){this.destroy()}finalize(){const e=this;let t=e.finalizing;return t||e.isFinalized||(e.isFinalizing=!0,e.finalizing=t=e._awaitFinalizer()),t}async _awaitFinalizer(){const e=this;try{await e.finalizer}finally{e.finalizing=null,e.isFinalized=!0,e.doFinalize()}}};const Ee=Symbol("dragAbort"),Oe=Symbol("dragInit"),Ce=Symbol("dragDrag"),Ie=Symbol("dragDrop"),Pe={x:"horizontal",y:"vertical"};class we extends(e.mixin(Ae,t,r)){static get configurable(){return{itemElement:null,scrollManager:null,monitoringConfig:null,source:null,target:null,targetElement:null,threshold:5,touchStartDelay:300}}static get identifiable(){return{}}construct(...e){super.construct(...e);const t=this,{event:o}=t;Object.assign(t,{altKey:null,cleaners:[],ctrlKey:null,data:new Map,element:o.target,endEvent:null,lastMoveEvent:null,metaKey:null,previousTarget:null,scrollerAction:null,shiftKey:null,state:Oe,startEvent:o,touchStartTimer:null,_valid:!0}),"touches"in o&&t.touchStartDelay&&(t.touchStartTimer=t.setTimeout((()=>t.touchStartTimer=null),t.touchStartDelay,"touchStartDelay")),s.on({element:globalThis,blur:"onWindowBlur",thisObj:t})}doDestroy(){const e=this,{source:t,target:o}=e;e.cleanup(),(null==o?void 0:o.dropping)===e&&(o.dropping=null),(null==t?void 0:t.dragging)===e&&(t.dragging=null),super.doDestroy()}onWindowBlur(){this.started&&this.abort()}get aborted(){return this.state===Ee}get completed(){return this.isDestroying||this.aborted||null!==this.endEvent}get pending(){return this.state===Oe}get started(){return this.state!==Oe&&!this.aborted}get valid(){return this.started&&null!=this.targetElement&&this._valid}set valid(e){this._valid=e}async get(e){if(this.aborted)throw new Error("Data is not available on aborted drag");if(!this.completed)throw new Error("Data is not available until drag completion");if(Array.isArray(e))return Promise.all(e.map((e=>this.get(e))));let t=this.data.get(e);return"function"==typeof t&&(t=await t(),this.data.set(e,t)),t}has(e){return this.data.has(e)}peek(e){if(this.aborted)throw new Error("Data is not available on aborted drag");if(Array.isArray(e))return e.map((e=>this.peek(e)));let t=this.data.get(e);return"function"==typeof t&&(t=!0),t}set(e,t){this.data.set(e,t)}changeTarget(e,t){if(e!==t){const o=this;o._target=e,o.previousTarget=t,t&&(t.dropping=null),e&&(e.dropping=o,e.dropping!==o&&(e=null,o.valid=!1)),o._target=t}return e}updateTarget(e,t){const o=this;t&&o.source.dragLeaveTarget(o,t),e&&(o.valid=!0,e.dragMove(o),o.source.dragEnterTarget(o))}updateTargetElement(e){let t,o,n,r,s;for(s=e;s;s=s.parentElement)if(o=a.get(s,"droppables"),o)for(r=0;r<o.length;++r)if(t=o[r],t.dropRootElement.contains(e)&&(n=t.droppableSelector,(!n||e.closest(`#${i.getId(t.dropRootElement)} ${n}`))&&(this.target=t,this.target===t)))return}abort(){const e=this,{element:t,source:o}=e;null==t||t.getBoundingClientRect(),e.state!==Ie&&(e.state=Ee,e.cleanup()),null==o||o.endDrag(e)}begin(){const e=this,{source:t}=e,o=t.beforeDrag(e);return!1!==o&&(t.dragging=e),o}cleanup(){let e;for(;e=this.cleaners.pop();)e()}end(e){const t=this,{lastMoveEvent:o,target:n}=t,{dragSwallowClickTime:r}=t.source;t.event=t.endEvent=e,t.syncFlags(),t.started&&((null==o?void 0:o.clientX)===e.clientX&&(null==o?void 0:o.clientY)===e.clientY&&(null==o?void 0:o.target)===e.target||t.track(),r&&s.on({element:document,capture:!0,expires:r,once:!0,click(e){e.stopPropagation()}}),t.state=Ie,n!==t.source&&(null==n||n.dragDrop(t)))}fakeKey(e,t){const o=this,{lastMoveEvent:n}=o;if(n&&o.element){let r;n.isKey=!0,"Alt"===e.key?o.altKey!==t&&(o.altKey=t,r=!0):"Control"===e.key&&o.ctrlKey!==t&&(o.ctrlKey=t,r=!0),r&&(o.event=n,o.track())}}keyDown(e){this.completed||("Escape"===e.key?this.abort():this.isDragToggleKey(e.key)&&this.fakeKey(e,!0))}keyUp(e){!this.completed&&this.isDragToggleKey(e.key)&&this.fakeKey(e,!1)}getDistance(e){return s.getDistanceBetween(this.startEvent,e)}isDragToggleKey(e){return"Control"===e||"Alt"===e}move(e){const t=this,{target:o}=e,n=t.getDistance(e)>=t.threshold;if(t.syncFlags(),t.touchStartTimer)n&&t.abort();else if(o&&o.nodeType===Node.ELEMENT_NODE){if(n&&!t.started&&(t.event=e,!1===t.start()))return void t.abort();t.started&&!t.completed&&(t.lastMoveEvent=t.event=e,"touchmove"===e.type&&(e.preventDefault(),e.stopImmediatePropagation()),t.track())}}start(){const e=this,{scrollManager:t,monitoringConfig:o,source:n}=e,{draggingBodyCls:r,dragLock:s}=n,a=n.dragRootElement;if(e.state=Ce,t){const n=t.startMonitoring(l.merge({scrollables:[{element:a}],direction:Pe[s]||s||"both",callback(t){const{lastMoveEvent:o}=e;o&&e.element&&(o.isScroll=!0,e.event=o,e.scrollerAction=t,e.track(),e.scrollerAction=null)}},o));e.cleaners.push(n)}const i=n.dragRootElement.closest(".b-outer")||document.body;if(i.classList.add(r),e.cleaners.push((()=>i.classList.remove(r))),!1===n.startDrag(e))return e.cleanup(),!1}syncFlags(){const e=this,{event:t}=e;e.altKey=t.altKey,e.ctrlKey=t.ctrlKey||t.metaKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey}track(){const e=this,{event:t,source:o,target:n}=e;let r,s=t.target;"touchmove"===t.type&&(r=t.changedTouches[0],s=i.elementFromPoint(r.clientX,r.clientY)),e.targetElement=s,n===e.target&&(null==n||n.dragMove(e)),o.trackDrag(e)}}d(we,"$name","DragContext"),we.prototype.STATE=we.STATE=Object.freeze({ABORTED:Ee,INIT:Oe,DRAGGING:Ce,DROPPED:Ie}),we._$name="DragContext";class xe extends(e.mixin(c)){static get type(){return"default"}static get configurable(){return{dragging:null}}static get factoryable(){return{defaultType:xe}}updateDragging(e,t){t&&this.close(t),e&&this.open(e)}close(e){}open(e){}dragStart(e){this.dragging=e}dragMove(e){}dragEnd(e){this.dragging=null}}xe.initClass(),xe._$name="DragProxy";var _e=t=>class extends(t||e){static get $name(){return"Draggable"}static get configurable(){return{dragging:{$config:"nullify",value:null},draggingClsSelector:null,dragDocumentListeners:{element:document,keydown:"onDragKeyDown",keyup:"onDragKeyUp",contextmenu:"onDragContextMenu",mousemove:"onDragPointerMove",mouseup:"onDragPointerUp",pointerup:"onDragPointerUp",touchend:"onDragPointerUp",touchmove:{handler:"onDragPointerMove",passive:!1}},dragItemSelector:null,dragItemOverCls:null,dragLock:null,dragMinDistance:1,dragProxy:{$config:["lazy","nullify"],value:null},dragRootElement:{$config:"nullify",value:null},dragSameTargetDrop:!1,dragSelector:null,ignoreSelector:null,dragSwallowClickTime:50,dragThreshold:5,dragTouchStartDelay:300,dropTargetSelector:null,overItem:null,testConfig:{dragSwallowClickTime:50}}}static get properties(){return{draggingCls:"b-draggable-active",draggingBodyCls:"b-draghelper-active",draggingItemCls:"b-dragging-item",draggingStartedCls:"b-draggable-started",draggableCls:"b-draggable"}}beforeDrag(e){const{dragRootElement:t,dragSelector:o,ignoreSelector:n}=this,r=o&&e.element.closest(o);return!o||Boolean(r&&r===t||t.contains(r)&&(!n||!e.element.matches(n)))}dragStart(e){}dragOver(e){}dragEnterTarget(e){}dragLeaveTarget(e,t){}dragDrop(e){}dragEnd(e){}get activeDrag(){const{dragging:e}=this;return null!=e&&e.started&&!e.completed?e:null}get dragEventer(){return this.trigger?this:null}get draggingClassElement(){const{draggingClsSelector:e,dragRootElement:t}=this;return e?null==t?void 0:t.closest(e):t}beginDrag(e){const{draggingCls:t,draggingClassElement:o}=this;t&&o&&(o.classList.add(t),e.cleaners.push((()=>o.classList.remove(t))))}async endDrag(e){const t=this,{dragEventer:o,dragProxy:n}=t;e.valid&&await t.dragDrop(e),t.isDestroyed||(e.pending?e.destroy():(t.dragEnd(e),null==n||n.dragEnd(e),null==o||o.trigger(e.valid?"drop":"dragCancel",{drag:e,event:e.event}),t.finalizeDrag(e)))}async finalizeDrag(e){var t;await(null===(t=e.finalize)||void 0===t?void 0:t.call(e))}moveDrag(e){if(!1!==this.dragOver(e)){const{dragEventer:t,dragProxy:o}=this;null==o||o.dragMove(e),null==t||t.trigger("drag",{drag:e,event:e.event})}}setupDragContext(e){const t=this,{dragItemSelector:o,id:n}=t,{target:r}=e;return{event:e,id:n?`${n}-drag-${t._nextDragId=(t._nextDragId||0)+1}`:null,itemElement:o?r.closest(o):r,touchStartDelay:t.dragTouchStartDelay,source:t,threshold:t.dragThreshold}}startDrag(e){const{draggingStartedCls:t,draggingClassElement:o,draggingItemCls:n,dragEventer:r,dragProxy:s}=this,{itemElement:a}=e;if(!1===(null==r?void 0:r.trigger("beforeDragStart",{drag:e,event:e.event})))return!1;t&&o&&(o.classList.add(t),e.cleaners.push((()=>o.classList.remove(t)))),n&&a&&(a.classList.add(n),e.cleaners.push((()=>a.classList.remove(n)))),null==s||s.dragStart(e);const i=this.dragStart(e);return!1!==i&&(null==r||r.trigger("dragStart",{drag:e,event:e.event})),i}trackDrag(e){var t;const{dropTargetSelector:o}=this;e.valid=!(o&&(null===(t=e.targetElement)||void 0===t||!t.closest(o))),this.moveDrag(e)}configureListeners(e){const t=g.assign({thisObj:this},this.dragDocumentListeners);return"touches"in e.startEvent?(delete t.mousemove,delete t.mouseup):(delete t.contextmenu,delete t.touchmove,delete t.touchend,delete t.pointerup),t}updateDragging(e,t){const o=this;if(e){const t=o.configureListeners(e);e.cleaners.push(s.on(t)),o.beginDrag(e)}else t&&t.destroy()}changeDragProxy(e,t){return xe.reconfigure(t,e,{owner:this,defaults:{owner:this}})}updateDragRootElement(e,t){var o;const n=this,{draggableCls:r,dragItemSelector:a,onDragItemMouseMove:i}=n;if(null==t||t.classList.remove(r),null===(o=n._dragRootDetacher)||void 0===o||o.call(n),e){const t={thisObj:n,element:e,mousedown:"onDragMouseDown",touchstart:"onDragTouchStart",pointerdown:e=>{var t,o;return e.pointerId&&(null===(t=(o=e.target).releasePointerCapture)||void 0===t?void 0:t.call(o,e.pointerId))}};i&&(t.mousemove={delegate:a,handler:"onDragItemMouseMove"}),(n.dragItemOverCls||i||n.onDragItemMouseEnter||n.onDragItemMouseLeave)&&Object.assign(t,{mouseover:{delegate:a,handler:"onDragItemMouseOver"},mouseout:{delegate:a,handler:"onDragItemMouseOut"}}),e.classList.add(r),n._dragRootDetacher=s.on(t)}}onDragItemMouseOver(e){this.overItem=e}onDragItemMouseOut(e){this.dragging||(this.overItem=e)}changeOverItem(e){var t;return this.enterLeaveEvent=e,"mouseout"===e.type?(null===(t=e.relatedTarget)||void 0===t?void 0:t.closest(this.dragItemSelector))||null:e.target.closest(this.dragItemSelector)}updateOverItem(e,t){const o=this,{dragItemOverCls:n}=o;var r,s;t&&(n&&t.classList.remove(n),null===(r=o.onDragItemMouseLeave)||void 0===r||r.call(o,o.enterLeaveEvent,t));e&&(n&&e.classList.add(n),null===(s=o.onDragItemMouseEnter)||void 0===s||s.call(o,o.enterLeaveEvent,e))}onDragContextMenu(e){e.preventDefault()}onDragKeyDown(e){this.dragging.keyDown(e)}onDragKeyUp(e){this.dragging.keyUp(e)}onDragMouseDown(e){0===e.button&&this.onDragPointerDown(e)}onDragPointerDown(e){let{dragging:t}=this;t?t.isFinalizing||t.abort():(t=this.setupDragContext(e),t&&(t=new we(t),!1===t.begin()&&t.destroy()))}changeDragging(e,t){return null==t||t.destroy(),e}onDragPointerMove(e){const{dragging:t}=this;t&&!t.completed&&(null==t||t.move(e))}onDragPointerUp(e){const{dragging:t}=this;t&&!t.completed&&(t.end(e),this.endDrag(t))}onDragTouchStart(e){1===e.touches.length&&this.onDragPointerDown(e)}},Le=t=>class extends(t||e){static get $name(){return"Droppable"}static get configurable(){return{droppableSelector:null,dropping:null,dropRootElement:{$config:"nullify",value:null}}}get dropEventer(){return this.trigger?this:null}get droppableCls(){return"b-droppable"}dragEnter(e){var t;return null===(t=this.dropEventer)||void 0===t?void 0:t.trigger("dragEnter",{drag:e,event:e.event})}dragMove(e){var t;return null===(t=this.dropEventer)||void 0===t?void 0:t.trigger("dragMove",{drag:e,event:e.event})}dragDrop(e){var t;return null===(t=this.dropEventer)||void 0===t?void 0:t.trigger("drop",{drag:e,event:e.event})}dragLeave(e){var t;return null===(t=this.dropEventer)||void 0===t?void 0:t.trigger("dragLeave",{drag:e,event:e.event})}changeDropping(e,t){if(e!==t){const o=this;t&&(!t.aborted&&t.completed||o.dragLeave(t)),e&&(o._dropping=e,!1===o.dragEnter(e)&&(e=null),o._dropping=t)}return e}updateDropRootElement(e,t){const o=this,{droppableCls:n}=o;let r,s,i;t&&(r=a.get(t,"droppables"),i=!0,Array.isArray(r)&&(s=r.indexOf(o))>-1&&(r.length<2?a.remove(t,"droppables"):(r.splice(s,1),r.forEach((e=>{n===e.droppableCls&&(i=!1)})))),i&&t.classList.remove(n)),e&&(r=a.get(e,"droppables"),r?r.push(o):a.set(e,"droppables",[o]),e.classList.add(n))}};const Ue={constructor:1,prototype:1,name:1,length:1,arguments:1,caller:1,callee:1,__proto__:1};class ke{static apply(e){if(!e.target)throw new Error("Override must specify what it overrides, using static getter target");if(!e.target.class)throw new Error("Override must specify which class it overrides, using target.class");if(!this.shouldApplyOverride(e))return!1;const t=Object.getOwnPropertyNames(e),o=Object.getOwnPropertyNames(e.prototype);return t.splice(t.indexOf("target"),1),this.internalOverrideAll(e.target.class,t,e),this.internalOverrideAll(e.target.class.prototype,o,e.prototype),!0}static internalOverrideAll(e,t,o){Reflect.ownKeys(o).forEach((n=>{if(t.includes(n)&&!Ue[n]){const t=Object.getOwnPropertyDescriptor(o,n);let r=e,s=null;for(;!s&&r;)s=Object.getOwnPropertyDescriptor(r,n),s||(r=Object.getPrototypeOf(r));s&&this.internalOverride(r,n,t,s)}}))}static internalOverride(e,t,o,n){(e._overridden=e._overridden||{})[t]=e[t],n.get?Object.defineProperty(e,t,{enumerable:!1,configurable:!0,get:o.get}):e[t]=o.value}static shouldApplyOverride(e){const t=e.target;if(!t.maxVersion&&!t.minVersion)return!0;if(!t.product)throw new Error("Override must specify product when using versioning");return(!t.maxVersion||!u[t.product].isNewerThan(t.maxVersion))&&(!t.minVersion||!u[t.product].isOlderThan(t.minVersion))}}ke._$name="Override";class je extends e{static get $name(){return"AvatarRendering"}static get configurable(){return{element:null,colorPrefix:"b-sch-",tooltip:null,size:null}}doDestroy(){var e;null===(e=this.tooltip)||void 0===e||e.destroy(),super.doDestroy()}updateElement(e){s.on({element:e,delegate:".b-resource-image",error:"onImageErrorEvent",thisObj:this,capture:!0})}changeTooltip(e){return h.new({forElement:this.element,forSelector:".b-resource-avatar",cls:"b-resource-avatar-tooltip"},e)}static get failedUrls(){return this._failedUrls||(this._failedUrls=new Set),this._failedUrls}getResourceAvatar({initials:e,color:t,iconCls:o,imageUrl:n,defaultImageUrl:r,dataset:s={},resourceRecord:a,alt:i=m.encodeHtml(null==a?void 0:a.name)}){return this.getImageConfig(e,t,n,r,s,i)||this.getIconConfig(o,s)||this.getResourceInitialsConfig(e,t,s)}getImageConfig(e,t,n,r,s,a){const{size:i}=this;if(n=je.failedUrls.has(n)?r:n||r)return o(o({tag:"img",draggable:"false",loading:"lazy",class:{"b-resource-avatar":1,"b-resource-image":1}},i?{style:{height:i+"px",width:i+"px"}}:void 0),{},{alt:a,elementData:{defaultImageUrl:r,imageUrl:n,initials:e,color:t,dataset:s},src:n,dataset:s})}getIconConfig(e,t){if(e)return e&&{tag:"i",class:{"b-resource-avatar":1,"b-resource-icon":1,[e]:1},dataset:t}}getResourceInitialsConfig(e,t,n){const{size:r}=this,s=i.isNamedColor(t)&&t,a=!s&&t;return{tag:"div",class:{"b-resource-avatar":1,"b-resource-initials":1,[`${this.colorPrefix}${s}`]:s},style:o({backgroundColor:a||null},r?{height:r+"px",width:r+"px"}:void 0),children:[e],dataset:n}}onImageErrorEvent({target:e}){if(!e.matches(".b-resource-avatar"))return;const{defaultImageUrl:t,initials:o,color:n,imageUrl:r,dataset:s}=e.elementData;if(t&&!e.src.endsWith(t.replace(/^[./]*/gm,"")))e.src=t;else{const t=i.createElement(this.getResourceInitialsConfig(o,n,s));t.elementData=e.elementData,e.parentElement.replaceChild(t,e)}je.failedUrls.add(r)}}je._$name="AvatarRendering";export{v as ActionBase,je as AvatarRendering,we as DragContext,xe as DragProxy,_e as Draggable,Le as Droppable,Ae as Finalizable,ke as Override,R as StateBase,Te as StateTrackingManager,_ as Transaction,X as UpdateAction};
//# sourceMappingURL=AvatarRendering.js.map
