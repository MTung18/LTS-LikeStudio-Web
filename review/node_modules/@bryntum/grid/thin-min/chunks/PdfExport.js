/*!
 *
 * Bryntum Grid 5.3.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Base as e,InstancePlugin as t,DomHelper as o,Combo as r,Popup as a,LocaleManagerSingleton as i,Field as n,BrowserHelper as s,VersionHelper as l,ObjectHelper as c,Toast as p,AjaxHelper as g,EventHelper as d}from"./Editor.js";import{GridFeatureManager as h}from"./GridBase.js";import{RowsRange as u,Orientation as m,FileFormat as f,PaperFormat as x,Exporter as b,FileMIMEType as w}from"./Exporter.js";import{Checkbox as R}from"./MessageDialog.js";var y=t=>class extends(t||e){static get $name(){return"SummaryFormatter"}generateHtml(e,t,o,r,a,i){const n=this.store,s=e.summaries||(e.sum?[{sum:e.sum,renderer:e.summaryRenderer}]:[]);let l=`<table class="${o}">`;return s.forEach((o=>{let r=o.sum,a=null;switch(!0===r&&(r="sum"),r){case"sum":case"add":a=n.sum(e.field,t);break;case"max":a=n.max(e.field,t);break;case"min":a=n.min(e.field,t);break;case"average":case"avg":a=n.average(e.field,t);break;case"count":a=t.length;break;case"countNotEmpty":a=t.reduce(((t,o)=>t+(null!=o[e.field]?1:0)),0)}if("function"==typeof r&&(a=t.reduce(r,"seed"in o?o.seed:0)),null!==a){const e="b-grid-summary-value",t=o.label?`<td class="b-grid-summary-label">${o.label}</td>`:"";let r,i=o.renderer?o.renderer({config:o,sum:a}):a;null==i&&(i=""),r=String(i).includes("<td>")?i:t?`${t}<td class="${e}">${i}</td>`:`<td colspan="2" class="${e}">${i}</td>`,l+=`<tr>${r}</tr>`}})),l+"</table>"}};class H extends(y(t)){static get configurable(){return{selectedOnly:null,hideFooters:!1}}static get pluginConfig(){return{chain:["renderRows","bindStore"]}}static get $name(){return"Summary"}construct(e,t){this.grid=e,super.construct(e,t),this.bindStore(e.store),e.hideFooters=this.hideFooters}bindStore(e){this.detachListeners("store"),e.ion({name:"store",change:"onStoreChange",thisObj:this})}get store(){return this.grid.store}doDestroy(){super.doDestroy()}doDisable(e){super.doDisable(e);const{client:t}=this;e?t.element.classList.add("b-summary-disabled"):(this.updateSummaries(),t.element.classList.remove("b-summary-disabled"),t.eachSubGrid((e=>e.scrollable.syncPartners())))}renderRows(){this.updateSummaries()}updateSummaries(){const e=this,{grid:t,store:r}=e,a=o.children(t.element,".b-grid-footer"),i=e.selectedOnly&&t.selectedRecords.length>0,n=(r.isFiltered?r.storage.values:r.allRecords).filter((e=>!e.isSpecialRow&&(!i||t.isSelected(e))));t.columns.forEach((e=>{var t;null===(t=e.summaries)||void 0===t||t.forEach((e=>{"seed"in e&&("initialSeed"in e||(e.initialSeed=e.seed),["number","string","date"].includes(typeof e.initialSeed)?e.seed=e.initialSeed:e.seed=Object.assign({},e.initialSeed))}))})),a.forEach((r=>{if(!r.dataset.column)return;const a=t.columns.get(r.dataset.column),i=e.generateHtml(a,n,"b-grid-footer-summary");(a.summaries?a.summaries.length:!!a.sum)&&(r.children.length?o.sync(i,r.firstElementChild):r.innerHTML=i)}))}onStoreChange({action:e,changes:t}){let o=!0;this.disabled||("update"===e&&(o=Object.keys(t).some((e=>{const t=this.grid.columns.get(e);return Boolean(t)&&(Boolean(t.sum)||Boolean(t.summaries))}))),o&&this.updateSummaries())}updateSelectedOnly(e){const t=this;t.detachListeners("selectionChange"),e&&t.grid.ion({name:"selectionChange",selectionChange:t.refresh,thisObj:t}),t.refresh()}refresh(){this.updateSummaries()}}H.featureClass="b-summary",H._$name="Summary",h.registerFeature(H);class P extends r{static get $name(){return"ExportRowsCombo"}static get type(){return"exportrowscombo"}static get defaultConfig(){return{editable:!1}}buildItems(){return[{id:u.all,text:this.L("L{all}")},{id:u.visible,text:this.L("L{visible}")}]}}P.initClass(),P._$name="ExportRowsCombo";class v extends r{static get $name(){return"ExportOrientationCombo"}static get type(){return"exportorientationcombo"}static get defaultConfig(){return{editable:!1}}buildItems(){return[{id:m.portrait,text:this.L("L{portrait}")},{id:m.landscape,text:this.L("L{landscape}")}]}}function E(e,t=(e=>e)){return Object.keys(e).map((e=>({id:e,text:t(e)})))}v.initClass(),v._$name="ExportOrientationCombo";class C extends a{static get $name(){return"ExportDialog"}static get type(){return"exportdialog"}static get configurable(){return{autoShow:!1,autoClose:!1,closable:!0,centered:!0,client:null,autoSelectVisibleColumns:!0,hidePNGMultipageOption:!0,title:"L{exportSettings}",maxHeight:"80%",scrollable:{overflowY:!0},defaults:{localeClass:this},items:{columnsField:{type:"combo",label:"L{ExportDialog.columns}",store:{},valueField:"id",displayField:"text",multiSelect:!0,weight:100,maxHeight:100},rowsRangeField:{type:"exportrowscombo",label:"L{ExportDialog.rows}",value:"all",weight:200},exporterTypeField:{type:"combo",label:"L{ExportDialog.exporterType}",editable:!1,value:"singlepage",displayField:"text",buildItems(){const e=this.parent;return e.exporters.map((t=>({id:t.type,text:e.optionalL(t.title,this)})))},onChange({value:e}){this.owner.widgetMap.alignRowsField.hidden="singlepage"===e,this.owner.widgetMap.repeatHeaderField.hidden="multipagevertical"!==e},weight:300},alignRowsField:{type:"checkbox",label:"L{ExportDialog.alignRows}",checked:!1,hidden:!0,weight:400},repeatHeaderField:{type:"checkbox",label:"L{ExportDialog.repeatHeader}",localeClass:this,hidden:!0,weight:500},fileFormatField:{type:"combo",label:"L{ExportDialog.fileFormat}",localeClass:this,editable:!1,value:"pdf",items:[],onChange({value:e,oldValue:t}){const o=this.parent;if(o.hidePNGMultipageOption){const r=o.widgetMap.exporterTypeField,a=r.store.find((e=>"singlepage"===e.id));e===f.png&&a?(this._previousDisabled=r.disabled,r.disabled=!0,this._previousValue=r.value,r.value="singlepage"):t===f.png&&this._previousValue&&(r.disabled=this._previousDisabled,r.value=this._previousValue)}},weight:600},paperFormatField:{type:"combo",label:"L{ExportDialog.paperFormat}",editable:!1,value:"A4",items:[],weight:700},orientationField:{type:"exportorientationcombo",label:"L{ExportDialog.orientation}",value:"portrait",weight:800}},bbar:{defaults:{localeClass:this},items:{exportButton:{color:"b-green",text:"L{ExportDialog.export}",weight:100,onClick:"up.onExportClick"},cancelButton:{color:"b-gray",text:"L{ExportDialog.cancel}",weight:200,onClick:"up.onCancelClick"}}}}}construct(e={}){const t=this,{client:o}=e;if(!o)throw new Error("`client` config is required");t.columnsStore=o.columns.chain((e=>e.isLeaf&&e.exportable),null,{excludeCollapsedRecords:!1}),t.applyInitialValues(e),super.construct(e),i.ion({locale:"onLocaleChange",prio:-1,thisObj:t})}applyInitialValues(e){const t=this,o=e.items=e.items||{};e.width=e.width||t.L("L{width}"),e.defaults=e.defaults||{},e.defaults.labelWidth=e.defaults.labelWidth||t.L("L{ExportDialog.labelWidth}"),o.columnsField=o.columnsField||{},o.fileFormatField=o.fileFormatField||{},o.paperFormatField=o.paperFormatField||{},o.fileFormatField.items=E(f,(e=>e.toUpperCase())),o.paperFormatField.items=E(x),o.columnsField.store=t.columnsStore}onBeforeShow(){var e;const{columnsField:t,alignRowsField:o,exporterTypeField:r,repeatHeaderField:a}=this.widgetMap;this.autoSelectVisibleColumns&&(t.value=this.columnsStore.query((e=>!e.hidden))),o.hidden="singlepage"===r.value,a.hidden="multipagevertical"!==r.value,null===(e=super.onBeforeShow)||void 0===e||e.call(this,...arguments)}onLocaleChange(){const e=this.L("L{labelWidth}");this.width=this.L("L{width}"),this.eachWidget((t=>{t instanceof n&&(t.labelWidth=e)}))}onExportClick(){const e=this.values;this.trigger("export",{values:e})}onCancelClick(){this.trigger("cancel"),this.hide()}get values(){const e=/field/i,t={};return this.eachWidget((o=>{e.test(o.ref)&&(t[o.ref.replace(e,"")]=o instanceof R?o.checked:o.value)})),t}}C.initClass(),C._$name="ExportDialog";class M extends b{static get $name(){return"MultiPageExporter"}static get type(){return"multipage"}static get title(){return this.L("L{multipage}")}static get exportingPageText(){return"L{exportingPage}"}async stateNextPage({client:e,rowsRange:t,enableDirectRendering:o}){const{exportMeta:r}=this;++r.currentPage,++r.verticalPosition,delete r.lastExportedRowBottom,r.verticalPosition>=r.verticalPages&&(Object.assign(r,{verticalPosition:0,horizontalPosition:r.horizontalPosition+1,currentPageTopMargin:0,lastTop:0,lastRowIndex:t===u.visible?e.rowManager.firstVisibleRow.dataIndex:0}),delete r.lastRowDataIndex,o||await this.scrollRowIntoView(e,r.firstVisibleDataIndex,{block:"start"}))}async prepareComponent(e){await super.prepareComponent(e);const t=this,{exportMeta:o}=t,{client:r,headerTpl:a,footerTpl:i,alignRows:n,rowsRange:s,enableDirectRendering:l}=e,c=x[e.paperFormat],p=e.orientation===m.portrait,g=p?c.width:c.height,d=p?c.height:c.width,h=t.inchToPx(g),f=t.inchToPx(d),b=s===u.visible,w=Math.ceil(o.totalWidth/h);let R=f;a&&(R-=t.measureElement(a({totalWidth:o.totalWidth,totalPages:-1,currentPage:-1}))),i&&(R-=t.measureElement(i({totalWidth:o.totalWidth,totalPages:-1,currentPage:-1})));let y,H,P=r.store.count;if(b?(P=t.getVisibleRowsCount(r),y=o.totalHeight+r.headerHeight+r.footerHeight+r.bodyHeight):y=o.totalHeight+r.headerHeight+r.footerHeight+r.scrollable.scrollHeight,n&&!b){const e=r.rowManager.rowOffsetHeight,t=Math.floor((R-r.headerHeight)/e),o=Math.floor(R/e),a=P-t;H=1+Math.ceil(a/o)}else H=Math.ceil(y/R);Object.assign(o,{paperWidth:g,paperHeight:d,pageWidth:h,pageHeight:f,horizontalPages:w,verticalPages:H,totalHeight:y,contentHeight:R,totalRows:P,totalPages:w*H,currentPage:0,verticalPosition:0,horizontalPosition:0,currentPageTopMargin:0,lastTop:0,lastRowIndex:b?r.rowManager.firstVisibleRow.dataIndex:0}),l||this.adjustRowBuffer(r)}async restoreComponent(e){await super.restoreComponent(e),e.enableDirectRendering||this.restoreRowBuffer(e.client)}async collectRows(e){const t=this,{exportMeta:o}=t,{client:r,alignRows:a,rowsRange:i}=e,{subGrids:n,currentPageTopMargin:s,verticalPosition:l,contentHeight:c,totalRows:p,lastRowDataIndex:g}=o,{rowManager:d}=r,{rows:h}=d,m=i===u.visible,f=r.hasActiveFeature("mergeCells");let x,b;b=m&&null!=g?g===h[h.length-1].dataIndex?h.length-1:h.findIndex((e=>e.dataIndex===g)):m?h.findIndex((e=>e.bottom>Math.ceil(r.scrollable.y))):h.findIndex((e=>e.bottom+s+r.headerHeight>0));const w=b;x=c-(m||0===l?0:h[b].top+s+r.headerHeight),0===l&&(x-=r.headerHeight);let R,y=0;for(;x>0;){const e=h[b];a&&x<e.offsetHeight?(y=-x,x=0,t.exportMeta.lastExportedRowBottom=h[b-1].bottom):(t.collectRow(e),x-=e.offsetHeight,R=e.dataIndex,(++b===h.length&&x>0||m&&b-w===p)&&(x=0))}if(f)for(const e in n){const t=n[e],o=r.subGrids[e].element.querySelectorAll(".b-grid-merged-cells");t.mergedCellsHtml=[];for(const e of o)t.mergedCellsHtml.push(e.outerHTML)}const H=h[b-1];if(H&&(o.exactGridHeight=H.bottom+r.footerContainer.offsetHeight+r.headerContainer.offsetHeight,o.lastRowDataIndex=H.dataIndex+1),await t.onRowsCollected(h.slice(w,b),e),m)o.exactGridHeight-=o.scrollableTopMargin=r.scrollable.y;else{const e=d.ion({offsetRows:({offset:e})=>y+=e});await t.scrollRowIntoView(r,R+1),e()}return y}async renderRows(e){const t=this,{exportMeta:o}=t,{client:r,alignRows:a,rowsRange:i}=e,{currentPageTopMargin:n,verticalPosition:s,contentHeight:l,totalRows:c,lastRowIndex:p,fakeRow:g}=o,{store:d}=r,h=r.hasActiveFeature("mergeCells"),m=i===u.visible;let f,x=p,{lastTop:b}=o;const w=x,R=[];f=l-(m||0===s?0:b+n+r.headerHeight),0===s&&(f-=r.headerHeight);let y,H,P=0;for(;f>0;)g.render(x,d.getAt(x),!0,!1,!0),a&&f<g.offsetHeight?(P=-f,f=0,t.exportMeta.lastExportedRowBottom=b):(H=b,y=x,b=g.translate(b),f-=g.offsetHeight,t.collectRow(g),R.push({top:g.top,bottom:g.bottom,offsetHeight:g.offsetHeight,dataIndex:g.dataIndex}),(++x===d.count&&f>0||m&&x-w===c)&&(f=0));return h&&t.renderMergedCells(e,w,x,R),o.lastRowIndex=a?x:y,o.lastTop=a?b:H,g&&(o.exactGridHeight=g.bottom+r.footerContainer.offsetHeight+r.headerContainer.offsetHeight),await t.onRowsCollected(R,e),P}async buildPage(e){const t=this,{exportMeta:o}=t,{client:r,headerTpl:a,footerTpl:i,enableDirectRendering:n}=e,{totalWidth:s,totalPages:l,currentPage:c,subGrids:p}=o;let g,d,h;Object.values(p).forEach((e=>e.rows=[])),e.rowsRange===u.all&&(o.totalHeight=r.height-r.bodyHeight+r.scrollable.scrollHeight-t.getVirtualScrollerHeight(r)),a&&(g=t.prepareHTML(a({totalWidth:s,totalPages:l,currentPage:c}))),i&&(d=t.prepareHTML(i({totalWidth:s,totalPages:l,currentPage:c}))),h=n?await t.renderRows(e):await t.collectRows(e);return{html:t.buildPageHtml(e),header:g,footer:d,offset:h}}async onRowsCollected(){}buildPageHtml(){const{subGrids:e}=this.exportMeta;let t=this.prepareExportElement();return Object.values(e).forEach((({placeHolder:e,rows:o,mergedCellsHtml:r})=>{const a=e.outerHTML;let i=o.reduce(((e,t)=>e+=t[0]),"");null!=r&&r.length&&(i+=`<div class="b-grid-merged-cells-container">${r.join("")}</div>`),t=t.replace(a,i)})),t}prepareExportElement(){const{element:e,exportMeta:t}=this;return t.scrollableTopMargin&&(e.querySelector(".b-grid-vertical-scroller").style.marginTop=`-${t.scrollableTopMargin}px`),super.prepareExportElement()}}M.prototype.pagesExtractor=async function*(e){const t=this,{exportMeta:o,stylesheets:r}=t,{totalWidth:a,totalPages:i,paperWidth:n,paperHeight:s,contentHeight:l}=o;let c;for(;(c=o.currentPage)<i;){t.trigger("exportStep",{text:t.L(M.exportingPageText,{currentPage:c,totalPages:i}),progress:Math.round((c+1)/i*90)});const{html:p,header:g,footer:d,offset:h}=await t.buildPage(e),u=[...r,`\n                <style>\n                    #${e.client.id} {\n                        height: ${o.exactGridHeight}px !important;\n                        width: ${a}px !important;\n                    }\n                    .b-export-body .b-export-viewport {\n                        margin-inline-start : ${-n*o.horizontalPosition}in;\n                        margin-top  : ${o.currentPageTopMargin}px;\n                    }\n                </style>\n            `];o.currentPageTopMargin-=l+h,await t.stateNextPage(e),yield{html:t.pageTpl({html:p,header:g,footer:d,styles:u,paperWidth:n,paperHeight:s})}}},M._$name="MultiPageExporter";class T extends b{static get $name(){return"MultiPageVerticalExporter"}static get type(){return"multipagevertical"}static get title(){return this.L("L{multipagevertical}")}static get exportingPageText(){return"L{exportingPage}"}async stateNextPage({client:e}){const{exportMeta:t}=this,{totalRows:o,processedRows:r,totalPages:a}=t;++t.currentPage,++t.verticalPosition,t.currentPage===a&&r.size!==o&&(++t.totalPages,++t.verticalPages)}estimateTotalPages(e){const t=this,{exportMeta:o}=t,{client:r,headerTpl:a,footerTpl:i,alignRows:n,rowsRange:s,repeatHeader:l,enableDirectRendering:c}=e,{pageWidth:p,pageHeight:g,totalWidth:d}=o,h=t.getScaleValue(p,d);let m,f=0-t.getVirtualScrollerHeight(r)+r.height-r.bodyElement.offsetHeight+r.scrollable.scrollHeight,x=g/h,b=r.store.count,w=0,R=f;if(a&&(x-=t.measureElement(a({totalWidth:d,totalPages:-1,currentPage:-1}))),i&&(x-=t.measureElement(i({totalWidth:d,totalPages:-1,currentPage:-1}))),l&&(x-=r.headerHeight+r.footerHeight,f-=r.headerHeight+r.footerHeight),s===u.visible){const e=r.rowManager,a=e.firstVisibleRow,i=e.lastVisibleRow;c||(w=a.top),b=t.getVisibleRowsCount(r),c?(f=r.headerHeight+r.footerHeight+i.bottom-a.top,R=i.bottom-a.top):R=f=f-r.scrollable.scrollHeight+i.bottom-a.top,o.lastRowIndex=a.dataIndex,o.finishRowIndex=i.dataIndex}else o.finishRowIndex=r.store.count-1;if(n&&!l&&s!==u.visible){const e=r.rowManager.rowOffsetHeight,t=Math.floor((x-r.headerHeight)/e),o=Math.floor(x/e),a=b-t;m=1+Math.ceil(a/o)}else m=Math.ceil(R/x);Object.assign(o,{scale:h,contentHeight:x,totalRows:b,totalHeight:f,verticalPages:m,initialScroll:w,horizontalPages:1,totalPages:m})}async prepareComponent(e){await super.prepareComponent(e);const t=this,{exportMeta:o}=t,{client:r}=e,a=x[e.paperFormat],i=e.orientation===m.portrait,n=i?a.width:a.height,s=i?a.height:a.width,l=t.inchToPx(n),c=t.inchToPx(s);Object.assign(o,{paperWidth:n,paperHeight:s,pageWidth:l,pageHeight:c,horizontalPages:1,currentPage:0,verticalPosition:0,horizontalPosition:0,currentPageTopMargin:0,lastTop:0,lastRowIndex:0,processedRows:new Set}),t.estimateTotalPages(e),e.enableDirectRendering||t.adjustRowBuffer(r)}async restoreComponent(e){await super.restoreComponent(e),e.enableDirectRendering||this.restoreRowBuffer(e.client)}async collectRows(e){const t=this,{exportMeta:o}=t,{client:r,alignRows:a,repeatHeader:i}=e,{subGrids:n,currentPageTopMargin:s,verticalPosition:l,totalRows:c,contentHeight:p}=o,g=i?0:r.headerHeight,{rowManager:d}=r,{rows:h}=d,m=e.rowsRange===u.visible,f=r.hasActiveFeature("mergeCells");let x,b=m?h.findIndex((e=>e.bottom>r.scrollable.y)):h.findIndex((e=>e.bottom+s+g>0));const w=b;x=p-(0===l?0:h[b].top+s+g),0===l&&(x-=g);let R,y=0;for(;x>0;){const e=h[b];a&&x<e.offsetHeight?(y=-x,x=0):(t.collectRow(e),x-=e.offsetHeight,x>0&&o.processedRows.add(e.dataIndex),R=e.dataIndex,(++b===h.length&&x>0||m&&b-w===c)&&(x=0))}if(f)for(const e in n){const t=n[e],o=r.subGrids[e].element.querySelectorAll(".b-grid-merged-cells");t.mergedCellsHtml=[];for(const e of o)t.mergedCellsHtml.push(e.outerHTML)}const H=h[b-1];if(H&&(o.exactGridHeight=H.bottom+r.footerContainer.offsetHeight+r.headerContainer.offsetHeight),await t.onRowsCollected(h.slice(w,b),e),m)o.scrollableTopMargin=r.scrollable.y;else{const e=d.ion({offsetRows:({offset:e})=>y+=e});await t.scrollRowIntoView(r,R+1),e()}return y}async renderRows(e){const t=this,{exportMeta:o}=t,{client:r,alignRows:a,repeatHeader:i}=e,{currentPageTopMargin:n,verticalPosition:s,totalRows:l,contentHeight:c,lastRowIndex:p,finishRowIndex:g,fakeRow:d}=o,h=i?0:r.headerHeight,{store:m}=r,f=r.hasActiveFeature("mergeCells"),x=e.rowsRange===u.visible;let b,w=p,{lastTop:R}=o;const y=w,H=[];b=c-(0===s?0:R+n+h),0===s&&(b-=h);let P,v,E=0;for(;b>0;)d.render(w,m.getAt(w),!0,!1,!0),a&&b<d.offsetHeight?(E=-b,b=0):(v=R,P=w,R=d.translate(R),b-=d.offsetHeight,t.collectRow(d),H.push({top:d.top,bottom:d.bottom,offsetHeight:d.offsetHeight,dataIndex:d.dataIndex}),b>0&&o.processedRows.add(w),(w===g||++w-y===l&&x)&&(b=0));return f&&t.renderMergedCells(e,y,w,H),o.lastRowIndex=P,o.lastTop=v,d&&(o.exactGridHeight=d.bottom+r.footerContainer.offsetHeight+r.headerContainer.offsetHeight),await t.onRowsCollected(H,e),E}async buildPage(e){const t=this,{exportMeta:o}=t,{client:r,headerTpl:a,footerTpl:i,enableDirectRendering:n}=e,{totalWidth:s,totalPages:l,currentPage:c,subGrids:p}=o;let g,d,h;Object.values(p).forEach((e=>e.rows=[])),e.rowsRange===u.all&&(o.totalHeight=r.headerHeight+r.footerHeight+r.scrollable.scrollHeight,n||(o.totalHeight-=t.getVirtualScrollerHeight(r))),a&&(g=t.prepareHTML(a({totalWidth:s,totalPages:l,currentPage:c}))),i&&(d=t.prepareHTML(i({totalWidth:s,totalPages:l,currentPage:c}))),h=n?await t.renderRows(e):await t.collectRows(e);return{html:t.buildPageHtml(e),header:g,footer:d,offset:h}}async onRowsCollected(){}buildPageHtml(){const{subGrids:e}=this.exportMeta;let t=this.prepareExportElement();return Object.values(e).forEach((({placeHolder:e,rows:o,mergedCellsHtml:r})=>{const a=e.outerHTML;let i=o.reduce(((e,t)=>e+=t[0]),"");null!=r&&r.length&&(i+=`<div class="b-grid-merged-cells-container">${r.join("")}</div>`),t=t.replace(a,i)})),t}}T.prototype.pagesExtractor=async function*(e){const t=this,{exportMeta:o,stylesheets:r}=t,{totalWidth:a,paperWidth:i,paperHeight:n,contentHeight:s,scale:l,initialScroll:c}=o;let p,{totalPages:g}=o;for(;(p=o.currentPage)<g;){t.trigger("exportStep",{text:t.L(T.exportingPageText,{currentPage:p,totalPages:g}),progress:Math.round((p+1)/g*90)});const{html:d,header:h,footer:u,offset:m}=await t.buildPage(e),f=[...r,`\n                <style>\n                    #${e.client.id} {\n                        width: ${a}px !important;\n                    }\n                    .b-export .b-export-content {\n                        transform: scale(${l});\n                        transform-origin: top left;\n                        height: auto;\n                    }\n                </style>\n            `];if(e.repeatHeader){const t=o.exactGridHeight?`${o.exactGridHeight+o.currentPageTopMargin}px`:"100%";f.push(`\n                <style>\n                    #${e.client.id} {\n                        height: ${t} !important;\n                    }\n                    .b-export .b-export-content {\n                        height: ${100/l}%;\n                    }\n                    .b-export-body {\n                        height: 100%;\n                        display: flex;\n                    }\n                    .b-export-viewport {\n                        height: 100%;\n                    }\n                    .b-grid-vertical-scroller {\n                        margin-top: ${o.currentPageTopMargin-c}px;\n                    }\n                </style>\n                `)}else{const t=o.exactGridHeight||s-o.currentPageTopMargin;f.push(`\n                <style>\n                    #${e.client.id} {\n                        height: ${t}px !important;\n                    }\n                    .b-export-body {\n                        overflow: hidden;\n                    }\n                    .b-export .b-export-content {\n                        height: ${100/l}%;\n                    }\n                    .b-export-body .b-export-viewport {\n                        margin-top: ${o.currentPageTopMargin}px;\n                    }\n                    .b-grid-vertical-scroller {\n                        margin-top: -${c}px;\n                    }\n                </style>\n                `)}o.currentPageTopMargin-=s+m,await t.stateNextPage(e),({totalPages:g}=o),yield{html:t.pageTpl({html:d,header:h,footer:u,styles:f,paperWidth:i,paperHeight:n})}}},T._$name="MultiPageVerticalExporter";class L extends b{static get $name(){return"SinglePageExporter"}static get type(){return"singlepage"}static get title(){return this.localize("L{singlepage}")}static get defaultConfig(){return{centerContentHorizontally:!1}}async prepareComponent(e){await super.prepareComponent(e),Object.assign(this.exportMeta,{verticalPages:1,horizontalPages:1,totalPages:1,currentPage:0,verticalPosition:0,horizontalPosition:0})}async onRowsCollected(){}positionRows(e,t){if(t.enableDirectRendering)return e.map((e=>e[0]));{let t=0;return e.map((([e,,o])=>{const r=e.replace(/translate\(\d+px, \d+px\)/,`translate(0px, ${t}px)`);return t+=o,r}))}}async collectRows(e){const t=this,{client:o}=e,{rowManager:r,store:a}=o,i=o.hasActiveFeature("mergeCells"),{subGrids:n}=t.exportMeta,s=e.rowsRange===u.visible&&a.count?t.getVisibleRowsCount(o):a.count;let{totalHeight:l}=t.exportMeta,c=0,p=-1;if(r.rows.length>0){if(e.rowsRange===u.visible&&(p=r.firstVisibleRow.dataIndex-1),i)for(const e of Object.values(n))e.mergedCellsHtml=[];for(;c<s;){const a=r.rows,g=a[a.length-1],d=c;if(a.forEach((e=>{e.dataIndex>p&&c<s&&(++c,l+=e.offsetHeight,t.collectRow(e))})),i)for(const e in n){const t=n[e],r=o.subGrids[e].element.querySelectorAll(".b-grid-merged-cells");for(const e of r)t.mergedCellsHtml.push(e.outerHTML)}const h=a.findIndex((e=>e.dataIndex===p+1)),u=h+(c-d);await t.onRowsCollected(a.slice(h,u),e),c<s&&(p=g.dataIndex,await t.scrollRowIntoView(o,p+1))}}return l}async renderRows(e){const t=this,{client:o,rowsRange:r}=e,{rowManager:a,store:i}=o,n=o.hasActiveFeature("mergeCells"),s=r===u.visible;let{totalHeight:l}=t.exportMeta;if(i.count){const{fakeRow:o}=t.exportMeta,{firstVisibleRow:r}=a,c=s?r.dataIndex:0,p=s?a.lastVisibleRow.dataIndex:i.count-1,g=[];let d=0;if(o.cells.length){for(let e=c;e<=p;e++)o.render(e,i.getAt(e),!0,!1,!0),d=o.translate(d),t.collectRow(o),g.push({top:o.top,bottom:o.bottom,offsetHeight:o.offsetHeight,dataIndex:o.dataIndex});await t.onRowsCollected(g,e)}l+=d,n&&t.renderMergedCells(e,c,p,g)}return l}buildPageHtml(e){const t=this,{subGrids:o}=t.exportMeta;let r=t.prepareExportElement();return Object.values(o).forEach((({placeHolder:o,rows:a,mergedCellsHtml:i})=>{const n=o.outerHTML;let s=t.positionRows(a,e).join("");null!=i&&i.length&&(s+=`<div class="b-grid-merged-cells-container">${i.join("")}</div>`),r=r.replace(n,s)})),r}}L.prototype.pagesExtractor=async function*(e){const t=this,{client:o}=e,{totalWidth:r}=t.exportMeta,a=t.stylesheets,i=e.orientation===m.portrait,n=x[e.paperFormat],l=i?n.width:n.height,c=i?n.height:n.width;let p,g,d;e.enableDirectRendering?(p=await t.renderRows(e),p+=o.headerHeight+o.footerHeight):(p=await t.collectRows(e),p+=o.height-o.bodyHeight);const h=t.buildPageHtml(e),u=p;if(e.headerTpl){g=t.prepareHTML(e.headerTpl({totalWidth:r}));p+=t.measureElement(g)}if(e.footerTpl){d=t.prepareHTML(e.footerTpl({totalWidth:r}));p+=t.measureElement(d)}const f=Math.min(1,t.getScaleValue(t.inchToPx(l),r)),b=Math.min(1,t.getScaleValue(t.inchToPx(c),p)),w=Math.min(f,b);a.push(`<style>\n                #${o.id} {\n                    height: ${u}px !important;\n                    width: ${r}px !important;\n                }\n                .b-export-content {\n                    ${t.centerContentHorizontally?"left: 50%;":""}\n                    transform: scale(${w}) ${t.centerContentHorizontally?"translateX(-50%)":""};\n                    transform-origin: top left;\n                    height: ${1===w?"inherit":"auto !important"};\n                }\n            </style>`),s.isIE11&&a.push(`<style>\n                .b-export-body {\n                   min-height: ${u}px !important;\n                }\n         </style>`),yield{html:t.pageTpl({html:h,header:g,footer:d,styles:a,paperWidth:l,paperHeight:c})}},L._$name="SinglePageExporter";class F extends t{static get $name(){return"PdfExport"}static get configurable(){return{dialogClass:C,exportServer:void 0,exportDialog:{value:!0,$config:["lazy"]},fileName:null,fileFormat:"pdf",clientURL:null,paperFormat:"A4",orientation:"portrait",rowsRange:"all",alignRows:!1,repeatHeader:!1,keepRegionSizes:null,pagesPerRequest:0,exporterConfig:null,exporterType:"singlepage",exporters:[L,M,T],translateURLsToAbsolute:!0,keepPathName:!0,openAfterExport:!0,sendAsBinary:!1,openInNewTab:!1,headerTpl:null,footerTpl:null,fetchOptions:null,exportMask:"L{Generating pages}",exportProgressMask:"L{Waiting for response from server}",showErrorToast:!0,localizableProperties:["exportMask","exportProgressMask"],filterStyles:e=>e,enableDirectRendering:!0}}updateEnableDirectRendering(e){e||l.deprecate("Grid","6.0.0","Indirect rendering is deprecated")}doDestroy(){var e;null===(e=this.exportDialog)||void 0===e||e.destroy(),this.exportersMap.forEach((e=>e.destroy())),super.doDestroy()}get currentExportPromise(){return this._currentExportPromise}set currentExportPromise(e){this._currentExportPromise=e}get exportersMap(){return this._exportersMap||(this._exportersMap=new Map)}getExporter(e={}){const t=this,{exportersMap:o}=t,{type:r}=e;let a;if(o.has(r))a=o.get(r),Object.assign(a,e);else{const i=this.exporters.find((e=>e.type===r));if(!i)throw new Error(`Exporter type ${r} is not found. Make sure you've configured it`);delete(e=c.clone(e)).type,a=new i(e),a.relayAll(t),o.set(r,a)}return a}buildRequest(e,t){return{html:JSON.stringify(e),fileFormat:t.fileFormat,format:t.paperFormat,orientation:t.orientation}}buildExportConfig(e={}){const{client:t,exportServer:o,clientURL:r,fileFormat:a,fileName:i,paperFormat:n,rowsRange:s,alignRows:l,repeatHeader:p,keepRegionSizes:g,orientation:d,translateURLsToAbsolute:h,keepPathName:u,sendAsBinary:m,headerTpl:f,footerTpl:x,filterStyles:b,enableDirectRendering:w}=this;e.columns||(e.columns=t.columns.visibleColumns.filter((e=>e.exportable)).map((e=>e.id)));const R=c.assign({client:t,exportServer:o,clientURL:r,fileFormat:a,paperFormat:n,rowsRange:s,alignRows:l,repeatHeader:p,keepRegionSizes:g,orientation:d,translateURLsToAbsolute:h,keepPathName:u,sendAsBinary:m,headerTpl:f,footerTpl:x,enableDirectRendering:w,exporterType:this.exporterType,fileName:i||t.$$name},e);if(R.columns=e.columns.slice(),"multipagevertical"!==R.exporterType&&(R.repeatHeader=!1),!("alignRows"in e)&&e.repeatHeader&&(R.alignRows=!0),!("keepRegionSizes"in e)&&!R.keepRegionSizes){const e=[],o={};t.eachSubGrid((t=>t.collapsed&&e.push(t.region))),e.length&&(t.eachSubGrid((t=>{e.includes(t.region)||(o[t.region]=!0)})),R.keepRegionSizes=o)}return R.exporterConfig=c.assign({type:R.exporterType,translateURLsToAbsolute:R.translateURLsToAbsolute,keepPathName:R.keepPathName,filterStyles:b},R.exporterConfig||{}),delete R.exporterType,delete R.translateURLsToAbsolute,delete R.keepPathName,R}async export(e={}){const t=this,{client:o,pagesPerRequest:r}=t;let a;if(e=t.buildExportConfig(e),!1!==o.trigger("beforePdfExport",{config:e})){o.isExporting=!0,o.mask(t.exportMask);try{const s=t.getExporter(e.exporterConfig);if(0===r){var i;const r=await s.export(e);if(t.isDestroying)return;null===(i=t.exportDialog)||void 0===i||i.close(),o.unmask(),t.trigger("exportStep",{progress:90,text:t.exportProgressMask,contentGenerated:!0});const n=t.receiveExportContent(r,e);t.toast=t.showLoadingToast(n);const l=await n;a={response:l},await t.processExportContent(l,e)}}catch(e){throw a=e instanceof Response?{response:e}:{error:e},e}finally{var n;if(t.toast&&!t.toast.isDestroying&&t.toast.hide(),!t.isDestroying)null===(n=t.exportDialog)||void 0===n||n.close(),o.unmask(),t.showErrorToast&&(a.error?"AbortError"!==a.error.name&&p.show({html:t.L("L{Export failed}"),rootElement:t.rootElement}):a.response.ok||p.show({html:t.L("L{Server error}"),rootElement:t.rootElement})),o.trigger("pdfExport",a),o.isExporting=!1}}return a}receiveExportContent(e,t){return g.fetch(t.exportServer,Object.assign({method:"POST",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:e,orientation:t.orientation,format:t.paperFormat,fileFormat:t.fileFormat,fileName:t.fileName,clientURL:t.clientURL,sendAsBinary:t.sendAsBinary})},this.fetchOptions))}async processExportContent(e,t){const o=this;if(e.ok&&o.openAfterExport){const r=(e=e.clone()).headers.get("content-type");if(r.match(/application\/octet-stream/)){const r=w[t.fileFormat],a=await o.responseBlobToObjectURL(e,r);o.getDownloadLink(t.fileName,a).click()}else if(r.match(/application\/json/)){const r=await e.json();if(r.success){o.getDownloadLink(t.fileName,r.url).click()}else p.show({html:r.msg,rootElement:this.rootElement})}}}async responseBlobToObjectURL(e,t){const o=await e.blob();return URL.createObjectURL(o.slice(0,o.size,t))}getDownloadLink(e,t){const o=document.createElement("a");return o.download=e,o.href=t,this.openInNewTab&&(o.target="_blank"),o}get defaultExportDialogConfig(){return c.copyProperties({},this,["client","exporters","exporterType","orientation","fileFormat","paperFormat","alignRows","rowsRange","repeatHeader"])}changeExportDialog(e,t){const o=this;if(null==t||t.destroy(),e){const t=o.dialogClass.mergeConfigs({rootElement:o.rootElement,client:o.client,items:{rowsRangeField:{value:o.rowsRange},exporterTypeField:{value:o.exporterType},orientationField:{value:o.orientation},paperFormatField:{value:o.paperFormat},repeatHeaderField:{value:o.repeatHeader},fileFormatField:{value:o.fileFormat},alignRowsField:{checked:o.alignRows}}},o.defaultExportDialogConfig,e);(e=o.dialogClass.new(t)).ion({export:o.onExportButtonClick,thisObj:o})}return e}async showExportDialog(){return this.exportDialog.show()}onExportButtonClick({values:e}){const t=this,o=t.exportDialog.mask({progress:0,maxProgress:100,text:t.exportMask}),r=t.ion({exportstep({progress:e,text:a,contentGenerated:i}){i?(t.exportDialog.unmask(),r()):(o.progress=e,null!=a&&(o.text=a))}});t.currentExportPromise=t.export(e),t.currentExportPromise.catch((()=>{})).finally((()=>{var e;r(),null===(e=t.exportDialog)||void 0===e||e.unmask(),t.currentExportPromise=null}))}showLoadingToast(e){const t=p.show({timeout:0,showProgress:!1,rootElement:this.rootElement,html:`\n    <span class="b-mask-icon b-icon b-icon-spinner"></span>\n    <span>${this.L("L{Waiting for response from server}")}</span>\n    <button class="b-button">${this.L("L{Click to abort}")}</button>`});return d.on({element:t.element,click(){var t;null===(t=e.abort)||void 0===t||t.call(e)}}),t}}F._$name="PdfExport",h.registerFeature(F,!1,"Grid");export{C as ExportDialog,v as ExportOrientationCombo,P as ExportRowsCombo,M as MultiPageExporter,T as MultiPageVerticalExporter,F as PdfExport,L as SinglePageExporter,H as Summary,y as SummaryFormatter};
//# sourceMappingURL=PdfExport.js.map
